# Story 1.12: Generate Rendered Template Content

## Status: Draft

## Story

As a developer, I want the `new` command to generate the final content string from the rendered template, so that the template processing is complete before file writing.

## Acceptance Criteria

- 1.12.1: The command generates a final content string from the rendered template.
- 1.12.2: Template rendering uses the custom function map with now, toLower, and toUpper functions.
- 1.12.3: Template execution receives no external data (nil data parameter for MVP).
- 1.12.4: Template execution errors are wrapped using the shared errors package and propagated to command output.

## Tasks / Subtasks

- [ ] Task 1: Create template execution service
  - [ ] Create `internal/app/template/executor.go` file
  - [ ] Define `TemplateExecutor` interface with `Execute(ctx context.Context, template *template.Template, data interface{}) (string, error)` method
  - [ ] Implement `GoTemplateExecutor` struct with `Execute` method using template.Execute() with nil data parameter for MVP
  - [ ] Add proper error handling using `internal/shared/errors` package for execution errors
  - [ ] Wrap template execution errors with context about the template being processed
  - [ ] Accept context.Context for future cancellation support

- [ ] Task 2: Integrate template execution into new command
  - [ ] Modify `internal/adapters/api/cli/new.go` to call template execution after parsing
  - [ ] Pass context.Context from command execution to executor service
  - [ ] Pass parsed template from Story 1.10 to executor service with nil data parameter
  - [ ] Handle execution errors using shared errors package and propagate to command output with clear error messages
  - [ ] Store rendered content string in command context for use in Story 1.13 file writing

- [ ] Task 3: Add unit tests for template execution
  - [ ] Create `executor_test.go` with table-driven tests for template execution
  - [ ] Test successful execution of static templates with nil data parameter
  - [ ] Test execution with custom functions (now, toLower, toUpper) from Story 1.11
  - [ ] Test error handling for execution failures using shared errors package
  - [ ] Verify no external data binding for MVP (data parameter always nil)

- [ ] Task 4: Update integration tests
  - [ ] Modify existing new command integration tests to verify rendered content
  - [ ] Add test cases for templates using custom functions with golden file comparisons
  - [ ] Store expected rendered output in `testdata/golden/` per testing strategy
  - [ ] Test complete pipeline from template reading to content generation
  - [ ] Verify error propagation through command layer

## Dev Notes

### Previous Story Context

This story builds on Story 1.11 (Add Basic Template Functions) which established the custom function map, and Story 1.10 (Implement Static Template Parsing) which set up template parsing. The template is now parsed with functions available, and this story completes the rendering process by executing the template to produce the final content string.

### Technical Context

- **Template Engine**: Uses Go stdlib `text/template` package for template parsing and execution
- **Function Integration**: Custom `FuncMap` with now, toLower, toUpper functions from Story 1.11
- **Execution Process**: `template.Execute(io.Writer, data)` produces rendered content
- **Data Context**: Template execution receives no external data for MVP - data parameter is nil, focusing on static templates with built-in functions only
- **Architecture Location**: Template execution logic in `internal/app/template/` package
- **Domain Model**: Template struct has `Parsed` (*template.Template) field for cached parsed templates

### Data Models

Template model from `internal/domain/template.go` includes:
- `Content string` - Raw template text
- `Parsed *template.Template` - Cached parsed template with functions

### API Specifications

FileSystemPort.ReadFile returns `([]byte, error)` - template content converted to string for parsing.

### Component Specifications

TemplateEngine in `docs/architecture/components.md#templateengine` coordinates template parsing and execution. Template execution uses Go `text/template.Execute()` with custom function map.

### File Locations

- New command logic: `internal/adapters/api/cli/new.go` (modify existing file)
- Template execution service: `internal/app/template/executor.go` (new service)
- Template execution interface: `internal/app/template/executor.go` (define interface for testability)
- Tests: `internal/app/template/executor_test.go` (co-located with implementation)

### Source Tree Structure

```
internal/app/template/
├── functions.go          # Template function implementations (from Story 1.11)
├── parser.go             # Template parsing (from Story 1.10)
├── executor.go           # Template execution (new)
├── executor_test.go      # Unit tests for execution
└── [existing files]
```

### Testing Standards

- **Unit Tests**: Co-located `*_test.go` files using table-driven tests for execution validation
- **Integration Tests**: `tests/integration/` with end-to-end template rendering tests
- **Coverage**: Target ≥85% for template execution functions
- **Test Patterns**: Use `testing` stdlib with subtests for different execution scenarios
- **Golden Files**: Store expected rendered output in `testdata/golden/` for comparison

### Coding Standards Compliance

- **Result Pattern**: Template execution returns `(string, error)` - Result pattern applies to service layer
- **Error Handling**: Template execution errors should be wrapped with context and propagated
- **Function Naming**: Use PascalCase for interfaces/structs, camelCase for methods
- **Context Awareness**: Template execution should accept `context.Context` for future cancellation

### Technical Constraints

- **Stdlib Only**: Use Go `text/template` stdlib for execution per tech-stack.md
- **Function Availability**: Custom functions (now, toLower, toUpper) from Story 1.11 must be available during execution
- **No External Data**: MVP templates receive no external data - data parameter is always nil
- **Performance**: Template execution should be efficient for typical template sizes (< 10KB)
- **Error Handling**: Use `internal/shared/errors` package for wrapping execution errors with context
- **Thread Safety**: Template execution is single-threaded for MVP but should be reentrant

### Security Considerations

- **Function Safety**: Custom template functions (now, toLower, toUpper) are pure functions with no side effects or external system access
- **No Command Execution**: Functions do not execute system commands or access external resources
- **Input Validation**: Template parsing in Story 1.10 already validates template syntax
- **Data Isolation**: No external data passed to templates prevents injection attacks
- **Review Status**: Functions reviewed and confirmed safe for template execution

### Performance Characteristics

- **Execution Time**: Template rendering completes in < 10ms for typical templates (< 10KB)
- **Memory Usage**: O(n) space complexity where n is template size, plus function execution overhead
- **Scalability**: Linear performance scaling with template size
- **Template Size Limits**: Maximum recommended template size is 100KB for MVP (configurable in future versions)

### Source References

- Template Engine: `docs/architecture/tech-stack.md#template-engine`
- Components: `docs/architecture/components.md#templateengine`
- Testing: `docs/architecture/testing-strategy.md#unit-tests`
- Data Models: `docs/architecture/data-models.md#template`

## Testing

### Unit Testing Requirements

- Test template execution with static content
- Test template execution with custom functions
- Test error handling for execution failures
- Test context cancellation support
- Verify no external data binding (nil data parameter)
- Include performance benchmarks for execution time
- Test template size limits and memory usage

### Integration Testing Requirements

- Test complete template pipeline from reading to execution
- Verify custom functions work in rendered output
- Test error propagation through command layer
- Test context cancellation in integration scenarios
- Confirm rendered content is ready for file writing
- Validate performance characteristics in end-to-end scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Initial story creation for generating rendered template content | BMad Master |
| 2025-01-19 | 1.1 | Added context.Context support, performance characteristics, template size limits, and security review | Scrum Master |

## Dev Agent Record

### Agent Model Used

BMad Master Task Executor

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Story Draft Checklist Validation

**Validation Date:** 2025-01-19  
**Validator:** BMad Master Task Executor  

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | Clear story purpose, epic relationship, and dependencies identified |
| 2. Technical Implementation Guidance | PASS   | Key files, technologies, and interfaces clearly specified |
| 3. Reference Effectiveness           | PASS   | Specific section references with context provided |
| 4. Self-Containment Assessment       | PASS   | Core technical details included, assumptions explicit |
| 5. Testing Guidance                  | PASS   | Testing approach and scenarios clearly outlined |

**Final Assessment:** READY  
The story provides sufficient context for implementation with clear technical guidance and proper references to architecture documents.