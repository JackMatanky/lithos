# Story 1.6: Logger Package

## Status

Draft

## Story

**As a** developer,
**I want** to implement structured logging with zerolog,
**so that** the application has consistent, structured logging across all components with configurable output formats.

## Acceptance Criteria

- 1.6.1: Add `github.com/rs/zerolog` v1.34.0 to `go.mod`

- 1.6.2: Create `internal/shared/logger/logger.go`:
  - Global `Log zerolog.Logger` instance
  - `New(output io.Writer, level string) zerolog.Logger` - creates configured logger
  - TTY detection via `golang.org/x/term` - pretty-print for terminals, JSON for pipes
  - Level parsing: "debug", "info", "warn", "error" (case-insensitive)

- 1.6.3: Context methods:
  - `WithComponent(logger zerolog.Logger, component string) zerolog.Logger`
  - `WithOperation(logger zerolog.Logger, operation string) zerolog.Logger`
  - `WithCorrelationID(logger zerolog.Logger, id string) zerolog.Logger`

- 1.6.4: Sensitive data filtering:
  - Filter password, token, apiKey fields from logs
  - Redact with "[REDACTED]" string

- 1.6.5: Test helper:
  - `NewTest() zerolog.Logger` - returns logger with ioutil.Discard for testing

- 1.6.6: Create unit tests in `internal/shared/logger/logger_test.go`:
  - Test: Log level configuration works
  - Test: TTY detection switches output format
  - Test: Context methods add fields correctly
  - Test: Sensitive data filtering works

- 1.6.7: All tests pass: `go test ./internal/shared/logger`

- 1.6.8: All linting passes: `golangci-lint run --fix internal/shared/logger`

- 1.6.9: Committed with message: `feat(shared): implement logger package with zerolog`

## Tasks / Subtasks

- [ ] Task 1: Add zerolog dependency (AC: 1.6.1)
  - [ ] Run `go get github.com/rs/zerolog@v1.34.0`
  - [ ] Run `go get golang.org/x/term@v0.25.0` (TTY detection)
  - [ ] Verify dependencies in go.mod

- [ ] Task 2: Implement logger constructor and TTY detection (AC: 1.6.2)
  - [ ] RED: Write failing test for New() constructor
  - [ ] GREEN: Implement New() with level parsing
  - [ ] REFACTOR: Add TTY detection using x/term
  - [ ] RED: Write test for pretty-print vs JSON mode
  - [ ] GREEN: Implement ConsoleWriter for TTY, JSON for pipes
  - [ ] REFACTOR: Extract level parsing to helper function

- [ ] Task 3: Implement context methods (AC: 1.6.3)
  - [ ] RED: Write failing test for WithComponent()
  - [ ] GREEN: Implement WithComponent() adding component field
  - [ ] REFACTOR: Ensure context methods are chainable
  - [ ] RED: Write failing test for WithOperation()
  - [ ] GREEN: Implement WithOperation() adding operation field
  - [ ] REFACTOR: Document method chaining pattern
  - [ ] RED: Write failing test for WithCorrelationID()
  - [ ] GREEN: Implement WithCorrelationID() adding id field
  - [ ] REFACTOR: Add examples in documentation

- [ ] Task 4: Implement sensitive data filtering (AC: 1.6.4)
  - [ ] RED: Write failing test for password redaction
  - [ ] GREEN: Implement field filter for password
  - [ ] REFACTOR: Add token and apiKey to filter list
  - [ ] RED: Write test for multiple sensitive fields
  - [ ] GREEN: Verify all sensitive fields redacted
  - [ ] REFACTOR: Use zerolog.Hook for filtering

- [ ] Task 5: Implement test helper (AC: 1.6.5)
  - [ ] RED: Write test verifying NewTest() produces no output
  - [ ] GREEN: Implement NewTest() with ioutil.Discard
  - [ ] REFACTOR: Document test helper usage

- [ ] Task 6: Complete test coverage (AC: 1.6.6)
  - [ ] Test log level parsing (all levels)
  - [ ] Test TTY detection behavior
  - [ ] Test context method chaining
  - [ ] Test sensitive data redaction
  - [ ] Test invalid log level handling (fallback to info)

- [ ] Task 7: Verify tests and linting (AC: 1.6.7-1.6.8)
  - [ ] Run `go test ./internal/shared/logger` - verify all pass
  - [ ] Run `golangci-lint run --fix internal/shared/logger` - verify no warnings
  - [ ] Review test coverage for completeness

- [ ] Task 8: Commit changes (AC: 1.6.9)
  - [ ] Stage logger package files
  - [ ] Commit with message: `feat(shared): implement logger package with zerolog`

## Dev Notes

### Logger Package Architecture

From `docs/architecture/components.md#shared-internal-packages`:

**Logger Responsibility:** Centralized structured logging wrapper around zerolog. Provides consistent log formatting across all components. Supports both JSON (machine-readable) and pretty-print (human-readable) output modes. Filters sensitive data and provides context-aware logging.

**Architecture Layer:** Shared Internal Package (Cross-Cutting Concern). Used by all layers. Not domain logic or infrastructureâ€”pure technical concern. Centralized to enforce consistent logging patterns.

**Key Interfaces:**
- `Log zerolog.Logger` - Global logger instance
- `WithComponent(component string) zerolog.Logger` - Add component context
- `WithOperation(operation string) zerolog.Logger` - Add operation context
- `WithCorrelationID(id string) zerolog.Logger` - Add correlation ID

**Dependencies:**
- ConfigPort - For log level configuration
- `golang.org/x/term` - For TTY detection (pretty-print vs JSON)

[Source: docs/architecture/components.md#logger]

From `docs/architecture/tech-stack.md`:

**Logging:** `github.com/rs/zerolog` v1.34.0
- High-performance zero-allocation JSON logger with CLI-friendly pretty-print mode
- PRD explicitly specifies
- Supports both machine-readable (JSON) and human-readable (colorized) output
- Latest release Mar 2025

[Source: docs/architecture/tech-stack.md]

From `docs/architecture/coding-standards.md`:

- Shared logging (`internal/shared/logger`) **MUST** be the only logging facility; no `fmt.Print*` or `log.*`.

[Source: docs/architecture/coding-standards.md]

### Logger Implementation Patterns

**TTY Detection Pattern:**
```go
import (
    "os"
    "github.com/rs/zerolog"
    "golang.org/x/term"
)

func New(output io.Writer, level string) zerolog.Logger {
    logLevel := parseLevel(level)

    // Detect if output is a TTY
    if f, ok := output.(*os.File); ok && term.IsTerminal(int(f.Fd())) {
        // Pretty-print for terminals
        output = zerolog.ConsoleWriter{
            Out:        output,
            TimeFormat: "15:04:05",
        }
    }
    // else: JSON format for pipes/files

    return zerolog.New(output).
        Level(logLevel).
        With().
        Timestamp().
        Logger()
}
```

**Level Parsing Pattern:**
```go
func parseLevel(level string) zerolog.Level {
    switch strings.ToLower(level) {
    case "debug":
        return zerolog.DebugLevel
    case "info":
        return zerolog.InfoLevel
    case "warn", "warning":
        return zerolog.WarnLevel
    case "error":
        return zerolog.ErrorLevel
    default:
        return zerolog.InfoLevel // Fallback
    }
}
```

**Context Methods Pattern:**
```go
func WithComponent(logger zerolog.Logger, component string) zerolog.Logger {
    return logger.With().Str("component", component).Logger()
}

func WithOperation(logger zerolog.Logger, operation string) zerolog.Logger {
    return logger.With().Str("operation", operation).Logger()
}

func WithCorrelationID(logger zerolog.Logger, id string) zerolog.Logger {
    return logger.With().Str("correlation_id", id).Logger()
}
```

**Sensitive Data Filtering Pattern:**
```go
type SensitiveFieldHook struct{}

func (h SensitiveFieldHook) Run(e *zerolog.Event, level zerolog.Level, msg string) {
    // Hook into zerolog to redact sensitive fields
    // Redact: password, token, apiKey
}
```

**Test Helper Pattern:**
```go
import "io/ioutil"

func NewTest() zerolog.Logger {
    return zerolog.New(ioutil.Discard).Level(zerolog.Disabled)
}
```

### Testing Standards

From `docs/architecture/testing-strategy.md`:

- Unit tests live beside code (`*_test.go`)
- Use table-driven tests for log level parsing
- Test TTY detection behavior
- Verify context methods produce correct output
- Test sensitive data redaction
- Ensure test helper produces no output

### File Locations

- Logger: `internal/shared/logger/logger.go`
- Tests: `internal/shared/logger/logger_test.go`

### Implementation Notes

**Key Requirements:**

1. **Structured Logging:** All logs as JSON (machine-readable) or pretty-print (human-readable)
2. **TTY Detection:** Automatic format switching based on output destination
3. **Level Configuration:** Support debug/info/warn/error levels, case-insensitive
4. **Context Enrichment:** Methods to add component/operation/correlation fields
5. **Sensitive Data:** Redact password/token/apiKey fields automatically
6. **Test Support:** NewTest() helper for silent logging in tests

**Output Modes:**
- **TTY (terminal):** Colorized, human-readable format with timestamps
- **Non-TTY (pipes, files):** JSON format for log aggregation/parsing

**Log Levels:**
- **debug:** Detailed diagnostic information
- **info:** General informational messages (default)
- **warn:** Warning messages for potential issues
- **error:** Error conditions requiring attention

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
