# Story 2.5: Implement Basic Schema Registry Service

## Status

Approved

## Story

As a developer, I want to implement the basic SchemaRegistry domain service, so that schema loading and registry management follow the architectural patterns.

## Acceptance Criteria

**Functional Requirements:**

2.5.1: `internal/app/schema/` contains SchemaRegistry implementing the interface from `docs/architecture/components.md#domain-services`.
2.5.2: Service loads schemas via SchemaEnginePort per `docs/architecture/components.md#schemaengineport`.
2.5.3: Service uses Registry package for thread-safe schema storage per `docs/architecture/components.md#shared-internal-packages`.
2.5.4: SchemaRegistry provides Get(name string) method for retrieving schemas by name with proper error handling.
2.5.5: Service integrates with ConfigPort to access schema directory configuration.

**Integration Requirements:**

2.5.6: SchemaRegistry follows domain service patterns with proper dependency injection.
2.5.7: Service implements Result[T] pattern for error handling.
2.5.8: Service supports context cancellation for loading operations.

**Quality Requirements:**

2.5.9: Unit tests cover SchemaRegistry behavior with mocked dependencies.
2.5.10: Code follows project coding standards and naming conventions.
2.5.11: Service includes proper error handling and logging.

## Tasks / Subtasks

- [ ] Task 1: Define SchemaRegistry interface and service (AC: 2.5.1, 2.5.6)
  - [ ] Create `internal/app/schema/registry.go` with SchemaRegistry service struct
  - [ ] Define interface for SchemaRegistry if needed for dependency injection
  - [ ] Implement constructor accepting SchemaEnginePort and ConfigPort dependencies
  - [ ] Follow domain service patterns with proper encapsulation

- [ ] Task 2: Implement schema loading functionality (AC: 2.5.2, 2.5.5, 2.5.8)
  - [ ] Implement LoadSchemas method using SchemaEnginePort
  - [ ] Integrate with ConfigPort to access schema directory configuration
  - [ ] Add context cancellation support for loading operations
  - [ ] Handle schema loading errors with proper error wrapping

- [ ] Task 3: Implement thread-safe schema storage (AC: 2.5.3, 2.5.4)
  - [ ] Use Registry package for thread-safe schema storage
  - [ ] Implement Get(name string) method for schema retrieval
  - [ ] Add proper error handling for missing schemas
  - [ ] Ensure concurrent access safety for all registry operations

- [ ] Task 4: Implement Result pattern and error handling (AC: 2.5.7, 2.5.11)
  - [ ] Use Result[T] pattern from `internal/shared/errors` for all public methods
  - [ ] Implement structured error handling with proper error wrapping
  - [ ] Add logging using `internal/shared/logger` for service operations
  - [ ] Handle all error conditions with appropriate error types

- [ ] Task 5: Add comprehensive testing (AC: 2.5.9, 2.5.10)
  - [ ] Create `internal/app/schema/registry_test.go` with unit tests
  - [ ] Add tests with mocked SchemaEnginePort and ConfigPort dependencies
  - [ ] Test schema loading, storage, retrieval, and error conditions
  - [ ] Add tests for context cancellation and concurrent access
  - [ ] Ensure test coverage meets project standards (â‰¥85% for app layer)

## Dev Notes

**Previous Story Insights:**
- Stories 2.1-2.4 will implement Config, Schema/Property models, and SchemaEnginePort providing foundation
- This story builds on Registry package and error handling patterns from Epic 1
- Hexagonal architecture patterns established provide guidance for domain service implementation

**Data Models:**
- SchemaRegistry service defined in `docs/architecture/components.md#schemaregistryservice`
- Uses Schema and Property models from domain layer
- Registry package provides thread-safe storage with CQRS-aware interfaces

**API Specifications:**
- SchemaRegistry interface with Load() and Get() methods
- Result[T] pattern for functional error handling
- Context support for cancellation and timeout handling

**Component Specifications:**
- SchemaRegistry located in `internal/app/schema/registry.go`
- Follows domain service patterns with dependency injection
- Uses ports for infrastructure concerns (SchemaEnginePort, ConfigPort)

**File Locations:**
- Service implementation: `internal/app/schema/registry.go` (create new)
- Tests: `internal/app/schema/registry_test.go` (create new)
- Interface: `internal/ports/api/schema.go` (create if needed)

**Testing Requirements:**
- Unit tests for SchemaRegistry with mocked dependencies
- Tests for schema loading, storage, retrieval operations
- Error handling tests for various failure scenarios
- Context cancellation and concurrent access tests

**Technical Constraints:**
- Follow domain service principles: business logic in application layer
- Use dependency injection for SchemaEnginePort and ConfigPort
- Use Result[T] pattern from shared errors package
- Support context cancellation for all I/O operations
- Use Registry package for thread-safe storage

**Source References:**
- [Architecture: docs/architecture/components.md#schemaregistryservice]
- [Architecture: docs/architecture/components.md#shared-internal-packages]
- [Architecture: docs/architecture/coding-standards.md#error-handling]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]
- [Architecture: docs/architecture/source-tree.md]

### Context Source

- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: Domain service implementation for schema registry management
- **Integration Points**: SchemaRegistry used by SchemaValidator for validation, loads schemas via SchemaEnginePort
- **Goal**: Establish core domain service for schema loading and thread-safe registry management

### Technical Guidance

#### Existing System Context

- **Current State**: SchemaEnginePort and Registry package exist, Config model provides configuration
- **Technology Stack**: Go 1.23+ with domain service patterns from hexagonal architecture
- **Integration Points**: SchemaRegistry loads via SchemaEnginePort, stores in Registry, accessed by SchemaValidator
- **Architecture Pattern**: Domain service in application layer using ports for infrastructure

#### Integration Approach

- **Domain Service**: Implement as pure business logic service in application layer
- **Dependency Injection**: Accept SchemaEnginePort and ConfigPort via constructor
- **Thread Safety**: Use Registry package for thread-safe schema storage
- **Error Handling**: Follow project Result[T] patterns for functional error handling

#### Technical Constraints

- **Application Layer**: SchemaRegistry belongs in `internal/app/schema/` as domain service
- **Result Pattern**: Use `internal/shared/errors` Result[T] for error handling
- **Context Support**: All public methods must accept context.Context for cancellation
- **Thread Safety**: Use Registry package for concurrent access safety

#### Key Files to Modify/Create

- `internal/app/schema/registry.go` - **CREATE** - SchemaRegistry service implementation
- `internal/app/schema/registry_test.go` - **CREATE** - Unit tests for SchemaRegistry
- `internal/ports/api/schema.go` - **CREATE** - SchemaRegistry interface definition (if needed)

#### Testing Strategy

- **Unit Tests**: Test SchemaRegistry with mocked SchemaEnginePort and ConfigPort
- **Integration Tests**: Test schema loading and registry operations
- **Error Tests**: Test error handling and context cancellation

### Definition of Done

- [ ] SchemaRegistry service implemented in `internal/app/schema/` following domain service patterns
- [ ] Service loads schemas via SchemaEnginePort with ConfigPort integration
- [ ] Registry package used for thread-safe schema storage
- [ ] Get(name string) method provides schema retrieval with proper error handling
- [ ] Result[T] pattern implemented for functional error handling
- [ ] Context cancellation supported for loading operations
- [ ] Unit tests pass with adequate coverage for all functionality
- [ ] Code follows project coding standards and naming conventions
- [ ] Proper error handling and logging implemented

### Risk Assessment

#### Implementation Risks

- **Primary Risk**: Thread safety issues in schema registry access patterns
- **Mitigation**: Use proven Registry package with comprehensive unit tests
- **Verification**: Test concurrent access scenarios thoroughly

#### Rollback Plan

- **Git Rollback**: Revert to previous commit if registry service fails
- **File Removal**: Delete new schema registry files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

## Testing

### Testing Strategy

- **Unit Tests**: Test SchemaRegistry with mocked SchemaEnginePort and ConfigPort
- **Integration Tests**: Test schema loading and registry operations
- **Error Tests**: Test error handling and context cancellation

### Testing Standards

- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use mocked dependencies for isolated unit testing
- Test both success and failure cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft for Schema Registry service implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- SchemaRegistry service patterns from components.md
- Domain service implementation patterns from hexagonal architecture
- Registry package usage from shared internal packages

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- SchemaRegistry service requirements extracted from components.md
- Domain service patterns and dependency injection requirements included
- Testing strategy aligned with project standards

### File List

**Files to Create/Modify:**
- `internal/app/schema/registry.go` - SchemaRegistry service implementation
- `internal/app/schema/registry_test.go` - Unit tests for SchemaRegistry
- `internal/ports/api/schema.go` - SchemaRegistry interface (if needed)

## QA Results

*This section will be populated by the QA Agent during review of the completed story implementation*
