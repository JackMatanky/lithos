# Story 2.5: Implement Basic Schema Registry Service

## Status

In Progress

## Story

As a developer, I want to implement the SchemaRegistryAdapter as an SPI adapter, so that schema loading and registry management follow the hexagonal architectural patterns.

## Acceptance Criteria

**Functional Requirements:**

2.5.1: `internal/ports/spi/schema.go` extended with `SchemaRegistryPort` defining registry operations per `docs/architecture/components.md#schemaregistryadapter`.
2.5.2: SchemaRegistryAdapter loads schemas via SchemaLoaderPort per `docs/architecture/components.md#schemaloaderport`.
2.5.3: Adapter uses Registry package for thread-safe schema storage per `docs/architecture/components.md#shared-internal-packages`.
2.5.4: SchemaRegistryAdapter provides GetSchema(name string) method for retrieving schemas by name with proper error handling.
2.5.5: Adapter integrates with ConfigPort to access schema directory configuration.

**Integration Requirements:**

2.5.6: SchemaRegistryAdapter follows SPI adapter patterns with proper dependency injection.
2.5.7: Adapter implements Result[T] pattern for error handling.
2.5.8: Adapter supports context cancellation for loading operations.

**Quality Requirements:**

2.5.9: Unit tests cover SchemaRegistryAdapter behavior with mocked dependencies.
2.5.10: Code follows project coding standards and naming conventions.
2.5.11: Adapter includes proper error handling and logging.

## Tasks / Subtasks

 - [ ] Task 1: Extend SchemaRegistryPort in existing schema port (AC: 2.5.1, 2.5.6)
  - [ ] Extend `internal/ports/spi/schema.go` with `SchemaRegistryPort` interface exposing `GetSchema(name string) (Schema, bool)`
  - [ ] Reference existing domain `Schema` and `PropertyBank` types without introducing new DTOs
  - [ ] Ensure the port depends only on domain models and shared error/result packages
  - [ ] Follow existing port patterns in the schema.go file

 - [ ] Task 2: Implement SchemaRegistryAdapter (AC: 2.5.2, 2.5.3, 2.5.5, 2.5.8)
  - [ ] Create `internal/adapters/spi/schema/registry.go` implementing `SchemaRegistryPort` using existing loader and config ports
  - [ ] Reuse `internal/shared/registry` for storage rather than inventing new synchronization primitives
  - [ ] Integrate with the existing SchemaLoader adapter to populate schemas during startup
  - [ ] Support context cancellation for initial loading operations
  - [ ] Follow established SPI adapter patterns per components.md specification

 - [ ] Task 3: Wire SchemaRegistryAdapter via interface injection (AC: 2.5.4, 2.5.6)
  - [ ] Update SchemaValidator constructor to accept SchemaRegistryPort interface parameter
  - [ ] Pass SchemaRegistryAdapter instance to SchemaValidator when creating it
  - [ ] Ensure SchemaValidator imports only `internal/ports/spi/schema.go`, never adapter packages
  - [ ] Update any other services that need schema registry access to use the interface
  - [ ] Verify no import statements reference adapter packages from domain/application layers

 - [ ] Task 4: Update error handling and logging (AC: 2.5.7, 2.5.11)
  - [ ] Replace custom registry error types with `internal/shared/errors.SchemaError` usage
  - [ ] Maintain structured logging via `internal/shared/logger` within the adapter
  - [ ] Ensure Result-pattern usage remains consistent for operations crossing package boundaries

 - [ ] Task 5: Implement comprehensive adapter tests (AC: 2.5.9, 2.5.10)
  - [ ] Create unit tests in `internal/adapters/spi/schema/registry_test.go` targeting the SchemaRegistryAdapter
  - [ ] Use existing test doubles from `tests/utils` and schema test helpers where valuable
  - [ ] Cover success, failure, and concurrency scenarios leveraging the shared registry package
  - [ ] Verify proper error handling and Result-pattern propagation
  - [ ] Test adapter initialization and dependency injection patterns

 - [ ] Task 6: Verify hexagonal architecture boundaries (AC: 2.5.6)
  - [ ] Audit import statements in domain/application layers to ensure no adapter package imports
  - [ ] Verify SchemaValidator and other domain services only import `internal/ports/spi/schema.go`
  - [ ] Confirm dependency injection properly isolates adapter implementation from service consumers
  - [ ] Run `go mod graph` or similar to validate import dependency direction

 - [ ] Task 7: Adjust documentation and story references
  - [ ] Update architecture references and diagrams if they assumed an app-layer service
  - [ ] Align story documentation to reflect the SPI placement and lean implementation approach

 - [ ] Task 8: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass

- [ ] Task 9: Pre-commit and commit readiness
  - [ ] Execute `pre-commit` to confirm hooks pass
  - [ ] Stage updates and commit with a full conventional commit message summarizing registry adapter changes

## Dev Notes

**Previous Story Insights:**

- Stories 2.1-2.4 will implement Config, Schema/Property models, and SchemaLoaderPort providing foundation
- This story builds on Registry package and error handling patterns from Epic 1
- Hexagonal architecture patterns established provide guidance for domain service implementation

**Data Models:**

- SchemaRegistryAdapter defined in `docs/architecture/components.md#schemaregistryadapter`
- Uses Schema and Property models from domain layer
- Registry package provides thread-safe storage with CQRS-aware interfaces

**Port Specifications:**

- `SchemaRegistryPort` exposes `GetSchema(name string) (Schema, bool)` following components.md specification
- The port surface area is intentionally minimal and reuses domain models
- Port extends existing `internal/ports/spi/schema.go` for better organization

**Component Specifications:**

- SchemaRegistryAdapter SPI adapter located in `internal/adapters/spi/schema/registry.go`
- Port exposed via `internal/ports/spi/schema.go` and wired into application/services composition roots
- Uses ports for infrastructure concerns (SchemaLoaderPort, ConfigPort)

**File Locations:**

- Port definition: `internal/ports/spi/schema.go` (extend existing)
- Adapter implementation: `internal/adapters/spi/schema/registry.go` (create new)
- Tests: `internal/adapters/spi/schema/registry_test.go` (create new)

**Testing Requirements:**

- Unit tests for the SchemaRegistryAdapter with mocked dependencies (SchemaLoaderPort, ConfigPort)
- Tests for schema storage and retrieval operations leveraging the shared registry package
- Error handling tests for various failure scenarios, including loader failures and missing schemas
- Concurrent access tests to verify thread-safe registry operations

**Technical Constraints:**

- Follow hexagonal architecture by implementing SchemaRegistryAdapter as SPI adapter per components.md
- Use dependency injection for SchemaLoaderPort and ConfigPort dependencies
- Use Registry package for thread-safe storage as specified in shared internal packages
- Extend existing `internal/ports/spi/schema.go` rather than creating new port file
- Follow established SPI adapter patterns for consistency

**Source References:**

- [Architecture: docs/architecture/components.md#schemaregistryadapter]
- [Architecture: docs/architecture/components.md#shared-internal-packages]
- [Architecture: docs/architecture/coding-standards.md#error-handling]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]
- [Architecture: docs/architecture/source-tree.md]

### Context Source

- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: SPI adapter implementation for schema registry management
- **Integration Points**: SchemaRegistryAdapter used by SchemaValidator for validation, loads schemas via SchemaLoaderPort
- **Goal**: Establish SPI adapter for schema loading and thread-safe registry management following hexagonal architecture

### Technical Guidance

#### Existing System Context

- **Current State**: SchemaLoaderPort and Registry package exist, Config model provides configuration
- **Technology Stack**: Go 1.23+ with SPI adapter patterns from hexagonal architecture
- **Integration Points**: SchemaRegistryAdapter loads via SchemaLoaderPort, stores in Registry, accessed by SchemaValidator through the port
- **Architecture Pattern**: Hexagonal architecture with driven SPI adapters providing infrastructure functionality

#### Integration Approach

- **SPI Adapter**: Implement registry coordination as a driven adapter in `internal/adapters/spi/schema`
- **Interface Injection**:
  - SchemaValidator and other services accept SchemaRegistryPort interface parameter in constructor
  - SchemaRegistryAdapter instance passed to services when they're created
  - Domain services receive SchemaRegistryPort interface, never importing adapter packages
  - Simple interface injection maintains hexagonal architecture boundaries
- **Thread Safety**: Use the existing `internal/shared/registry` package for concurrent-safe storage
- **Error Handling**: Follow project Result[T] patterns and propagate `errors.SchemaError` for external visibility

#### Technical Constraints

- **Ports Layer**: Registry functionality must be exposed via extending `internal/ports/spi/schema.go`
- **Adapter Isolation**: Application services obtain the registry through the port, never by importing adapter packages directly
- **Interface Injection**: Services accept SchemaRegistryPort interface parameter, adapter instance passed when creating services
- **Import Boundaries**: Domain/application layers import only `internal/ports/spi/schema.go`, never `internal/adapters/spi/schema/*`
- **Registry Pattern**: Use `internal/shared/registry` package for thread-safe storage per architecture specification
- **SPI Adapter Pattern**: Follow established patterns for SPI adapters per components.md

#### Key Files to Modify/Create

- `internal/ports/spi/schema.go` - **EXTEND** - Add SchemaRegistryPort interface to existing file
- `internal/adapters/spi/schema/registry.go` - **CREATE** - SchemaRegistryAdapter implementation
- `internal/adapters/spi/schema/registry_test.go` - **CREATE** - Unit tests for adapter
- Domain services (e.g., SchemaValidator) - **UPDATE** - Accept SchemaRegistryPort interface parameter in constructor

#### Testing Strategy

- **Unit Tests**: Target the SchemaRegistryAdapter with mocked SchemaLoaderPort and ConfigPort dependencies
- **Integration Tests**: Optionally exercise adapter wiring alongside SchemaValidator once the port is in place
- **Error Tests**: Validate error propagation and missing schema lookups using shared test utilities
- **Concurrency Tests**: Verify thread-safe access patterns using the Registry package

### Definition of Done

- [ ] SchemaRegistryPort extended in `internal/ports/spi/schema.go` following hexagonal architecture
- [ ] SchemaRegistryAdapter implements the port in `internal/adapters/spi/schema/` using existing loader/config dependencies
- [ ] Adapter reuses `internal/shared/registry` for thread-safe schema storage with concurrent access safety
- [ ] `GetSchema(name string)` returns schemas with existence flag per components.md specification
- [ ] Domain services updated to accept SchemaRegistryPort interface parameter in constructors
- [ ] SchemaRegistryAdapter instance passed to services when they're created (simple interface injection)
- [ ] Import boundaries verified: no `internal/adapters/spi/schema` imports in domain/application layers
- [ ] Adapter consumes domain Schema and PropertyBank objects without JSON parsing
- [ ] Unit tests cover adapter behavior with mocked dependencies and concurrent access
- [ ] Code follows project coding standards and naming conventions
- [ ] Proper error handling and logging implemented with shared error helpers
- [ ] Port extension maintains consistency with existing schema.go patterns
- [ ] Adapter follows established SPI adapter patterns from architecture

### Risk Assessment

#### Implementation Risks

- **Primary Risk**: Thread safety issues in schema registry access patterns
- **Mitigation**: Use proven Registry package with comprehensive unit tests
- **Verification**: Test concurrent access scenarios thoroughly

#### Rollback Plan

- **Git Rollback**: Revert to previous commit if registry service fails
- **File Removal**: Delete new schema registry files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

## Testing

### Testing Strategy

- **Unit Tests**: Test SchemaRegistry with mocked SchemaLoaderPort and ConfigPort
- **Integration Tests**: Test schema loading and registry operations
- **Error Tests**: Test error handling and context cancellation

### Testing Standards

- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use mocked dependencies for isolated unit testing
- Test both success and failure cases

## Change Log

| Date       | Version | Description                                                    | Author |
| ---------- | ------- | -------------------------------------------------------------- | ------ |
| 2025-10-21 | 1.3     | Aligned story with current architecture - SPI adapter pattern, extend existing schema.go port | po     |
| 2025-10-21 | 1.2     | Re-scoped story to SPI adapter implementation with new tasks  | dev    |
| 2025-10-21 | 1.1     | Implemented SchemaRegistry service, tests, and linting updates | dev    |
| 2025-10-20 | 1.0     | Initial story draft for Schema Registry service implementation | sm     |

## Dev Agent Record

### Agent Model Used

dev (Full Stack Developer)

### Debug Log References

- Re-evaluated architecture to move SchemaRegistry behind an SPI port per technical preferences
- Captured refactor plan to reuse existing loader adapter and shared registry storage
- Documented need to replace custom registry errors with `errors.SchemaError`

### Completion Notes List

- Prior implementation lives in `internal/app/schema`; refactor tasks will migrate logic to SPI adapter
- Decision recorded to keep implementation lean and reuse existing packages/utilities
- Awaiting execution of new tasks before re-running lint/test workflow for final validation

### File List

**Files To Update/Create:**

- `internal/ports/spi/schema.go` (extend with SchemaRegistryPort)
- `internal/adapters/spi/schema/registry.go` (create SchemaRegistryAdapter)
- `internal/adapters/spi/schema/registry_test.go` (create adapter tests)

## QA Results

### Architecture Alignment Validation - October 21, 2025

**Reviewed By**: Sarah (Product Owner)

**Status**: Story updated and aligned with current architecture

**Critical Issues Resolved:**

✅ **Architecture Pattern Alignment**: Updated story from domain service to SPI adapter implementation per components.md
✅ **File Organization**: Corrected to extend existing `internal/ports/spi/schema.go` instead of creating new port file
✅ **Component Specification**: Aligned with SchemaRegistryAdapter specification from components.md
✅ **Acceptance Criteria**: Rewritten to reflect SPI adapter patterns and hexagonal architecture
✅ **Task Structure**: Updated tasks to follow established SPI adapter implementation patterns

**Key Changes Made:**

- Story description updated to specify SchemaRegistryAdapter implementation
- All acceptance criteria updated to reference SPI adapter rather than domain service
- File paths corrected to extend existing schema.go port file (Option A selected)
- Dev Notes updated to reflect current architecture specifications
- Tasks rewritten to follow SPI adapter patterns per components.md

**Architecture Compliance:**

- ✅ Follows hexagonal architecture with SPI adapter in correct layer
- ✅ Uses established dependency injection patterns
- ✅ Extends existing port file for better organization
- ✅ References correct architecture components and specifications
- ✅ Aligns with Registry package usage patterns

**Implementation Readiness**: ✅ **READY FOR IMPLEMENTATION** - Story aligned with architecture, dependencies resolved

**Dependency Status**: ✅ **RESOLVED** - Stories 2.3 and 2.4 completed, providing required domain objects and SchemaLoaderPort

**Architectural Integrity**: ✅ **VERIFIED** - Dependency injection patterns ensure proper layer isolation per hexagonal architecture

### Pre-Implementation Review (Historical)

**Status**: ~~Story needs completion and dependency resolution before implementation~~ **RESOLVED**

**Key Issues Identified:**

- ~~Story dependencies: Requires completion of Stories 2.3 and 2.4 for domain objects and SchemaLoaderPort~~ ✅ **RESOLVED**
- Tasks need to be completed sequentially before story can be approved
- ~~Need clearer specification of Registry package integration patterns~~ ✅ **CLARIFIED**
- ~~Thread-safety requirements need more detailed implementation guidance~~ ✅ **DETAILED**

**Critical Dependencies:**

- ~~Story 2.3: Property domain models for PropertyBank handling~~ ✅ **COMPLETED**
- ~~Story 2.4: SchemaLoaderPort implementation for schema loading~~ ✅ **COMPLETED**

**Updated Recommendations:**

- ✅ Stories 2.3 and 2.4 are completed - proceed with implementation
- Complete Task 1-5 sequentially with focus on thread-safety patterns
- Ensure proper dependency injection maintains layer isolation
- Add comprehensive concurrent access testing scenarios
