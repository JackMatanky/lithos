# Story 4.3: FinderPort & Fuzzy Adapter

## Status

Draft

## Story

**As a** developer,
**I want** FinderPort and its fuzzy finder adapter,
**so that** the CLI can provide interactive template selection with a fzf-like experience.

## Acceptance Criteria

**FinderPort Interface:**

- 4.3.1: Create `internal/ports/spi/finder.go` declaring `FinderPort` interface with:
  - `Find(ctx context.Context, items []FinderItem) (FinderItem, error)` - Fuzzy finder for item selection
  - GoDoc comments referencing FR10 in `docs/prd/requirements.md`
  - Generic enough to support templates and future use cases

- 4.3.2: Define `FinderItem` interface with methods:
  - `DisplayName() string` - Primary text shown in finder
  - `PreviewText() string` - Optional preview/description text
  - Methods allow any type to be used with finder

- 4.3.3: Document error handling expectations in GoDoc:
  - `InteractiveError` returned when TTY unavailable
  - `CancellationError` returned when user cancels (Ctrl+C)
  - Error messages must include remediation guidance
  - Reference `docs/architecture/error-handling-strategy.md`

**FuzzyfindAdapter Implementation:**

- 4.3.4: Create `internal/adapters/spi/interactive/fuzzyfind.go` implementing `FinderPort` with:
  - `NewFuzzyfindAdapter(log Logger) *FuzzyfindAdapter` constructor
  - `Find(ctx context.Context, items []FinderItem) (FinderItem, error)` method
  - Implementation matches `docs/architecture/components.md#fuzzyfindadapter` exactly

- 4.3.5: Find() method implementation:
  - Uses `github.com/ktr0731/go-fuzzyfinder` v0.8.0 for fuzzy finding
  - Displays items with `DisplayName()` as primary text
  - Shows `PreviewText()` in preview pane if available
  - Returns selected item
  - Handles cancellation (Ctrl+C) gracefully

**Non-Interactive Mode:**

- 4.3.6: Detect non-TTY environments using `golang.org/x/term.IsTerminal()`:
  - Check before launching finder
  - Return `InteractiveError` with remediation guidance
  - Error message format: "Interactive finder unavailable: not a TTY. Provide item explicitly as argument"
  - No fallback selection (user must specify item explicitly)

**Error Handling:**

- 4.3.7: Implement error handling per `docs/architecture/error-handling-strategy.md`:
  - Wrap go-fuzzyfinder errors with context
  - Return `InteractiveError` for TTY issues
  - Return `CancellationError` for user cancellation
  - Include remediation guidance in all error messages
  - Distinguish between cancellation (not an error) and failure (actual error)

**Logging:**

- 4.3.8: Follow coding standards for logging:
  - Debug level: Log item count, search state
  - Info level: Log finder start/end
  - Warn level: Log non-TTY detection
  - Error level: Log unexpected failures

**Unit Tests:**

- 4.3.9: Create `internal/adapters/spi/interactive/fuzzyfind_test.go` with tests for:
  - Successful item selection
  - Preview text display
  - Cancellation handling (simulated Ctrl+C)
  - Non-TTY error when unavailable
  - Empty items list handling
  - Single item auto-selection (optional UX improvement)

**Quality Gates:**

- 4.3.10: Run `golangci-lint run ./internal/ports/spi` - all checks pass

- 4.3.11: Run `golangci-lint run ./internal/adapters/spi/interactive` - all checks pass

- 4.3.12: Run `go test ./internal/adapters/spi/interactive` - all tests pass with >80% coverage

- 4.3.13: Verify adapter satisfies FinderPort interface at compile time

- 4.3.14: Verify port interface follows ISP (segregated from PromptPort)

- 4.3.15: Committed with message: `feat: add FinderPort and FuzzyfindAdapter for interactive selection`

## Tasks / Subtasks

- [ ] Task 1: Design FinderPort interface (AC: 4.3.1-4.3.3)
  - [ ] RED: Write failing test for FinderPort interface contract
    - [ ] Create test verifying interface method signatures
    - [ ] Create mock implementing FinderPort
    - [ ] Verify compilation fails without interface definition
  - [ ] GREEN: Define FinderPort interface
    - [ ] Create `internal/ports/spi/finder.go`
    - [ ] Define `FinderPort` interface with Find method
    - [ ] Define `FinderItem` interface with display methods
    - [ ] Verify test compilation passes
  - [ ] REFACTOR: Add comprehensive GoDoc
    - [ ] Add package comment explaining SPI ports
    - [ ] Add GoDoc for FinderPort referencing FR10
    - [ ] Add GoDoc for FinderItem explaining interface pattern
    - [ ] Document error handling expectations
    - [ ] Verify ISP segregation from PromptPort
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/ports/spi`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 2: TDD - Implement FuzzyfindAdapter (AC: 4.3.4-4.3.6, 4.3.9)
  - [ ] RED: Write failing test for successful item selection
    - [ ] Create test file `internal/adapters/spi/interactive/fuzzyfind_test.go`
    - [ ] Write test case for Find() with mock items
    - [ ] Verify test fails with "undefined: FuzzyfindAdapter"
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure
  - [ ] RED: Write failing test for preview text display
    - [ ] Write test verifying PreviewText() is shown
    - [ ] Run tests and confirm failure
  - [ ] RED: Write failing test for cancellation handling
    - [ ] Write test simulating Ctrl+C (fuzzyfinder.ErrAbort)
    - [ ] Verify CancellationError returned
    - [ ] Run tests and confirm failure
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Create `internal/adapters/spi/interactive/fuzzyfind.go`
    - [ ] Implement `NewFuzzyfindAdapter(log Logger) *FuzzyfindAdapter`
    - [ ] Implement Find() method using go-fuzzyfinder
    - [ ] Map DisplayName() to finder display
    - [ ] Map PreviewText() to preview pane
    - [ ] Handle cancellation (fuzzyfinder.ErrAbort)
    - [ ] Run `go test ./internal/adapters/spi/interactive` and verify tests pass
  - [ ] REFACTOR: Decompose into SRP components
    - [ ] Extract `detectTTY() (bool, error)` - Single responsibility: check terminal availability
    - [ ] Extract `buildFinderConfig(items []FinderItem) fuzzyfinder.Config` - Single responsibility: construct finder configuration
    - [ ] Extract `handleCancellation(err error) error` - Single responsibility: convert cancellation to CancellationError
    - [ ] Review method sizes: Find() should orchestrate, helpers do specific tasks
    - [ ] Add comprehensive GoDoc for all exported types/methods
    - [ ] Add inline comments for complex logic (TTY detection, error wrapping)
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run tests to verify refactoring didn't break functionality
    - [ ] Verify test coverage >80%
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 3: TDD - Implement non-TTY detection (AC: 4.3.6, 4.3.9)
  - [ ] RED: Write failing test for non-TTY error
    - [ ] Write test mocking term.IsTerminal to return false
    - [ ] Verify InteractiveError returned with remediation
    - [ ] Run tests and confirm failure
  - [ ] RED: Write failing test for empty items list
    - [ ] Write test with empty []FinderItem
    - [ ] Verify appropriate error returned
    - [ ] Run tests and confirm failure
  - [ ] GREEN: Implement TTY detection and error handling
    - [ ] Implement detectTTY() using term.IsTerminal()
    - [ ] Return InteractiveError when TTY unavailable
    - [ ] Handle empty items list
    - [ ] Run tests and verify they pass
  - [ ] REFACTOR: Review error handling
    - [ ] Verify detectTTY() has single responsibility
    - [ ] Add GoDoc for detectTTY() explaining TTY detection
    - [ ] Verify error messages include remediation guidance
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Run tests to verify refactoring success
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 4: Implement error handling and logging (AC: 4.3.7-4.3.8)
  - [ ] Implement error wrapping per architecture
    - [ ] Wrap go-fuzzyfinder errors with context
    - [ ] Return InteractiveError for TTY issues
    - [ ] Return CancellationError for user cancellation
    - [ ] Include remediation guidance in error messages
  - [ ] Add structured logging
    - [ ] Debug: item count, search state
    - [ ] Info: finder start/end
    - [ ] Warn: non-TTY detection
    - [ ] Error: unexpected failures
  - [ ] Verify logging doesn't expose sensitive data
  - [ ] Run tests to verify error handling

- [ ] Task 5: Quality verification (AC: 4.3.10-4.3.14)
  - [ ] Run golangci-lint on ports/spi
  - [ ] Run golangci-lint on adapters/spi/interactive
  - [ ] Run go test with coverage report
  - [ ] Verify >80% code coverage
  - [ ] Verify compile-time interface satisfaction
  - [ ] Verify ISP compliance
  - [ ] Fix any linting or test failures

- [ ] Task 6: Commit changes (AC: 4.3.15)
  - [ ] Review all changes
  - [ ] Verify tests pass
  - [ ] Commit with proper message

## Dev Notes

### Go-Fuzzyfinder Library Details

From `docs/architecture/tech-stack.md`:

**Fuzzy Finder:** `github.com/ktr0731/go-fuzzyfinder` v0.8.0
- fzf-like fullscreen experience
- Minimal implementation overhead for `lithos find` command
- PRD explicitly specifies
- Active maintenance (published Apr 2025)

**Terminal Utilities:** `golang.org/x/term` v0.25.0
- TTY detection, terminal sizing
- Required for interactive UI libraries
- Fullscreen terminal mode support

### Adapter Architecture

From `docs/architecture/components.md#fuzzyfindadapter`:

**Responsibility:** Implement `FinderPort` for fuzzy finding template selection in `lithos find` command.

**Key Interfaces:**
- `Find(ctx context.Context, templates []Template) (Template, error)` - Fuzzy finder for template selection

**Dependencies:** `github.com/ktr0731/go-fuzzyfinder`, `golang.org/x/term`, Logger.

**Technology Stack:** `go-fuzzyfinder` library for fzf-like interface, TTY detection, fullscreen terminal mode.

**Note:** Only CLI adapter depends on this port (not TemplateEngine). Post-MVP TUI will use different finder implementation.

### FinderPort Design

From `docs/architecture/components.md#finderport`:

**Responsibility:** Provide fuzzy finder for interactive template selection in `lithos find` command. Segregated from PromptPort per ISP.

**Key Interfaces:**
- `Find(ctx context.Context, templates []Template) (Template, error)` - Fuzzy finder for template selection

**Dependencies:** Implemented by FuzzyfindAdapter.

**Note:** Segregated from PromptPort because:
- PromptPort used by TemplateEngine (domain service)
- FinderPort used by CLI adapter only (API adapter)
- Different use cases, different consumers
- ISP (Interface Segregation Principle) compliance

### FinderItem Interface Pattern

**Why Generic Interface:**

The FinderItem interface allows any type to be used with the finder:

```go
// Any type can implement FinderItem
type Template struct {
    ID   TemplateID
    Name string
    Description string
    // ... other fields
}

func (t Template) DisplayName() string {
    return t.Name
}

func (t Template) PreviewText() string {
    return t.Description
}

// Now Template can be used with FinderPort
finder.Find(ctx, templates)
```

This pattern enables:
- Templates in Story 4.5 (CLI find command)
- Future use cases (notes, schemas, etc.)
- No coupling to specific types

### Error Handling Strategy

From `docs/architecture/error-handling-strategy.md`:

**InteractiveError Type:**
- Used when TTY unavailable
- Must include remediation guidance
- Example: "Interactive finder unavailable: not a TTY. Provide template name as argument: lithos new <template-name>"

**CancellationError Type:**
- Used when user cancels (Ctrl+C)
- Not treated as failure in logs
- Example: "Template selection cancelled by user"

**Error Distinction:**
```go
// Cancellation - user choice, not an error condition
if err == fuzzyfinder.ErrAbort {
    return FinderItem{}, CancellationError{
        Message: "Selection cancelled by user",
    }
}

// Non-TTY - actual error requiring remediation
if !term.IsTerminal(int(os.Stdin.Fd())) {
    return FinderItem{}, InteractiveError{
        Message: "Interactive finder unavailable: not a TTY",
        Remediation: "Provide item explicitly as argument",
    }
}
```

### Logging Requirements

From `docs/architecture/coding-standards.md`:

**Log Levels:**
- **Debug:** Item count, search state, internal state
- **Info:** Operation start/end
- **Warn:** Non-TTY fallback
- **Error:** Unexpected failures

**Example Logging:**
```go
log.Info().Int("count", len(items)).Msg("launching fuzzy finder")
log.Debug().Str("search", query).Msg("user searching")
log.Warn().Msg("non-TTY detected, cannot launch finder")
```

### Go-Fuzzyfinder Usage Patterns

**Basic Usage:**
```go
idx, err := fuzzyfinder.Find(
    items,
    func(i int) string {
        return items[i].DisplayName()
    },
    fuzzyfinder.WithPreviewWindow(func(i, w, h int) string {
        if i == -1 {
            return ""
        }
        return items[i].PreviewText()
    }),
)
if err != nil {
    if err == fuzzyfinder.ErrAbort {
        return nil, CancellationError{}
    }
    return nil, fmt.Errorf("finder failed: %w", err)
}
return items[idx], nil
```

**Cancellation Handling:**
```go
if err == fuzzyfinder.ErrAbort {
    // User pressed Ctrl+C or Esc
    return nil, CancellationError{Message: "Selection cancelled"}
}
```

### Testing Strategy

From `docs/architecture/testing-strategy.md`:

**Unit Test Requirements:**
- Mock TTY detection
- Test happy path and error paths
- Verify logging calls
- Verify error messages include remediation
- Test coverage >80%

**Test Structure:**
```go
func TestFind_Success(t *testing.T) {
    adapter := NewFuzzyfindAdapter(testLogger)
    items := []FinderItem{
        &mockItem{name: "Item 1", preview: "Preview 1"},
        &mockItem{name: "Item 2", preview: "Preview 2"},
    }
    // Mock user selection somehow
    result, err := adapter.Find(ctx, items)
    assert.NoError(t, err)
    assert.Equal(t, "Item 1", result.DisplayName())
}

func TestFind_NonTTY(t *testing.T) {
    adapter := NewFuzzyfindAdapter(testLogger)
    items := []FinderItem{&mockItem{name: "Item 1"}}
    // Mock term.IsTerminal to return false
    _, err := adapter.Find(ctx, items)
    assert.Error(t, err)
    assert.IsType(t, InteractiveError{}, err)
}

func TestFind_Cancellation(t *testing.T) {
    adapter := NewFuzzyfindAdapter(testLogger)
    items := []FinderItem{&mockItem{name: "Item 1"}}
    // Mock fuzzyfinder.ErrAbort
    _, err := adapter.Find(ctx, items)
    assert.Error(t, err)
    assert.IsType(t, CancellationError{}, err)
}
```

### SPI Structure

From `docs/architecture/source-tree.md`:

**Port Location:** `internal/ports/spi/finder.go`
- Secondary/driven port interface
- Define contract for fuzzy finding
- Domain-agnostic (not coupled to templates)

**Adapter Location:** `internal/adapters/spi/interactive/fuzzyfind.go`
- Secondary/driven adapter implementation
- Implement FinderPort interface
- Handle infrastructure concerns (TTY, terminal control, fzf library)

**File Organization:**
- `finder.go` - FinderPort interface and FinderItem interface
- `fuzzyfind.go` - FuzzyfindAdapter implementation
- `fuzzyfind_test.go` - Unit tests
- `promptui.go` - PromptUIAdapter (Story 4.2)

### Interface Segregation

From `docs/architecture/components.md`:

**Why FinderPort is Separate from PromptPort:**

1. **Different Consumers:**
   - PromptPort: Used by TemplateEngine (domain service)
   - FinderPort: Used by CLI adapter (API adapter)

2. **Different Use Cases:**
   - PromptPort: Template rendering, inline prompts
   - FinderPort: Command-line template selection

3. **Different Lifecycle:**
   - PromptPort: Called during template execution
   - FinderPort: Called before template selection

4. **ISP Compliance:**
   - TemplateEngine doesn't need fuzzy finding
   - CLI adapter doesn't need text prompts
   - Clean separation of concerns

### FR10 Reference

From `docs/prd/requirements.md#fr10`:

**FR10: Interactive Input Collection**
- Templates can prompt users for input during rendering
- Support for interactive selection from lists
- Fuzzy finding for template discovery
- Graceful fallback for non-interactive environments
- Clear error messages with remediation guidance

### Refactoring Guidelines

**SRP Decomposition for FuzzyfindAdapter:**

The Find() method orchestrates the workflow, delegating specific responsibilities to focused helpers:

**Extract These Helpers:**

1. **detectTTY() (bool, error)**
   - Single responsibility: Check if running in terminal
   - Wraps term.IsTerminal() with error handling
   - Returns boolean and error for clear control flow
   - Why extract: TTY detection is distinct from finder logic

2. **buildFinderConfig(items []FinderItem) fuzzyfinder.Config**
   - Single responsibility: Construct go-fuzzyfinder configuration
   - Maps FinderItem methods to fuzzyfinder callbacks
   - Sets up preview pane configuration
   - Why extract: Configuration construction separate from execution

3. **handleCancellation(err error) error**
   - Single responsibility: Convert fuzzyfinder errors to domain errors
   - Detects fuzzyfinder.ErrAbort → CancellationError
   - Detects other errors → wrapped errors
   - Why extract: Error translation is distinct concern

**When to Decompose:**
- If Find() exceeds 20 lines, extract helpers
- If error handling mixes with finder logic, extract handleCancellation()
- If configuration setup is >5 lines, extract buildFinderConfig()

**Naming Standards:**
- Helpers: camelCase, verb-object pattern (detectTTY, buildFinderConfig, handleCancellation)
- Exported types: PascalCase (FuzzyfindAdapter, FinderPort, FinderItem)
- Methods: PascalCase for exported (Find), camelCase for private helpers

**Documentation Requirements:**
- Package comment explaining interactive adapters
- GoDoc for FuzzyfindAdapter explaining adapter pattern
- GoDoc for NewFuzzyfindAdapter explaining constructor
- GoDoc for Find() method explaining workflow
- Inline comments for complex logic (TTY detection, error wrapping)
- Comments on helpers explaining single responsibility

### TDD Workflow

1. **Write failing test** for specific behavior
2. **Implement** minimum code to make test pass
3. **Refactor** while keeping tests green
4. **Verify** golangci-lint passes
5. **Repeat** for next behavior

Each test should verify:
- Correct return values
- Expected error types
- Logging calls made
- Interface contract satisfied

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 4 requirements | Bob (Scrum Master) |
| 2025-10-28 | 1.1 | Applied quality fixes: TDD, SRP, linting, GoDoc, coverage | QA Specialist |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent during implementation_

### Debug Log References

_To be completed by dev agent during implementation_

### Completion Notes List

_To be completed by dev agent during implementation_

### File List

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
