# Story 1.1: Establish Test Vault and Golden Files

## Status

Ready for Review

## Story

**As a** QA specialist,
**I want** to create a foundational test data set,
**so that** all unit and integration tests can use a consistent and predictable set of "golden" files.

## Acceptance Criteria

1. A `testdata` directory is created in the repository.
2. The directory contains a minimal vault structure with sample templates, schemas, and notes.
3. A "golden" output file is created for a simple template to test against in later stories.

## Tasks / Subtasks

- [x] Task 1: Create testdata directory structure (AC: 1)
  - [x] Create `testdata/` directory in repository root
  - [x] Create `testdata/vault/` subdirectory for test vault
  - [x] Create `testdata/golden/` subdirectory for expected output files

- [x] Task 2: Create minimal vault structure with sample data (AC: 2)
  - [x] Create `testdata/vault/templates/` directory
  - [x] Create simple template file `testdata/vault/templates/basic-note.md`
  - [x] Create `testdata/vault/schemas/` directory
  - [x] Create basic schema file `testdata/vault/schemas/note.json`
  - [x] Create sample notes directory `testdata/vault/notes/`
  - [x] Create sample note files with frontmatter in `testdata/vault/notes/`

- [x] Task 3: Create golden output file for template testing (AC: 3)
  - [x] Generate expected output by manually rendering basic template
  - [x] Save expected output as `testdata/golden/basic-note-expected.md`
  - [x] Document template input parameters used for golden file generation
  - [x] Verify golden file structure matches expected template output format

- [x] Task 4: Add comprehensive unit tests for test data structure
  - [x] Test that testdata directory structure exists and is accessible
  - [x] Test that sample vault files can be loaded successfully
  - [x] Test that golden files can be read and compared during tests
  - [x] Verify all sample data follows expected data model structures

## Dev Notes

### Architecture Context

This story establishes the testing foundation for the entire Lithos project using hexagonal architecture principles. Based on the architecture documents, this test vault must support the core data models and follow the established directory structure.

**Hexagonal Architecture Testing Approach:** [Source: architecture/high-level-architecture.md]
- **Test Adapters as First-Class Citizens:** Epic 1.1 test vault and Epic 4.1 interactive test harness are implemented as test adapters
- **Same Ports for Production and Test:** Production code and test code use the same ports, eliminating the need for mocking frameworks
- **Test Harness Implementation:** Epic 1.1/4.1 test harness uses injected mock adapters for the InteractivePort and other ports
- **Adapter Substitution:** Test adapters can be swapped at runtime (e.g., production PromptUIAdapter vs. test MockInteractiveAdapter)

**Source Tree Structure:** [Source: architecture/source-tree.md]
- `testdata/` directory is specified in the source tree as "Golden vault used in automated tests"
- The test vault structure should mirror the expected vault layout for consistency

**Data Models to Support:** [Source: architecture/data-models.md]
- **File Model**: Test files need Path, Basename, Folder, ModTime attributes
- **Frontmatter Model**: Test notes need FileClass and Fields for schema validation testing
- **Note Model**: Test data should provide complete File + Frontmatter compositions
- **Schema Model**: Test schemas need Name, Properties (optional Extends/Excludes for inheritance testing)
- **Template Model**: Test templates need FilePath, Name, Content for execution testing

**Tech Stack Requirements:** [Source: architecture/tech-stack.md]
- Use Go 1.23+ stdlib for file operations (`os`, `path/filepath`)
- Test files should be compatible with `github.com/goccy/go-yaml` for YAML parsing
- JSON schema files should use `encoding/json` stdlib
- Template content should use `text/template` syntax

### Testing Strategy Compliance

**Test Data Management:** [Source: architecture/testing-strategy.md]
- "Immutable vault fixtures under `testdata/vault/` containing templates, schemas, and notes"
- "Tests copy fixtures into temp directories before mutation"
- "Golden Files: Store rendered notes and cache JSON snapshots in `testdata/golden/`"
- Use `t.Cleanup` patterns for temporary directory management

**Directory Structure to Create:**
```
testdata/
├── vault/              # Test vault fixtures
│   ├── templates/      # Sample templates for testing
│   ├── schemas/        # Sample schemas for validation testing
│   └── notes/          # Sample notes with frontmatter
└── golden/             # Expected output files for comparison
    └── basic-note-expected.md
```

### Sample Data Requirements

**Basic Template Content:**
- Should use Go `text/template` syntax
- Include basic template functions: `now`, `toLower`, `toUpper` (per Epic 1.11)
- Support frontmatter variable substitution
- Be simple enough for golden file generation

**Basic Schema Structure:**
- JSON format with `name`, `properties` structure
- Include at least one string property with basic validation
- Support basic Property types: StringPropertySpec with enum/pattern constraints
- Follow Property model structure from data-models.md

**Sample Note Structure:**
- YAML frontmatter delimited by `---`
- Include `fileClass` field for schema reference
- Include sample user-defined fields
- Use `.md` extension following Obsidian conventions

### File Location Standards

**Testing Standards:** [Source: architecture/testing-strategy.md]
- Co-located `*_test.go` files near implementation
- Use `testdata/` for fixtures with helper copy utilities
- Integration tests under `tests/` when requiring full vault fixtures

**Coding Standards:** [Source: architecture/coding-standards.md]
- Unit tests MUST use table-driven cases for branches
- Tests MUST cover success, validation failure scenarios
- Golden files belong under `testdata/` mirroring vault layout
- Use `testing` stdlib package (Go 1.23+)

### Technical Constraints

- All paths must be cross-platform compatible (use `filepath.Join`)
- File permissions must be readable by test processes
- Sample data must not contain any secrets or sensitive information
- Template syntax must be valid for Go `text/template` engine
- Schema JSON must be valid and parseable by `encoding/json`
- YAML frontmatter must be valid and parseable by `goccy/go-yaml`

## Testing

### Test Requirements

Based on testing strategy from architecture documents:

**Unit Test Coverage:**
- Test data directory structure validation
- Sample file accessibility and format validation
- Golden file comparison utilities
- Cross-platform path handling

**Test Framework:** [Source: architecture/testing-strategy.md]
- Use Go stdlib `testing` package (Go 1.23+)
- Table-driven tests for multiple sample data scenarios
- Use `t.Cleanup` for temporary directory management

**Fixture Management:**
- Immutable fixtures in `testdata/vault/`
- Copy utilities to avoid mutating source fixtures
- Temporary directory patterns for test isolation

**File Validation Tests:**
- Verify template files contain valid Go template syntax
- Verify schema files contain valid JSON and proper structure
- Verify note files contain valid YAML frontmatter
- Verify golden files match expected output format

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Bob (SM) |
| 2024-10-19 | 1.1 | Story implementation completed | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (October 2024) - Full Stack Developer Agent

### Debug Log References

- Created testdata directory structure: `mkdir -p testdata/vault testdata/golden`
- Verified directory structure: `ls -la testdata/`
- Added goccy/go-yaml dependency: `go get github.com/goccy/go-yaml@v1.17.1`
- Ran comprehensive tests: `go test -mod=readonly -v ./testdata_test.go`
- All tests passed with 100% success rate

### Completion Notes List

1. **Task 1 Completed**: Successfully created testdata directory structure with vault and golden subdirectories
2. **Task 2 Completed**: Created complete minimal vault structure including:
   - Templates directory with basic-note.md template using Go text/template syntax
   - Schemas directory with note.json schema following JSON format
   - Notes directory with two sample notes containing valid YAML frontmatter
3. **Task 3 Completed**: Generated golden output file with documented input parameters for deterministic testing
4. **Task 4 Completed**: Implemented comprehensive unit tests covering:
   - Directory structure validation
   - File existence checks
   - Template syntax validation
   - Schema JSON validation
   - YAML frontmatter validation
   - Golden file accessibility
   - Cross-platform path compatibility

### File List

**Created Files:**
- `testdata/vault/templates/basic-note.md` - Template with Go text/template syntax
- `testdata/vault/schemas/note.json` - JSON schema definition
- `testdata/vault/notes/sample-note-1.md` - Sample note with frontmatter
- `testdata/vault/notes/sample-note-2.md` - Second sample note with frontmatter
- `testdata/golden/basic-note-expected.md` - Expected template output
- `testdata/golden/basic-note-input-params.json` - Input parameters documentation
- `testdata_test.go` - Comprehensive test suite

**Modified Files:**
- `go.mod` - Added goccy/go-yaml@v1.17.1 dependency

## QA Results

_To be populated by QA agent_
