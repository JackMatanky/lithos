# Story 1.7: Define Core Ports & Implement FileSystem Adapter

## Status

Approved

## Story

As a developer, I want to define the `FileSystemPort` and implement a local file system adapter, so that domain logic is decoupled from direct file I/O.

## Acceptance Criteria

- 1.7.1: The `FileSystemPort` interface is defined in `internal/ports/spi/` with `ReadFile`, `WriteFileAtomic`, and `Walk` methods per `docs/architecture/components.md#spi-port-interfaces`.
- 1.7.2: The `LocalFileSystemAdapter` is implemented in `internal/adapters/spi/filesystem/`, satisfying the `FileSystemPort` per `docs/architecture/components.md#spi-adapters`.
- 1.7.3: The adapter correctly uses the `os` package to perform file operations.
- 1.7.4: The adapter and port are unit-tested.
- 1.7.5: Package includes comprehensive README.md documentation with usage examples.

## Tasks / Subtasks

- [ ] Task 1: Define FileSystemPort interface in internal/ports/spi/ (AC: 1.7.1)
  - [ ] Create internal/ports/spi/filesystem.go file
  - [ ] Define FileSystemPort interface with ReadFile, WriteFileAtomic, and Walk methods
  - [ ] Define WalkFunc type for directory traversal callbacks
  - [ ] Add package documentation following coding standards
- [ ] Task 2: Implement LocalFileSystemAdapter in internal/adapters/spi/filesystem/ (AC: 1.7.2, 1.7.3)
  - [ ] Create internal/adapters/spi/filesystem/ directory
  - [ ] Create filesystem.go file with LocalFileSystemAdapter struct
  - [ ] Implement ReadFile method using os.ReadFile
  - [ ] Implement WriteFileAtomic method using temp file + rename pattern
  - [ ] Implement Walk method using filepath.WalkDir
  - [ ] Add proper error handling and logging
- [ ] Task 3: Create unit tests for adapter and port (AC: 1.7.4)
  - [ ] Create filesystem_test.go in internal/adapters/spi/filesystem/
  - [ ] Test ReadFile with existing and non-existing files
  - [ ] Test WriteFileAtomic with atomic write behavior
  - [ ] Test Walk method with directory traversal
  - [ ] Test error conditions and edge cases
  - [ ] Ensure tests use temp directories for isolation
- [ ] Task 4: Run tests and verify implementation
  - [ ] Execute go test ./internal/adapters/spi/filesystem/
  - [ ] Verify all tests pass with proper coverage (≥85%)
  - [ ] Run golangci-lint to ensure code standards compliance
- [ ] Task 5: Pass pre-commit hooks and commit changes
  - [ ] Run pre-commit hooks: golangci-lint run and gitleaks detect
  - [ ] Ensure all hooks pass without errors
  - [ ] Stage all changed files
  - [ ] Create conventional commit message following project standards
  - [ ] Commit all changes with the conventional commit message

- [ ] Task 6: Create package README.md
  - [ ] Create internal/ports/spi/README.md for FileSystemPort
  - [ ] Create internal/adapters/spi/filesystem/README.md for LocalFileSystemAdapter
  - [ ] Document interface contracts and usage patterns
  - [ ] Include code examples for dependency injection
  - [ ] Document error handling and atomic write guarantees

## Dev Notes

### Previous Story Insights

Story 1.6 implemented the shared registry package in `internal/shared/registry/`, establishing the pattern for shared internal packages. This filesystem port and adapter follows the hexagonal architecture pattern established in Story 1.2, where ports are defined in `internal/ports/spi/` and adapters in `internal/adapters/spi/`. The shared directory structure is already established from Story 1.2.

### FileSystemPort Specifications

[Source: docs/architecture/components.md#spi-port-interfaces]

**Responsibility:** Provide safe file read/write/walk operations so domain services can interact with the vault without importing `os`.

**Key Interfaces:**

- `ReadFile(path string) ([]byte, error)`
- `WriteFileAtomic(path string, data []byte) error`
- `Walk(root string, fn WalkFunc) error`

**Dependencies:** Implemented by LocalFileSystemAdapter.

**Technology Stack:** Go `os`, `io`, and atomic write helpers (temp file + rename); honors config-defined vault roots.

### LocalFileSystemAdapter Specifications

[Source: docs/architecture/components.md#spi-adapters]

**Responsibility:** Implement `FileSystemPort`, wrapping filesystem interactions with safe defaults for vault operations.

**Key Interfaces:**

- `ReadFile(path string) ([]byte, error)`
- `WriteFileAtomic(path string, data []byte) error`
- `Walk(root string, fn WalkFunc) error`

**Dependencies:** Go `os`, `io`, `path/filepath`, Config (vault root), Logger for error reporting.

**Technology Stack:** Stdlib-only adapter with atomic write helpers (temp file + rename); tested via temp directories to ensure portability.

### Technical Constraints

[Source: docs/architecture/tech-stack.md]

- Go 1.23+ minimum version requirement
- File System: os, path/filepath (stdlib) - Explicit choice to use stdlib over abstraction libraries (e.g., `afero`). Aligns with "Standard Library First" principle. Provides cross-platform path handling.

### Coding Standards

[Source: docs/architecture/coding-standards.md]

- Go 1.25+ MUST be used (CI enforces via toolchain)
- Ports MUST remain lean (≤3 methods); grow only with proven need (FileSystemPort follows this with 3 methods)
- Package comments for port and adapter packages documenting responsibility
- Exported identifiers MUST have GoDoc summarizing purpose, error conditions, and context requirements
- Concurrency and side effects MUST be documented where applicable

### File Locations

[Source: docs/architecture/source-tree.md]

- Port: internal/ports/spi/filesystem.go
- Adapter: internal/adapters/spi/filesystem/filesystem.go
- Tests: internal/adapters/spi/filesystem/filesystem_test.go
- Follow source tree structure for ports and adapters under internal/ports/ and internal/adapters/

### Testing Requirements

[Source: docs/architecture/testing-strategy.md]

- Unit tests MUST live beside the code under test (`*_test.go`) and use table-driven cases for branches
- Unit tests for core services under `internal/app` and value objects in `internal/domain` (filesystem adapter is infrastructure adapter, similar scope)
- Target: ≥85% for internal/adapters/spi/filesystem package
- Use table-driven tests for filesystem operations
- Test atomic write behavior via temp directories
- Include edge cases: non-existent files, permission errors, atomic write guarantees

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-12 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

[To be filled by dev agent]

### Debug Log References

[To be filled by dev agent]

### Completion Notes List

[To be filled by dev agent]

### File List

[To be filled by dev agent]

## QA Results

[To be filled by QA agent]
