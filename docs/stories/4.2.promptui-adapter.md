# Story 4.2: PromptUI Adapter

## Status

Draft

## Story

**As a** developer,
**I want** a PromptUI-based adapter that satisfies PromptPort,
**so that** templates can collect user input through the CLI with a clean terminal UX.

## Acceptance Criteria

**Adapter Implementation:**

- 4.2.1: Create `internal/adapters/spi/interactive/promptui.go` implementing `PromptPort` interface with:
  - `NewPromptUIAdapter(log Logger) *PromptUIAdapter` constructor
  - `Prompt(ctx context.Context, cfg PromptConfig) (string, error)` method
  - `Suggester(ctx context.Context, cfg SuggesterConfig) (string, error)` method
  - Implementation matches `docs/architecture/components.md#promptuiadapter` exactly

- 4.2.2: Prompt() method implementation:
  - Uses `github.com/manifoldco/promptui` v0.9.0 for text input
  - Respects `PromptConfig.Default` value
  - Executes `PromptConfig.Validator` if provided
  - Returns user input or default
  - Handles cancellation (Ctrl+C) gracefully

- 4.2.3: Suggester() method implementation:
  - Uses `promptui.Select` for list selection
  - Displays `SuggesterConfig.Options` as choices
  - Highlights `SuggesterConfig.Default` if provided
  - Returns selected option
  - Handles cancellation gracefully

**Non-Interactive Mode:**

- 4.2.4: Detect non-TTY environments using `golang.org/x/term.IsTerminal()`:
  - Check before prompting
  - Return `InteractiveError` with remediation guidance
  - Error message format: "Interactive prompt unavailable: not a TTY. Use NonInteractiveFallback or run in terminal"
  - Use `NonInteractiveFallback` value if provided

**Error Handling:**

- 4.2.5: Implement error handling per `docs/architecture/error-handling-strategy.md`:
  - Wrap promptui errors with context
  - Return `InteractiveError` for TTY issues
  - Return validation errors from `Validator` function
  - Include remediation guidance in all error messages

**Logging:**

- 4.2.6: Follow coding standards for logging:
  - Debug level: Log retry attempts, validation failures
  - Info level: Log prompt start/end with prompt name
  - Warn level: Log non-TTY fallback usage
  - Error level: Log unexpected failures
  - Satisfy FR10 UX guidance for transparency

**Unit Tests:**

- 4.2.7: Create `internal/adapters/spi/interactive/promptui_test.go` with tests for:
  - Successful text prompt with default value
  - Successful suggester with selection
  - Validation failure and retry
  - Cancellation handling (simulated Ctrl+C)
  - Non-interactive fallback behavior
  - Non-TTY error when fallback unavailable
  - Default value usage when input empty

**Quality Gates:**

- 4.2.8: Run `golangci-lint run ./internal/adapters/spi/interactive` - all checks pass

- 4.2.9: Run `go test ./internal/adapters/spi/interactive` - all tests pass with >80% coverage

- 4.2.10: Verify adapter satisfies PromptPort interface at compile time

- 4.2.11: Committed with message: `feat: add PromptUI adapter implementing PromptPort`

## Tasks / Subtasks

- [ ] Task 1: TDD - Write failing test for Prompt() (AC: 4.2.7)
  - [ ] RED: Write failing test for successful text prompt with default
    - [ ] Create test file structure in `internal/adapters/spi/interactive/promptui_test.go`
    - [ ] Write test case verifying Prompt() with default value
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure
  - [ ] RED: Write failing test for validation failure handling
    - [ ] Write test case with validator that returns error
    - [ ] Verify test fails appropriately
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure

- [ ] Task 2: Implement Prompt() method (AC: 4.2.2, 4.2.4)
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Create adapter struct with logger field
    - [ ] Extract TTY detection to private `detectTTY()` method
    - [ ] Extract prompt configuration to private `buildPromptConfig()` method
    - [ ] Implement promptui text prompt in Prompt() method
    - [ ] Handle default values
    - [ ] Handle validator execution
    - [ ] Handle cancellation
    - [ ] Implement non-interactive fallback
    - [ ] Run `go test ./internal/adapters/spi/interactive` and verify tests pass
  - [ ] REFACTOR: Decompose into SRP components
    - [ ] Extract TTY detection to `detectTTY() bool` method:
      - [ ] Single responsibility: check if stdin is a TTY
      - [ ] Returns boolean for TTY availability
      - [ ] Add GoDoc explaining TTY detection logic
    - [ ] Extract prompt configuration to `buildPromptConfig(cfg PromptConfig) promptui.Prompt` method:
      - [ ] Single responsibility: convert PromptConfig to promptui.Prompt
      - [ ] Maps Label, Default, Validate fields
      - [ ] Add GoDoc explaining configuration mapping
    - [ ] Extract error handling to private `handleInteractiveError(err error, cfg PromptConfig) error` method:
      - [ ] Single responsibility: wrap promptui errors with context and remediation
      - [ ] Detects cancellation vs other errors
      - [ ] Returns InteractiveError or wrapped error
      - [ ] Add GoDoc explaining error classification
    - [ ] Review naming: Prompt (clear), detectTTY (specific), buildPromptConfig (descriptive)
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Add GoDoc for PromptUIAdapter struct
      - [ ] Add GoDoc for Prompt() method with examples
      - [ ] Add GoDoc for private helpers explaining purpose
      - [ ] Document non-interactive fallback behavior
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/adapters/spi/interactive` to verify refactoring didn't break tests
    - [ ] Verify test coverage >80% for Prompt()
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 3: TDD - Write failing test for Suggester() (AC: 4.2.7)
  - [ ] RED: Write failing test for successful selection from list
    - [ ] Write test case with list of options
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure
  - [ ] RED: Write failing test for default selection highlighting
    - [ ] Write test case with default option specified
    - [ ] Verify test fails appropriately
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure
  - [ ] RED: Write failing test for cancellation handling
    - [ ] Write test simulating Ctrl+C cancellation
    - [ ] Verify test fails appropriately
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure

- [ ] Task 4: Implement Suggester() method (AC: 4.2.3, 4.2.4)
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Extract suggester configuration to private `buildSuggesterConfig()` method
    - [ ] Implement promptui Select for list selection
    - [ ] Handle options display
    - [ ] Handle default selection
    - [ ] Handle cancellation
    - [ ] Implement non-interactive fallback
    - [ ] Run `go test ./internal/adapters/spi/interactive` and verify tests pass
  - [ ] REFACTOR: Decompose into SRP components
    - [ ] Extract suggester configuration to `buildSuggesterConfig(cfg SuggesterConfig) promptui.Select` method:
      - [ ] Single responsibility: convert SuggesterConfig to promptui.Select
      - [ ] Maps Label, Items, Default fields
      - [ ] Add GoDoc explaining configuration mapping
    - [ ] Verify handleInteractiveError() reused for suggester errors
    - [ ] Review naming: Suggester (clear), buildSuggesterConfig (descriptive)
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Add GoDoc for Suggester() method with examples
      - [ ] Document option selection behavior
      - [ ] Document default highlighting behavior
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/adapters/spi/interactive` to verify refactoring didn't break tests
    - [ ] Verify test coverage >80% for Suggester()
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 5: TDD - Write failing tests for error handling (AC: 4.2.7)
  - [ ] RED: Write failing test for non-TTY error with remediation
    - [ ] Write test mocking non-TTY environment
    - [ ] Verify error includes remediation guidance
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure
  - [ ] RED: Write failing test for fallback value usage
    - [ ] Write test with NonInteractiveFallback set
    - [ ] Verify fallback used when TTY unavailable
    - [ ] Run `go test ./internal/adapters/spi/interactive` and confirm failure

- [ ] Task 6: Implement error handling and logging (AC: 4.2.5-4.2.6)
  - [ ] GREEN: Implement error handling
    - [ ] Verify handleInteractiveError() wraps errors correctly
    - [ ] Add remediation guidance to errors
    - [ ] Run `go test ./internal/adapters/spi/interactive` and verify tests pass
  - [ ] GREEN: Implement logging
    - [ ] Add debug logging for retries
    - [ ] Add info logging for prompt lifecycle
    - [ ] Add warn logging for fallbacks
    - [ ] Run `go test ./internal/adapters/spi/interactive` and verify tests pass
  - [ ] REFACTOR: Review logging and error handling
    - [ ] Verify logging levels match coding standards
    - [ ] Verify no sensitive data in logs
    - [ ] Add comprehensive GoDoc for error types
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL linter warnings
    - [ ] Run `go test ./internal/adapters/spi/interactive` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 7: Quality verification (AC: 4.2.8-4.2.10)
  - [ ] Run golangci-lint on interactive adapter
  - [ ] Run go test with coverage report
  - [ ] Verify >80% code coverage
  - [ ] Verify compile-time interface satisfaction
  - [ ] Fix any linting or test failures
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/spi/interactive`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 8: Commit changes (AC: 4.2.11)
  - [ ] Review all changes
  - [ ] Verify tests pass
  - [ ] Commit with proper message

## Dev Notes

### PromptUI Library Details

From `docs/architecture/tech-stack.md`:

**Interactive Prompts:** `github.com/manifoldco/promptui` v0.9.0
- Clean API, good terminal UX for Epic 4 interactive features
- PRD explicitly specifies
- **Note: Last release Oct 2021 - mature/stable but unmaintained**
- InteractivePort abstraction enables future migration to `charmbracelet/huh` when adding TUI (Post-MVP Phase 4)

**Terminal Utilities:** `golang.org/x/term` v0.25.0
- TTY detection, terminal sizing
- Required for interactive UI libraries
- Enables: (1) Detecting if output is TTY for color control, (2) Terminal width for formatting, (3) Raw mode for prompts

### Adapter Architecture

From `docs/architecture/components.md#promptuiadapter`:

**Responsibility:** Implement `PromptPort` for terminal-based text input and selection interactions used by template engine.

**Key Interfaces:**
- `Prompt(ctx context.Context, cfg PromptConfig) (string, error)` - Text input prompt
- `Suggester(ctx context.Context, cfg SuggesterConfig) (string, error)` - Selection from list

**Dependencies:** `github.com/manifoldco/promptui`, `golang.org/x/term`, Logger.

**Technology Stack:** `promptui` library for prompts, TTY detection via `x/term`, graceful fallback to non-interactive mode when TTY unavailable.

**Note:** Post-MVP (Phase 4) will migrate to `charmbracelet/huh` for TUI support. Port abstraction enables swap without domain changes.

### SRP Decomposition for Adapters

**Private Method Extraction:**

Extract TTY detection:
```go
// detectTTY checks if stdin is a TTY
func (a *PromptUIAdapter) detectTTY() bool {
    return term.IsTerminal(int(os.Stdin.Fd()))
}
```

Extract prompt configuration:
```go
// buildPromptConfig converts PromptConfig to promptui.Prompt
func (a *PromptUIAdapter) buildPromptConfig(cfg PromptConfig) promptui.Prompt {
    return promptui.Prompt{
        Label:    cfg.Label,
        Default:  cfg.Default,
        Validate: cfg.Validator,
    }
}
```

Extract error handling:
```go
// handleInteractiveError wraps promptui errors with context and remediation
func (a *PromptUIAdapter) handleInteractiveError(err error, cfg PromptConfig) error {
    if err == promptui.ErrInterrupt {
        return fmt.Errorf("prompt cancelled by user")
    }
    return fmt.Errorf("prompt %q failed: %w. Remediation: ...", cfg.Name, err)
}
```

### Error Handling Strategy

From `docs/architecture/error-handling-strategy.md`:

**InteractiveError Type:**
- Used when TTY unavailable
- Must include remediation guidance
- Example: "Interactive prompt unavailable: not a TTY. Use --non-interactive mode or set LITHOS_NONINTERACTIVE=true"

**Error Wrapping:**
```go
if !term.IsTerminal(int(os.Stdin.Fd())) {
    if cfg.NonInteractiveFallback != "" {
        log.Warn().Str("fallback", cfg.NonInteractiveFallback).Msg("using non-interactive fallback")
        return cfg.NonInteractiveFallback, nil
    }
    return "", InteractiveError{
        Message: "Interactive prompt unavailable: not a TTY",
        Remediation: "Use NonInteractiveFallback or run in terminal",
    }
}
```

### Logging Requirements

From `docs/architecture/coding-standards.md`:

**Log Levels:**
- **Debug:** Retry attempts, validation failures, internal state
- **Info:** Operation start/end, user-facing milestones
- **Warn:** Fallback usage, non-critical issues
- **Error:** Failures requiring user intervention

**Example Logging:**
```go
log.Info().Str("name", cfg.Name).Msg("prompting user for input")
log.Debug().Str("name", cfg.Name).Msg("validation failed, retrying")
log.Warn().Str("name", cfg.Name).Str("fallback", cfg.NonInteractiveFallback).Msg("using fallback value")
```

### PromptUI Usage Patterns

**Text Prompt Example:**
```go
prompt := promptui.Prompt{
    Label:    cfg.Label,
    Default:  cfg.Default,
    Validate: cfg.Validator,
}
result, err := prompt.Run()
```

**Select Example:**
```go
prompt := promptui.Select{
    Label: cfg.Label,
    Items: cfg.Options,
}
_, result, err := prompt.Run()
```

**Cancellation Handling:**
```go
if err == promptui.ErrInterrupt {
    return "", errors.New("prompt cancelled by user")
}
```

### Testing Strategy

From `docs/architecture/testing-strategy.md`:

**Unit Test Requirements:**
- Mock TTY detection (use build tags or interfaces)
- Test happy path and error paths
- Verify logging calls
- Verify error messages include remediation
- Test coverage >80%

**Test Structure:**
```go
func TestPrompt_Success(t *testing.T) {
    adapter := NewPromptUIAdapter(testLogger)
    cfg := PromptConfig{
        Name:  "test",
        Label: "Enter value",
        Default: "default",
    }
    // Simulate user input somehow (may need mocking)
}

func TestPrompt_NonTTY(t *testing.T) {
    adapter := NewPromptUIAdapter(testLogger)
    cfg := PromptConfig{
        Name:  "test",
        Label: "Enter value",
        NonInteractiveFallback: "fallback",
    }
    // Mock term.IsTerminal to return false
    result, err := adapter.Prompt(ctx, cfg)
    assert.NoError(t, err)
    assert.Equal(t, "fallback", result)
}
```

### SPI Adapter Location

From `docs/architecture/source-tree.md`:

**SPI Adapters Location:** `internal/adapters/spi/interactive/`
- Secondary/driven adapter implementations
- Implement SPI port interfaces
- Handle infrastructure concerns (TTY, terminal control)
- No domain logic

**File Organization:**
- `promptui.go` - PromptUIAdapter implementation
- `promptui_test.go` - Unit tests
- `fuzzyfind.go` - FuzzyfindAdapter (Story 4.3)

### FR10 Reference

From `docs/prd/requirements.md#fr10`:

**FR10: Interactive Input Collection**
- Templates can prompt users for input during rendering
- Support for text input prompts with validation
- Support for selection from predefined lists
- Graceful fallback for non-interactive environments
- Clear error messages with remediation guidance
- UX must be transparent with logging

### TDD Workflow

1. **Write failing test** for specific behavior
2. **Implement** minimum code to make test pass
3. **Refactor** while keeping tests green (extract private methods per SRP)
4. **Verify** golangci-lint passes
5. **Repeat** for next behavior

Each test should verify:
- Correct return values
- Expected error types
- Logging calls made
- Interface contract satisfied

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 4 requirements | Bob (Scrum Master) |
| 2025-10-28 | 1.1 | Applied quality fixes: TDD RED-GREEN-REFACTOR, SRP decomposition with private method extraction, comprehensive GoDoc, linting checkpoints | QA Specialist |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent during implementation_

### Debug Log References

_To be completed by dev agent during implementation_

### Completion Notes List

_To be completed by dev agent during implementation_

### File List

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
