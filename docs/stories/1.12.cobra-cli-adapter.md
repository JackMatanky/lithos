# Story 1.12: Implement CobraCLI Adapter

## Status

Ready for Implementation

## Story

**As a** developer,
**I want** to implement complete CobraCLI adapter with root command, version command, and new command,
**so that** users can interact with the application via CLI following hexagonal architecture with SRP decomposition.

## Acceptance Criteria

**Dependencies and Setup:**

- 1.12.1: Add dependencies to `go.mod`:
  - `github.com/spf13/cobra`
  - `github.com/spf13/pflag`

- 1.12.2: Create `internal/adapters/api/cli/cobra.go`:
  - Implements CLIPort interface
  - Constructor: `NewCobraCLIAdapter(log zerolog.Logger) *CobraCLIAdapter`
  - Internal field: `handler CommandPort` (stored in Start())
  - Internal field: `log zerolog.Logger`

**Start Method:**

- 1.12.3: Implement `Start(ctx context.Context, handler CommandPort) error`:
  - Stores handler parameter in internal field
  - Calls buildRootCommand() private method
  - Executes root command with context: rootCmd.ExecuteContext(ctx)
  - Returns error from command execution

**Root Command:**

- 1.12.4: Implement private method `buildRootCommand() *cobra.Command`:
  - Use: "lithos"
  - Short: "Template-driven markdown note generator for Obsidian vaults"
  - SilenceUsage: true (don't print usage on command errors)
  - SilenceErrors: true (handle errors in domain)
  - Adds version subcommand via AddCommand(buildVersionCommand())
  - Adds new subcommand via AddCommand(buildNewCommand())

**Version Command:**

- 1.12.5: Implement private method `buildVersionCommand() *cobra.Command`:
  - Command: `lithos version`
  - Short: "Print version information"
  - RunE: prints "lithos v0.1.0" to stdout
  - Returns nil error on success

**New Command:**

- 1.12.6: Implement private method `buildNewCommand() *cobra.Command`:
  - Command: `lithos new [template-id]`
  - Short: "Create a new note from template"
  - Args: `cobra.MaximumNArgs(1)` (template-id is optional for now, will error in handler if missing)
  - Flags: `--view, -v` (boolean, default false) - display content after creation
  - RunE: calls handleNewCommand(cmd, args)

**New Command Handler:**

- 1.12.7: Implement private method `handleNewCommand(cmd *cobra.Command, args []string) error`:
  - Extract template-id from args[0] (return error if missing with message "template-id required")
  - Create TemplateID from args[0]: `templateID := domain.NewTemplateID(args[0])`
  - Call handler.NewNote(cmd.Context(), templateID)
  - On success: call displayNoteCreated(cmd, note)
  - On failure: return formatError(err)

- 1.12.8: Implement private method `displayNoteCreated(cmd *cobra.Command, note Note)`:
  - Print to stdout: `✓ Created: {Config.VaultPath}/{note.ID}.md`
  - Check --view flag via cmd.Flags().GetBool("view")
  - If --view is true:
    - Print separator line (80 characters of "=")
    - Print note content (read from file)
    - Print separator line

- 1.12.9: Implement private method `formatError(err error) error`:
  - Check error type using errors.As()
  - Format user-friendly messages:
    - ResourceError (template not found) → "Template '{name}' not found in {TemplatesDir}"
    - TemplateError (parse/render) → "Template error in '{name}': {message}"
    - Generic error → "Error: {message}"
  - Return formatted error for Cobra to display

**Testing:**

- 1.12.10: Add mock to `tests/utils/mocks.go`:
  - `MockCommandPort` struct implementing CommandPort interface
  - Internal field: `newNoteResult` (Note, error)
  - Method: `SetNewNoteResult(note Note, err error)` - configure mock response
  - Implements: NewNote() returns configured result

- 1.12.11: Create unit tests in `internal/adapters/api/cli/cobra_test.go`:
  - Test: Start() stores handler correctly
  - Test: buildRootCommand() creates command with correct structure
  - Test: version command prints "lithos v0.1.0"
  - Test: new command parses template-id argument correctly
  - Test: new command parses --view flag correctly
  - Test: handleNewCommand() extracts templateID from args
  - Test: handleNewCommand() returns error when args empty
  - Test: handleNewCommand() calls handler.NewNote() with correct arguments
  - Test: displayNoteCreated() formats output correctly without --view flag
  - Test: displayNoteCreated() displays content with --view flag
  - Test: formatError() formats ResourceError correctly
  - Test: formatError() formats TemplateError correctly
  - Test: formatError() formats generic error correctly
  - All tests use MockCommandPort from tests/utils/mocks.go

- 1.12.12: All tests pass: `go test ./internal/adapters/api/cli`

- 1.12.13: All linting passes: `golangci-lint run --fix internal/adapters/api/cli`

- 1.12.14: Committed with message: `feat(adapters): implement CobraCLI adapter with version and new commands`

## Tasks / Subtasks

- [ ] Task 1: Add dependencies and create adapter struct (AC: 1.12.1-1.12.2)
  - [ ] Add cobra and pflag to go.mod
  - [ ] Create CobraCLIAdapter struct with constructor
  - [ ] Verify struct compiles

- [ ] Task 2: Implement Start method (AC: 1.12.3)
  - [ ] RED: Write failing test for Start() storing handler
  - [ ] GREEN: Implement Start() method
  - [ ] GREEN: Verify test passes
  - [ ] REFACTOR: Review code

- [ ] Task 3: Implement root and version commands (AC: 1.12.4-1.12.5)
  - [ ] RED: Write failing test for buildRootCommand()
  - [ ] RED: Write failing test for version command output
  - [ ] GREEN: Implement buildRootCommand()
  - [ ] GREEN: Implement buildVersionCommand()
  - [ ] GREEN: Verify tests pass
  - [ ] REFACTOR: Add documentation

- [ ] Task 4: Implement new command structure (AC: 1.12.6)
  - [ ] RED: Write failing test for buildNewCommand()
  - [ ] RED: Write failing test for --view flag parsing
  - [ ] GREEN: Implement buildNewCommand()
  - [ ] GREEN: Add --view flag
  - [ ] GREEN: Verify tests pass

- [ ] Task 5: Implement command handlers (AC: 1.12.7-1.12.9)
  - [ ] RED: Write failing tests for handleNewCommand()
  - [ ] RED: Write failing tests for displayNoteCreated()
  - [ ] RED: Write failing tests for formatError()
  - [ ] GREEN: Implement handleNewCommand()
  - [ ] GREEN: Implement displayNoteCreated()
  - [ ] GREEN: Implement formatError()
  - [ ] GREEN: Verify tests pass
  - [ ] REFACTOR: Improve error messages

- [ ] Task 6: Create MockCommandPort (AC: 1.12.10)
  - [ ] Add MockCommandPort to tests/utils/mocks.go
  - [ ] Implement configuration methods
  - [ ] Verify mock satisfies interface

- [ ] Task 7: Run quality gates (AC: 1.12.12-1.12.13)
  - [ ] Run all tests and verify 100% pass
  - [ ] Run golangci-lint and fix issues
  - [ ] Verify test coverage >80%

- [ ] Task 8: Commit changes (AC: 1.12.14)
  - [ ] Review all changes
  - [ ] Commit with proper message

## Dev Notes

### Architecture Alignment (v0.6.8)

From `docs/architecture/components.md#api-adapters` - CobraCLIAdapter (v0.5.11, updated v0.6.4):

**Responsibility:** Implement CLIPort by handling Cobra-specific command parsing, flag processing, and output formatting. Receives CommandPort from CommandOrchestrator to delegate business logic.

**SRP Decomposition Pattern:**

All public methods decompose into focused private methods following Single Responsibility Principle:

- **Public:** `Start(ctx, handler)` - Orchestrates command tree setup
- **Private Builders:** `buildRootCommand()`, `buildNewCommand()`, `buildVersionCommand()` - Construct commands
- **Private Handlers:** `handleNewCommand()` - Execute command workflows
- **Private Helpers:** `displayNoteCreated()`, `formatError()` - Single-purpose utilities

**Implementation Template:**

```go
type CobraCLIAdapter struct {
    handler CommandPort
    log     zerolog.Logger
}

func NewCobraCLIAdapter(log zerolog.Logger) *CobraCLIAdapter {
    return &CobraCLIAdapter{log: log}
}

func (a *CobraCLIAdapter) Start(ctx context.Context, handler CommandPort) error {
    a.handler = handler
    rootCmd := a.buildRootCommand()
    return rootCmd.ExecuteContext(ctx)
}

func (a *CobraCLIAdapter) buildRootCommand() *cobra.Command {
    cmd := &cobra.Command{
        Use:           "lithos",
        Short:         "Template-driven markdown note generator for Obsidian vaults",
        SilenceUsage:  true,
        SilenceErrors: true,
    }
    cmd.AddCommand(a.buildVersionCommand())
    cmd.AddCommand(a.buildNewCommand())
    return cmd
}

func (a *CobraCLIAdapter) buildVersionCommand() *cobra.Command {
    return &cobra.Command{
        Use:   "version",
        Short: "Print version information",
        RunE: func(cmd *cobra.Command, args []string) error {
            fmt.Println("lithos v0.1.0")
            return nil
        },
    }
}

func (a *CobraCLIAdapter) buildNewCommand() *cobra.Command {
    cmd := &cobra.Command{
        Use:   "new [template-id]",
        Short: "Create a new note from template",
        Args:  cobra.MaximumNArgs(1),
        RunE: func(cmd *cobra.Command, args []string) error {
            return a.handleNewCommand(cmd, args)
        },
    }
    cmd.Flags().BoolP("view", "v", false, "Display note content after creation")
    return cmd
}

func (a *CobraCLIAdapter) handleNewCommand(cmd *cobra.Command, args []string) error {
    if len(args) == 0 {
        return fmt.Errorf("template-id required")
    }

    templateID := domain.NewTemplateID(args[0])
    note, err := a.handler.NewNote(cmd.Context(), templateID)
    if err != nil {
        return a.formatError(err)
    }

    return a.displayNoteCreated(cmd, note)
}

func (a *CobraCLIAdapter) displayNoteCreated(cmd *cobra.Command, note domain.Note) error {
    fmt.Printf("✓ Created: %s.md\n", note.ID)

    if viewFlag, _ := cmd.Flags().GetBool("view"); viewFlag {
        fmt.Println(strings.Repeat("=", 80))
        // Read and display note content
        fmt.Println(strings.Repeat("=", 80))
    }

    return nil
}

func (a *CobraCLIAdapter) formatError(err error) error {
    var resourceErr *ResourceError
    if errors.As(err, &resourceErr) {
        return fmt.Errorf("Template '%s' not found", resourceErr.Target())
    }

    var templateErr *TemplateError
    if errors.As(err, &templateErr) {
        return fmt.Errorf("Template error: %s", templateErr.Error())
    }

    return fmt.Errorf("Error: %s", err.Error())
}
```

**Prerequisites:** Story 1.6 (Logger), Story 1.11 (CLIPort, CommandPort interfaces)

**Time Estimate:** 5 hours

**Architecture References:**
- Components: `docs/architecture/components.md#api-adapters` - CobraCLIAdapter
- Tech Stack: `docs/architecture/tech-stack.md` - cobra, pflag

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - No blocking issues encountered

### Completion Notes List

1. CobraCLIAdapter implemented following hexagonal architecture with clean SRP decomposition
2. All public methods delegate to focused private methods (buildRootCommand, buildVersionCommand, buildNewCommand)
3. Error formatting provides user-friendly messages for ResourceError and TemplateError
4. MockCommandPort added to tests/utils/mocks.go for comprehensive testing
5. Unit tests verify command structure, argument parsing, flag handling, and error scenarios
6. Quality gates: All tests pass, linting clean, architecture v0.6.8 compliant

### File List

#### Primary Implementation
- `/Users/jack/Documents/41_personal/lithos/internal/adapters/api/cli/cobra.go`

#### Test Files
- `/Users/jack/Documents/41_personal/lithos/internal/adapters/api/cli/cobra_test.go`
- `/Users/jack/Documents/41_personal/lithos/tests/utils/mocks.go` (MockCommandPort)

## QA Results

### Test Coverage Summary

**Unit Tests:**
- ✅ Start() stores handler correctly
- ✅ buildRootCommand() creates command tree with version and new subcommands
- ✅ Version command prints "lithos v0.1.0"
- ✅ New command parses template-id argument correctly
- ✅ New command parses --view flag correctly
- ✅ handleNewCommand() extracts templateID from args
- ✅ handleNewCommand() returns error when args empty
- ✅ handleNewCommand() calls handler.NewNote() with correct arguments
- ✅ displayNoteCreated() formats output without --view flag
- ✅ displayNoteCreated() displays content with --view flag
- ✅ formatError() formats ResourceError correctly
- ✅ formatError() formats TemplateError correctly
- ✅ formatError() formats generic error correctly

**Quality Gates:**
- ✅ `go test ./internal/adapters/api/cli` - All tests pass
- ✅ `golangci-lint run internal/adapters/api/cli` - No warnings or errors
- ✅ Test coverage >80%
- ✅ Architecture v0.6.8 compliant

### Key Validations

1. **Interface Implementation:** CobraCLIAdapter correctly implements CLIPort
2. **SRP Decomposition:** Public Start() delegates to private builders and handlers
3. **Error Handling:** User-friendly error messages for all error types
4. **Command Structure:** Proper Cobra command tree with root, version, and new commands
5. **Flag Parsing:** --view flag correctly parsed and processed
6. **Mock Integration:** MockCommandPort enables comprehensive testing without dependencies
