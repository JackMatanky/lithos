# Story 3.7: FrontmatterService

## Status

Draft

**Prerequisites:** Stories 3.1–3.6 (especially VaultIndexer and QueryService)

## Story

**As a** developer,
**I want** FrontmatterService to extract and validate frontmatter from markdown content,
**so that** VaultIndexer can create valid Note objects with validated frontmatter data.

## Acceptance Criteria

1. `internal/app/frontmatter/service.go` implements `Extract(content []byte) (Frontmatter, error)` method that parses YAML frontmatter from markdown content using goldmark with abhinav/goldmark-frontmatter extension.

2. `internal/app/frontmatter/service.go` implements `Validate(ctx context.Context, frontmatter Frontmatter, schema Schema) error` method that validates frontmatter fields against a provided schema using field validators.

3. Extract() method supports both YAML (`---`) and TOML (`+++`) frontmatter delimiters, handles edge cases (code blocks containing delimiters), and returns structured FrontmatterError for parse failures.

4. Validate() method enforces FR6/FR7 requirements: preserves unknown fields, validates required fields, enforces type constraints, and validates array vs scalar expectations without auto-coercion.

5. FrontmatterService depends only on SchemaEngine (for loading schemas) and Logger - **NO dependency on QueryService** to avoid circular dependencies.

6. Service uses interface-based field validation with polymorphic validators (StringValidator, NumberValidator, DateValidator, BoolValidator) for clean separation of validation logic.

7. All validation errors return structured FrontmatterError instances with schema name, field name, rule violated, actual value, and remediation message for CLI display.

8. Unit tests cover extraction scenarios (valid YAML/TOML, missing frontmatter, malformed content) and validation scenarios (required fields, type mismatches, unknown field preservation) using fake SchemaEngine.

9. `golangci-lint run ./internal/app/frontmatter` and `go test ./internal/app/frontmatter` succeed with >90% test coverage.

10. Integration with VaultIndexer: VaultIndexer calls SchemaEngine.Load() first, then FrontmatterService.Extract(), then loads appropriate schema and calls FrontmatterService.Validate() with the schema.

## Tasks / Subtasks

- [ ] Task 1: Implement FrontmatterService struct and constructor (AC: 1, 5)
  - [ ] RED: Write failing tests for FrontmatterService struct
    - [ ] Write test case expecting FrontmatterService struct exists
    - [ ] Write test case expecting NewFrontmatterService constructor
    - [ ] Write test case expecting SchemaEngine dependency injection
    - [ ] Write test case expecting Logger dependency injection
    - [ ] Verify tests fail (struct not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Create FrontmatterService struct
    - [ ] Define FrontmatterService struct with SchemaEngine and Logger fields
    - [ ] Implement NewFrontmatterService(schemaEngine *SchemaEngine, log Logger) constructor
    - [ ] Add interface compliance check if interface exists
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Add comprehensive GoDoc for FrontmatterService explaining purpose
    - [ ] Add GoDoc for constructor explaining dependencies
    - [ ] Verify single responsibility (frontmatter extraction and validation)
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint

- [ ] Task 2: Implement Extract() method with goldmark integration (AC: 1, 3)
  - [ ] RED: Write failing tests for Extract method
    - [ ] Write test case expecting Extract() method signature
    - [ ] Write test case for valid YAML frontmatter extraction
    - [ ] Write test case for valid TOML frontmatter extraction
    - [ ] Write test case for missing frontmatter (empty result)
    - [ ] Write test case for malformed frontmatter (structured error)
    - [ ] Write test case for edge cases (code blocks with delimiters)
    - [ ] Verify tests fail (method not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement Extract method
    - [ ] Add goldmark dependency: `go.abhg.dev/goldmark/frontmatter v0.2.0`
    - [ ] Implement Extract(content []byte) (Frontmatter, error) method
    - [ ] Use goldmark with frontmatter extension for parsing
    - [ ] Support both YAML and TOML frontmatter formats
    - [ ] Handle edge cases and return structured FrontmatterError
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Extract helper methods if Extract() exceeds 20 lines:
      - [ ] parseMarkdownWithFrontmatter(content []byte) (frontmatterData, error)
      - [ ] convertToFrontmatter(data map[string]interface{}) (Frontmatter, error)
    - [ ] Add comprehensive GoDoc explaining extraction logic
    - [ ] Add inline comments for goldmark usage
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`

- [ ] Task 3: Implement field validators with polymorphism (AC: 6)
  - [ ] RED: Write failing tests for field validator interface
    - [ ] Write test case expecting FieldValidator interface
    - [ ] Write test case expecting StringValidator implements FieldValidator
    - [ ] Write test case expecting NumberValidator implements FieldValidator
    - [ ] Write test case expecting DateValidator implements FieldValidator
    - [ ] Write test case expecting BoolValidator implements FieldValidator
    - [ ] Verify tests fail (validators not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement field validators
    - [ ] Create FieldValidator interface with Validate method
    - [ ] Implement StringValidator, NumberValidator, DateValidator, BoolValidator
    - [ ] Each validator handles specific PropertySpec types
    - [ ] Return structured FrontmatterError for validation failures
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Decompose validators into focused methods
    - [ ] Add comprehensive GoDoc for interface and implementations
    - [ ] Document validation rules for each PropertySpec type
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`

- [ ] Task 4: Implement Validate() method with schema parameter (AC: 2, 4, 7)
  - [ ] RED: Write failing tests for Validate method
    - [ ] Write test case expecting Validate(ctx, frontmatter, schema) signature
    - [ ] Write test case for required field validation
    - [ ] Write test case for type validation using field validators
    - [ ] Write test case for unknown field preservation (FR6)
    - [ ] Write test case for array vs scalar enforcement
    - [ ] Write test case for structured error aggregation
    - [ ] Verify tests fail (method not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement Validate method
    - [ ] Implement Validate(ctx context.Context, frontmatter Frontmatter, schema Schema) error
    - [ ] Required field validation against schema
    - [ ] Type validation using field validators
    - [ ] Unknown field preservation (FR6 compliance)
    - [ ] Array vs scalar enforcement without auto-coercion
    - [ ] Error aggregation with errors.Join
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Extract helper methods for validation concerns:
      - [ ] validateRequiredFields(frontmatter, schema) error
      - [ ] validateFieldTypes(frontmatter, schema) error
      - [ ] aggregateValidationErrors(errors []error) error
    - [ ] Add comprehensive GoDoc explaining validation logic
    - [ ] Document FR6/FR7 compliance
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`

- [ ] Task 5: Integration testing with SchemaEngine (AC: 5, 8, 10)
  - [ ] RED: Write failing integration tests
    - [ ] Write test for FrontmatterService with real SchemaEngine
    - [ ] Write test for VaultIndexer integration workflow
    - [ ] Write test for schema loading before validation
    - [ ] Verify tests fail (integration not complete)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement integration
    - [ ] Create fake SchemaEngine for testing
    - [ ] Test complete workflow: SchemaEngine.Load() → Extract() → Validate()
    - [ ] Verify error handling across service boundaries
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Clean up test helpers and fakes
    - [ ] Document integration patterns
    - [ ] Verify >90% test coverage

- [ ] Task 6: Quality gates and documentation (AC: 9)
  - [ ] Run `go test ./internal/app/frontmatter` and verify 100% pass
  - [ ] Run `golangci-lint run ./internal/app/frontmatter` and fix issues
  - [ ] Verify test coverage >90%: `go test -cover ./internal/app/frontmatter`
  - [ ] Add comprehensive GoDoc for all exported functions
  - [ ] Document integration patterns with VaultIndexer

## Dev Notes

### FrontmatterService Architecture

**Purpose:** Extract YAML/TOML frontmatter from markdown and validate against schema rules with strict type checking.

**Key Design Decisions:**

1. **No QueryService Dependency:** Avoids circular dependency - QueryService depends on indexed frontmatter, not live extraction
2. **Schema Parameter:** Validate() takes schema as parameter rather than looking it up, enabling flexible validation
3. **SchemaEngine Dependency:** For loading and resolving schemas before validation
4. **Goldmark Integration:** Uses production-ready frontmatter extension instead of custom parsing

### Dependencies

- **SchemaEngine:** For loading and resolving schemas
- **Logger:** For structured logging
- **Goldmark + Frontmatter Extension:** For robust frontmatter extraction

### Integration Pattern with VaultIndexer

```go
// VaultIndexer workflow
func (indexer *VaultIndexer) processFile(vf VaultFile) error {
    // 1. SchemaEngine loads schemas FIRST
    if err := indexer.schemaEngine.Load(ctx); err != nil {
        return err
    }

    // 2. Extract frontmatter from content
    frontmatter, err := indexer.frontmatterService.Extract(vf.Content)
    if err != nil {
        return err
    }

    // 3. Get schema for this file class
    schema, err := indexer.schemaEngine.GetSchema(frontmatter.FileClass)
    if err != nil {
        return err
    }

    // 4. Validate frontmatter against schema
    if err := indexer.frontmatterService.Validate(ctx, frontmatter, schema); err != nil {
        return err
    }

    // 5. Create Note and add to index
    note := Note{Frontmatter: frontmatter}
    return indexer.addToIndex(note)
}
```

### Error Handling

All errors use structured FrontmatterError with:
- Schema name
- Field name (if applicable)
- Rule violated
- Actual value
- Remediation message

### Testing Strategy

1. **Unit Tests:** Extract(), Validate(), field validators with fakes
2. **Integration Tests:** Full workflow with real SchemaEngine
3. **Edge Cases:** Malformed YAML, missing schemas, unknown fields
4. **Performance:** Large frontmatter extraction and validation

## Change Log

| Date       | Version | Description                                           | Author     |
| ---------- | ------- | ----------------------------------------------------- | ---------- |
| 2025-10-31 | 2.0     | Complete rewrite: removed QueryService dependency, fixed circular dependency, proper schema parameter pattern, goldmark integration | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
