# Story 5.2: Frontmatter FileSpec Validation with QueryService

## Status

Draft

## Story

**As a** developer,
**I want** FrontmatterService to validate FileSpec properties using QueryService,
**so that** file references are checked against the indexed vault.

## Acceptance Criteria

**FileSpec Validation Integration:**

- 5.2.1: Verify `FrontmatterService.Validate` identifies FileSpec properties from schema PropertySpec
- 5.2.2: Implement FileSpec validation that delegates to `QueryService.ByPath(ctx, filepath)` for each file reference
- 5.2.3: Verify validation accepts both absolute and relative paths (relative to vault root)
- 5.2.4: Verify validation normalizes paths before lookup (resolve `./`, `../`, remove trailing slashes)

**Wikilink Reference Support:**

- 5.2.5: Verify validation supports wikilink format `[[basename]]` in FileSpec fields
- 5.2.6: Implement wikilink resolution that strips brackets and queries by basename via QueryService
- 5.2.7: Verify wikilink validation handles ambiguous basenames (multiple matches) as error
- 5.2.8: Document wikilink support in `docs/architecture/components.md#frontmatterservice`

**Validation Error Format:**

- 5.2.9: Verify FileSpec validation errors return `ValidationError` instances with:
  - Field name (e.g., `"references"`)
  - Error reason (e.g., `"file not found"` or `"ambiguous wikilink"`)
  - Actual value (the invalid file path or wikilink)
  - Remediation message (suggest valid paths or warn about case sensitivity)

- 5.2.10: Implement multi-error aggregation for FileSpec arrays (validate all references, return all errors)

**Testing:**

- 5.2.11: Create unit tests in `internal/app/frontmatter/service_test.go`:
  - Test FileSpec validation: valid path, not found, ambiguous wikilink
  - Test wikilink resolution: `[[basename]]` format
  - Test path normalization: relative paths, `./`, `../`
  - Test error aggregation: multiple invalid FileSpec references

- 5.2.12: All tests pass: `go test ./internal/app/frontmatter`

- 5.2.13: All linting passes: `golangci-lint run --fix internal/app/frontmatter`

- 5.2.14: Committed with message: `feat(frontmatter): add FileSpec validation with QueryService integration`

## Tasks / Subtasks

- [ ] Task 1: Implement FileSpec detection in validation (AC: 5.2.1)
  - [ ] RED: Write failing test for FileSpec property detection
    - [ ] Write test case in `internal/app/frontmatter/service_test.go`
    - [ ] Create schema with `PropertySpec.Type == "file"`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] RED: Write failing test for FileSpec array detection
    - [ ] Write test case with `Property.Array == true`
    - [ ] Verify both single and array FileSpec detected
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Add logic to identify FileSpec by `PropertySpec.Type == "file"`
    - [ ] Handle both single FileSpec and FileSpec arrays
    - [ ] Run `go test ./internal/app/frontmatter` and verify all tests pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR:
    - [ ] Decompose into SRP components:
      - [ ] Extract registerFunction() if property detection grows >15 lines
      - [ ] Verify detection logic has single responsibility (identify FileSpec properties)
      - [ ] Consider: Extract isFileSpecProperty() helper if detection complex
    - [ ] Review naming: clear and descriptive (isFileSpecProperty, detectFileSpec)
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Document FileSpec detection logic
      - [ ] Explain single vs array handling
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
    - [ ] Verify test coverage >90% for FileSpec detection
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 2: Implement basic file path validation (AC: 5.2.2-5.2.4)
  - [ ] RED: Write failing test for valid file path
    - [ ] Write test case with file that exists in test vault
    - [ ] Verify validation succeeds
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] RED: Write failing test for file not found
    - [ ] Write test case with missing file
    - [ ] Verify ValidationError returned
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] RED: Write failing test for path normalization
    - [ ] Write test case with `./` and `../` in path
    - [ ] Verify path normalized before lookup
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Implement validateFileReference() delegating to QueryService.ByPath
    - [ ] Add path normalization logic
    - [ ] Support absolute and vault-relative paths
    - [ ] Run `go test ./internal/app/frontmatter` and verify all tests pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR:
    - [ ] Decompose into SRP components:
      - [ ] Extract executeFunction() if validation logic grows >15 lines
      - [ ] Extract buildQuery() for path normalization if >10 lines
      - [ ] Verify validateFileReference has single responsibility (validate one file)
    - [ ] Review naming: validateFileReference (clear), normalizePath (descriptive)
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Document validation workflow
      - [ ] Explain path normalization rules
      - [ ] Document QueryService integration
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
    - [ ] Verify test coverage >90% for file validation
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 3: Implement wikilink support (AC: 5.2.5-5.2.8)
  - [ ] RED: Write failing test for wikilink resolution
    - [ ] Write test case with `[[basename]]` format
    - [ ] Verify brackets stripped and basename queried
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] RED: Write failing test for ambiguous wikilink
    - [ ] Write test case with basename matching multiple files
    - [ ] Verify ValidationError with "ambiguous" message
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Implement resolveWikilink() to detect and strip brackets
    - [ ] Update validateFileReference to handle wikilinks
    - [ ] Check for ambiguous matches (QueryService returns multiple)
    - [ ] Run `go test ./internal/app/frontmatter` and verify all tests pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR:
    - [ ] Decompose into SRP components:
      - [ ] Extract buildQuery() for wikilink parsing if complex
      - [ ] Verify resolveWikilink has single responsibility (parse wikilink format)
      - [ ] Verify ambiguity check separate from validation
    - [ ] Review naming: resolveWikilink (clear), isWikilink (boolean check)
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Document wikilink format: `[[basename]]`
      - [ ] Explain ambiguity handling
      - [ ] Document error cases
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
    - [ ] Verify test coverage >90% for wikilink support
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 4: Implement ValidationError format (AC: 5.2.9-5.2.10)
  - [ ] RED: Write failing test for ValidationError structure
    - [ ] Verify error contains field, reason, value, remediation
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] RED: Write failing test for error aggregation
    - [ ] Write test with multiple invalid FileSpec references
    - [ ] Verify all errors returned (not just first)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failure
  - [ ] GREEN: Implement minimal code to pass tests
    - [ ] Create ValidationError instances with all fields
    - [ ] Aggregate errors for FileSpec arrays
    - [ ] Run `go test ./internal/app/frontmatter` and verify all tests pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR:
    - [ ] Decompose into SRP components:
      - [ ] Verify ValidationError creation has single responsibility
      - [ ] Verify error aggregation separate from validation
    - [ ] Review naming: clear error field names
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Document ValidationError structure
      - [ ] Explain error aggregation strategy
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 5: Run quality gates (AC: 5.2.12-5.2.13)
  - [ ] Run `go test ./internal/app/frontmatter` and verify 100% pass
  - [ ] Run `golangci-lint run --fix internal/app/frontmatter` and fix any issues
  - [ ] Verify test coverage is adequate (>90% for FileSpec validation)
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 6: Commit changes (AC: 5.2.14)
  - [ ] Review all changes
  - [ ] Stage files: `git add internal/app/frontmatter/service.go internal/app/frontmatter/service_test.go`
  - [ ] Commit with message: `feat(frontmatter): add FileSpec validation with QueryService integration`

## Dev Notes

### Architecture Alignment (v0.6.8)

From `docs/architecture/components.md#frontmatterservice`:

**Frontmatter Validation (Business Rules with Strict Type Checking):**

FrontmatterService.Validate() performs strict validation with in-memory type normalization for validation logic only. **Important:** Validation never modifies files—normalization is purely in-memory for validation purposes.

**Validation Workflow:**

1. **Schema Lookup:** Get schema from SchemaRegistry using frontmatter.FileClass
2. **Required Field Check:** Ensure all required properties present in frontmatter.Fields
3. **Array vs Scalar Check:** Verify array/scalar expectation matches (no auto-coercion)
4. **Type Normalization (In-Memory Only):** Normalize YAML types for validation logic without modifying files
5. **Constraint Validation:** Validate normalized value against PropertySpec constraints (pattern, min/max, enum, etc.)
6. **File Reference Validation:** For FileSpec properties, validate file exists via QueryService.ByPath()
7. **Error Aggregation:** Return all validation errors with field-level remediation hints

**File Reference Validation (Step 6 Detail):**

For PropertySpec with `Type: "file"`:

- Extract file path from frontmatter field value
- Support both filepath formats and wikilink format `[[basename]]`
- Normalize path (resolve relative to vault root, remove trailing slashes)
- Query vault via `QueryService.ByPath(ctx, normalizedPath)`
- Return ValidationError if file not found or ambiguous
- Include query hints in remediation message (similar paths, case corrections)

### QueryService Integration

From `docs/architecture/components.md#queryservice`:

**Key Interfaces:**

- `ByPath(ctx context.Context, path string) ([]Note, error)` - Find notes by path
  - Returns single note if file path (exact match)
  - Returns multiple notes if directory path (all notes in directory)
  - Returns empty slice if no matches
  - Case-sensitive matching

**Technology Stack:** In-memory indices backed by Go maps with `sync.RWMutex` for concurrent safety.

### Wikilink Format

**Wikilink Syntax:**

```yaml
# Single wikilink reference
references: "[[john-doe]]"

# Array of wikilinks
references:
  - "[[john-doe]]"
  - "[[jane-smith]]"

# Mixed format (wikilinks and paths)
references:
  - "[[john-doe]]"
  - "contacts/jane-smith.md"
```

**Wikilink Resolution Logic:**

```go
func (s *FrontmatterService) resolveWikilink(value string) (string, bool) {
    // Check if value matches [[basename]] format
    if strings.HasPrefix(value, "[[") && strings.HasSuffix(value, "]]") {
        basename := strings.TrimSuffix(strings.TrimPrefix(value, "[["), "]]")
        return basename, true
    }
    return value, false
}

func (s *FrontmatterService) validateFileReference(ctx context.Context, value string) error {
    // Resolve wikilink if applicable
    path, isWikilink := s.resolveWikilink(value)

    // Query vault
    notes, err := s.queryService.ByPath(ctx, path)
    if err != nil {
        return fmt.Errorf("query failed: %w", err)
    }

    // Handle results
    if len(notes) == 0 {
        hints := s.generateQueryHints(path, isWikilink)
        return NewValidationError("file not found", value, hints)
    }

    if len(notes) > 1 && isWikilink {
        basenames := extractBasenames(notes)
        hint := fmt.Sprintf("ambiguous wikilink [[%s]]: matches %v", path, basenames)
        return NewValidationError("ambiguous reference", value, hint)
    }

    return nil
}
```

### ValidationError Format

From `docs/architecture/error-handling-strategy.md`:

**ValidationError Structure:**

```go
type ValidationError struct {
    Field       string   // Frontmatter field name
    Reason      string   // Human-readable error reason
    Value       any      // The invalid value
    Remediation string   // Suggested fix or query hints
}

func (e ValidationError) Error() string {
    return fmt.Sprintf("validation failed for field %q: %s (value: %v). %s",
        e.Field, e.Reason, e.Value, e.Remediation)
}
```

**Example Error Messages:**

```
validation failed for field "references": file not found (value: [[john-doe]]).
Query hints: Did you mean [[john-smith]]? Similar: [john-smith.md, jane-doe.md]

validation failed for field "references": ambiguous reference (value: [[contact]]).
Query hints: ambiguous wikilink [[contact]]: matches [contact-1.md, contact-2.md]

validation failed for field "attachment": file not found (value: File.md).
Query hints: Case mismatch? Found: file.md
```

### Testing Standards

From `docs/architecture/testing-strategy.md` and `docs/architecture/coding-standards.md`:

**Unit Test Requirements:**

- Tests live in `internal/app/frontmatter/service_test.go`
- Use table-driven tests for different FileSpec scenarios
- Mock QueryService using test doubles from `tests/utils/mocks.go`
- Test both success and error cases

**TDD Workflow:**

- RED: Write failing test first
- GREEN: Implement minimum code to pass
- REFACTOR: Improve code quality while tests pass

**Quality Gates:**

- All tests pass: `go test ./internal/app/frontmatter`
- No linting errors: `golangci-lint run --fix internal/app/frontmatter`
- Test coverage >90% for FileSpec validation

### Refactoring Guidelines

**SRP Decomposition Examples:**

For FileSpec validation, SRP decomposition focuses on:

**FileSpec Detection:**

- isFileSpecProperty: Single responsibility = identify if property is FileSpec type
- If detection logic >10 lines, extract helper

**File Path Validation:**

- validateFileReference: Single responsibility = validate single file reference exists
- If validation logic >15 lines, extract executeFunction() helper
- normalizePath: Single responsibility = normalize path format before lookup
- If normalization >10 lines, extract buildQuery() helper

**Wikilink Resolution:**

- resolveWikilink: Single responsibility = parse wikilink format and extract basename
- isWikilink: Single responsibility = check if value is wikilink format
- If parsing complex, extract buildQuery() helper

**Error Handling:**

- createValidationError: Single responsibility = construct ValidationError with all fields
- aggregateErrors: Single responsibility = collect multiple validation errors

**When to Decompose:**

- If any method exceeds 15 lines, consider extraction
- If path normalization has >2 steps, extract helper
- If wikilink parsing mixes detection with extraction, separate concerns
- If error formatting mixes construction with message generation, separate

**Naming Standards:**

- Boolean checks: isXxx, hasXxx (isWikilink, isFileSpecProperty)
- Actions: validate, resolve, normalize (validateFileReference, resolveWikilink, normalizePath)
- Builders: build, create (buildQuery, createValidationError)
- Aggregators: aggregate, collect (aggregateErrors)

**Documentation Requirements:**

- Document FileSpec detection logic
- Explain wikilink format and resolution
- Document path normalization rules
- Explain error aggregation for arrays
- Document QueryService integration points

### Common Pitfalls to Avoid

1. **DO NOT skip path normalization** - Paths must be normalized before QueryService lookup
2. **DO NOT ignore ambiguous wikilinks** - Multiple matches is error condition
3. **DO NOT lose error context** - Aggregate all errors, don't fail on first
4. **DO validate all array elements** - Check every FileSpec reference in arrays
5. **DO include remediation hints** - Help users fix validation errors

## Change Log

| Date       | Version | Description                                                              | Author             |
| ---------- | ------- | ------------------------------------------------------------------------ | ------------------ |
| 2025-10-28 | 1.0     | Story created from Epic 5 requirements                                   | Bob (Scrum Master) |
| 2025-10-28 | 1.1     | Enhanced with full TDD framework, SRP decomposition, linting checkpoints | QA Specialist      |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent during implementation_

### Debug Log References

_To be completed by dev agent during implementation_

### Completion Notes List

_To be completed by dev agent during implementation_

### File List

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
