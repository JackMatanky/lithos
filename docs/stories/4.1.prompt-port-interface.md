# Story 4.1: PromptPort Contract

## Status

Draft

## Story

**As a** developer,
**I want** the PromptPort interface and configuration structs defined per the architecture,
**so that** interactive prompts can be implemented behind a stable SPI and templates can gather user input.

## Acceptance Criteria

**PromptPort Interface:**

- 4.1.1: Create `internal/ports/spi/prompt.go` declaring `PromptPort` interface with:
  - `Prompt(ctx context.Context, cfg PromptConfig) (string, error)` - Text input prompt
  - `Suggester(ctx context.Context, cfg SuggesterConfig) (string, error)` - Selection from list
  - GoDoc comments referencing FR10 in `docs/prd/requirements.md`

- 4.1.2: Define `PromptConfig` struct with fields:
  - `Name string` - Identifier for the prompt
  - `Label string` - User-facing prompt text
  - `Default string` - Default value if user provides no input
  - `Validator func(string) error` - Optional validation function
  - `NonInteractiveFallback string` - Value to use when TTY unavailable
  - Inline comments referencing architecture section

- 4.1.3: Define `SuggesterConfig` struct with fields:
  - `Name string` - Identifier for the suggester
  - `Label string` - User-facing prompt text
  - `Options []string` - List of choices
  - `Default string` - Default selection
  - `NonInteractiveFallback string` - Value to use when TTY unavailable
  - Inline comments referencing architecture section

**Error Handling:**

- 4.1.4: Document error handling expectations in GoDoc:
  - `InteractiveError` returned when TTY unavailable
  - Error messages must include remediation guidance
  - Reference `docs/architecture/error-handling-strategy.md`

**Quality Gates:**

- 4.1.5: Run `golangci-lint run ./internal/ports/spi` - all checks pass

- 4.1.6: Verify port interface follows ISP (Interface Segregation Principle):
  - PromptPort segregated from FinderPort
  - No unnecessary methods
  - Single responsibility: user input collection

- 4.1.7: Committed with message: `feat: add PromptPort interface and configuration structs`

## Tasks / Subtasks

- [ ] Task 1: Design PromptPort interface (AC: 4.1.1)
  - [ ] Create `internal/ports/spi/prompt.go`
  - [ ] Define `PromptPort` interface with Prompt and Suggester methods
  - [ ] Add comprehensive GoDoc comments:
    - [ ] Add package comment explaining SPI ports for interactive input
    - [ ] Add GoDoc for PromptPort interface referencing FR10
    - [ ] Document method signatures and return values
    - [ ] Document context usage and cancellation behavior
  - [ ] Document interface purpose and usage patterns
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/ports/spi`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 2: Define configuration structs (AC: 4.1.2-4.1.3)
  - [ ] Define `PromptConfig` struct with all required fields
  - [ ] Define `SuggesterConfig` struct with all required fields
  - [ ] Add comprehensive GoDoc comments:
    - [ ] Add GoDoc for PromptConfig explaining text input configuration
    - [ ] Add GoDoc for each field explaining purpose and usage
    - [ ] Add GoDoc for SuggesterConfig explaining selection configuration
    - [ ] Add examples of typical configuration usage
  - [ ] Add inline comments explaining each field
  - [ ] Reference architecture sections in comments
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/ports/spi`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 3: Document error handling (AC: 4.1.4)
  - [ ] Add GoDoc for InteractiveError expectations
  - [ ] Document remediation guidance requirements
  - [ ] Reference error-handling-strategy.md
  - [ ] Add examples of proper error messages
  - [ ] Add comprehensive GoDoc comments:
    - [ ] Document error types and when they should be returned
    - [ ] Provide example error messages with remediation
    - [ ] Explain context cancellation error handling

- [ ] Task 4: Add Interactive Port Documentation Standards section
  - [ ] Document port interface design principles
  - [ ] Document configuration struct patterns
  - [ ] Document error handling contracts
  - [ ] Document non-interactive fallback behavior
  - [ ] Reference architecture alignment

- [ ] Task 5: Quality verification (AC: 4.1.5-4.1.6)
  - [ ] Run golangci-lint on ports/spi directory
  - [ ] Verify ISP compliance
  - [ ] Review interface segregation from FinderPort
  - [ ] Confirm single responsibility
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/ports/spi`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 6: Commit changes (AC: 4.1.7)
  - [ ] Review all changes
  - [ ] Commit with proper message
  - [ ] Verify commit follows conventional commit format

## Dev Notes

### Port Location and Architecture

From `docs/architecture/components.md#promptport`:

**Responsibility:** Deliver interactive UX primitives (prompts, suggesters) to template engine for `{{prompt}}` and `{{suggester}}` template functions. Segregated from FinderPort per ISP.

**Key Interfaces:**
- `Prompt(ctx context.Context, cfg PromptConfig) (string, error)` - Text input prompt
- `Suggester(ctx context.Context, cfg SuggesterConfig) (string, error)` - Selection from list

**Dependencies:** Implemented by PromptUIAdapter.

**Technology Stack:** `github.com/manifoldco/promptui`, `golang.org/x/term` for TTY detection.

**Note:** Post-MVP (Phase 4) will migrate to `charmbracelet/huh` + `charmbracelet/bubbletea` for TUI support. Port abstraction enables this swap without changing TemplateEngine.

### Configuration Fields

From `docs/prd/epic-4-interactive-input-engine.md`:

**PromptConfig and SuggesterConfig** expose the documented fields:
- Name - Identifier for the prompt/suggester
- Label - User-facing prompt text
- Default - Default value/selection
- Options - List of choices (SuggesterConfig only)
- Validator - Optional validation function (PromptConfig only)
- NonInteractiveFallback - Value when TTY unavailable

### Error Handling Strategy

From `docs/architecture/error-handling-strategy.md`:

Port documentation must state error handling expectations:
- `InteractiveError` type for non-TTY environments
- Error messages must include remediation guidance
- Example: "Interactive prompt unavailable: not a TTY. Use --non-interactive mode or set environment variable"

### Interface Segregation

From `docs/architecture/components.md`:

PromptPort is segregated from FinderPort per ISP (Interface Segregation Principle):
- **PromptPort:** Text input and list selection (used by TemplateEngine)
- **FinderPort:** Fuzzy finding for template selection (used by CLI adapter)

This separation ensures:
- TemplateEngine doesn't depend on fuzzy finder functionality
- CLI adapter can inject different finders without affecting templates
- Clean substitution for TUI/LSP adapters in post-MVP phases

### SPI Port Pattern

From `docs/architecture/source-tree.md`:

**SPI Ports Location:** `internal/ports/spi/`
- Secondary/driven port interfaces
- Define contracts for infrastructure services
- Domain depends on these abstractions, not concrete implementations
- Adapters in `internal/adapters/spi/` implement these ports

**Port Naming Convention:**
- Interface suffix: `Port` (e.g., PromptPort, FinderPort)
- Config suffix: `Config` (e.g., PromptConfig, SuggesterConfig)
- Pure Go interfaces with no framework dependencies

### FR10 Reference

From `docs/prd/requirements.md#fr10`:

**FR10: Interactive Input Collection**
- Templates can prompt users for input during rendering
- Support for text input prompts
- Support for selection from predefined lists
- Graceful fallback for non-interactive environments
- Clear error messages with remediation guidance

### Interactive Port Documentation Standards

**Port Interface Design:**

Interfaces should be minimal and focused:
- Single responsibility (user input collection)
- Method signatures use context for cancellation
- Configuration structs externalize parameters
- No framework dependencies in interface definition

**Configuration Struct Patterns:**

Configuration structs should:
- Use simple types (string, []string, func)
- Include NonInteractiveFallback for graceful degradation
- Document field usage in inline comments
- Reference architecture sections

**Error Handling Contracts:**

Port implementations must:
- Return InteractiveError for TTY issues
- Include remediation guidance in all errors
- Respect context cancellation
- Wrap underlying errors with context

**Non-Interactive Fallback Behavior:**

When TTY unavailable:
- Check NonInteractiveFallback first
- Return InteractiveError if fallback empty
- Log warning when using fallback
- Document fallback behavior in port comments

### Testing Considerations

From `docs/architecture/testing-strategy.md`:

Port interfaces enable trivial test setup:
```go
// Mock PromptPort for testing
type MockPromptPort struct {
    PromptFunc    func(ctx context.Context, cfg PromptConfig) (string, error)
    SuggesterFunc func(ctx context.Context, cfg SuggesterConfig) (string, error)
}

// Use in tests without real TTY interaction
engine := NewTemplateEngine(mockPromptPort, ...)
```

Unit tests should verify:
- Interface method signatures match documentation
- Configuration structs have expected fields
- GoDoc comments reference correct documentation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 4 requirements | Bob (Scrum Master) |
| 2025-10-28 | 1.1 | Applied quality fixes: comprehensive GoDoc, linting checkpoints, Interactive Port Documentation Standards section | QA Specialist |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent during implementation_

### Debug Log References

_To be completed by dev agent during implementation_

### Completion Notes List

_To be completed by dev agent during implementation_

### File List

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
