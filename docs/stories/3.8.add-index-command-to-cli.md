# Story 3.8: Add Index Command to CLI

## Status

Draft

## Story

As a user, I want to run `lithos index` through the CLI adapter, so that I can trigger vault indexing through the proper architectural layers.

## Acceptance Criteria

- 3.8.1: CobraCLIAdapter includes `index` subcommand that calls CLICommandPort.Index method.
- 3.8.2: CommandOrchestrator implements Index method that delegates to VaultIndexer.
- 3.8.3: Command returns structured IndexStats and logs progress through proper service layers.
- 3.8.4: CLI handles errors gracefully and provides user-friendly feedback.

## Tasks / Subtasks

- [ ] Task 1 (AC: 3.8.1): Add `index` command to Cobra CLI
  - [ ] In `internal/adapters/api/cobra.go`, add a new `indexCmd` to the root command.
  - [ ] The `indexCmd` should call a new `Index` method on the `CLICommandPort`.
- [ ] Task 2 (AC: 3.8.2): Implement `Index` method in `CommandOrchestrator`
  - [ ] In `internal/app/command/orchestrator.go`, implement the `Index(ctx context.Context) (IndexStats, error)` method.
  - [ ] This method should delegate the call to the `VaultIndexer.Rebuild` method.
- [ ] Task 3 (AC: 3.8.3, 3.8.4): Handle Command Output and Errors
  - [ ] The `indexCmd` in the `CobraCLIAdapter` should receive the `IndexStats` and any error from the `CommandOrchestrator`.
  - [ ] If the command is successful, print the `IndexStats` to the console in a user-friendly format.
  - [ ] If the command fails, log the error and print a user-friendly error message to the console.
- [ ] Task 4: Add Integration Tests
  - [ ] Add integration tests for the `lithos index` command in `tests/integration/index_command_test.go`.
  - [ ] Test the successful execution of the command and verify the output.
  - [ ] Test the command with errors and verify the error handling.
- [ ] Task 5: Full method and function decomposition into private srp function while ensuring a logical file organization.
- [ ] Task 6: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass
- [ ] Task 7: Pre-commit and commit readiness
  - [ ] Execute `pre-commit run` to confirm hooks pass
  - [ ] Stage updates and commit with a fully descriptive conventional commit message

## Dev Notes

### Data Models
- `IndexStats` will be returned from the `CommandOrchestrator` and displayed to the user. [Source: docs/architecture/components.md#commandorchestrator]

### Component Specifications
- The `CobraCLIAdapter` is the entry point for the `lithos index` command. [Source: docs/architecture/components.md#cobracliadapter]
- The `CommandOrchestrator` delegates the indexing task to the `VaultIndexer`. [Source: docs/architecture/components.md#commandorchestrator]
- The `CLICommandPort` defines the `Index` method that the `CobraCLIAdapter` will call. [Source: docs/architecture/components.md#clicommandport]
- **Dependency Note:** This story depends on Stories 3.3-3.6 for VaultIndexer (rebuilds vault index with file scanning, frontmatter extraction, and caching) and IndexStats (indexing metrics structure with file counts, duration, etc.).
- **Key Domain Terms:** VaultIndexer (domain service that orchestrates vault scanning and indexing), IndexStats (structure containing indexing results like file counts and duration), CommandOrchestrator (service that coordinates CLI commands with domain services).

### File Locations
- `CobraCLIAdapter` is in `internal/adapters/api/cobra.go`. [Source: docs/architecture/source-tree.md#source-tree]
- `CommandOrchestrator` is in `internal/app/command/orchestrator.go`. [Source: docs/architecture/source-tree.md#source-tree]
- `CLICommandPort` is in `internal/ports/api/cli.go`. [Source: docs/architecture/source-tree.md#source-tree]

### Testing Requirements
- Integration tests should be used to test the `lithos index` command from end to end. [Source: docs/architecture/testing-strategy.md#integration-tests]
- Mocks should be used for the `VaultIndexer` in the `CommandOrchestrator` unit tests. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Technical Constraints
- The command should provide clear feedback to the user about the progress and result of the indexing operation. [Source: docs/prd/epic-3-vault-indexing-engine.md#story-3-8-add-index-command-to-cli]

## Change Log

| Date       | Version | Description                                  | Author |
| ---------- | ------- | -------------------------------------------- | ------ |
| 2025-10-22 | 1.0     | Initial story draft for index CLI command.   | sm     |
| 2025-10-23 | 1.1     | Added dependency summaries and term explanations | sm     |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
