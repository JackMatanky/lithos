# Story 2.4: Implement Schema Engine Port and Adapter

## Status

Approved

## Story

As a developer, I want to implement the SchemaEnginePort and SchemaLoaderAdapter, so that schemas can be loaded from JSON files following the architecture.

## Acceptance Criteria

**Functional Requirements:**

2.4.1: `internal/ports/spi/` contains SchemaEnginePort interface with LoadSchemas and LoadPropertyBank methods.
2.4.2: `internal/adapters/spi/schema/` contains SchemaLoaderAdapter implementing SchemaEnginePort.
2.4.3: Adapter scans for `.json` files in `schemas/` directory per `docs/architecture/tech-stack.md#json-processing`.
2.4.4: Property bank files are loaded from `schemas/_fields/` directory with `$ref` resolution.
2.4.5: JSON parsing uses Go stdlib `encoding/json` with structured error handling.

**Integration Requirements:**

2.4.6: SchemaEnginePort follows hexagonal architecture patterns for SPI interfaces.
2.4.7: SchemaLoaderAdapter integrates with FileSystemPort for file operations.
2.4.8: Adapter uses ConfigPort to access schema directory configuration.

**Quality Requirements:**

2.4.9: Unit tests cover SchemaLoaderAdapter behavior and error handling.
2.4.10: Code follows project coding standards and naming conventions.
2.4.11: Structured error handling for malformed JSON and missing files.

## Tasks / Subtasks

- [ ] Task 1: Define SchemaEnginePort interface (AC: 2.4.1, 2.4.6)
  - [ ] Create `internal/ports/spi/schema.go` with SchemaEnginePort interface
  - [ ] Define LoadSchemas method: `LoadSchemas(ctx context.Context) ([]SchemaDefinition, error)`
  - [ ] Define LoadPropertyBank method: `LoadPropertyBank(ctx context.Context) ([]PropertyDefinition, error)`
  - [ ] Define SchemaDefinition and PropertyDefinition types for return values
  - [ ] Ensure interface follows hexagonal architecture patterns per components.md

- [ ] Task 2: Implement SchemaLoaderAdapter (AC: 2.4.2, 2.4.3, 2.4.7, 2.4.8)
  - [ ] Create `internal/adapters/spi/schema/loader_adapter.go` implementing SchemaEnginePort
  - [ ] Implement constructor with dependency injection for FileSystemPort and ConfigPort
  - [ ] Implement LoadSchemas method:
    - Use ConfigPort.Config() to get schema directory path
    - Use FileSystemPort.Walk() to scan for .json files in schemas/ directory
    - Parse each JSON file using Go stdlib encoding/json
    - Return []SchemaDefinition with parsed schema data
    - Handle file access errors with SchemaError wrapping
  - [ ] Add security validation for file paths within configured schema directory bounds
  - [ ] Follow adapter patterns from existing adapters (LocalFileSystemAdapter, ConfigViperAdapter)

- [ ] Task 3: Implement property bank loading (AC: 2.4.4)
  - [ ] Implement LoadPropertyBank method scanning schemas/_fields/ directory using FileSystemPort.Walk
  - [ ] Parse property bank JSON files using Go stdlib encoding/json
  - [ ] Implement $ref resolution algorithm:
    - Parse JSON and detect $ref attributes using JSON pointer syntax
    - Resolve references by looking up property ID in loaded property bank registry
    - Substitute reference with actual property definition
    - Handle nested references and circular reference detection
  - [ ] Return []PropertyDefinition with resolved properties for SchemaRegistry consumption

- [ ] Task 4: Add JSON processing and error handling (AC: 2.4.5, 2.4.11)
  - [ ] Use Go stdlib encoding/json for schema file parsing per tech-stack.md
  - [ ] Implement structured error handling using shared errors package:
    - SchemaError for schema loading/resolution errors (schema name, message)
    - FileSystemError for file I/O failures (operation, path, cause)
    - Use error wrapping functions: Wrap(), WrapWithContext()
  - [ ] Handle missing files with clear error messages including file path context
  - [ ] Validate JSON schema structure and provide detailed error messages for malformed JSON
  - [ ] Add path validation for security: ensure schema directory access is within configured bounds

- [ ] Task 5: Add comprehensive testing (AC: 2.4.9, 2.4.10)
  - [ ] Create `internal/adapters/spi/schema/loader_adapter_test.go` with table-driven unit tests
  - [ ] Add tests with mocked FileSystemPort and ConfigPort dependencies using test doubles
  - [ ] Test scenarios include:
    - Successful schema loading from valid JSON files
    - Property bank loading with $ref resolution
    - Error handling for malformed JSON files with specific error validation
    - Missing file and directory access error handling
    - Security validation: directory traversal prevention, path validation
    - Concurrent access safety for SchemaRegistry integration
  - [ ] Add integration tests with actual JSON test fixtures in testdata/
  - [ ] Test $ref resolution with various reference patterns and circular reference detection
  - [ ] Performance tests for large schema files and concurrent loading scenarios
  - [ ] Ensure â‰¥85% test coverage for adapter implementations per testing-strategy.md

## Dev Notes

**Previous Story Insights:**
- Stories 2.1-2.3 will implement Config, Schema, and Property models providing foundation
- This story builds on existing FileSystemPort and ConfigPort from Epic 1
- Hexagonal architecture patterns established in Story 1.14/1.15 provide guidance

**Data Models:**
- SchemaEnginePort interface defined per `docs/architecture/components.md#schemaengineport`
- SchemaDefinition type containing parsed schema data from JSON files
- PropertyDefinition type containing property bank entries after $ref resolution
- SchemaLoaderAdapter implements port using filesystem abstractions per components.md
- Property bank support with $ref resolution using JSON pointer syntax per data-models.md
- Integration with Schema and Property domain models from Stories 2.2 and 2.3

**API Specifications:**
- SchemaEnginePort interface per components.md with specific method signatures:
  - `LoadSchemas(ctx context.Context) ([]SchemaDefinition, error)` - Load schema files from schemas/ directory
  - `LoadPropertyBank(ctx context.Context) ([]PropertyDefinition, error)` - Load property banks from schemas/_fields/
- SchemaLoaderAdapter implements SchemaEnginePort using filesystem abstractions per components.md
- Integration with SchemaRegistry domain service per components.md dependency chain
- Error handling follows shared errors package with SchemaError and FileSystemError types

**Component Specifications:**
- SchemaEnginePort located in `internal/ports/spi/schema.go`
- SchemaLoaderAdapter located in `internal/adapters/spi/schema/loader_adapter.go`
- Follows hexagonal architecture with port interface and concrete adapter

**File Locations:**
- Port interface: `internal/ports/spi/schema.go` (create new)
- Adapter implementation: `internal/adapters/spi/schema/loader_adapter.go` (create new)
- Tests: `internal/adapters/spi/schema/loader_adapter_test.go` (create new)

**Testing Requirements:**
- Unit tests for SchemaLoaderAdapter with mocked FileSystemPort and ConfigPort dependencies
- Unit tests for SchemaEnginePort interface compliance and method signatures
- Integration tests for schema loading from actual JSON files with various structures
- Error handling tests for malformed JSON, missing files, and directory access errors
- $ref resolution tests for property bank references including circular reference detection
- Security tests for path validation and directory traversal prevention
- Performance tests for large schema files and property bank resolution
- Concurrent access tests for thread-safe SchemaRegistry integration

**Technical Constraints:**
- Follow hexagonal architecture: port in SPI ports, adapter in SPI adapters per components.md
- Use dependency injection for FileSystemPort and ConfigPort following established patterns
- Use Go stdlib `encoding/json` for parsing with structured error handling per tech-stack.md
- Support $ref resolution in property banks using JSON pointer syntax per data-models.md
- Follow coding-standards.md: Go 1.23+ features, Result pattern for port boundaries if needed
- Ensure thread-safe implementation for concurrent SchemaRegistry usage
- Use shared errors package for consistent error types (SchemaError, FileSystemError)
- Implement security validation for file path access within configured schema directory bounds

**Source References:**
- [Architecture: docs/architecture/components.md#schemaengineport] - Interface specification and method signatures
- [Architecture: docs/architecture/components.md#schemaloaderadapter] - Adapter implementation requirements
- [Architecture: docs/architecture/components.md#schemaregistry] - SchemaRegistry domain service integration
- [Architecture: docs/architecture/data-models.md#propertybank] - $ref resolution algorithm specification
- [Architecture: docs/architecture/source-tree.md] - File location in internal/ports/spi/ and internal/adapters/spi/
- [Architecture: docs/architecture/tech-stack.md#json-processing] - Go stdlib encoding/json usage
- [Architecture: docs/architecture/coding-standards.md#core-standards] - Go 1.23+ standards and Result patterns
- [Architecture: docs/architecture/testing-strategy.md#unit-tests] - Testing patterns and coverage targets
- [Architecture: docs/architecture/components.md#error-package] - Shared error types and handling patterns

### Context Source

- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: SPI port and adapter implementation for schema loading
- **Integration Points**: SchemaEnginePort used by SchemaRegistry service, SchemaLoaderAdapter implements filesystem schema loading
- **Goal**: Establish infrastructure layer for loading schema definitions from JSON files

### Technical Guidance

#### Existing System Context

- **Current State**: FileSystemPort and ConfigPort exist, Schema/Property domain models in development
- **Technology Stack**: Go 1.23+ with stdlib JSON for parsing, hexagonal architecture patterns
- **Integration Points**: SchemaEnginePort used by SchemaRegistry, SchemaLoaderAdapter provides filesystem implementation
- **Architecture Pattern**: SPI port interface with concrete adapter implementation

#### Integration Approach

- **Port Definition**: Define clean interface contract for schema loading operations
- **Adapter Implementation**: Concrete filesystem-based implementation using existing ports
- **Directory Scanning**: Use FileSystemPort for scanning schemas/ and _fields/ directories
- **JSON Processing**: Leverage Go stdlib with structured error handling

#### Technical Constraints

- **Hexagonal Architecture**: SchemaEnginePort belongs in SPI ports, adapter in SPI adapters
- **Dependency Injection**: Adapter depends on FileSystemPort and ConfigPort
- **JSON Format**: Use stdlib encoding/json for schema file parsing
- **Error Handling**: Follow project error handling patterns with structured errors

#### Key Files to Modify/Create

- `internal/ports/spi/schema.go` - **CREATE** - SchemaEnginePort interface definition
- `internal/adapters/spi/schema/loader_adapter.go` - **CREATE** - SchemaLoaderAdapter implementation
- `internal/adapters/spi/schema/loader_adapter_test.go` - **CREATE** - Unit tests for adapter

#### Testing Strategy

- **Unit Tests**: Test SchemaLoaderAdapter with mocked FileSystemPort and ConfigPort
- **Integration Tests**: Test schema loading from actual JSON files
- **Error Tests**: Test error handling for malformed JSON and missing files

### Definition of Done

- [ ] SchemaEnginePort interface defined with specific method signatures per components.md
- [ ] SchemaDefinition and PropertyDefinition types defined for return values
- [ ] SchemaLoaderAdapter implements SchemaEnginePort with JSON file scanning using FileSystemPort.Walk
- [ ] Adapter scans schemas/ directory for .json files and _fields/ for property banks per tech-stack.md
- [ ] Property bank loading includes $ref resolution using JSON pointer syntax per data-models.md
- [ ] JSON parsing uses Go stdlib `encoding/json` with structured error handling per tech-stack.md
- [ ] Error handling uses shared errors package (SchemaError, FileSystemError) per components.md
- [ ] Security validation prevents directory traversal and validates file paths
- [ ] Hexagonal architecture patterns followed for port and adapter per components.md
- [ ] Integration with FileSystemPort and ConfigPort working correctly with dependency injection
- [ ] Thread-safe implementation for concurrent SchemaRegistry usage
- [ ] Unit and integration tests pass with â‰¥85% coverage per testing-strategy.md
- [ ] Code follows project coding-standards.md: Go 1.23+ features and naming conventions
- [ ] Performance optimized for large schema files and concurrent access

### Risk Assessment

#### Implementation Risks

- **Primary Risk**: Complex $ref resolution in property banks may introduce parsing bugs
- **Mitigation**: Implement incrementally with comprehensive unit tests
- **Verification**: Test property bank resolution with various reference scenarios

#### Rollback Plan

- **Git Rollback**: Revert to previous commit if schema loading fails
- **File Removal**: Delete new schema adapter files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

#### Performance Considerations

- **File System Scanning**: Efficient directory walking using FileSystemPort.Walk with early termination
- **JSON Parsing**: Use streaming JSON parser for large schema files to minimize memory allocation
- **$ref Resolution**: Cache resolved property definitions to avoid repeated resolution overhead
- **Concurrent Safety**: Design for thread-safe access by SchemaRegistry domain service
- **Error Context**: Minimize allocation in error paths using efficient error wrapping

#### Security Considerations

- **Path Validation**: Validate all file paths are within configured schema directory bounds
- **Directory Traversal Prevention**: Reject paths containing ".." or absolute paths outside vault
- **File Access Permissions**: Verify read permissions before attempting file operations
- **JSON Security**: Protect against malformed JSON that could cause excessive memory allocation
- **Schema Content Validation**: Basic validation of schema structure before processing

## Testing

### Testing Strategy

- **Unit Tests**: Test SchemaLoaderAdapter with mocked FileSystemPort and ConfigPort
- **Integration Tests**: Test schema loading from actual JSON files
- **Error Tests**: Test error handling for malformed JSON and missing files

### Testing Standards

- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use mocked dependencies for isolated unit testing
- Test both success and failure cases
- Target â‰¥85% coverage for adapter implementations per testing-strategy.md

## QA Results

*This section will be populated by the QA Agent during review of the completed story implementation*

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft for Schema Engine Port and Adapter implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- SchemaEnginePort interface from components.md
- SchemaLoaderAdapter implementation patterns from architecture
- JSON processing requirements from tech-stack.md

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- Port and adapter requirements extracted from components.md
- JSON processing and $ref resolution requirements included
- Testing strategy aligned with project standards

### File List

**Files to Create/Modify:**
- `internal/ports/spi/schema.go` - SchemaEnginePort interface definition
- `internal/adapters/spi/schema/loader_adapter.go` - SchemaLoaderAdapter implementation
- `internal/adapters/spi/schema/loader_adapter_test.go` - Unit tests for adapter
