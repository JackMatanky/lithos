# Story 1.9: Implement the `new` Command and Template Reading

## Status

Done

## Story

As a developer, I want to add a `new` command that reads a template file using the `FileSystemPort`, so that the command is wired into the architecture.

## Acceptance Criteria

- 1.9.1: A `new` subcommand is added to the Cobra adapter.
- 1.9.2: The command accepts a `<template-path>` argument.
- 1.9.3: The command's `RunE` function is injected with the `FileSystemPort`.
- 1.9.4: The command successfully uses the port to read the specified template file into memory.
- 1.9.5: A clear error is shown if the file does not exist, and the error originates from the adapter, not the command logic itself.

## Tasks / Subtasks

- [x] Task 1: Add `new` subcommand to CobraCLIAdapter (AC: 1.9.1, 1.9.2)
  - [x] Modify internal/adapters/api/cli/cobra_adapter.go to add new command
  - [x] Implement command with <template-path> argument
- [x] Task 2: Inject FileSystemPort into command (AC: 1.9.3)
  - [x] Update command constructor to accept FileSystemPort
  - [x] Wire port injection in main.go or adapter setup
- [x] Task 3: Implement template reading logic (AC: 1.9.4, 1.9.5)
  - [x] Add RunE function that calls FileSystemPort.ReadFile
  - [x] Handle file not found errors properly
  - [x] Log success or error appropriately
- [x] Task 4: Add unit tests for new command
  - [x] Create tests in internal/adapters/api/cli/
  - [x] Test successful file reading
  - [x] Test error handling for missing files
- [x] Task 5: Run tests and verify implementation
  - [x] Execute go test ./internal/adapters/api/cli/
  - [x] Verify all tests pass
  - [x] Run golangci-lint to ensure code standards
- [x] Task 6: Pass pre-commit hooks and commit changes
  - [x] Run pre-commit hooks
  - [x] Commit with conventional commit message

## Dev Notes

### Previous Story Insights

Story 1.8 integrated Cobra and created the CLI adapter structure. This story builds on that by adding the first command to the adapter, following the established pattern of injecting ports into command RunE functions.

### FileSystemPort Specifications

[Source: docs/architecture/components.md#filesystemport]

**Responsibility:** Provide safe file read/write/walk operations so domain services can interact with the vault without importing `os`.

**Key Interfaces:**

- `ReadFile(path string) ([]byte, error)`
- `WriteFileAtomic(path string, data []byte) error`
- `Walk(root string, fn WalkFunc) error`

**Dependencies:** Implemented by LocalFileSystemAdapter.

**Technology Stack:** Go `os`, `io`, and atomic write helpers (temp file + rename); honors config-defined vault roots.

### File Locations

[Source: docs/architecture/source-tree.md]

- CLI Adapter: internal/adapters/api/cli/cobra_adapter.go
- Main entry: cmd/lithos/main.go

### Technology Stack

[Source: docs/architecture/tech-stack.md]

- CLI Framework: github.com/spf13/cobra v1.9.1
- Go version: 1.23+ minimum

### Testing Requirements

[Source: docs/architecture/testing-strategy.md]

- Unit tests for adapter in internal/adapters/api/cli/
- Integration tests for CLI command flows
- Test coverage ≥85% for adapter package

## Change Log

| Date       | Version | Description                              | Author             |
| ---------- | ------- | ---------------------------------------- | ------------------ |
| 2025-01-12 | 1.0     | Initial story creation                   | Bob (Scrum Master) |
| 2025-10-19 | 1.1     | Implemented new command with FileSystemPort injection | dev                |

## Dev Agent Record

### Agent Model Used

dev

### Debug Log References

- CLI build and test execution logs
- File system port injection verification
- Template reading functionality testing

### Completion Notes List

- Successfully implemented `new` subcommand with `<template-path>` argument
- Injected FileSystemPort into CLI adapter constructor and command RunE function
- Added comprehensive unit tests covering success and error scenarios
- Verified error handling for missing files with clear error messages
- All tests pass and CLI functionality confirmed through manual testing
- Code follows hexagonal architecture patterns with proper port injection

### File List

- cmd/lithos/main.go - Updated to create and inject FileSystemPort
- internal/adapters/api/cli/cobra_adapter.go - Added new command and FileSystemPort injection
- internal/adapters/api/cli/cobra_adapter_test.go - Added unit tests for new command

## QA Results

### Review Date: 2025-10-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Architecture Compliance:** ✓ Excellent implementation of hexagonal architecture with proper port injection. FileSystemPort is correctly injected into the CLI adapter constructor and used in the command RunE function.

**Code Quality:** ✓ Clean, well-documented code following Go conventions. Proper error handling with contextual messages. No linting violations.

**Error Handling:** ✓ Clear, user-friendly error messages that originate from the adapter layer as required. File not found errors are properly wrapped with template path context.

### Refactoring Performed

No refactoring needed - implementation is solid and follows all established patterns.

### Compliance Check

- Coding Standards: ✓ Passes golangci-lint with 0 issues
- Project Structure: ✓ Follows established adapter patterns
- Testing Strategy: ✓ Comprehensive unit tests with proper mocking
- All ACs Met: ✓ All 5 acceptance criteria fully implemented and tested

### Requirements Traceability

**AC 1.9.1:** new subcommand added to Cobra adapter ✓
- Verified: `newCmd` added to `setupCommands()` and registered with root command

**AC 1.9.2:** Accepts `<template-path>` argument ✓
- Verified: `Args: cobra.ExactArgs(1)` and `Use: "new <template-path>"`

**AC 1.9.3:** FileSystemPort injected into command ✓
- Verified: Port injected in constructor, stored in struct, used in RunE

**AC 1.9.4:** Successfully reads template file using port ✓
- Verified: `a.fileSystemPort.ReadFile(templatePath)` called in RunE

**AC 1.9.5:** Clear error for missing files from adapter ✓
- Verified: Error wrapped with template path and originates from port call

### Test Architecture Assessment

**Coverage:** ✓ Comprehensive unit tests covering:
- Successful file reading with content verification
- File not found error handling
- Missing arguments validation
- Existing commands (version, help) still work

**Quality:** ✓ Proper mocking of FileSystemPort, table-driven test structure, clear assertions on both exit codes and output capture.

**Testability:** ✓ High - well-isolated unit tests with controlled dependencies.

### Security Review

**Input Validation:** ✓ Template path accepted as argument, no injection risks in current implementation.

**Error Messages:** ✓ No sensitive information leaked in error messages.

**File Access:** ✓ Uses abstracted FileSystemPort, no direct OS calls in adapter.

### Performance Considerations

**Efficiency:** ✓ Simple file read operation with no performance concerns for this foundational command.

**Scalability:** ✓ Command structure supports future enhancement without performance impact.

### NFR Validation

**Security:** PASS - No security issues identified
**Performance:** PASS - Efficient implementation
**Reliability:** PASS - Proper error handling and testing
**Maintainability:** PASS - Clean code, good documentation, comprehensive tests

### Files Modified During Review

None - implementation is solid and requires no changes.

### Gate Status

Gate: PASS → docs/qa/gates/1.9-implement-the-new-command-and-template-reading.yml

### Recommended Status

✓ Ready for Done - All acceptance criteria met, comprehensive testing, no issues found.
