# Story 2.6: Implement Inheritance Resolution

## Status

Approved

## Story

As a developer, I want to implement inheritance resolution in the SchemaRegistry, so that schema hierarchies are properly resolved.

## Acceptance Criteria

**Functional Requirements:**

2.6.1: Builder pattern resolves inheritance by: loading all schemas → building dependency graph → detecting cycles → resolving in topological order.
2.6.2: ResolvedProperties are computed by merging parent properties, applying Excludes, then merging child Properties.
2.6.3: Inheritance resolution handles multi-level chains (C extends B, B extends A) with proper property override priority.
2.6.4: Cycle detection provides clear error messages identifying the circular dependency path.
2.6.5: ResolvedProperties are immutable after inheritance resolution to ensure thread safety.

**Integration Requirements:**

2.6.6: Inheritance resolution integrates with existing SchemaRegistry service.
2.6.7: Builder pattern uses existing Schema and Property domain models.
2.6.8: Resolution process follows domain service patterns with proper error handling.

**Quality Requirements:**

2.6.9: Unit tests cover inheritance resolution logic and cycle detection.
2.6.10: Code follows project coding standards and naming conventions.
2.6.11: Comprehensive error handling for circular dependencies and invalid references.

## Technical Guidance

### Existing System Context

- **Current State**: SchemaRegistry service loads schemas, Schema/Property models support inheritance fields
- **Technology Stack**: Go 1.23+ with domain service patterns, topological sorting for dependency resolution
- **Integration Points**: Inheritance resolution enhances SchemaRegistry with proper property resolution
- **Architecture Pattern**: Builder pattern in domain service layer for complex schema processing

### Integration Approach

- **Builder Pattern**: Implement inheritance resolution as builder pattern within SchemaRegistry
- **Topological Sorting**: Use dependency graph and topological ordering for safe resolution
- **Property Merging**: Implement proper property override semantics with Excludes support
- **Cycle Detection**: Use DFS-based cycle detection with clear error reporting

### Technical Constraints

- **Domain Service**: Inheritance resolution belongs in SchemaRegistry as business logic
- **Thread Safety**: ResolvedProperties must be immutable after resolution
- **Error Handling**: Follow project Result[T] patterns for inheritance errors
- **Performance**: Resolution happens at startup, optimize for correctness over speed

### Key Files to Modify/Create

- `internal/app/schema/registry.go` - **UPDATE** - Add inheritance resolution to SchemaRegistry
- `internal/app/schema/inheritance_resolver.go` - **CREATE** - Builder pattern for inheritance resolution
- `internal/app/schema/inheritance_resolver_test.go` - **CREATE** - Unit tests for inheritance logic

## Tasks / Subtasks

- [ ] Task 1: Implement inheritance resolution builder (AC: 2.6.1, 2.6.6)
  - [ ] Create `internal/app/schema/inheritance_resolver.go` with builder pattern
  - [ ] Implement dependency graph building from schema Extends relationships
  - [ ] Add topological sorting for safe resolution order
  - [ ] Integrate with existing SchemaRegistry service

- [ ] Task 2: Implement cycle detection (AC: 2.6.4, 2.6.11)
  - [ ] Add DFS-based cycle detection during dependency graph construction
  - [ ] Provide clear error messages identifying circular dependency paths
  - [ ] Handle both direct cycles (A → B → A) and indirect cycles (A → B → C → A)
  - [ ] Include schema names in error messages for debugging

- [ ] Task 3: Implement property resolution (AC: 2.6.2, 2.6.3, 2.6.5)
  - [ ] Implement property merging logic: parent properties → apply Excludes → merge child properties
  - [ ] Handle multi-level inheritance chains with proper override priority
  - [ ] Ensure ResolvedProperties are immutable after resolution
  - [ ] Support property override semantics (child replaces parent for same name)

- [ ] Task 4: Integrate with SchemaRegistry (AC: 2.6.7, 2.6.8)
  - [ ] Update SchemaRegistry to call inheritance resolution after schema loading
  - [ ] Use existing Schema and Property domain models
  - [ ] Follow domain service patterns with proper error handling
  - [ ] Ensure Result[T] pattern for inheritance resolution errors

- [ ] Task 5: Add comprehensive testing (AC: 2.6.9, 2.6.10)
  - [ ] Create `internal/app/schema/inheritance_resolver_test.go` with unit tests
  - [ ] Test various inheritance scenarios: single level, multi-level, property overrides
  - [ ] Test cycle detection with different circular dependency patterns
  - [ ] Test Excludes functionality for subtractive inheritance
  - [ ] Test error conditions and edge cases
  - [ ] Ensure test coverage meets project standards (≥85% for app layer)

## Dev Notes

**Previous Story Insights:**
- Story 2.5 will implement SchemaRegistry service providing foundation for inheritance enhancement
- This story builds on Schema/Property models with inheritance fields from Stories 2.2-2.3
- Hexagonal architecture patterns established provide guidance for domain service enhancement

### Context Source

- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: Domain service enhancement for schema inheritance processing
- **Integration Points**: SchemaRegistry service enhanced with inheritance resolution logic
- **Goal**: Establish robust schema inheritance resolution with cycle detection and proper property merging

### Technical Guidance

#### Existing System Context

- **Current State**: SchemaRegistry service loads schemas, Schema/Property models support inheritance fields
- **Technology Stack**: Go 1.23+ with domain service patterns, topological sorting for dependency resolution
- **Integration Points**: Inheritance resolution enhances SchemaRegistry with proper property resolution
- **Architecture Pattern**: Builder pattern in domain service layer for complex schema processing

#### Integration Approach

- **Builder Pattern**: Implement inheritance resolution as builder pattern within SchemaRegistry
- **Topological Sorting**: Use dependency graph and topological ordering for safe resolution
- **Property Merging**: Implement proper property override semantics with Excludes support
- **Cycle Detection**: Use DFS-based cycle detection with clear error reporting

#### Technical Constraints

- **Domain Service**: Inheritance resolution belongs in SchemaRegistry as business logic
- **Thread Safety**: ResolvedProperties must be immutable after resolution
- **Error Handling**: Follow project Result[T] patterns for inheritance errors
- **Performance**: Resolution happens at startup, optimize for correctness over speed

#### Key Files to Modify/Create

- `internal/app/schema/registry.go` - **UPDATE** - Add inheritance resolution to SchemaRegistry
- `internal/app/schema/inheritance_resolver.go` - **CREATE** - Builder pattern for inheritance resolution
- `internal/app/schema/inheritance_resolver_test.go` - **CREATE** - Unit tests for inheritance logic

#### Testing Strategy

- **Unit Tests**: Test inheritance resolution with various schema hierarchies
- **Cycle Tests**: Test cycle detection with different circular dependency patterns
- **Integration Tests**: Test complete schema loading with inheritance resolution

### Definition of Done

- [ ] Builder pattern resolves inheritance with dependency graph and topological sorting
- [ ] ResolvedProperties computed by merging parent properties, applying Excludes, merging child properties
- [ ] Multi-level inheritance chains handled with proper property override priority
- [ ] Cycle detection provides clear error messages with dependency paths
- [ ] ResolvedProperties are immutable after inheritance resolution
- [ ] Integration with existing SchemaRegistry service working correctly
- [ ] Unit tests pass with adequate coverage for all inheritance scenarios
- [ ] Code follows project coding standards and naming conventions
- [ ] Comprehensive error handling for circular dependencies and invalid references

### Risk Assessment

#### Implementation Risks

- **Primary Risk**: Complex inheritance resolution logic may introduce bugs in property merging
- **Mitigation**: Implement incrementally with comprehensive unit tests for each scenario
- **Verification**: Test inheritance with various schema hierarchies and edge cases

#### Rollback Plan

- **Git Rollback**: Revert to previous commit if inheritance resolution fails
- **Feature Disable**: Temporarily disable inheritance resolution if critical bugs found
- **Testing Verification**: Run full test suite to ensure no regressions

**Data Models:**
- Schema model with Extends, Excludes, Properties, and ResolvedProperties fields
- Property model with Name, Required, Array, and Spec fields
- Inheritance resolution populates ResolvedProperties based on inheritance hierarchy

**API Specifications:**
- SchemaRegistry enhanced with inheritance resolution during schema loading
- Builder pattern for complex inheritance processing
- Result[T] pattern for inheritance resolution errors

**Component Specifications:**
- InheritanceResolver as builder pattern in `internal/app/schema/inheritance_resolver.go`
- Enhanced SchemaRegistry service calling inheritance resolution
- Follows domain service patterns with proper encapsulation

**File Locations:**
- Inheritance resolver: `internal/app/schema/inheritance_resolver.go` (create new)
- Updated registry: `internal/app/schema/registry.go` (enhance existing)
- Tests: `internal/app/schema/inheritance_resolver_test.go` (create new)

**Testing Requirements:**
- Unit tests for inheritance resolution with various schema hierarchies
- Cycle detection tests with different circular dependency patterns
- Property merging tests including Excludes functionality
- Integration tests with complete schema loading and resolution

**Technical Constraints:**
- Follow domain service principles: business logic in application layer
- Use builder pattern for complex inheritance processing
- Ensure thread safety with immutable ResolvedProperties
- Support topological sorting for safe dependency resolution
- Implement comprehensive cycle detection with clear error messages

**Source References:**
- [Architecture: docs/architecture/data-models.md#schema]
- [Architecture: docs/architecture/components.md#schemaregistryservice]
- [Architecture: docs/architecture/coding-standards.md#core-standards]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]

## Testing

### Testing Strategy

- **Unit Tests**: Test inheritance resolution with various schema hierarchies
- **Cycle Tests**: Test cycle detection with different circular dependency patterns
- **Integration Tests**: Test complete schema loading with inheritance resolution

### Testing Standards

- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use table-driven tests for multiple inheritance scenarios
- Test both success and failure cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft for inheritance resolution implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- Schema inheritance patterns from data-models.md
- Builder pattern for complex domain logic processing
- Topological sorting requirements for dependency resolution

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- Inheritance resolution requirements extracted from data-models.md and epic
- Builder pattern and cycle detection requirements included
- Testing strategy aligned with project standards

### File List

**Files to Create/Modify:**
- `internal/app/schema/inheritance_resolver.go` - Builder pattern for inheritance resolution
- `internal/app/schema/registry.go` - Enhanced SchemaRegistry with inheritance resolution
- `internal/app/schema/inheritance_resolver_test.go` - Unit tests for inheritance logic

## QA Results

*This section will be populated by the QA Agent during review of the completed story implementation*
