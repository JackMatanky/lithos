# Story 1.6: Implement Shared Registry Package

## Status

Draft

## Story

As a developer, I want to implement a shared registry package, so that the application has thread-safe storage for shared resources.

## Acceptance Criteria

- 1.6.1: `internal/shared/registry/` package is created for thread-safe storage.
- 1.6.2: Registry supports generic types with Get, Set, and Delete operations.
- 1.6.3: Registry uses `sync.RWMutex` for concurrent access.
- 1.6.4: Package includes unit tests for thread safety and operations.
- 1.6.5: Package includes comprehensive README.md documentation with usage examples.

## Tasks / Subtasks

- [ ] Task 1: Set up registry package structure and dependencies
  - [ ] Create internal/shared/registry/ directory
  - [ ] Create registry.go file with package declaration and imports
  - [ ] Verify Go 1.23+ generics support (no additional dependencies needed)
- [ ] Task 2: Implement core registry interfaces and types
  - [ ] Define Reader[T any] interface with Get, Exists, ListKeys methods (AC: 1.6.2)
  - [ ] Define Writer[T any] interface with Register, Clear methods (AC: 1.6.2)
  - [ ] Define Persister interface with SaveIndex, LoadIndex methods
  - [ ] Define Registry[T any] interface combining Reader and Writer
  - [ ] Implement concrete registry struct with sync.RWMutex (AC: 1.6.3)
  - [ ] Implement New[T any]() Registry[T] constructor function
- [ ] Task 3: Implement registry operations
  - [ ] Implement Get method for retrieving values by key (AC: 1.6.2)
  - [ ] Implement Register method for storing values (AC: 1.6.2)
  - [ ] Implement Clear method for removing all entries
  - [ ] Implement Exists method for checking key presence
  - [ ] Implement ListKeys method for retrieving all keys
  - [ ] Ensure all operations use RWMutex for thread safety (AC: 1.6.3)
- [ ] Task 4: Implement persistence operations (optional for MVP)
  - [ ] Implement SaveIndex method using encoding/json
  - [ ] Implement LoadIndex method using encoding/json
  - [ ] Add error handling for JSON marshaling/unmarshaling
- [ ] Task 5: Create comprehensive unit tests
  - [ ] Create registry_test.go file with table-driven tests (AC: 1.6.4)
  - [ ] Test Get, Register, Clear operations with various types (AC: 1.6.2)
  - [ ] Test thread safety with concurrent goroutines (AC: 1.6.3, 1.6.4)
  - [ ] Test Exists and ListKeys methods
  - [ ] Test error conditions and edge cases
  - [ ] Verify mutex usage prevents race conditions
- [ ] Task 6: Run tests and verify implementation
  - [ ] Execute go test ./internal/shared/registry/
  - [ ] Verify all tests pass with proper coverage (≥85%)
  - [ ] Run golangci-lint to ensure code standards compliance
  - [ ] Verify generics work correctly with Go 1.23+
  - [ ] Confirm thread safety under concurrent access
- [ ] Task 7: Pass pre-commit hooks and commit changes (AC: 1.6.5, 1.6.6)
  - [ ] Create internal/shared/registry/README.md file
  - [ ] Document package purpose and usage
  - [ ] Include code examples for basic usage and CQRS patterns
  - [ ] Document thread safety guarantees and concurrent access
  - [ ] Include integration examples with persistence
- [ ] Task 8: Pass pre-commit hooks and commit changes
  - [ ] Run pre-commit hooks: golangci-lint run and gitleaks detect
  - [ ] Ensure all hooks pass without errors
  - [ ] Stage all changed files (registry package)
  - [ ] Create conventional commit message following project standards
  - [ ] Commit all changes with the conventional commit message

## Dev Notes

### Previous Story Insights

Story 1.5 implemented the shared logger package in `internal/shared/logger/`, establishing the pattern for shared internal packages. This registry package follows the same architectural approach as a cross-cutting concern, similar to the logger. The shared directory structure is already established from Story 1.2.

### Registry Package Specifications

[Source: architecture/components.md#registry-package]

**Responsibility:** Generic in-memory registry implementation with CQRS-aware interfaces. Provides thread-safe storage for schemas and templates loaded at startup. Supports read-only access for validators/queries and write-only access for loaders. Generic implementation reusable across different data types.

**Architecture Layer + Rationale:** Shared Internal Package (Cross-Cutting Concern). Used by Schema Service and Template Service. Not domain logic or infrastructure—pure technical pattern. Centralized to avoid code duplication.

**Key Interfaces Required:**

- `Reader[T any]` - Read-only access (`Get`, `Exists`, `ListKeys`)
- `Writer[T any]` - Write-only access (`Register`, `Clear`)
- `Persister` - Persistence operations (`SaveIndex`, `LoadIndex`)
- `Registry[T any]` - Full registry combining all capabilities
- `New[T any]() Registry[T]` - Constructor

**Dependencies:**

- Go stdlib `sync` package for RWMutex
- Go stdlib `encoding/json` for Persister (optional)

**Technology Stack:**

- Pure Go with generics (requires Go 1.23+)
- Go stdlib `sync.RWMutex` for thread-safe access

### Technical Constraints

[Source: architecture/tech-stack.md]

- Go 1.23+ minimum version requirement (for generics support)
- Pure Go with generics (requires Go 1.23+)
- Go stdlib `sync.RWMutex` for thread-safe access
- Go stdlib `encoding/json` for optional persistence

### Coding Standards

[Source: architecture/coding-standards.md]

- Go 1.25+ MUST be used (CI enforces via toolchain)
- Shared maps/slices MUST NOT be mutated without synchronization (registry uses RWMutex)
- Functions over 60 lines or with >2 nested control structures SHOULD be refactored
- Ports MUST remain lean (≤3 methods); grow only with proven need (registry interfaces follow this)
- Package comments for registry package documenting responsibility
- Exported identifiers MUST have GoDoc summarizing purpose, error conditions, and context requirements
- Concurrency and side effects MUST be documented where applicable

### File Locations

[Source: architecture/source-tree.md]

- Package: internal/shared/registry/
- Implementation: internal/shared/registry/registry.go
- Tests: internal/shared/registry/registry_test.go
- Follow source tree structure for shared packages under internal/shared/

### Testing Requirements

[Source: architecture/testing-strategy.md]

- Unit tests MUST live beside the code under test (`*_test.go`) and use table-driven cases for branches
- Tests MUST cover success, validation failure, and cancellation paths for command orchestration (registry tests cover success and error paths)
- Unit tests for core services under `internal/app` and value objects in `internal/domain` (registry is shared internal package, similar scope)
- Target: ≥85% for internal/shared/registry package
- Use table-driven tests for registry operations
- Test thread safety with concurrent access patterns
- Include edge cases: empty registry, non-existent keys, type safety

### Integration with Future Stories

This registry package will be used by:

- Schema Service for storing loaded schemas (Story 1.7+)
- Template Service for storing loaded templates (Story 1.7+)
- Any service requiring thread-safe in-memory storage of shared resources
- CQRS pattern implementation with separate read/write interfaces

## Dev Agent Record

### Agent Model Used

[To be filled by dev agent]

### Debug Log References

[To be filled by dev agent]

### Completion Notes List

[To be filled by dev agent]

### File List

[To be filled by dev agent]

## QA Results

[To be filled by QA agent]

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-12 | 1.0     | Initial story creation | Bob (Scrum Master) |
