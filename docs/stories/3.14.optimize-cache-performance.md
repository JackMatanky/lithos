# Story 3.14: Implement Complete Cache Management

## Status: Draft

## Story

**As a** developer,
**I want** complete and reliable cache management for the vault indexing system,
**so that** cache operations are consistent, incremental refreshes work correctly, and schema validation is maintained.

## Acceptance Criteria

1. Incremental refresh removes cache entries for notes that have been deleted from the vault
2. Schema loading occurs in both Build and Refresh operations to ensure consistency
3. Single, consistent `ensureCacheDir` implementation across all cache operations
4. Cache state accurately reflects vault state after all operations
5. No orphaned cache entries persist after note deletions
6. Schema validation works correctly in incremental refresh scenarios

## Tasks / Subtasks

- [ ] Task 1: Optimize JSON serialization in cache writer
  - [ ] Replace json.MarshalIndent with json.Marshal for production cache files
  - [ ] Measure and document performance improvement
  - [ ] Ensure cache files remain readable for debugging when needed
  - [ ] Update any tests that depend on indented JSON format
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 2: Consolidate cache directory management
  - [ ] Identify all ensureCacheDir function implementations
  - [ ] Create single, shared implementation in utils package
  - [ ] Update all cache components to use the consolidated function
  - [ ] Remove duplicate implementations and maintain consistency
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 3: Add graceful cache directory handling
  - [ ] Update QueryService to handle missing cache directory on first access
  - [ ] Implement automatic directory creation during query operations
  - [ ] Add proper error handling for directory creation failures
  - [ ] Test fresh installation scenarios without manual setup
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 4: Performance validation and documentation
  - [ ] Benchmark cache write operations before and after optimization
  - [ ] Measure cache file size reduction
  - [ ] Document performance improvements achieved
  - [ ] Validate reliability improvements across platforms
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 5: Quality Assurance - Pre-commit and Validation
  - [ ] Execute `pre-commit run --all-files`, stage files, and write detailed conventional commit message (no `--no-verify` flag)
  - [ ] Run bmad-qa `review-story` to validate test coverage meets requirements

## Dev Notes

### Source Tree Information

Based on docs/architecture/source-tree.md:

**Primary Files to Modify:**
- `internal/adapters/spi/cache/json_writer.go` - Contains JSON serialization logic
- `internal/app/query/service.go` - Query service cache directory handling
- `internal/adapters/spi/cache/helper.go` - Location for consolidated ensureCacheDir function

**Related Components:**
- `internal/adapters/spi/cache/json_reader.go` - May need updates for consistency
- All cache-using components that call ensureCacheDir

### Architecture Context from docs/architecture/data-models.md

**Cache Models:**
- JSON serialization should be optimized for production use
- Cache directory management should be consistent across components
- Missing directory handling should be graceful and automatic

**Performance Considerations:**
- json.Marshal is faster than json.MarshalIndent
- Compact JSON reduces file size and I/O operations
- Directory creation should be handled transparently

### Component Specifications from docs/architecture/components.md

**Cache Components:**
- JSON writer should optimize for performance in production
- Directory management should be centralized and reliable
- Query service should handle initialization gracefully

**Performance Requirements:**
- Cache operations should be fast and efficient
- File size should be minimized for better I/O performance
- Reliability should be maintained across all scenarios

### Critical Implementation Notes

**JSON Serialization:**
- Use json.Marshal for production cache files (no indentation)
- Consider keeping indentation for development/debugging if needed
- Ensure backward compatibility with existing cache files
- Document the performance trade-offs

**Directory Management:**
- Single ensureCacheDir function in cache helper
- Handle cross-platform path creation
- Proper error handling and recovery
- Atomic directory creation to prevent race conditions

**Graceful Initialization:**
- Query service should create cache directory on first access
- Handle permission errors appropriately
- Provide clear error messages for unrecoverable issues
- Ensure operations are idempotent

### Testing

**Test File Locations:**
Based on docs/architecture/testing-strategy.md and source tree:
- Unit tests: `internal/adapters/spi/cache/*_test.go`
- Performance tests: `tests/performance/cache_operations_bench_test.go`
- Integration tests: `tests/integration/cache_directory_handling_test.go`

**Testing Standards:**
- Benchmark JSON serialization performance
- Test cache directory creation on different platforms
- Validate fresh installation behavior
- Measure file size differences
- Test error handling for permission issues

**Testing Framework:**
- Go standard testing package with benchmarking
- File system utilities for cross-platform testing
- Performance measurement tools

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-12 | 1.0 | Initial story creation for Epic 3 critical fixes | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

[To be populated by development agent]

### Debug Log References

[To be populated by development agent]

### Completion Notes List

[To be populated by development agent]

### File List

[To be populated by development agent]

## QA Results

[To be populated by QA agent]
