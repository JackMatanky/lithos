# Story 3.17: Hybrid Architecture DI and Production-Scale E2E Testing

## Status: Ready for Enhancement - Course Correction Applied

## Story

As a developer,
I want to implement dependency injection for the hybrid vault indexing engine and validate production-ready performance with realistic vault sizes,
So that the vault indexing functionality delivers sub-100ms template queries at 500+ note scale.

## Course Correction Context

**Performance Enhancement**: Enhanced to validate hybrid BoltDB + SQLite architecture with production-scale testing (500+ notes) and configurable file_class_key support. See: `docs/course_correction/sprint-change-proposal-2025-11-02-epic3-hybrid-storage-architecture.md`

## Context

This story completes the vault indexing engine (Epic 3) by wiring all components through dependency injection and ensuring the entire indexing workflow works correctly through e2e testing. It follows the same pattern established in story 1.16 for the foundational CLI.

## Acceptance Criteria

### Functional Requirements

1. âœ… PRESERVE: All vault indexing components registered in DI container
2. âœ… PRESERVE: main.go includes vault indexing engine dependencies
3. ðŸ”„ ENHANCE: E2E tests cover hybrid BoltDB+SQLite workflow validation
4. âœ… PRESERVE: E2E tests use real filesystem operations
5. ðŸ†• ADD: Test data includes 500+ note vault extracted from real Obsidian vault at `docs/refs/obsidian/`

### Integration Requirements

6. âœ… PRESERVE: Vault indexing engine integrates with existing CLI structure
7. ðŸ”„ ENHANCE: Cache operations work with hybrid BoltDB+SQLite+JSON adapters
8. âœ… PRESERVE: Frontmatter parsing handles various formats and edge cases
9. ðŸ”„ ENHANCE: Query service returns accurate results with smart routing
10. âœ… PRESERVE: No breaking changes to existing functionality

### Performance Requirements (NEW)

11. ðŸ†• ADD: E2E tests include performance validation with 500+ note test vault
12. ðŸ†• ADD: Template query performance meets sub-100ms requirements
13. ðŸ†• ADD: BoltDB and SQLite integration tested under realistic load
14. ðŸ†• ADD: Configuration testing for file_class_key setting variations

### Quality Requirements

15. âœ… PRESERVE: All e2e tests pass consistently
16. âœ… PRESERVE: Code coverage meets project standards (80%+)
17. ðŸ”„ ENHANCE: Error handling tested for multi-storage scenarios
18. ðŸ”„ ENHANCE: Tests run efficiently despite larger test vault
19. âœ… PRESERVE: Test cleanup removes temporary files and cache data

## Dev Notes

### Previous Story Insights

From story 3.8 (CLI index command): The CLI command structure is established and ready for integration testing. The indexer service has been implemented with proper error handling.

### Data Models

- **Cache Models**: Use existing cache port interfaces and JSON adapters [Source: docs/architecture/data-models.md#cache-interfaces]
- **Vault Models**: Frontmatter parsing follows the established note domain model [Source: docs/architecture/data-models.md#note-model]
- **Query Models**: Query results use the property bank model for structured data [Source: docs/architecture/data-models.md#property-bank]

### API Specifications

- **CLI Interface**: Follows cobra CLI adapter pattern from story 1.12 [Source: docs/architecture/components.md#cli-adapter]
- **Cache Interface**: Implements cache port interfaces from story 3.1 [Source: docs/architecture/components.md#cachewriterport]
- **Vault Reader/Writer**: Uses established port interfaces from stories 3.3-3.4 [Source: docs/architecture/components.md#vaultreaderport]

### Component Specifications

- **DI Container**: Extend the existing registry from story 1.7 with vault indexing components [Source: docs/architecture/components.md#dependency-injection]
- **E2E Test Structure**: Follow the e2e testing pattern from story 1.16 [Source: docs/architecture/testing-strategy.md#e2e-testing]
- **Test Data**: Extract production-scale notes from `docs/refs/obsidian/` to testdata/vault-large/ [Source: docs/refs/obsidian-vault-guide.md]

### File Locations

- **Main Application**: Update cmd/lithos/main.go to include vault indexing dependencies [Source: docs/architecture/source-tree.md#main-application]
- **DI Registry**: Extend internal/shared/registry/registry.go with vault components [Source: docs/architecture/source-tree.md#registry-package]
- **E2E Tests**: Create tests/e2e/vault_indexing_test.go [Source: docs/architecture/source-tree.md#e2e-tests]
- **Test Data**: Add testdata/vault/ with sample .md files [Source: docs/architecture/source-tree.md#test-data]

### Testing Requirements

- **E2E Test Coverage**: Complete workflow from CLI command to query results [Source: docs/architecture/testing-strategy.md#e2e-scenarios]
- **Integration Tests**: Component interactions within the vault indexing engine [Source: docs/architecture/testing-strategy.md#integration-testing]
- **Unit Tests**: Individual component testing (already covered in previous stories) [Source: docs/architecture/testing-strategy.md#unit-testing]

### Technical Constraints

- **Go Version**: Must be compatible with existing Go 1.21+ codebase [Source: docs/architecture/tech-stack.md#go-version]
- **Dependencies**: Use existing libraries (cobra, viper, etc.) [Source: docs/architecture/tech-stack.md#dependencies]
- **File System**: Handle cross-platform path separators [Source: docs/architecture/tech-stack.md#platform-compatibility]

## Tasks / Subtasks

- [ ] Task 1: Register vault indexing components in DI container
  - [ ] Add cache adapters to registry
  - [ ] Register vault reader/writer adapters
  - [ ] Add frontmatter service to registry
  - [ ] Register indexer service
  - [ ] Add query service to registry
  - [ ] Include CLI index command in registry
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 2: Wire vault indexing dependencies in main.go
  - [ ] Import vault indexing registry functions
  - [ ] Add vault components to application container
  - [ ] Ensure proper initialization order
  - [ ] Test basic application startup with vault components
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 3: Create e2e test infrastructure with production-scale data
  - [ ] Create tests/e2e/vault_indexing_test.go
  - [ ] Extract 500+ notes from `docs/refs/obsidian/` to testdata/vault-large/
  - [ ] Preserve diverse note types: templates, projects, tools, knowledge notes
  - [ ] Create test helper functions for vault setup/cleanup
  - [ ] Implement performance validation for realistic vault sizes
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 4: Implement e2e test scenarios
  - [ ] Test CLI index command execution
  - [ ] Verify cache file creation and content
  - [ ] Test query functionality against indexed data
  - [ ] Validate frontmatter parsing accuracy
  - [ ] Test error handling for invalid files
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 5: Add comprehensive test coverage
  - [ ] Ensure 80%+ code coverage for new integration code
  - [ ] Test edge cases (empty vault, malformed frontmatter, permission issues)
  - [ ] Validate performance meets requirements
  - [ ] Run tests across different environments
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 6: Documentation and cleanup
  - [ ] Update any necessary documentation
  - [ ] Ensure test data is properly organized
  - [ ] Verify no breaking changes to existing functionality
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 7: Quality Assurance - Pre-commit and Validation
  - [ ] Execute `pre-commit run --all-files`, stage files, and write detailed conventional commit message (no `--no-verify` flag)
  - [ ] Run bmad-qa `review-story` to validate test coverage meets requirements

## Testing

### E2E Test Scenarios

1. **Complete Vault Indexing Workflow**
   - Given: A vault directory with markdown files containing frontmatter
   - When: CLI index command is executed
   - Then: Cache files are created with correct indexed data

2. **Query Functionality**
   - Given: An indexed vault with known content
   - When: Query service is called with specific criteria
   - Then: Correct results are returned

3. **Error Handling**
   - Given: Vault with malformed files
   - When: Index command is executed
   - Then: Errors are handled gracefully without crashing

### Validation Steps

- Run full e2e test suite: `go test ./tests/e2e/...`
- Verify code coverage: `go test -cover ./internal/app/vault/...`
- Manual testing: Execute CLI commands with test vault
- Integration testing: Verify with existing CLI structure

## Dev Agent Record

### Agent Model Used

bmad-dev v1.0 - Full Stack Developer specialized in Go implementation and testing

### Dev Notes

This story requires careful integration of all vault indexing components. The DI wiring must follow the established patterns from story 1.16. E2E tests should be comprehensive but focused on the critical path.

### File List

- cmd/lithos/main.go (modified)
- internal/shared/registry/registry.go (modified)
- tests/e2e/vault_indexing_test.go (new)
- testdata/vault/ (new directory with sample files)

### Change Log

- 2025-01-12: Initial story creation following epic 3 completion pattern
