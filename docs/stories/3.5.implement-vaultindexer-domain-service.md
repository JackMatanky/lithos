# Story 3.5: Implement VaultIndexer Domain Service

## Status

Draft

## Story

As a developer, I want to implement the VaultIndexer domain service, so that vault indexing follows the architectural patterns.

## Acceptance Criteria

- 3.5.1: `internal/app/indexing/` contains VaultIndexer implementing the interface from `docs/architecture/components.md#vaultindexer`.
- 3.5.2: Service orchestrates vault scanning, frontmatter parsing, and cache persistence through port interfaces.

## Tasks / Subtasks

- [ ] Task 1 (AC: 3.5.1): Implement `VaultIndexer` Service
  - [ ] Create a new file `internal/app/indexing/vault_indexer.go`.
  - [ ] Define the `VaultIndexer` struct.
  - [ ] Implement the `NewVaultIndexer` constructor that accepts its dependencies (ports) via dependency injection.
- [ ] Task 2 (AC: 3.5.2): Implement `Rebuild` Method
  - [ ] Implement the `Rebuild(ctx context.Context, vaultPath string) (IndexStats, error)` method.
  - [ ] The method should use the `FileSystemPort` to walk the vault directory.
  - [ ] For each file, it should read the content and use the `ExtractFrontmatter` function.
  - [ ] It should then use the `SchemaValidator` to validate the frontmatter.
  - [ ] Finally, it should use the `CacheCommandPort` to store the indexed note.
- [ ] Task 3: Add Unit Tests
  - [ ] Add unit tests for the `VaultIndexer` service in `internal/app/indexing/vault_indexer_test.go`.
  - [ ] Use mocks for all the ports.
  - [ ] Test the happy path where indexing is successful.
  - [ ] Test scenarios with errors from the ports.
- [ ] Task 4: Full method and function decomposition into private srp function while ensuring a logical file organization.
- [ ] Task 5: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass
- [ ] Task 6: Pre-commit and commit readiness
  - [ ] Execute `pre-commit run` to confirm hooks pass
  - [ ] Stage updates and commit with a fully descriptive conventional commit message

## Dev Notes

### Data Models
- The `Note` model, which is a composition of `File` and `Frontmatter`, will be created and passed to the `CacheCommandPort`. [Source: docs/architecture/data-models.md#note]

### Component Specifications
- The `VaultIndexer` is a domain service that orchestrates the indexing process. [Source: docs/architecture/components.md#vaultindexer]
- It depends on `FileSystemPort`, `CacheCommandPort`, and `SchemaValidator`. [Source: docs/architecture/components.md#vaultindexer]

### File Locations
- The `VaultIndexer` service should be implemented in `internal/app/indexing/vault_indexer.go`. [Source: docs/architecture/source-tree.md#source-tree]
- Tests should be in `internal/app/indexing/vault_indexer_test.go`. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Testing Requirements
- Unit tests should use mocks for all external dependencies (ports). [Source: docs/architecture/testing-strategy.md#unit-tests]
- Tests should cover success and failure scenarios. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Technical Constraints
- The `Rebuild` method must accept a `context.Context` and handle cancellation. [Source: docs/architecture/coding-standards.md#core-standards]
- Errors should be wrapped and returned using the `Result[T]` pattern. [Source: docs/architecture/coding-standards.md#error-handling]

## Change Log

| Date       | Version | Description                                    | Author |
| ---------- | ------- | ---------------------------------------------- | ------ |
| 2025-10-22 | 1.0     | Initial story draft for VaultIndexer service   | sm     |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
