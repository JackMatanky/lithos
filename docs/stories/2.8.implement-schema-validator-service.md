# Story 2.8: Implement Schema Validation Services

## Status

Approved

## Story

As a developer, I want to implement FrontmatterValidator, SchemaValidator, and SchemaEngine as separate domain services, so that validation and business logic are properly decoupled from domain models and moved to the application layer, completing the comprehensive architectural refactoring per the approved Sprint Change Proposal.

## Acceptance Criteria

**Functional Requirements:**

2.8.1: `internal/app/frontmatter/validator.go` contains FrontmatterValidator implementing validation interface with clean public API.
2.8.2: FrontmatterValidator validates Frontmatter against Schema using PropertySpec polymorphism.
2.8.3: Validation checks Required fields, Array constraints, and type-specific PropertySpec rules.
2.8.4: Returns structured ValidationError types from `internal/shared/errors/`.
2.8.5: `internal/app/schema/validator.go` contains SchemaValidator implementing schema definition validation interface with clean public API.
2.8.6: SchemaValidator validates complete schema definitions and property banks for data integrity.
2.8.7: **ARCHITECTURAL**: All validation methods extracted from domain models (Property.Validate(), Schema.Validate(), PropertySpec validation implementations in property_specs.go) and moved to appropriate services (FrontmatterValidator for frontmatter validation, SchemaValidator for schema validation).
2.8.8: `internal/app/schema/engine.go` contains SchemaEngine implementing business logic interface with clean public API.
2.8.9: SchemaEngine provides business logic methods (Get*/Has*) extracted from domain models.
2.8.10: **ARCHITECTURAL**: All business logic methods extracted from domain models and moved to SchemaEngine service.

**Integration Requirements:**

2.8.11: SchemaValidator follows domain service patterns with proper dependency injection.
2.8.12: SchemaEngine follows domain service patterns with proper dependency injection.
2.8.13: SchemaEngine implements all required interfaces per components.md (LoadSchema, LoadPropertyBank, GetSchema, HasSchema, GetProperty, HasProperty).
2.8.14: FrontmatterValidator integrates with SchemaEngine for schema access (no direct SchemaRegistryPort access).
2.8.15: Validation and business logic operations support context cancellation for long-running operations.

**Quality Requirements:**

2.8.16: Unit tests cover SchemaValidator, SchemaEngine, and FrontmatterValidator behavior with mocked dependencies.
2.8.17: Code follows project coding standards and naming conventions.
2.8.18: Comprehensive error handling using the refactored Result[T] pattern from the errors package.

## Tasks / Subtasks

- [ ] Task 1: Define SchemaValidator service (AC: 2.8.5, 2.8.6)
  - [ ] Create `internal/app/schema/validator.go` with SchemaValidator service struct
  - [ ] Implement constructor accepting no dependencies (pure validation logic)
  - [ ] Follow domain service patterns with proper encapsulation
  - [ ] Extract ALL validation methods from domain models (AC: 2.8.7, 2.8.10)
    - [ ] Move `Property.Validate()` logic to `SchemaValidator.ValidateProperty()`
    - [ ] Move `Schema.Validate()` logic to `SchemaValidator.ValidateSchema()`
    - [ ] Move `PropertyBank.Validate()` logic to `SchemaValidator.ValidatePropertyBank()`
    - [ ] Move ALL PropertySpec validation implementations from `property_specs.go` to SchemaValidator service
    - [ ] Move all validation helper functions from domain models to SchemaValidator service
    - [ ] Remove ALL validation methods from domain models (Property, Schema, PropertyBank, PropertySpec implementations)
    - [ ] Update all callers to use SchemaValidator methods instead of domain model methods
    - [ ] Verify all existing tests pass after comprehensive validation method extraction
    - [ ] Ensure domain models become pure data structures with no validation methods
  - [ ] Implement ValidateSchema and ValidatePropertyBank methods for schema definition validation
  - [ ] Use regular dependency injection (no port interface needed)

- [ ] Task 2: Integrate SchemaValidator with SchemaRegistry (AC: 2.8.7, 2.8.13)
  - [ ] Ensure SchemaValidator uses SchemaRegistry.Get() for schema lookup
  - [ ] Handle cases where schema is not found with SchemaNotFoundError per components.md
  - [ ] Support validation against schema.ResolvedProperties (post-inheritance resolution from Story 2.6)
  - [ ] Validate frontmatter.FileClass matches schemaName parameter
  - [ ] Handle PropertyBank references that may be in ResolvedProperties per data-models.md

- [ ] Task 3: Add comprehensive testing for SchemaValidator (AC: 2.8.15)
  - [ ] Create `internal/app/schema/validator_test.go` with unit tests
  - [ ] Add tests with mocked SchemaRegistry and various schema validation scenarios
  - [ ] Test ValidateSchema method with valid and invalid schemas
  - [ ] Test ValidatePropertyBank method with property bank references
  - [ ] Test error handling: schema not found, malformed schemas, validation failures
  - [ ] Test Result[T] pattern and structured error reporting
  - [ ] Test context cancellation scenarios with various timeout durations
  - [ ] Ensure test coverage meets project standards (≥95% for internal/app per testing-strategy.md)

- [ ] Task 4: Define SchemaEngine service (AC: 2.8.8, 2.8.9)
  - [ ] Create `internal/app/schema/engine.go` with SchemaEngine service struct
  - [ ] Implement constructor accepting SchemaLoaderPort, SchemaRegistryPort, and SchemaValidator dependencies
  - [ ] Follow domain service patterns with proper encapsulation
  - [ ] Implement ALL required SchemaEngine interfaces per components.md:
    - [ ] `LoadSchema(ctx context.Context) Result[[]Schema]` - Load and validate schemas through SchemaLoaderPort + SchemaValidator
    - [ ] `LoadPropertyBank(ctx context.Context) Result[*PropertyBank]` - Load and validate property bank through SchemaLoaderPort + SchemaValidator
    - [ ] `GetSchema(ctx context.Context, name string) Result[Schema]` - Retrieve validated schema by name (must be pre-validated by SchemaEngine)
    - [ ] `HasSchema(ctx context.Context, name string) Result[bool]` - Check if schema exists
    - [ ] `GetProperty(ctx context.Context, name string) Result[Property]` - Retrieve property from property bank
    - [ ] `HasProperty(ctx context.Context, name string) Result[bool]` - Check if property exists in bank
  - [ ] **CRITICAL ARCHITECTURE**: SchemaEngine is the ONLY gateway for schema access - all schema operations must go through SchemaEngine
  - [ ] Use SchemaLoaderPort for loading operations and SchemaValidator for validation
  - [ ] Use regular dependency injection (no port interface needed)

- [ ] Task 5: Extract business logic methods from domain models to SchemaEngine (AC: 2.8.7, 2.8.8)
  - [ ] Move `Schema.Get*()` and `Schema.Has*()` methods to SchemaEngine coordination logic (used internally by GetSchema/HasSchema methods)
  - [ ] Move `Property.Get*()` and `Property.Has*()` methods to SchemaEngine coordination logic (used internally by GetProperty/HasProperty methods)
  - [ ] Move `PropertyBank.Get*()` and `PropertyBank.Has*()` methods to SchemaEngine coordination logic (used internally by property bank operations)
  - [ ] Implement SchemaEngine as coordination layer that uses SchemaLoaderPort for loading and SchemaValidator for validation
  - [ ] Remove business logic methods from domain models, keeping only data structures
  - [ ] Update all callers to use SchemaEngine service instead of model methods
  - [ ] Verify all existing tests pass after business logic method extraction

- [ ] Task 6: Add comprehensive testing for SchemaEngine (AC: 2.8.15)
  - [ ] Create `internal/app/schema/engine_test.go` with unit tests for SchemaEngine
  - [ ] Add tests with mocked SchemaLoaderPort, SchemaRegistryPort, and SchemaValidator dependencies
  - [ ] Test all required SchemaEngine interface methods:
    - [ ] LoadSchema and LoadPropertyBank methods (coordination with SchemaLoaderPort and SchemaValidator)
    - [ ] GetSchema and HasSchema methods (schema retrieval and existence checking)
    - [ ] GetProperty and HasProperty methods (property bank operations)
  - [ ] Test business logic coordination extracted from domain models
  - [ ] Test error handling for all SchemaEngine operations
  - [ ] Test Result[T] pattern and structured error reporting for SchemaEngine
  - [ ] Test context cancellation scenarios for all SchemaEngine methods
  - [ ] Ensure combined test coverage meets project standards (≥95% for internal/app per testing-strategy.md)

- [ ] Task 7: Consolidate domain model files after method extraction (AC: 2.8.7, 2.8.10)
  - [ ] **CONSOLIDATION**: Move all content from `internal/domain/property_bank.go` to `internal/domain/property.go`
    - [ ] Move PropertyBank struct definition and NewPropertyBank constructor
    - [ ] Move RegisterProperty method (retains domain logic for property registration)
    - [ ] **REMOVE**: GetProperty, HasProperty, and Validate methods (moved to SchemaEngine and SchemaValidator)
    - [ ] Update imports and dependencies as needed
  - [ ] **CONSOLIDATION**: Move all content from `internal/domain/property_specs.go` to `internal/domain/property.go`
    - [ ] Move all PropertySpec implementations (StringPropertySpec, NumberPropertySpec, DatePropertySpec, FilePropertySpec, BoolPropertySpec)
    - [ ] **REMOVE**: All Validate() methods from PropertySpec implementations (moved to SchemaValidator)
    - [ ] Move type constants and helper functions that remain domain-relevant
    - [ ] Update imports and dependencies as needed
  - [ ] **FILE CLEANUP**: Delete now-empty files
    - [ ] Delete `internal/domain/property_bank.go`
    - [ ] Delete `internal/domain/property_specs.go`
  - [ ] **CONSOLIDATION VERIFICATION**:
    - [ ] Ensure `internal/domain/property.go` contains all Property, PropertyBank, and PropertySpec definitions
    - [ ] Verify all domain structs are pure data structures without service layer methods
    - [ ] Confirm all imports are resolved and no circular dependencies exist
    - [ ] Run domain package tests to ensure consolidation is successful

- [ ] Task 8: Define FrontmatterValidator service (AC: 2.8.1)
  - [ ] Create `internal/app/frontmatter/validator.go` with FrontmatterValidator service struct
  - [ ] Implement constructor accepting SchemaEngine dependency for schema access
  - [ ] Follow domain service patterns with proper encapsulation
  - [ ] **CRITICAL ARCHITECTURE**: FrontmatterValidator must ONLY access schemas through SchemaEngine (no direct SchemaRegistryPort access)
  - [ ] Use regular dependency injection (no port interface needed)

- [ ] Task 9: Implement FrontmatterValidator validation logic (AC: 2.8.2, 2.8.3)
  - [ ] Implement Validate(ctx context.Context, schemaName string, frontmatter Frontmatter) Result[ValidationResult] method
  - [ ] Use SchemaEngine.GetSchema(ctx, schemaName) to retrieve validated schema with error handling for missing schemas
  - [ ] **CRITICAL FLOW**: Schema must be loaded/validated by SchemaEngine BEFORE frontmatter validation can proceed
  - [ ] Validate each frontmatter field against schema ResolvedProperties (post-inheritance, pre-validated by SchemaEngine)
  - [ ] Use PropertySpec polymorphism for type-specific field validation (StringPropertySpec, NumberPropertySpec, etc.)
  - [ ] Check Required field constraints (field must exist in frontmatter.Fields)
  - [ ] Check Array constraints (if Array=true, field value must be slice; if Array=false, field value must be scalar)
  - [ ] Support context cancellation for validation process with periodic context.Done() checks
  - [ ] Validate frontmatter fields against schema.ResolvedProperties (not Properties) to include inheritance
  - [ ] Add context cancellation checks in field validation loops for responsiveness

- [ ] Task 10: Implement structured error handling using refactored errors package (AC: 2.8.4)
  - [ ] Use ValidationError types from the refactored `internal/shared/errors` package (post-Story 2.7)
  - [ ] Implement field-level error reporting with field names and values using existing error types
  - [ ] Use Result[T] pattern from `internal/shared/errors` for functional error handling across all validation methods
  - [ ] Provide clear error messages for different field validation failures with remediation hints
  - [ ] Aggregate multiple field errors into single ValidationResult with detailed context

- [ ] Task 11: Add comprehensive testing for FrontmatterValidator (AC: 2.8.15)
  - [ ] Create `internal/app/frontmatter/validator_test.go` with unit tests
  - [ ] Add tests with mocked SchemaEngine and various frontmatter scenarios
  - [ ] Test frontmatter field validation scenarios for each PropertySpec type:
    - StringPropertySpec: enum validation, pattern matching, edge cases for string fields
    - NumberPropertySpec: min/max bounds, step validation, type checking for numeric fields
    - DatePropertySpec: format validation with Go time layouts for date fields
    - FilePropertySpec: fileClass/directory constraints for file reference fields
    - BoolPropertySpec: type checking for boolean fields
  - [ ] Test Required field validation (missing fields in frontmatter, optional fields)
  - [ ] Test Array constraint validation (scalar vs array field values in frontmatter)
  - [ ] Test inheritance validation using schema.ResolvedProperties against frontmatter fields
  - [ ] Test error handling: schema not found, malformed frontmatter, field validation failures
  - [ ] Test Result[T] pattern and structured error reporting for frontmatter validation
  - [ ] Test context cancellation scenarios with various timeout durations during frontmatter validation
  - [ ] Test field-level validation edge cases and error handling for frontmatter fields
   - [ ] Ensure test coverage meets project standards (≥95% for internal/app per testing-strategy.md)

- [ ] Task 12: Decompose functions for SRP compliance across all services
  - [ ] Break larger validation routines into focused private helpers
  - [ ] Keep public APIs unchanged while improving internal structure
  - [ ] Re-run the validator test suite to verify all acceptance criteria remain satisfied

- [ ] Task 13: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass

- [ ] Task 14: Pre-commit and commit readiness
  - [ ] Execute `pre-commit run` to confirm hooks pass
  - [ ] Stage updates and commit with a fully descriptive conventional commit message summarizing validator and engine changes

## Dev Notes

**Previous Story Insights:**
- Stories 2.1-2.6 will implement Config, Schema/Property models, SchemaLoaderPort, SchemaRegistry, and inheritance resolution providing foundation
- This story builds on PropertySpec implementations and SchemaRegistry
- Hexagonal architecture patterns established provide guidance for domain service implementation

**Data Models:**
- Frontmatter model with Fields map and FileClass for validation input [Source: docs/architecture/data-models.md#frontmatter]
- Schema model with ResolvedProperties for validation rules [Source: docs/architecture/data-models.md#schema]
- Property model with PropertySpec interface for polymorphic validation [Source: docs/architecture/data-models.md#property]

**API Specifications:**
- SchemaValidator interface with Validate method [Source: docs/architecture/components.md#schemavalidator]
- ValidationError types for structured error reporting [Source: docs/architecture/coding-standards.md#error-handling]
- Result[T] pattern for functional error handling [Source: internal/shared/errors package]

**Component Specifications:**
- SchemaValidator located in `internal/app/schema/validator.go` [Source: docs/architecture/components.md#domain-services]
- SchemaEngine located in `internal/app/schema/engine.go` with specific interface requirements [Source: docs/architecture/components.md#schemaengine]
- FrontmatterValidator located in `internal/app/frontmatter/validator.go` [Source: docs/architecture/components.md#frontmattervalidator]
- **CRITICAL ARCHITECTURE**: SchemaEngine serves as gateway for ALL schema operations - no direct SchemaRegistryPort access by other services
- **VALIDATION FLOW**: SchemaEngine loads/validates schemas → FrontmatterValidator validates frontmatter against validated schemas
- Follows domain service patterns with dependency injection [Source: docs/architecture/components.md#schemavalidator]
- Uses PropertySpec polymorphism for extensible validation [Source: docs/architecture/data-models.md#propertyspec]

**File Locations:**
- Service implementation: `internal/app/schema/validator.go` (create new)
- Tests: `internal/app/schema/validator_test.go` (create new)
- Error types: `internal/shared/errors/validation.go` (create new)

**Testing Requirements:**
- Unit tests for SchemaValidator with mocked SchemaRegistry
- Tests for validation of various property types and constraints
- Error handling tests for different validation failure scenarios
- Integration tests with real schemas and frontmatter

**Technical Constraints:**
- Follow domain service principles: business logic in application layer [Source: docs/architecture/components.md#domain-services]
- Use dependency injection for SchemaRegistry access [Source: docs/architecture/components.md#schemavalidator]
- Implement Result[T] pattern from shared errors package [Source: docs/architecture/coding-standards.md#error-handling]
- Support context cancellation for validation operations [Source: docs/architecture/coding-standards.md#core-standards]
- Leverage PropertySpec interface for polymorphic validation [Source: docs/architecture/data-models.md#propertyspec]

**PropertySpec Implementation Details:**
- StringPropertySpec: Supports enum validation, pattern matching (regex), min/max length constraints
- NumberPropertySpec: Supports min/max bounds, step validation, integer vs float type checking
- DatePropertySpec: Supports Go time layout format validation (RFC3339, custom formats)
- FilePropertySpec: Supports fileClass/directory constraints for file references
- BoolPropertySpec: Supports type checking and validation

**Result[T] Pattern Usage:**
- All validation methods return Result[ValidationResult] not (ValidationResult, error)
- Use errors.Ok[ValidationResult](result) for success cases
- Use errors.Err[ValidationResult](validationError) for failure cases
- Chain validation operations using Result[T].AndThen() methods
- Import and use the refactored errors package: `internal/shared/errors`
- Follow the Result[T] pattern established in the errors package refactoring (Story 2.7)

**ValidationError Type Structure:**
- Use the refactored errors package with minimal, lean error types
- BaseError: minimal with just message and cause (no bloat)
- ValidationError: simplified for domain validation errors
- ResourceError: for resource operations
- Follow the Result[T] pattern from aidantwoods-go-result-digest.txt reference
- Ensure correct domain terminology (use "property" not "field" for schema errors)

**Source References:**
- [Architecture: docs/architecture/components.md#schemavalidator]
- [Architecture: docs/architecture/data-models.md#frontmatter]
- [Architecture: docs/architecture/coding-standards.md#error-handling]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]

### Context Source
- **Source**: Epic 2 - Configuration & Schema Loading + Sprint Change Proposal
- **Enhancement Type**: Domain service implementation for frontmatter validation and business logic with comprehensive architectural refactoring
- **Integration Points**: SchemaValidator and SchemaEngine used by VaultIndexer and TemplateEngine for validation and business operations
- **Goal**: Establish core domain services for schema-based operations and extract ALL methods from domain models to resolve hexagonal architecture violations

### Architectural Refactoring
**CRITICAL**: This story will extract ALL methods currently embedded in domain models and move them to appropriate application services:

**SchemaValidator Service:**
- `Property.Validate()` → `SchemaValidator.ValidateProperty()`
- `Schema.Validate()` → `SchemaValidator.ValidateSchema()`
- PropertySpec validation methods → `SchemaValidator` orchestration

**SchemaEngine Service:**
- `Schema.Get*()` and `Schema.Has*()` → `SchemaEngine.Get*()` and `SchemaEngine.Has*()`
- `Property.Get*()` and `Property.Has*()` → `SchemaEngine.Get*()` and `SchemaEngine.Has*()`

**Domain Models Become Pure Data Structures:**
- All validation methods removed from domain layer
- All business logic methods removed from domain layer
- Domain models contain only data structures and basic getters/setters
- Validation becomes application layer business logic via SchemaValidator
- Business logic becomes application layer operations via SchemaEngine

This resolves the architectural inconsistency where methods were incorrectly placed in the domain layer instead of the application layer as defined in `docs/architecture/components.md`.

### Technical Guidance

#### Existing System Context
- **Current State**: SchemaRegistry loads schemas, Property models define validation rules
- **Technology Stack**: Go 1.23+ with domain service patterns, PropertySpec polymorphism
- **Integration Points**: SchemaValidator validates frontmatter during indexing and template generation
- **Architecture Pattern**: Domain service using Result[T] pattern for functional error handling

#### Integration Approach
- **Domain Service**: Implement as pure business logic service in application layer
- **SchemaEngine Gateway**: SchemaEngine is the ONLY access point for all schema operations
- **Dependency Chain**: FrontmatterValidator → SchemaEngine → SchemaLoaderPort + SchemaValidator
- **Validation Flow**: Schema loaded/validated by SchemaEngine BEFORE frontmatter validation
- **Polymorphic Validation**: Use PropertySpec interface for type-specific validation
- **Structured Errors**: Return ValidationError types with field-level details

#### Technical Constraints
- **Application Layer**: SchemaValidator belongs in `internal/app/schema/` as domain service
- **Result Pattern**: Use `internal/shared/errors` Result[T] for error handling
- **Context Support**: All public methods must accept context.Context for cancellation
- **Polymorphism**: Leverage PropertySpec interface for extensible validation

#### Key Files to Modify/Create
- `internal/app/schema/validator.go` - **CREATE** - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - **CREATE** - Unit tests for SchemaValidator
- `internal/app/schema/engine.go` - **CREATE** - SchemaEngine service implementing ALL required interfaces per components.md
- `internal/app/schema/engine_test.go` - **CREATE** - Unit tests for SchemaEngine
- `internal/app/frontmatter/validator.go` - **CREATE** - FrontmatterValidator service for frontmatter field validation
- `internal/app/frontmatter/validator_test.go` - **CREATE** - Unit tests for FrontmatterValidator
- **CRITICAL DEPENDENCY**: Task 1 (extract ALL validation methods from domain models) MUST be completed first, as these methods provide validation logic for SchemaValidator and field validation logic for FrontmatterValidator

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data [Source: docs/architecture/testing-strategy.md#unit-tests]
- **Validation Tests**: Test various validation scenarios and error conditions including PropertySpec polymorphism edge cases
- **Integration Tests**: Test end-to-end validation with real schemas and inheritance resolution
- **Context Cancellation Tests**: Test validation behavior with various timeout scenarios (immediate cancellation, mid-validation cancellation, long-running operations)

### Definition of Done

- [ ] SchemaValidator service implemented in `internal/app/schema/` following domain service patterns
- [ ] Service validates schemas and property banks using extracted validation logic
- [ ] Validation checks Required properties, Array constraints, and type-specific PropertySpec rules
- [ ] Returns Result[ValidationResult] with structured ValidationError types for property-level details
- [ ] SchemaEngine service implemented in `internal/app/schema/` following domain service patterns
- [ ] SchemaEngine provides business logic methods extracted from domain models
- [ ] SchemaEngine uses SchemaRegistry for schema loading/retrieval and SchemaValidator for validation
- [ ] Integrates with SchemaRegistry for schema lookup with proper error handling
- [ ] Supports context cancellation for validation and business logic operations
- [ ] Validates against post-inheritance ResolvedProperties (includes property bank references)
- [ ] Structured error types defined using the refactored errors package Result[T] pattern
- [ ] Clear error messages with remediation hints for different validation and business logic failures
- [ ] **ARCHITECTURAL**: All validation methods extracted from domain models and moved to SchemaValidator service
- [ ] **ARCHITECTURAL**: All business logic methods extracted from domain models and moved to SchemaEngine service
- [ ] Domain models (Property, Schema, PropertyBank, PropertySpec implementations) become pure data structures without methods
- [ ] All callers updated to use SchemaValidator for validation and SchemaEngine for business logic
- [ ] Unit tests pass with ≥95% coverage for all validation and business logic scenarios including inheritance
- [ ] Code follows project coding standards and naming conventions
- [ ] Private helper functions for validation and business logic concerns follow SRP

### Risk Assessment

#### Implementation Risks
- **Primary Risk**: Complex PropertySpec polymorphism may introduce validation bugs
- **Mitigation**: Implement incrementally with comprehensive unit tests
- **Verification**: Test validation with various property types and constraints

#### Rollback Plan
- **Git Rollback**: Revert to previous commit if validation logic fails
- **File Removal**: Delete new validator files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

### Testing

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data
- **Validation Tests**: Test various validation scenarios and error conditions
- **Integration Tests**: Test end-to-end validation with real schemas

#### Testing Standards
- Follow testing patterns from `docs/architecture/testing-strategy.md` [Source: docs/architecture/testing-strategy.md#unit-tests]
- Unit tests co-located with implementation files (≥95% coverage for internal/app)
- Use table-driven tests for multiple validation scenarios and PropertySpec types
- Test both success and failure cases including edge cases and error conditions
- Mock SchemaRegistry using tests/utils/mocks.go patterns
- Test context cancellation scenarios with configurable timeouts

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 14.0 | **DOMAIN FILE CONSOLIDATION** - Added Task 6.5 to consolidate property_bank.go and property_specs.go into property.go after method extraction, creating single unified domain property file with pure data structures | po |
| 2025-10-22 | 13.0 | **ARCHITECTURAL FLOW CORRECTION** - Fixed dependency chain: FrontmatterValidator → SchemaEngine → SchemaLoaderPort + SchemaValidator. SchemaEngine is ONLY gateway for schema access. All schema operations must go through SchemaEngine before frontmatter validation | po |
| 2025-10-22 | 12.0 | **CRITICAL FIXES** - Fixed Task 10 PropertySpec vs Fields terminology confusion (FrontmatterValidator validates frontmatter fields not properties), corrected SchemaEngine to implement ALL required interfaces per components.md, updated dependencies and AC numbering | po |
| 2025-10-22 | 11.0 | **ARCHITECTURAL CORRECTIONS** - Task 11 moved before Task 1 as prerequisite, SchemaEngine uses SchemaRegistry not SchemaLoaderPort, removed unnecessary port interfaces, corrected error handling instructions per sprint change proposal | po |
| 2025-10-22 | 10.0 | **COMPREHENSIVE ARCHITECTURAL ALIGNMENT** - Removed unnecessary port interfaces, corrected SchemaEngine to use SchemaLoaderPort, fixed FrontmatterValidator references, updated error handling instructions per sprint change proposal, added critical dependency note for Task 11 | po |
| 2025-10-22 | 8.0 | **ARCHITECTURAL ALIGNMENT FIXED** - Corrected service responsibilities (FrontmatterValidator vs SchemaValidator), removed error file creation, aligned tasks with components.md | po |
| 2025-10-22 | 6.0 | **SPRINT CHANGE PROPOSAL IMPLEMENTATION** - Story scope expanded per approved Sprint Change Proposal to include SchemaEngine service and comprehensive method extraction from ALL domain models including property_specs.go | po |
| 2025-10-22 | 5.0 | **STATUS CORRECTED** - Story status changed back to In Progress - current implementation incomplete per Sprint Change Proposal requirements | po |
| 2025-10-22 | 4.0 | **FULL IMPLEMENTATION COMPLETE** - Both SchemaValidator and SchemaEngine services implemented with comprehensive method extraction and testing | dev |
| 2025-10-22 | 3.0 | **SPRINT CHANGE PROPOSAL** - Expanded scope to include SchemaEngine service and comprehensive method extraction from domain models per approved architectural refactoring | po |
| 2025-01-21 | 1.2 | Fixed validation issues: corrected AC numbering, updated source references, reordered tasks, enhanced technical details, added context cancellation testing | po |
| 2025-10-22 | 2.0 | **IMPLEMENTATION COMPLETE** - SchemaValidator service fully implemented with comprehensive testing and architectural refactoring | dev |
| 2025-10-21 | 1.1 | Added explicit architectural refactoring requirements - validation methods moved from domain models to service | po |
| 2025-10-20 | 1.0 | Initial story draft for Schema Validator service implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- SchemaValidator service patterns from components.md
- Validation logic requirements from data-models.md
- Error handling patterns from shared errors package

### Completion Notes List

- **CURRENT STATUS**: Story validated and ready for implementation - all scope and dependency issues resolved
- **VALIDATION COMPLETE**: Epic updated to match expanded scope, duplicate tasks consolidated, dependencies clarified
- **READY FOR DEV**: Comprehensive technical guidance provided, all architectural requirements clearly specified
- **IMPLEMENTATION PATH**: Follow tasks in order for safe architectural refactoring - Task 11 is prerequisite for Task 1

### File List

**Files to Create/Modify per Sprint Change Proposal:**
- `internal/app/schema/validator.go` - **CREATE** - SchemaValidator service with comprehensive method extraction from ALL domain models
- `internal/app/schema/validator_test.go` - **CREATE** - Comprehensive unit tests (95%+ coverage) with table-driven test cases
- `internal/app/schema/engine.go` - **CREATE** - SchemaEngine service implementing ALL required interfaces per components.md
- `internal/app/schema/engine_test.go` - **CREATE** - Comprehensive unit tests for SchemaEngine with mocked dependencies
- `internal/app/frontmatter/validator.go` - **CREATE** - FrontmatterValidator service for frontmatter field validation
- `internal/app/frontmatter/validator_test.go` - **CREATE** - Comprehensive unit tests for FrontmatterValidator
- `internal/shared/errors/validation.go` - **CREATE** - Structured validation error types per Result[T] pattern
- `internal/shared/errors/business.go` - **CREATE** - Business logic error types
- `internal/ports/api/schema.go` - **MODIFY** - Update existing SchemaLoaderPort interface if needed (no new port interfaces required)
- `internal/domain/schema.go` - **MODIFY** - Remove ALL methods (Get*/Has*/Validate*)
- `internal/domain/property.go` - **MODIFY/CONSOLIDATE** - Remove ALL methods (Validate*), consolidate content from property_bank.go and property_specs.go
- `internal/domain/property_bank.go` - **DELETE** - Content moved to property.go
- `internal/domain/property_specs.go` - **DELETE** - Content moved to property.go
- `internal/domain/schema_test.go` - **MODIFY** - Remove tests for extracted methods
- `internal/domain/property_test.go` - **MODIFY** - Remove tests for extracted methods
- `internal/domain/property_bank_test.go` - **MODIFY** - Remove tests for extracted methods
- `internal/domain/property_specs_test.go` - **MODIFY** - Remove tests for extracted methods

## QA Results

### Story Validation Complete (Version 9.0)

**Status**: ✅ **VALIDATION PASSED** - All critical scope, dependency, and architectural alignment issues resolved. Story ready for safe implementation.

**Critical Issues Resolved:**
- ✅ **FIXED**: Epic-Story Scope Mismatch - Updated parent epic to reflect expanded scope (17 ACs + SchemaEngine service)
- ✅ **FIXED**: Undefined Dependencies - Story 2.8 properly defined in epic sequence
- ✅ **FIXED**: Status Inconsistency - Change log aligned with current In Progress status
- ✅ **FIXED**: Task Duplication - Consolidated duplicate tasks and renumbered properly
- ✅ **FIXED**: AC Numbering - Renumbered to match epic (2.8.1-2.8.17)
- ✅ **FIXED**: Architectural Misalignment - Corrected service responsibilities per components.md (SchemaValidator handles property/PropertySpec validation, FrontmatterValidator validates frontmatter against schemas)
- ✅ **FIXED**: Task 11 Inconsistency - Corrected Task 11 to assign Property.Validate() and PropertySpec validation to SchemaValidator, ensuring consistency with architectural refactoring section
- ✅ **FIXED**: Error Handling Bloat - Removed creation of new error files, aligned with refactored errors package approach

**Technical Readiness Confirmed:**
- ✅ Comprehensive Dev Notes with all technical details and source references
- ✅ Clear implementation path with 14 sequential tasks
- ✅ Proper architectural boundaries defined (domain models → pure data structures)
- ✅ Dependencies on Stories 2.1-2.6, 2.8 properly established
- ✅ Integration points with SchemaRegistry and Result[T] pattern specified

**Quality Assurance:**
- ✅ Anti-hallucination check passed - all technical claims sourced to architecture documents
- ✅ Test coverage requirements specified (≥95% for internal/app)
- ✅ Error handling aligned with refactored errors package
- ✅ Context cancellation support throughout validation pipeline

**Implementation Guidance:**
- Execute Tasks in order for safe architectural refactoring - Task 11 must precede Task 1
- Focus on PropertySpec polymorphism edge cases in testing
- Implement method extraction incrementally to minimize risk
- Use table-driven tests for comprehensive scenario coverage
- Ensure domain models become pure data structures with no methods
- SchemaValidator orchestrates all property and PropertySpec validation logic
- SchemaEngine loads/retrieves schemas from SchemaRegistry and validates them
- FrontmatterValidator uses SchemaEngine for schema access and validation

### Sprint Change Proposal Implementation

**Status**: ✅ **UPDATED FOR ALIGNMENT** - Story corrected to match approved Sprint Change Proposal requirements.

**Architectural Requirements Met:**
- ✅ FrontmatterValidator, SchemaValidator, and SchemaEngine services
- ✅ Comprehensive method extraction from ALL domain models
- ✅ Proper hexagonal architecture boundaries established
- ✅ Clean Result[T] pattern integration
- ✅ Domain models become pure data structures
- ✅ SchemaEngine uses SchemaRegistry for schema loading/retrieval operations
- ✅ Removed unnecessary port interfaces per sprint change proposal
