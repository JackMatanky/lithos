# Story 3.12: Implement Complete Cache Management

## Status: Draft

## Story

**As a** developer,
**I want** complete cache management including deletion reconciliation and schema loading,
**so that** the cache accurately reflects the current vault state and incremental operations work correctly.

## Acceptance Criteria

1. Incremental refresh removes cache entries for notes that have been deleted from the vault
2. Schema loading occurs in both Build and Refresh operations to ensure consistency
3. Single, consistent `ensureCacheDir` implementation across all cache operations
4. Cache state accurately reflects vault state after all operations
5. No orphaned cache entries persist after note deletions
6. Schema validation works correctly in incremental refresh scenarios

## Tasks / Subtasks

- [ ] Task 1: Implement deletion reconciliation in incremental refresh
  - [ ] Modify VaultIndexer.Refresh to identify deleted source files
  - [ ] Add CacheWriterPort.Delete calls for missing source files
  - [ ] Implement proper cache entry cleanup logic
  - [ ] Test deletion reconciliation with various vault changes
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 2: Add schema loading to incremental refresh path
  - [ ] Update RefreshFromCache to load schemas before processing
  - [ ] Ensure schema validation occurs in refresh operations
  - [ ] Maintain schema consistency between Build and Refresh paths
  - [ ] Add error handling for schema loading failures
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 3: Consolidate ensureCacheDir implementations
  - [ ] Identify all ensureCacheDir function locations
  - [ ] Create single, shared implementation in utils package
  - [ ] Update all callers to use the consolidated function
  - [ ] Remove duplicate implementations
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 4: Comprehensive cache state validation
  - [ ] Add cache state verification after all operations
  - [ ] Implement cache-to-vault consistency checks
  - [ ] Test cache management with complex vault operations
  - [ ] Validate schema loading in all code paths
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 5: Quality Assurance - Pre-commit and Validation
  - [ ] Execute `pre-commit run --all-files`, stage files, and write detailed conventional commit message (no `--no-verify` flag)
  - [ ] Run bmad-qa `test-design` to validate test coverage meets requirements
  - [ ] Run bmad-po `validate-next-story` to ensure story completeness and architecture compliance

## Dev Notes

### Source Tree Information

Based on docs/architecture/source-tree.md:

**Primary Files to Modify:**
- `internal/app/vault/indexer.go` - Contains Refresh method and cache operations
- `internal/adapters/spi/cache/json_writer.go` - Cache writer with ensureCacheDir
- `internal/adapters/spi/cache/json_reader.go` - Cache reader operations
- `internal/shared/utils/` - Location for consolidated ensureCacheDir function

**Related Components:**
- `internal/app/query/service.go` - Uses cache data for query operations
- `internal/domain/config.go` - Configuration for cache directory paths

### Architecture Context from docs/architecture/data-models.md

**Cache Models:**
- Cache entries should have lifecycle management
- Schema loading is required for proper cache interpretation
- Cache state must remain consistent with vault state

**FileMetadata Model:**
- Used to track which files exist in vault
- Should be compared against cache entries for reconciliation
- Missing files should trigger cache entry deletion

### Component Specifications from docs/architecture/components.md

**VaultIndexer Component:**
- Build Process: Creates initial cache state
- Refresh Process: Updates cache incrementally while maintaining consistency
- Must handle file deletions and additions correctly
- Schema loading required for both Build and Refresh

**Cache Components:**
- CacheWriterPort: Must support deletion operations
- CacheReaderPort: Must provide complete cache state information
- ensureCacheDir: Should be consistent across all cache operations

### Critical Implementation Notes

**Deletion Reconciliation:**
- Compare current vault file list with existing cache entries
- Identify cache entries without corresponding source files
- Call CacheWriterPort.Delete for orphaned entries
- Maintain referential integrity during deletion

**Schema Loading:**
- Load schemas before any cache processing
- Ensure schemas are available for validation during refresh
- Maintain schema consistency between Build and Refresh operations
- Handle schema loading errors gracefully

**Cache Directory Management:**
- Single ensureCacheDir function in shared utils
- Handle cross-platform path creation
- Proper error handling for directory creation failures
- Consistent behavior across all cache adapters

### Testing

**Test File Locations:**
Based on docs/architecture/testing-strategy.md and source tree:
- Unit tests: `internal/app/vault/indexer_test.go`, `internal/adapters/spi/cache/*_test.go`
- Integration tests: `tests/integration/cache_management_test.go`
- State validation: Custom test utilities for cache-vault consistency

**Testing Standards:**
- Test deletion reconciliation with various file operation scenarios
- Validate schema loading in both Build and Refresh paths
- Test cache directory creation on different platforms
- Include edge cases: permission issues, disk space, concurrent operations

**Testing Framework:**
- Go standard testing package for unit tests
- File system manipulation utilities for integration tests
- Custom cache state verification helpers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-12 | 1.0 | Initial story creation for Epic 3 critical fixes | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

[To be populated by development agent]

### Debug Log References

[To be populated by development agent]

### Completion Notes List

[To be populated by development agent]

### File List

[To be populated by development agent]

## QA Results

[To be populated by QA agent]
