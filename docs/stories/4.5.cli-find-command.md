# Story 4.5: CLI Find Command

## Status

Draft

## Story

**As a** developer,
**I want** CommandOrchestrator and the CLI adapter to offer the interactive `find` flow,
**so that** users can discover templates via fuzzy finder and understand the interactive UX pattern.

## Acceptance Criteria

**CommandOrchestrator FindTemplates Method:**

- 4.5.1: Add `FindTemplates` method to `internal/app/command/orchestrator.go`:
  - Signature: `FindTemplates(ctx context.Context) ([]Template, error)`
  - Delegates to TemplatePort.List() to get available templates
  - Returns list of templates for CLI adapter to display or pass to FinderPort
  - Implementation matches `docs/architecture/components.md#commandorchestrator` exactly

- 4.5.2: Implement error handling for FindTemplates:
  - Returns structured errors for template loading failures
  - Logs template discovery process
  - No templates found returns empty list (not error)

**CLI Find Command:**

- 4.5.3: Add `find` command to `internal/adapters/api/cobra/cli.go`:
  - Command: `lithos find`
  - Description: "Interactively search and select templates"
  - Calls CommandOrchestrator.FindTemplates() to get templates
  - If templates found, launches FinderPort.Find() for selection
  - Displays selected template details
  - Matches `docs/architecture/components.md#cobracliapapter` patterns

- 4.5.4: Implement Template type to satisfy FinderItem interface:
  - Add `DisplayName() string` method returning template name
  - Add `PreviewText() string` method returning template description
  - Enables Template to be used with FinderPort

**Non-Interactive Mode:**

- 4.5.5: Handle non-interactive environments gracefully:
  - Detect when FinderPort returns InteractiveError
  - Display list of available templates as fallback
  - Show usage guidance: "Run in terminal for interactive selection or use: lithos new <template-name>"
  - Respects non-interactive mode per FR10

**Output Formatting:**

- 4.5.6: Implement output formatting for find command:
  - Interactive mode: Launch fuzzy finder, display selection
  - Non-interactive mode: Print template list with formatting
  - Success message: "Selected template: <name>"
  - Template details: Show name, description, file path
  - Per coding standards (clean, readable output)

**Error Handling:**

- 4.5.7: Implement error handling per `docs/architecture/error-handling-strategy.md`:
  - Template loading errors: Show error with remediation
  - Interactive errors: Fall back to list display
  - Cancellation: Exit gracefully without error message
  - No templates: "No templates found. Create templates in templates/ directory"

**Cancellation Handling:**

- 4.5.8: Handle user cancellation (Ctrl+C) gracefully:
  - Detect CancellationError from FinderPort
  - Exit without error message (user choice, not failure)
  - Log cancellation at debug level only
  - Return exit code 0 (success - user cancelled intentionally)

**Logging:**

- 4.5.9: Follow coding standards for logging:
  - Debug level: Template count, finder launch, selection
  - Info level: Command start/end
  - Warn level: Non-interactive fallback
  - Error level: Template loading failures

**Integration Tests:**

- 4.5.10: Create `tests/integration/cli_find_test.go` with tests for:
  - Successful template discovery and listing
  - Interactive selection with stubbed FinderPort
  - Non-interactive fallback with list display
  - Cancellation handling
  - Empty template directory handling
  - Error display and remediation

**End-to-End Tests:**

- 4.5.11: Create `tests/e2e/find_command_test.go` with tests for:
  - Full workflow with real CLI invocation (mocked finder)
  - Output formatting verification
  - Non-interactive mode verification
  - Error message verification

**Quality Gates:**

- 4.5.12: Run `golangci-lint run ./internal/app/command` - all checks pass

- 4.5.13: Run `golangci-lint run ./internal/adapters/api/cobra` - all checks pass

- 4.5.14: Run `go test ./internal/app/command` - all tests pass with >80% coverage

- 4.5.15: Run `go test ./internal/adapters/api/cobra` - all tests pass with >80% coverage

- 4.5.16: Run `go test ./tests/integration` - integration tests pass

- 4.5.17: Run `go test ./tests/e2e` - e2e tests pass

- 4.5.18: Verify FR2 requirements satisfied (CLI command documented)

- 4.5.19: Verify FR10 requirements satisfied (interactive UX with fallback)

- 4.5.20: Update CLI usage documentation with find command

- 4.5.21: Committed with message: `feat: add lithos find command for interactive template selection`

## Tasks / Subtasks

- [ ] Task 1: TDD - Write failing tests for FindTemplates (AC: 4.5.10)
  - [ ] RED: Write failing test for successful template discovery
    - [ ] Create test file `tests/integration/cli_find_test.go`
    - [ ] Write test case for FindTemplates() method
    - [ ] Verify test fails with "undefined: FindTemplates"
    - [ ] Run tests and confirm failure
  - [ ] RED: Write failing test for empty template directory
    - [ ] Write test with no templates available
    - [ ] Run tests and confirm failure
  - [ ] RED: Write failing test for template loading error
    - [ ] Write test with TemplatePort.List() error
    - [ ] Run tests and confirm failure
  - [ ] GREEN: Implement FindTemplates in CommandOrchestrator
    - [ ] Add FindTemplates method to orchestrator
    - [ ] Delegate to TemplatePort.List()
    - [ ] Implement error handling
    - [ ] Add logging
    - [ ] Run tests and verify they pass
  - [ ] REFACTOR: Review SRP
    - [ ] Verify FindTemplates has single responsibility (delegate to port)
    - [ ] Add comprehensive GoDoc
    - [ ] Run `golangci-lint run --fix internal/app/command`
    - [ ] Fix ALL linter warnings
    - [ ] Run tests to verify refactoring
    - [ ] Verify test coverage >80%
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/command`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 2: Implement FinderItem interface for Template (AC: 4.5.4)
  - [ ] RED: Write failing test for interface methods
    - [ ] Write test for DisplayName() method
    - [ ] Write test for PreviewText() method
    - [ ] Run tests and confirm failure
  - [ ] GREEN: Add interface methods to Template
    - [ ] Add DisplayName() method to Template type
    - [ ] Add PreviewText() method to Template type
    - [ ] Verify interface satisfaction at compile time
    - [ ] Run tests and verify they pass
  - [ ] REFACTOR: Add GoDoc
    - [ ] Add GoDoc for DisplayName() explaining purpose
    - [ ] Add GoDoc for PreviewText() explaining purpose
    - [ ] Run `golangci-lint run --fix`
    - [ ] Run tests to verify success
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix`
    - [ ] Fix ALL warnings

- [ ] Task 3: TDD - Implement CLI find command (AC: 4.5.3, 4.5.10-4.5.11)
  - [ ] RED: Write failing test for interactive selection
    - [ ] Write integration test for find command
    - [ ] Mock FinderPort to return selected template
    - [ ] Run tests and confirm failure
  - [ ] RED: Write failing test for non-interactive fallback
    - [ ] Write test with InteractiveError from FinderPort
    - [ ] Run tests and confirm failure
  - [ ] RED: Write failing test for cancellation handling
    - [ ] Write test with CancellationError from FinderPort
    - [ ] Run tests and confirm failure
  - [ ] GREEN: Implement find command in CLI adapter
    - [ ] Add buildFindCommand() method to CLI adapter - Single responsibility: construct find command
    - [ ] Add handleFindCommand() method - Single responsibility: orchestrate find workflow
    - [ ] Add selectTemplate() helper - Single responsibility: launch finder and get selection
    - [ ] Add displayTemplates() helper - Single responsibility: format template list output
    - [ ] Wire command to root command
    - [ ] Run tests and verify they pass
  - [ ] REFACTOR: Decompose into SRP components
    - [ ] Extract `selectTemplate(templates) Template` - Single responsibility: use FinderPort
    - [ ] Extract `displayTemplates(templates)` - Single responsibility: print template list
    - [ ] Extract `formatError(err) string` - Single responsibility: format error messages
    - [ ] Verify buildFindCommand() has single responsibility (construct command)
    - [ ] Verify handleFindCommand() orchestrates, helpers do specific tasks
    - [ ] Add comprehensive GoDoc for all methods
    - [ ] Run `golangci-lint run --fix internal/adapters/api/cobra`
    - [ ] Fix ALL linter warnings
    - [ ] Run tests to verify refactoring
    - [ ] Verify test coverage >80%
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/api/cobra`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 4: Implement non-interactive mode handling (AC: 4.5.5)
  - [ ] Detect InteractiveError from FinderPort
  - [ ] Implement fallback template list display using displayTemplates()
  - [ ] Add usage guidance message
  - [ ] Run tests to verify fallback works

- [ ] Task 5: Implement output formatting (AC: 4.5.6)
  - [ ] Format interactive mode output
  - [ ] Format non-interactive mode list (via displayTemplates())
  - [ ] Format template details display
  - [ ] Run tests to verify output format

- [ ] Task 6: Implement error and cancellation handling (AC: 4.5.7-4.5.8)
  - [ ] Handle template loading errors via formatError()
  - [ ] Handle CancellationError gracefully
  - [ ] Handle empty templates
  - [ ] Add error remediation messages
  - [ ] Run tests to verify error handling

- [ ] Task 7: Implement logging (AC: 4.5.9)
  - [ ] Add debug logging for internal state
  - [ ] Add info logging for lifecycle
  - [ ] Add warn logging for fallback
  - [ ] Add error logging for failures
  - [ ] Verify log levels match standards

- [ ] Task 8: Quality verification (AC: 4.5.12-4.5.17)
  - [ ] Run golangci-lint on command package
  - [ ] Run golangci-lint on cobra adapter
  - [ ] Run unit tests for all packages
  - [ ] Run integration tests
  - [ ] Run e2e tests
  - [ ] Fix any linting or test failures

- [ ] Task 9: Verify requirements and update docs (AC: 4.5.18-4.5.20)
  - [ ] Verify FR2 requirements satisfied
  - [ ] Verify FR10 requirements satisfied
  - [ ] Update CLI usage documentation
  - [ ] Add command examples
  - [ ] Document non-interactive mode

- [ ] Task 10: Commit changes (AC: 4.5.21)
  - [ ] Review all changes
  - [ ] Verify tests pass
  - [ ] Commit with proper message

## Dev Notes

### Refactoring Guidelines

**SRP Decomposition for CLI Find Command:**

The handleFindCommand() method orchestrates the workflow, delegating specific responsibilities to focused helpers:

**Extract These Helpers:**

1. **selectTemplate(templates []Template) (Template, error)**
   - Single responsibility: Launch FinderPort and get user selection
   - Wraps FinderPort.Find() call
   - Returns selected template or error
   - Why extract: Template selection is distinct from error handling/display

2. **displayTemplates(templates []Template)**
   - Single responsibility: Print formatted list of templates
   - Used for non-interactive fallback
   - Handles empty list case
   - Why extract: Output formatting separate from command logic

3. **formatError(err error) string**
   - Single responsibility: Convert errors to user-friendly messages
   - Detects error types (InteractiveError, CancellationError)
   - Adds remediation guidance
   - Why extract: Error formatting reused across commands

**When to Decompose:**

- If handleFindCommand() exceeds 25 lines, extract helpers
- If template display logic is >10 lines, extract displayTemplates()
- If error formatting is duplicated, extract formatError()

**Naming Standards:**

- Helpers: camelCase, verb-object pattern (selectTemplate, displayTemplates, formatError)
- Command builders: buildXCommand pattern (buildFindCommand)
- Handlers: handleXCommand pattern (handleFindCommand)

**Documentation Requirements:**

- Package comment explaining CLI adapter responsibilities
- GoDoc for each command builder explaining command structure
- GoDoc for each handler explaining workflow
- GoDoc for helpers explaining single responsibility
- Inline comments for complex error handling

[... rest of Dev Notes from original file ...]

## Change Log

| Date       | Version | Description                                               | Author             |
| ---------- | ------- | --------------------------------------------------------- | ------------------ |
| 2025-10-28 | 1.0     | Story created from Epic 4 requirements                    | Bob (Scrum Master) |
| 2025-10-28 | 1.1     | Applied quality fixes: TDD, SRP, linting, GoDoc, coverage | QA Specialist      |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent during implementation_

### Debug Log References

_To be completed by dev agent during implementation_

### Completion Notes List

_To be completed by dev agent during implementation_

### File List

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
