# Story 5.5: Dependency Injection and E2E Test for Schema-Driven Lookups

## Status: Draft

## Story

As a developer,
I want to implement dependency injection for the schema-driven lookup components and add comprehensive e2e tests,
So that the schema-driven lookup functionality is properly wired and thoroughly tested end-to-end.

## Context

This story completes the schema-driven lookups (Epic 5) by wiring all components through dependency injection and ensuring the entire lookup workflow works correctly through e2e testing. It follows the same pattern established in story 1.14 for the foundational CLI.

## Acceptance Criteria

### Functional Requirements

1. All schema-driven lookup components (lookup functions, query functions, fileclass functions, integration test) are properly registered in the DI container
2. The main.go file includes the schema-driven lookup dependencies in the application wiring
3. E2E tests cover the complete schema-driven lookup workflow from template function calls through schema resolution to data retrieval
4. The e2e tests validate actual schema-driven behavior with realistic test data
5. Test scenarios include various lookup patterns and schema configurations

### Integration Requirements

6. Schema-driven lookups integrate seamlessly with the existing template engine
7. Lookup functions work correctly with schema validation and resolution
8. Query functions integrate properly with property bank data structures
9. Fileclass functions handle file-based lookups accurately
10. No breaking changes to existing template functionality

### Quality Requirements

11. All e2e tests pass consistently
12. Code coverage for schema-driven lookup components meets project standards (80%+)
13. Error handling is tested for schema validation failures, missing data, and lookup errors
14. Tests run within reasonable time limits (< 30 seconds for full suite)
15. Test cleanup properly handles temporary schemas and test data

## Dev Notes

### Previous Story Insights

From story 5.4 (schema-driven lookup integration test): The lookup components are implemented and basic integration testing is in place. Ready for full DI wiring and comprehensive e2e testing.

### Data Models

- **Schema Models**: Use existing schema validation and resolution models [Source: docs/architecture/data-models.md#schema-models]
- **Property Bank Models**: Integrate with established property bank structures [Source: docs/architecture/data-models.md#property-bank]
- **Lookup Result Models**: Follow template engine result patterns [Source: docs/architecture/data-models.md#lookup-results]

### API Specifications

- **Template Engine Interface**: Follows template engine patterns from story 1.9 [Source: docs/architecture/backend-architecture.md#template-engine]
- **Schema Resolution**: Uses schema resolver from story 2.7 [Source: docs/architecture/backend-architecture.md#schema-resolver]
- **Lookup Functions**: Implement template function interfaces [Source: docs/architecture/backend-architecture.md#template-functions]

### Component Specifications

- **DI Container**: Extend the existing registry from story 1.7 with schema-driven lookup components [Source: docs/architecture/backend-architecture.md#dependency-injection]
- **E2E Test Structure**: Follow the e2e testing pattern from story 1.14 [Source: docs/architecture/testing-strategy.md#e2e-testing]
- **Schema Test Data**: Create test schemas and data for realistic testing [Source: docs/architecture/testing-strategy.md#test-data]

### File Locations

- **Main Application**: Update cmd/lithos/main.go to include schema-driven lookup dependencies [Source: docs/architecture/source-tree.md#main-application]
- **DI Registry**: Extend internal/shared/registry/registry.go with lookup components [Source: docs/architecture/source-tree.md#registry-package]
- **E2E Tests**: Create tests/e2e/schema_lookup_test.go [Source: docs/architecture/source-tree.md#e2e-tests]
- **Test Schemas**: Add testdata/schemas/ with sample schema files [Source: docs/architecture/source-tree.md#test-data]

### Testing Requirements

- **E2E Test Coverage**: Complete workflow from template function to schema-driven result [Source: docs/architecture/testing-strategy.md#e2e-scenarios]
- **Integration Tests**: Component interactions within the schema-driven lookup system [Source: docs/architecture/testing-strategy.md#integration-testing]
- **Schema Validation**: Test various schema configurations and validation scenarios [Source: docs/architecture/testing-strategy.md#schema-testing]

### Technical Constraints

- **Go Version**: Must be compatible with existing Go 1.21+ codebase [Source: docs/architecture/tech-stack.md#go-version]
- **Schema Compatibility**: Handle different schema formats and versions [Source: docs/architecture/tech-stack.md#schema-compatibility]
- **Dependencies**: Use existing libraries for schema processing [Source: docs/architecture/tech-stack.md#dependencies]

## Tasks / Subtasks

- [ ] Task 1: Register schema-driven lookup components in DI container
  - [ ] Add lookup function implementations to registry
  - [ ] Register query function handlers
  - [ ] Add fileclass function processors
  - [ ] Include schema integration components in registry

- [ ] Task 2: Wire schema-driven lookup dependencies in main.go
  - [ ] Import schema-driven lookup registry functions
  - [ ] Add lookup components to application container
  - [ ] Ensure proper initialization order with schema system
  - [ ] Test basic application startup with lookup components

- [ ] Task 3: Create e2e test infrastructure
  - [ ] Create tests/e2e/schema_lookup_test.go
  - [ ] Set up test schema files and data structures
  - [ ] Create test scenarios for different lookup patterns
  - [ ] Implement test helper functions for schema setup/cleanup

- [ ] Task 4: Implement e2e test scenarios
  - [ ] Test template function calls with schema-driven lookups
  - [ ] Verify schema resolution and validation in lookup process
  - [ ] Test query functions against property bank data
  - [ ] Validate fileclass functions with file-based lookups
  - [ ] Test error handling for invalid schemas and missing data

- [ ] Task 5: Add comprehensive test coverage
  - [ ] Ensure 80%+ code coverage for new integration code
  - [ ] Test various schema configurations and lookup patterns
  - [ ] Validate performance meets requirements
  - [ ] Run tests across different schema formats

- [ ] Task 6: Documentation and cleanup
  - [ ] Update any necessary documentation
  - [ ] Ensure test schemas are properly organized
  - [ ] Verify no breaking changes to existing template functionality

## Testing

### E2E Test Scenarios

1. **Complete Schema-Driven Lookup Workflow**
   - Given: Template with schema-driven lookup functions
   - When: Template is processed with schema references
   - Then: Correct data is retrieved and resolved from schemas

2. **Schema Validation in Lookups**
   - Given: Lookup function with invalid schema reference
   - When: Template processing occurs
   - Then: Validation errors are handled gracefully

3. **Query Function Integration**
   - Given: Query function accessing property bank data
   - When: Schema-driven query is executed
   - Then: Correct results are returned based on schema constraints

### Validation Steps

- Run full e2e test suite: `go test ./tests/e2e/...`
- Verify code coverage: `go test -cover ./internal/app/schema/...`
- Manual testing: Execute templates with schema-driven lookups
- Integration testing: Verify with existing template engine

## Dev Agent Record

### Agent Model Used

bmad-dev v1.0 - Full Stack Developer specialized in Go implementation and testing

### Dev Notes

This story requires careful integration with the existing schema system and template engine. The DI wiring must coordinate with schema resolution dependencies. E2E tests need realistic schema configurations.

### File List

- cmd/lithos/main.go (modified)
- internal/shared/registry/registry.go (modified)
- tests/e2e/schema_lookup_test.go (new)
- testdata/schemas/ (new directory with test schema files)

### Change Log

- 2025-01-12: Initial story creation following epic 5 completion pattern
