# Story 3.7: Implement Query Service

## Status

Draft

## Story

As a developer, I want to implement the QueryService domain service, so that read-side access to indexed data follows the architectural patterns.

## Acceptance Criteria

- 3.7.1: QueryService includes Filter struct with Key, Operator, and Value fields for flexible searching.
- 3.7.2: Query method accepts filter parameters and returns filtered Note slices through CacheQueryPort.
- 3.7.3: Initial implementation supports basic iteration with preparation for advanced filtering.
- 3.7.4: Service maintains thread-safe access patterns using `sync.RWMutex` as specified in components documentation.

## Tasks / Subtasks

- [ ] Task 1 (AC: 3.7.1): Implement `Filter` Struct and `QueryService`
  - [ ] Create a new file `internal/app/query/query_service.go`.
  - [ ] Define the `Filter` struct with `Key`, `Operator`, and `Value` fields.
  - [ ] Define the `QueryService` struct, including a `sync.RWMutex`.
  - [ ] Implement the `NewQueryService` constructor that accepts its dependencies (ports) via dependency injection.
- [ ] Task 2 (AC: 3.7.2, 3.7.3): Implement `Query` Method
  - [ ] Implement the `Query(ctx context.Context, filter QueryFilter) ([]Note, error)` method.
  - [ ] The method should use the `CacheQueryPort` to get all notes.
  - [ ] For the initial implementation, the method should iterate over all notes and return them, ignoring the filter.
- [ ] Task 3 (AC: 3.7.4): Implement Thread-Safe Access
  - [ ] Use the `sync.RWMutex` to ensure that concurrent access to the `QueryService` is thread-safe.
- [ ] Task 4: Add Unit Tests
  - [ ] Add unit tests for the `QueryService` in `internal/app/query/query_service_test.go`.
  - [ ] Use mocks for the `CacheQueryPort`.
  - [ ] Test that the `Query` method returns all notes from the cache.
- [ ] Task 5: Full method and function decomposition into private srp function while ensuring a logical file organization.
- [ ] Task 6: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass
- [ ] Task 7: Pre-commit and commit readiness
  - [ ] Execute `pre-commit run` to confirm hooks pass
  - [ ] Stage updates and commit with a fully descriptive conventional commit message

## Dev Notes

### Data Models
- The `Note` model is the data structure returned by the `QueryService`. [Source: docs/architecture/data-models.md#note]
- A `Filter` struct should be created to support future filtering capabilities.

### Component Specifications
- The `QueryService` provides a read-only view of the indexed data. [Source: docs/architecture/components.md#queryservice]
- It uses the `CacheQueryPort` to access the cached data. [Source: docs/architecture/components.md#queryservice]
- Thread-safe access is a key requirement. [Source: docs/architecture/components.md#queryservice]

### File Locations
- The `QueryService` should be implemented in `internal/app/query/query_service.go`. [Source: docs/architecture/source-tree.md#source-tree]
- Tests should be in `internal/app/query/query_service_test.go`. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Testing Requirements
- Unit tests must use a mock `CacheQueryPort`. [Source: docs/architecture/testing-strategy.md#unit-tests]
- Tests should verify that the `Query` method returns the expected data. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Technical Constraints
- The `Query` method must be thread-safe. [Source: docs/architecture/components.md#queryservice]
- The initial implementation should focus on basic iteration, with advanced filtering to be added in a future story. [Source: docs/prd/epic-3-vault-indexing-engine.md#story-3-7-implement-query-service]

## Change Log

| Date       | Version | Description                                  | Author |
| ---------- | ------- | -------------------------------------------- | ------ |
| 2025-10-22 | 1.0     | Initial story draft for QueryService.        | sm     |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
