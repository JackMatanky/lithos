# Story 2.3: Implement Property Domain Models

## Status

Approved

## Story

As a developer, I want to implement the Property models and PropertySpec from the architecture, so that I have robust property definitions.

## Acceptance Criteria

**Functional Requirements:**

2.3.1: Property model with Name, Required, Array, and Spec fields is implemented following the architecture specification.
2.3.2: PropertySpec interface and concrete implementations (StringPropertySpec, NumberPropertySpec, DatePropertySpec, FilePropertySpec, BoolPropertySpec) are created.
2.3.3: PropertyBank model with Properties map and Location field is implemented for reusable property definitions.
2.3.4: All property models include unit tests for validation and behavior.

**Integration Requirements:**

2.3.5: Property models integrate with Schema model for validation rules.
2.3.6: PropertySpec implementations support JSON unmarshaling from schema files.
2.3.7: PropertyBank supports loading from JSON files with $ref resolution.

**Quality Requirements:**

2.3.8: Unit tests cover Property model validation and PropertySpec polymorphism.
2.3.9: Code follows project coding standards and naming conventions.
2.3.10: Property models include proper error handling for invalid configurations.

## Tasks / Subtasks

- [ ] Task 1: Implement Property domain model (AC: 2.3.1, 2.3.5)
  - [ ] Create `internal/domain/property.go` with Property struct containing:
    - Name (string) - Property identifier matching frontmatter key
    - Required (boolean) - Whether property must be present in frontmatter
    - Array (boolean) - Whether property accepts multiple values (YAML list)
    - Spec (PropertySpec interface) - Type-specific validation configuration
  - [ ] Implement PropertySpec interface with Validate(value interface{}) error method
  - [ ] Add NewProperty constructor with validation of field constraints
  - [ ] Ensure integration with Schema model for validation rules composition

- [ ] Task 2: Implement PropertySpec concrete types (AC: 2.3.2, 2.3.6)
  - [ ] Create StringPropertySpec with Enum ([]string) and Pattern (string) fields for validation
  - [ ] Create NumberPropertySpec with Min, Max (*float64) and Step (*float64) for numeric validation
  - [ ] Create DatePropertySpec with Format (string) field using Go time layout syntax
  - [ ] Create FilePropertySpec with FileClass and Directory (string) fields for file reference constraints
  - [ ] Create BoolPropertySpec (no additional fields, type checking only)
  - [ ] Implement Validate(value interface{}) error method for each PropertySpec type
  - [ ] Implement JSON unmarshaling using Go stdlib encoding/json with discriminator pattern

- [ ] Task 3: Implement PropertyBank model (AC: 2.3.3, 2.3.7)
  - [ ] Create `internal/domain/property_bank.go` with PropertyBank struct containing:
    - Properties (map[string]Property) - Named property definitions by unique identifier
    - Location (string) - Path to property bank directory (default: schemas/_fields/)
  - [ ] Implement NewPropertyBank constructor with location validation
  - [ ] Add RegisterProperty method for adding reusable property definitions
  - [ ] Add ResolveReference method for $ref resolution using JSON pointer syntax
  - [ ] Ensure thread-safe access patterns for SchemaRegistry concurrent usage

- [ ] Task 4: Add comprehensive testing (AC: 2.3.4, 2.3.8, 2.3.9, 2.3.10)
  - [ ] Create `internal/domain/property_test.go` with table-driven unit tests for Property model
  - [ ] Test Property constructor validation and field constraint enforcement
  - [ ] Add tests for all PropertySpec implementations using table-driven test patterns:
    - StringPropertySpec: enum validation, pattern matching, edge cases
    - NumberPropertySpec: min/max bounds, step validation, integer detection
    - DatePropertySpec: format parsing with various Go time layouts
    - FilePropertySpec: fileClass filtering, directory constraints
    - BoolPropertySpec: type checking and error cases
  - [ ] Create `internal/domain/property_bank_test.go` with PropertyBank registry tests
  - [ ] Test JSON serialization/unmarshaling with discriminator pattern validation
  - [ ] Test $ref resolution with valid and invalid reference scenarios
  - [ ] Add error condition tests for malformed JSON, invalid constraints, circular references
  - [ ] Ensure ≥85% coverage for domain models per testing-strategy.md standards

## Dev Notes

### Context Source

- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: Domain model implementation for property validation system
- **Integration Points**: Property models used by Schema for validation rules and PropertyBank for reusable definitions
- **Goal**: Establish core domain models for schema property validation

### Existing System Context

- **Current State**: Basic domain models exist but Property models not yet implemented
- **Technology Stack**: Go 1.23+ with stdlib JSON for serialization
- **Integration Points**: Property models used by Schema for validation and PropertyBank for reusable definitions
- **Architecture Pattern**: Domain Core models following hexagonal architecture

### Integration Approach

- **Safe Implementation**: Create new domain models without affecting existing functionality
- **Polymorphism Support**: PropertySpec interface enables type-specific validation
- **JSON Compatibility**: Ensure models can be unmarshaled from JSON schema files
- **Reference Resolution**: PropertyBank supports $ref for reusable property definitions

### Technical Constraints

- **Domain Core**: Property models belong in `internal/domain/` as pure business logic
- **Interface Polymorphism**: PropertySpec interface with concrete implementations for each type
- **JSON Serialization**: Use Go stdlib JSON with proper struct tags and custom unmarshaling
- **Type Safety**: All fields properly typed, no interface{} overuse

### Key Files to Modify/Create

- `internal/domain/property.go` - **CREATE** - Property model and PropertySpec implementations
- `internal/domain/property_bank.go` - **CREATE** - PropertyBank model
- `internal/domain/property_test.go` - **CREATE** - Unit tests for Property models

### Risk Assessment

#### Implementation Risks

- **Primary Risk**: Complex PropertySpec polymorphism may introduce validation bugs
- **Mitigation**: Implement incrementally with comprehensive unit tests
- **Verification**: Test each PropertySpec type thoroughly before integration
- **Performance Risk**: PropertySpec validation could become bottleneck in large vaults
- **Mitigation**: Use efficient stdlib validation (regexp.Compile once, reuse compiled patterns)
- **Concurrency Risk**: PropertyBank registry accessed by multiple goroutines
- **Mitigation**: Design for thread-safe access patterns required by SchemaRegistry

#### Rollback Plan

- **Git Rollback**: Revert to previous commit if PropertySpec validation fails
- **File Removal**: Delete new property files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

#### Performance Considerations

- **PropertySpec Validation**: Critical path for vault indexing performance (PRD target: <300ms render)
- **Regex Compilation**: Compile StringPropertySpec patterns once during schema loading, reuse during validation
- **Memory Allocation**: Minimize allocations in Validate methods to reduce GC pressure during batch validation
- **Concurrent Access**: PropertyBank registry must support concurrent reads by SchemaRegistry domain service
- **JSON Unmarshaling**: Use efficient stdlib patterns for PropertySpec discriminator unmarshaling

### Previous Story Insights

- Story 2.2 will implement Schema model providing foundation for property validation
- This story builds on domain model patterns established in Epic 1 (File, Frontmatter, Note models)
- Hexagonal architecture patterns established in Story 1.14/1.15 provide guidance for domain model placement

### Data Models

- Property model defined in `docs/architecture/data-models.md#property` with required fields: Name, Required, Array, Spec
- PropertySpec interface with Validate(value interface{}) error method for polymorphic validation
- Five concrete PropertySpec implementations: StringPropertySpec, NumberPropertySpec, DatePropertySpec, FilePropertySpec, BoolPropertySpec
- PropertyBank model defined in `docs/architecture/data-models.md#propertybank` with Properties map[string]Property and Location string field
- JSON unmarshaling using discriminator pattern to determine PropertySpec concrete type
- $ref resolution pattern for reusable property definitions across schemas

### API Specifications

- Property models are pure domain core, no direct API exposure
- Used by Schema model for validation rules and PropertyBank for reusable definitions
- PropertySpec interface enables polymorphic validation by SchemaValidator domain service
- Integration with SchemaRegistry for property bank loading and reference resolution
- Used by SchemaEnginePort adapter for JSON unmarshaling from schema files

### Component Specifications

- Property models located in `internal/domain/property.go` per source-tree.md
- PropertyBank model in `internal/domain/property_bank.go` per architecture design
- Follows hexagonal architecture: pure domain core with no infrastructure dependencies
- Supports JSON serialization via Go stdlib `encoding/json` per tech-stack.md
- PropertySpec interface enables polymorphic validation by SchemaValidator domain service
- PropertyBank provides reusable property registry for SchemaRegistry domain service

### File Locations

- Property model: `internal/domain/property.go` (create new)
- PropertyBank model: `internal/domain/property_bank.go` (create new)
- Tests: `internal/domain/property_test.go` and `internal/domain/property_bank_test.go` (create new)

### Testing Requirements

- Unit tests for Property model field validation and PropertySpec polymorphism
- Unit tests for all PropertySpec implementations and type-specific validation
- Unit tests for PropertyBank loading and $ref resolution
- Integration tests for JSON unmarshaling and property validation

### Technical Constraints

- Follow domain core principles: pure business logic, no infrastructure dependencies per components.md
- Use Go stdlib `encoding/json` for serialization with proper struct tags per tech-stack.md
- Implement PropertySpec as interface with concrete implementations for polymorphic validation
- Support $ref resolution in PropertyBank for reusable properties per data-models.md
- Follow coding-standards.md: Go 1.23+ features, Result pattern for error handling if crossing boundaries
- Ensure thread-safe design for use by SchemaRegistry domain service with concurrent access

### Source References

- [Architecture: docs/architecture/data-models.md#property] - Property model specification
- [Architecture: docs/architecture/data-models.md#propertyspec-type-specific-configurations] - PropertySpec interface and implementations
- [Architecture: docs/architecture/data-models.md#propertybank] - PropertyBank model and $ref resolution
- [Architecture: docs/architecture/components.md#schemaregistry] - SchemaRegistry domain service integration
- [Architecture: docs/architecture/components.md#schemavalidator] - SchemaValidator polymorphic validation
- [Architecture: docs/architecture/components.md#schemaengineport] - SchemaEnginePort JSON loading requirements
- [Architecture: docs/architecture/source-tree.md] - File location specifications in internal/domain/
- [Architecture: docs/architecture/tech-stack.md#json-processing] - Go stdlib encoding/json usage
- [Architecture: docs/architecture/coding-standards.md#core-standards] - Go 1.23+ requirements and standards
- [Architecture: docs/architecture/testing-strategy.md#unit-tests] - Testing patterns and coverage targets

### Testing

#### Testing Strategy

- **Unit Tests**: Test Property model creation, PropertySpec validation, PropertyBank loading
- **Validation Tests**: Test type-specific validation logic and error handling
- **Integration Tests**: Test JSON unmarshaling and $ref resolution

#### Testing Standards

- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use table-driven tests for multiple validation scenarios
- Test both success and failure cases
- Target ≥85% coverage for `internal/app` domain services (per testing-strategy.md)
- Target ≥70% overall coverage for new domain models

### Definition of Done

- [ ] Property model implemented with all required fields and PropertySpec interface
- [ ] All PropertySpec concrete implementations created with proper validation
- [ ] PropertyBank model implemented with Properties map and $ref resolution
- [ ] JSON unmarshaling works correctly for all property types using Go stdlib encoding/json
- [ ] PropertySpec polymorphic validation supports SchemaValidator domain service
- [ ] PropertyBank registry provides thread-safe access for SchemaRegistry concurrent usage
- [ ] Domain-driven design principles followed with proper encapsulation and no infrastructure dependencies
- [ ] Unit tests pass with ≥85% coverage for domain models per testing-strategy.md
- [ ] Code follows project coding-standards.md: Go 1.23+ features, proper naming conventions
- [ ] Error handling implemented for invalid configurations with structured error types
- [ ] Performance optimized for vault indexing: efficient regex compilation, minimal allocations

## QA Results

*This section will be populated by the QA Agent during review of the completed story implementation*

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft for Property domain models implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- Property model patterns from data-models.md
- PropertySpec polymorphism requirements from architecture
- JSON processing requirements from tech-stack.md

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- Property model requirements extracted from data-models.md
- PropertySpec interface and implementations detailed
- Testing strategy aligned with project standards

### File List

**Files to Create/Modify:**
- `internal/domain/property.go` - Property model and PropertySpec implementations
- `internal/domain/property_bank.go` - PropertyBank model
- `internal/domain/property_test.go` - Unit tests for Property models

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Story draft created with full technical context | sm |
