# Story 3.11: Optimize File Scanning and Memory Usage

<!-- Source: docs/course_correction/sprint-change-proposal-2025-01-12-epic3-vault-indexing-critical-fixes.md -->

## Status: Draft

## Story

**As a** developer,
**I want** the vault scanning process to be memory-efficient and performant,
**so that** large vaults with media files don't cause excessive memory usage or slow scanning performance.

## Acceptance Criteria

1. Only markdown files have their content loaded into memory during vault scanning
2. Cache directory exclusion works correctly without false positives for legitimate notes
3. Large vaults with PDFs, images, and other binary files scan efficiently
4. Memory usage remains predictable and bounded regardless of vault size
5. File filtering happens before content loading to prevent unnecessary memory allocation
6. Proper mime-type detection is used for accurate file classification

## Tasks / Subtasks

- [ ] Task 1: Implement FileMetadata-first scanning approach
  - [ ] Modify VaultReaderAdapter.ScanAll to return FileMetadata without content
  - [ ] Add file extension filtering before content loading
  - [ ] Implement proper cache directory exclusion logic
  - [ ] Replace unsafe string matching with path segment comparison
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 2: Add content loading optimization
  - [ ] Update content loading to happen only after file filtering
  - [ ] Implement lazy content loading for markdown files only
  - [ ] Add memory usage monitoring and bounds checking
  - [ ] Optimize file reading for large vault scenarios
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 3: Enhance file type detection
  - [ ] Add mime-type detection for better file classification
  - [ ] Implement fallback logic for files without extensions
  - [ ] Add configuration for custom file type mappings
  - [ ] Test with various file types and edge cases
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 4: Performance testing and validation
  - [ ] Create test vaults with mixed file types (markdown + binaries)
  - [ ] Benchmark scanning performance before and after optimization
  - [ ] Validate memory usage with large binary files present
  - [ ] Test cache directory exclusion with various vault structures
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 5: Quality Assurance - Pre-commit and Validation
  - [ ] Execute `pre-commit run --all-files`, stage files, and write detailed conventional commit message (no `--no-verify` flag)
  - [ ] Run bmad-qa `test-design` to validate test coverage meets requirements
  - [ ] Run bmad-po `validate-next-story` to ensure story completeness and architecture compliance

## Dev Notes

### Source Tree Information

Based on docs/architecture/source-tree.md:

**Primary Files to Modify:**
- `internal/adapters/spi/vault/reader.go` - Contains ScanAll method that currently loads all file content
- `internal/domain/vault.go` - FileMetadata and related structures
- `internal/shared/utils/` - May need file type detection utilities

**Related Components:**
- `internal/app/vault/indexer.go` - Uses ScanAll results for processing
- `internal/adapters/spi/cache/` - Cache operations that may be affected by content loading changes

### Architecture Context from docs/architecture/data-models.md

**FileMetadata Model:**
- Currently includes content field loaded during scanning
- Used by VaultIndexer to determine which files to process
- Should be separated from content loading for efficiency

**VaultFile Model:**
- Represents files in the vault with metadata
- Content loading should be deferred until actually needed
- File type classification should happen early in the process

### Component Specifications from docs/architecture/components.md

**VaultReaderAdapter Component:**
- ScanAll method currently loads all file contents
- Should be modified to scan metadata first, then load content selectively
- File filtering should happen at the adapter level for efficiency

**VaultIndexer Component:**
- Build process: scan → filter → load content → process
- Should receive filtered FileMetadata to avoid redundant filtering
- Content loading should be optimized for memory usage

### Critical Implementation Notes

**File Filtering Strategy:**
- Filter by extension first (.md, .markdown)
- Exclude cache directories (.lithos subdirectories)
- Use proper path manipulation instead of string contains
- Add mime-type detection as fallback for files without extensions

**Memory Optimization:**
- Load content only for files that pass all filters
- Implement streaming or chunked reading for large files if needed
- Add memory monitoring to prevent excessive usage
- Consider lazy loading patterns for content access

**Cache Directory Handling:**
- Properly identify .lithos directories in any vault location
- Exclude entire directory trees, not just individual files
- Handle nested cache directories correctly
- Ensure exclusion doesn't affect legitimate note files

### Testing

**Test File Locations:**
Based on docs/architecture/testing-strategy.md and source tree:
- Unit tests: `internal/adapters/spi/vault/reader_test.go`
- Integration tests: `tests/integration/vault_scanning_test.go`
- Performance tests: `tests/performance/vault_scanning_bench_test.go`

**Testing Standards:**
- Test with vaults containing 1000+ files including large binaries
- Benchmark memory usage and scanning time
- Test cache directory exclusion with various vault structures
- Validate file type detection accuracy
- Include edge cases: files without extensions, unusual directory structures

**Testing Framework:**
- Go standard testing package for unit tests
- Custom performance testing utilities
- File system test helpers from `tests/utils/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-12 | 1.0 | Initial story creation for Epic 3 critical fixes | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

[To be populated by development agent]

### Debug Log References

[To be populated by development agent]

### Completion Notes List

[To be populated by development agent]

### File List

[To be populated by development agent]

## QA Results

[To be populated by QA agent]
