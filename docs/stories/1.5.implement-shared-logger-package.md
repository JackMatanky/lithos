# Story 1.5: Implement Shared Logger Package

## Status

Draft

## Story

As a developer, I want to implement a shared logger package, so that the application has consistent structured logging.

## Acceptance Criteria

- 1.5.1: `internal/shared/logger/` package is created for structured logging.
- 1.5.2: Logger supports log levels (Debug, Info, Warn, Error).
- 1.5.3: Logger outputs structured JSON format with timestamps and context.
- 1.5.4: Package includes unit tests for logging functionality.
- 1.5.5: Package includes comprehensive README.md documentation with usage examples.

## Tasks / Subtasks

- [ ] Task 1: Set up logger package structure and dependencies
  - [ ] Create internal/shared/logger/ directory
  - [ ] Create logger.go file with package declaration and imports
  - [ ] Add github.com/rs/zerolog v1.34.0 dependency to go.mod
  - [ ] Add golang.org/x/term dependency for TTY detection

- [ ] Task 2: Implement core logger functionality
  - [ ] Define global logger instance with zerolog.Logger
  - [ ] Implement WithComponent(component string) zerolog.Logger method
  - [ ] Implement WithOperation(operation string) zerolog.Logger method
  - [ ] Implement WithCorrelationID(id string) zerolog.Logger method
  - [ ] Configure JSON output by default with TTY detection for pretty-print

- [ ] Task 3: Implement log level support
  - [ ] Configure logger to support Debug, Info, Warn, Error levels
  - [ ] Add level filtering based on configuration
  - [ ] Ensure proper level hierarchy (Debug < Info < Warn < Error)

- [ ] Task 4: Implement structured logging with context
  - [ ] Add timestamp fields to all log entries
  - [ ] Support correlation_id, component, command fields
  - [ ] Support optional template_id, file_path fields
  - [ ] Ensure sensitive data filtering (no prompt responses or rendered content)

- [ ] Task 5: Create comprehensive unit tests
  - [ ] Create logger_test.go file with table-driven tests
  - [ ] Test log level filtering and output
  - [ ] Test context field addition (component, operation, correlation_id)
  - [ ] Test JSON vs pretty-print output modes
  - [ ] Test sensitive data filtering
  - [ ] Verify logger interface compliance

- [ ] Task 6: Run tests and verify implementation
  - [ ] Execute go test ./internal/shared/logger/
  - [ ] Verify all tests pass with proper coverage (≥85%)
  - [ ] Run golangci-lint to ensure code standards compliance
  - [ ] Verify zerolog integration works correctly
  - [ ] Confirm log output formats match specifications

- [ ] Task 7: Pass pre-commit hooks and commit changes
  - [ ] Run pre-commit hooks: golangci-lint run and gitleaks detect
  - [ ] Ensure all hooks pass without errors
  - [ ] Stage all changed files (logger package and go.mod)
  - [ ] Create conventional commit message following project standards
  - [ ] Commit all changes with the conventional commit message

- [ ] Task 8: Create package README.md
  - [ ] Create internal/shared/logger/README.md file
  - [ ] Document package purpose and usage
  - [ ] Include code examples for basic usage and context methods
  - [ ] Document log output formats (JSON and pretty-print)
  - [ ] Include configuration options and best practices
  - [ ] Add integration examples with error handling

## Dev Notes

### Previous Story Insights

Story 1.2 established the hexagonal architecture directory structure. The `internal/shared/` directory exists and follows the source tree structure from `docs/architecture/source-tree.md`. Story 1.4 (shared errors package) provides the foundation for error handling that this logger will integrate with.

### Logger Package Specifications

[Source: architecture/components.md#logger]

**Package Purpose:** Centralized structured logging wrapper around zerolog. Provides consistent log formatting across all components. Supports both JSON (machine-readable) and pretty-print (human-readable) output modes. Filters sensitive data and provides context-aware logging.

**Architecture Layer:** Shared Internal Package (Cross-Cutting Concern). Used by all layers. Not domain logic or infrastructure—pure technical concern. Centralized to enforce consistent logging patterns.

**Key Interfaces Required:**
- `Log zerolog.Logger` - Global logger instance
- `WithComponent(component string) zerolog.Logger` - Add component context
- `WithOperation(operation string) zerolog.Logger` - Add operation context
- `WithCorrelationID(id string) zerolog.Logger` - Add correlation ID

### Logging Standards

[Source: architecture/error-handling-strategy.md#logging-standards]

**Library:** `github.com/rs/zerolog` via the shared `logger` package (JSON mode by default; pretty-print when TTY detected).

**Required Fields:** `correlation_id` (UUIDv7 per command), `component` (e.g., `template.engine`), `command` (`new`, `find`, `index`), plus optional `template_id` or `file_path`.

**Levels:**
- `debug` for development diagnostics and verbose flag usage.
- `info` for normal command summaries.
- `warn` for validation failures or partial successes.
- `error` for unexpected faults or data corruption attempts.

**Sensitive Data:** Prompt responses and rendered content never appear in logs—only metadata and error hints.

### Expected Log Output Examples

**JSON Format (default, machine-readable):**
```json
{"level":"info","correlation_id":"0192d1b8-5c5c-7b8f-9c5c-8f5c7b8f9c5c","component":"template.engine","command":"new","template_id":"note.md","message":"Template processing completed successfully"}
```

**Pretty-print Format (when TTY detected):**
```
12:34:56 INF Template processing completed successfully component=template.engine command=new correlation_id=0192d1b8-5c5c-7b8f-9c5c-8f5c7b8f9c5c template_id=note.md
```

**Error with context:**
```json
{"level":"error","correlation_id":"0192d1b8-5c5c-7b8f-9c5c-8f5c7b8f9c5c","component":"vault.indexer","operation":"scan","file_path":"notes/invalid.md","error":"schema validation failed","message":"Failed to index vault"}
```

### Technical Constraints

[Source: architecture/tech-stack.md]

- Use `github.com/rs/zerolog` v1.34.0 for structured logging
- Use `golang.org/x/term` for TTY detection (pretty-print vs JSON)
- High-performance zero-allocation JSON logger with CLI-friendly pretty-print mode
- Supports both machine-readable (JSON) and human-readable (colorized) output

### Coding Standards

[Source: architecture/coding-standards.md]

- Shared logging (`internal/shared/logger`) **MUST** be the only logging facility; no `fmt.Print*` or `log.*`.
- Follow Result pattern for all error returns across port boundaries
- Use PascalCase for exported types and functions
- Keep receiver names 1-2 letters
- Functions under 60 lines, no nested control structures over 2 levels
- Package comments for logger package

### File Locations

[Source: architecture/source-tree.md]

- Package: internal/shared/logger/
- Implementation: internal/shared/logger/logger.go
- Tests: internal/shared/logger/logger_test.go
- Follow source tree structure for shared packages

### Testing Requirements

[Source: architecture/testing-strategy.md]

- Unit tests co-located with implementation (*_test.go)
- Table-driven tests for logger functionality
- Test coverage for happy path, edge cases, and output formatting
- Use testing package from stdlib, no external testing libraries
- Target: ≥85% for internal/shared/logger package
- Include edge cases: TTY detection, level filtering, context field handling
- Validation: Package compiles, tests pass with go test -v, golangci-lint clean

### Integration with Future Stories

This logger package will be used by:
- Story 1.4 errors package (for error logging)
- Story 1.6 registry package (for operation logging)
- Story 1.7+ port implementations (for request/response logging)
- All domain services and adapters for consistent logging
- CommandOrchestrator for command execution logging

## Dev Agent Record

### Agent Model Used

[To be filled by dev agent]

### Debug Log References

[To be filled by dev agent]

### Completion Notes List

[To be filled by dev agent]

### File List

[To be filled by dev agent]

## QA Results

[To be filled by QA agent]

## Change Log

| Date       | Version | Description           | Author             |
| ---------- | ------- | --------------------- | ------------------ |
| 2025-01-12 | 1.0     | Initial story creation | Bob (Scrum Master) |
