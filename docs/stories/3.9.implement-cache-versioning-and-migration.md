# Story 3.9: Implement Cache Versioning and Migration

## Status

Draft

## Story

As a developer, I want the cache to include versioning and migration capabilities, so that schema changes don't break existing installations.

## Acceptance Criteria

- 3.9.1: Cache metadata includes semantic version field for cache schema per original requirements.
- 3.9.2: VaultIndexer detects version mismatches and handles migration or clean rebuild.
- 3.9.3: Migration logic is documented and includes rollback guidance.
- 3.9.4: Cache version changes trigger appropriate user notifications and recovery procedures.

## Tasks / Subtasks

- [ ] Task 1 (AC: 3.9.1): Add Version to Cache Metadata
  - [ ] Create a new file `internal/adapters/spi/cache/metadata.go` to define the cache metadata struct.
  - [ ] The struct should include a `Version` field (e.g., using a semantic versioning library).
  - [ ] When the cache is created or rebuilt, the current version should be stored in a metadata file (e.g., `.lithos/cache/metadata.json`).
- [ ] Task 2 (AC: 3.9.2): Implement Version Mismatch Detection
  - [ ] In the `VaultIndexer`, before starting the indexing process, read the cache metadata file.
  - [ ] Compare the version in the metadata file with the current application's cache version.
  - [ ] If the versions do not match, trigger a migration or a clean rebuild.
- [ ] Task 3 (AC: 3.9.3): Implement Migration Logic
  - [ ] For now, the migration strategy will be a clean rebuild. If the cache version is out of date, the `VaultIndexer` should delete the existing cache and create a new one.
  - [ ] Document this behavior and provide guidance on how to handle more complex migrations in the future.
- [ ] Task 4 (AC: 3.9.4): Implement User Notifications
  - [ ] When a cache migration (rebuild) is triggered, log a clear message to the user indicating that the cache is being rebuilt due to a version mismatch.
- [ ] Task 5: Add Unit and Integration Tests
  - [ ] Add unit tests for the version detection and migration logic in the `VaultIndexer`.
  - [ ] Add integration tests to verify that the `lithos index` command correctly handles cache versioning.
- [ ] Task 6: Full method and function decomposition into private srp function while ensuring a logical file organization.
- [ ] Task 7: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass
- [ ] Task 8: Pre-commit and commit readiness
  - [ ] Execute `pre-commit run` to confirm hooks pass
  - [ ] Stage updates and commit with a fully descriptive conventional commit message

## Dev Notes

### Data Models
- A new `CacheMetadata` struct should be created to store the cache version. [Source: docs/prd/epic-3-vault-indexing-engine.md#story-3-9-implement-cache-versioning-and-migration]

### Component Specifications
- The `VaultIndexer` is responsible for managing the cache version and triggering migrations. [Source: docs/architecture/components.md#vaultindexer]

### File Locations
- Cache metadata logic should be in `internal/adapters/spi/cache/metadata.go`. [Source: docs/architecture/source-tree.md#source-tree]
- The `VaultIndexer` is in `internal/app/indexing/vault_indexer.go`. [Source: docs/architecture/source-tree.md#source-tree]

### Testing Requirements
- Tests should cover scenarios where the cache is up-to-date, out-of-date, and non-existent. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Technical Constraints
- The initial migration strategy will be a simple rebuild. More complex migration paths are a future consideration. [Source: docs/prd/epic-3-vault-indexing-engine.md#story-3-9-implement-cache-versioning-and-migration]

## Change Log

| Date       | Version | Description                                  | Author |
| ---------- | ------- | -------------------------------------------- | ------ |
| 2025-10-22 | 1.0     | Initial story draft for cache versioning.    | sm     |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
