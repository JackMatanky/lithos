# Story 1.5: Shared Error Package

## Status

Draft

## Story

**As a** developer,
**I want** to implement all error types using idiomatic Go error handling,
**so that** the application has consistent error handling without Result[T] pattern.

## Acceptance Criteria

**Base Error Types:**

- 1.5.1: Create `internal/shared/errors/types.go`:
  - `BaseError` struct with `message string` and `cause error` fields
  - Implements `Error() string` and `Unwrap() error` methods
  - Constructor: `NewBaseError(message string, cause error) BaseError`

- 1.5.2: Add `ValidationError` to `internal/shared/errors/types.go`:
  - Embeds `BaseError`
  - Fields: `property string`, `reason string`, `value interface{}`
  - Constructor: `NewValidationError(property, reason string, value interface{}, cause error) *ValidationError`
  - Methods: `Property() string`, `Reason() string`, `Value() interface{}`

- 1.5.3: Add `ResourceError` to `internal/shared/errors/types.go`:
  - Embeds `BaseError`
  - Fields: `resource string`, `operation string`, `target string`
  - Constructor: `NewResourceError(resource, operation, target string, cause error) *ResourceError`
  - Methods: `Resource() string`, `Operation() string`, `Target() string`

- 1.5.4: Create unit tests in `internal/shared/errors/types_test.go`:
  - Test: Error construction and methods
  - Test: errors.Unwrap() works correctly
  - Test: errors.Is() and errors.As() work correctly

**Domain-Specific Errors:**

- 1.5.5: Create `internal/shared/errors/template.go`:
  - `TemplateError` type using BaseError
  - Constructor: `NewTemplateError(message string, templateID string, cause error)`
  - Method: `TemplateID() string`
  - Unit tests for construction and unwrapping

- 1.5.6: Create `internal/shared/errors/schema.go`:
  - `SchemaError` type using BaseError
  - Constructor: `NewSchemaError(message string, schemaName string, cause error)`
  - Method: `SchemaName() string`
  - Unit tests for construction and unwrapping

- 1.5.7: Create `internal/shared/errors/frontmatter.go`:
  - `FrontmatterError` type using BaseError
  - Constructor: `NewFrontmatterError(message string, field string, cause error)`
  - Method: `Field() string`
  - Unit tests for construction and unwrapping

**Helper Functions:**

- 1.5.8: Create `internal/shared/errors/helpers.go`:
  - `Wrap(err error, message string) error` - wraps with fmt.Errorf
  - `WrapWithContext(err error, format string, args ...interface{}) error`
  - Uses Go stdlib `errors.Join()` for multiple errors

- 1.5.9: Create unit tests in `internal/shared/errors/helpers_test.go`:
  - Test: Wrap() preserves original error
  - Test: WrapWithContext() formats message correctly
  - Test: errors.Unwrap() works on wrapped errors

- 1.5.10: **Verify NO Result[T] type exists anywhere in codebase**

- 1.5.11: All tests pass: `go test ./internal/shared/errors`

- 1.5.12: All linting passes: `golangci-lint run --fix internal/shared/errors`

- 1.5.13: Committed with message: `feat(shared): implement error package with idiomatic Go`

## Tasks / Subtasks

- [ ] Task 1: Implement base error types (AC: 1.5.1-1.5.3)
  - [ ] RED: Write failing tests for BaseError construction
    - [ ] Write test case in `internal/shared/errors/types_test.go`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement BaseError with Error() and Unwrap()
    - [ ] Implement BaseError struct with message and cause fields
    - [ ] Implement Error() string method
    - [ ] Implement Unwrap() error method
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Ensure error messages are clear
    - [ ] Review Error() message format
    - [ ] Ensure cause is included when present
    - [ ] Add comprehensive GoDoc comments
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification
  - [ ] RED: Write failing tests for ValidationError
    - [ ] Write test cases for construction and accessors
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement ValidationError embedding BaseError
    - [ ] Implement ValidationError struct with fields
    - [ ] Implement NewValidationError constructor
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add accessor methods for ValidationError fields
    - [ ] Implement Property() string
    - [ ] Implement Reason() string
    - [ ] Implement Value() interface{}
    - [ ] Add comprehensive GoDoc comments
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification
  - [ ] RED: Write failing tests for ResourceError
    - [ ] Write test cases for construction and accessors
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement ResourceError embedding BaseError
    - [ ] Implement ResourceError struct with fields
    - [ ] Implement NewResourceError constructor
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add accessor methods for ResourceError fields
    - [ ] Implement Resource() string
    - [ ] Implement Operation() string
    - [ ] Implement Target() string
    - [ ] Add comprehensive GoDoc comments
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 2: Test error wrapping and unwrapping (AC: 1.5.4)
  - [ ] RED: Write test for errors.Unwrap() compatibility
    - [ ] Write test case in `internal/shared/errors/types_test.go`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Verify Unwrap() returns cause correctly
    - [ ] Verify BaseError.Unwrap() works
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add tests for errors.Is() and errors.As()
    - [ ] Test errors.Is() for error comparison
    - [ ] Test errors.As() for type extraction
    - [ ] Add comprehensive test coverage
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification
  - [ ] RED: Write test for error chain traversal
    - [ ] Write test with nested error wrapping
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Verify error chains work with stdlib
    - [ ] Verify errors.Is() traverses chain
    - [ ] Verify errors.As() traverses chain
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Document error wrapping patterns
    - [ ] Add examples in GoDoc
    - [ ] Document best practices
    - [ ] Show error chain patterns
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 3: Implement domain-specific errors (AC: 1.5.5-1.5.7)
  - [ ] RED: Write failing tests for TemplateError
    - [ ] Write test case in `internal/shared/errors/template_test.go`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement TemplateError in template.go
    - [ ] Create template.go with TemplateError struct
    - [ ] Implement NewTemplateError constructor
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add TemplateID accessor method
    - [ ] Implement TemplateID() string method
    - [ ] Add comprehensive GoDoc comments
    - [ ] Document use cases
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification
  - [ ] RED: Write failing tests for SchemaError
    - [ ] Write test case in `internal/shared/errors/schema_test.go`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement SchemaError in schema.go
    - [ ] Create schema.go with SchemaError struct
    - [ ] Implement NewSchemaError constructor
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add SchemaName accessor method
    - [ ] Implement SchemaName() string method
    - [ ] Add comprehensive GoDoc comments
    - [ ] Document use cases
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification
  - [ ] RED: Write failing tests for FrontmatterError
    - [ ] Write test case in `internal/shared/errors/frontmatter_test.go`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement FrontmatterError in frontmatter.go
    - [ ] Create frontmatter.go with FrontmatterError struct
    - [ ] Implement NewFrontmatterError constructor
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add Field accessor method
    - [ ] Implement Field() string method
    - [ ] Add comprehensive GoDoc comments
    - [ ] Document use cases
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 4: Implement helper functions (AC: 1.5.8-1.5.9)
  - [ ] RED: Write failing tests for Wrap()
    - [ ] Write test case in `internal/shared/errors/helpers_test.go`
    - [ ] Verify test fails with expected error message
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement Wrap() using fmt.Errorf
    - [ ] Create helpers.go with Wrap function
    - [ ] Use fmt.Errorf with %w verb
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Ensure wrapped errors preserve original
    - [ ] Verify errors.Unwrap() works on wrapped errors
    - [ ] Add comprehensive GoDoc comments
    - [ ] Document when to use Wrap vs WrapWithContext
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification
  - [ ] RED: Write failing tests for WrapWithContext()
    - [ ] Write test cases with format strings
    - [ ] Run `go test ./internal/shared/errors` and confirm failure
  - [ ] GREEN: Implement WrapWithContext() with format strings
    - [ ] Implement WrapWithContext in helpers.go
    - [ ] Use fmt.Sprintf for message formatting
    - [ ] Use fmt.Errorf with %w for wrapping
    - [ ] Run `go test ./internal/shared/errors` and verify pass
    - [ ] Verify no other tests broken
  - [ ] REFACTOR: Add tests for errors.Join() usage
    - [ ] Test multiple error aggregation
    - [ ] Document errors.Join() patterns
    - [ ] Add examples in GoDoc
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 5: Verify no Result[T] pattern exists (AC: 1.5.10)
  - [ ] Search codebase for Result type definitions
  - [ ] Verify all functions use (T, error) signatures
  - [ ] Document idiomatic Go error handling approach

- [ ] Task 6: Verify tests and linting (AC: 1.5.11-1.5.12)
  - [ ] Run `go test ./internal/shared/errors` - verify all pass
  - [ ] Run `golangci-lint run --fix internal/shared/errors` - verify no warnings
  - [ ] Review test coverage for completeness
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/shared/errors`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 7: Commit changes (AC: 1.5.13)
  - [ ] Stage all error package files
  - [ ] Commit with message: `feat(shared): implement error package with idiomatic Go`

## Dev Notes

### QA Test Design Reference

**Test Design Document:** `docs/qa/assessments/1.5-test-design-20251028.md`

This story incorporates all 10 unit test scenarios identified in the QA test design:
- UNIT-001 through UNIT-010 covering BaseError, ValidationError, ResourceError, domain-specific errors, and helper functions
- All scenarios are P0 priority due to critical error handling importance for system reliability
- Test coverage ensures proper error construction, unwrapping, and stdlib compatibility

**Note:** The detailed test scenarios in AC1.5.4 and Tasks 1-6 are derived from this QA analysis.

### Error Handling Architecture

From `docs/architecture/components.md#shared-internal-packages`:

**Error Package Responsibility:** Defines domain-specific error types for better error handling and user messaging. Implements idiomatic Go error handling patterns. Wraps stdlib errors with context. Provides error factories and helper functions.

**Architecture Layer:** Shared Internal Package (Cross-Cutting Concern). Used by all layers. Not domain logic or infrastructure—pure technical concern. Centralized error definitions enable consistent error handling.

**Key Types:**
- `BaseError` – Lightweight foundation (message + optional cause)
- `ValidationError` – Property-level validation failures (property, reason, value)
- `ResourceError` – Resource operations (resource, operation, target, cause)
- Domain-specific wrappers: `SchemaError`, `TemplateError`, `FrontmatterError`

[Source: docs/architecture/components.md#error-package]

From `docs/architecture/coding-standards.md` - Error Handling:

- The application core and ports **MUST** use idiomatic Go `(T, error)` return signatures throughout.
- Domain-specific error types **MUST** implement the standard `error` interface and support unwrapping via `Unwrap() error` method.
- Errors **MUST** be wrapped with contextual messages using `fmt.Errorf("context: %w", err)` to preserve error chains for `errors.Is()` and `errors.As()` checks.
- Adapters **MUST** convert infrastructure errors to domain-specific error types (e.g., `os.ErrNotExist` → `FileSystemError`).
- Use `errors.Is`/`errors.As` for comparisons; never rely on `==` for non-sentinel errors.

[Source: docs/architecture/coding-standards.md#error-handling]

### Error Package Design Patterns

**BaseError Pattern:**
```go
type BaseError struct {
    message string
    cause   error
}

func (e BaseError) Error() string {
    if e.cause != nil {
        return fmt.Sprintf("%s: %v", e.message, e.cause)
    }
    return e.message
}

func (e BaseError) Unwrap() error {
    return e.cause
}
```

**Embedding Pattern for Domain Errors:**
```go
type TemplateError struct {
    BaseError
    templateID string
}

func NewTemplateError(message, templateID string, cause error) *TemplateError {
    return &TemplateError{
        BaseError:  NewBaseError(message, cause),
        templateID: templateID,
    }
}

func (e *TemplateError) TemplateID() string {
    return e.templateID
}
```

**Error Wrapping Pattern:**
```go
// Wrap adds context to an error
func Wrap(err error, message string) error {
    if err == nil {
        return nil
    }
    return fmt.Errorf("%s: %w", message, err)
}

// WrapWithContext adds formatted context
func WrapWithContext(err error, format string, args ...interface{}) error {
    if err == nil {
        return nil
    }
    message := fmt.Sprintf(format, args...)
    return fmt.Errorf("%s: %w", message, err)
}
```

### Testing Standards

From `docs/architecture/testing-strategy.md`:

- Unit tests live beside code (`*_test.go`)
- Use table-driven tests for multiple error cases
- Test error construction, Error() method, Unwrap() method
- Test errors.Is() and errors.As() compatibility
- Test error wrapping preserves chain
- Verify error messages are clear and actionable

### File Locations

- Base types: `internal/shared/errors/types.go`
- Domain errors: `internal/shared/errors/template.go`, `schema.go`, `frontmatter.go`
- Helpers: `internal/shared/errors/helpers.go`
- Tests: `internal/shared/errors/*_test.go`

### Implementation Notes

**Key Requirements:**

1. **No Result[T] Pattern:** Use idiomatic Go (T, error) signatures throughout
2. **Error Unwrapping:** All custom errors must support errors.Unwrap()
3. **Error Comparison:** errors.Is() and errors.As() must work correctly
4. **Error Context:** Wrap errors with contextual information using fmt.Errorf("%s: %w")
5. **Accessor Methods:** Domain errors expose specific fields via methods

**Architecture Version:** v0.6.7 removed Result[T] pattern, moved to idiomatic Go error handling
**Change Log Reference:** v0.5.9 - Error types split (FrontmatterError, CacheReadError, etc.)

### Refactoring Guidelines

**SRP Decomposition Examples:**

For the error package, SRP focuses on each error type having a single purpose:

**BaseError:**
- Single responsibility: Provide base error functionality (message + cause + unwrapping)
- Keep minimal - no domain-specific logic
- Foundation for all custom errors

**Domain-Specific Errors (TemplateError, SchemaError, FrontmatterError):**
- Each has single responsibility: Represent specific error category with context
- Embed BaseError for common functionality
- Add domain-specific fields via private fields + accessor methods
- Constructor has single responsibility: Create error with all context

**Helper Functions:**
- Wrap: Single responsibility = add context message to existing error
- WrapWithContext: Single responsibility = add formatted context to error
- Each helper is focused on one error handling pattern

**When to Decompose:**
- If error construction has >3 parameters, consider builder pattern
- If Error() method has complex formatting, extract formatter function
- If multiple errors need aggregation, use errors.Join()

**Naming Standards:**
- Error types: PascalCase with "Error" suffix (BaseError, TemplateError)
- Constructors: NewErrorType (NewBaseError, NewTemplateError)
- Accessor methods: field name without "Get" prefix (TemplateID(), not GetTemplateID())
- Helper functions: Verb-based (Wrap, WrapWithContext)

**Documentation Requirements:**
- Package comment explaining idiomatic Go error handling approach
- Each error type has GoDoc explaining when to use and what context it provides
- Constructors document all parameters and when to use
- Helper functions show usage examples in GoDoc

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 1 requirements | Bob (Scrum Master) |
| 2025-10-28 | 1.1 | Enhanced with full TDD framework, SRP decomposition, linting checkpoints | QA Specialist |

## Dev Agent Record

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
