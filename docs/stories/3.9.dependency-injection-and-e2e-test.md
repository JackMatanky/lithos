# Story 3.9: Dependency Injection and E2E Test for Vault Indexing Engine

## Status: Draft

## Story

As a developer,
I want to implement dependency injection for the vault indexing engine components and add comprehensive e2e tests,
So that the vault indexing functionality is properly wired and thoroughly tested end-to-end.

## Context

This story completes the vault indexing engine (Epic 3) by wiring all components through dependency injection and ensuring the entire indexing workflow works correctly through e2e testing. It follows the same pattern established in story 1.14 for the foundational CLI.

## Acceptance Criteria

### Functional Requirements

1. All vault indexing components (cache adapters, vault reader/writer, frontmatter service, indexer service, query service, CLI index command) are properly registered in the DI container
2. The main.go file includes the vault indexing engine dependencies in the application wiring
3. E2E tests cover the complete vault indexing workflow from CLI command execution through cache operations to query results
4. The e2e tests use real file system operations and validate actual vault indexing behavior
5. Test data includes sample markdown files with frontmatter for realistic testing scenarios

### Integration Requirements

6. Vault indexing engine integrates seamlessly with the existing CLI command structure
7. Cache operations work correctly with the JSON cache adapters
8. Frontmatter parsing handles various markdown file formats and edge cases
9. Query service returns accurate results based on indexed vault data
10. No breaking changes to existing functionality

### Quality Requirements

11. All e2e tests pass consistently
12. Code coverage for vault indexing components meets project standards (80%+)
13. Error handling is tested for file system issues, malformed frontmatter, and cache failures
14. Tests run within reasonable time limits (< 30 seconds for full suite)
15. Test cleanup properly removes temporary files and cache data

## Dev Notes

### Previous Story Insights

From story 3.8 (CLI index command): The CLI command structure is established and ready for integration testing. The indexer service has been implemented with proper error handling.

### Data Models

- **Cache Models**: Use existing cache port interfaces and JSON adapters [Source: docs/architecture/data-models.md#cache-interfaces]
- **Vault Models**: Frontmatter parsing follows the established note domain model [Source: docs/architecture/data-models.md#note-model]
- **Query Models**: Query results use the property bank model for structured data [Source: docs/architecture/data-models.md#property-bank]

### API Specifications

- **CLI Interface**: Follows cobra CLI adapter pattern from story 1.12 [Source: docs/architecture/backend-architecture.md#cli-adapter]
- **Cache Interface**: Implements cache port interfaces from story 3.1 [Source: docs/architecture/backend-architecture.md#cache-ports]
- **Vault Reader/Writer**: Uses established port interfaces from stories 3.3-3.4 [Source: docs/architecture/backend-architecture.md#vault-ports]

### Component Specifications

- **DI Container**: Extend the existing registry from story 1.7 with vault indexing components [Source: docs/architecture/backend-architecture.md#dependency-injection]
- **E2E Test Structure**: Follow the e2e testing pattern from story 1.14 [Source: docs/architecture/testing-strategy.md#e2e-testing]
- **Test Data**: Create testdata/vault/ directory with sample markdown files [Source: docs/architecture/testing-strategy.md#test-data]

### File Locations

- **Main Application**: Update cmd/lithos/main.go to include vault indexing dependencies [Source: docs/architecture/source-tree.md#main-application]
- **DI Registry**: Extend internal/shared/registry/registry.go with vault components [Source: docs/architecture/source-tree.md#registry-package]
- **E2E Tests**: Create tests/e2e/vault_indexing_test.go [Source: docs/architecture/source-tree.md#e2e-tests]
- **Test Data**: Add testdata/vault/ with sample .md files [Source: docs/architecture/source-tree.md#test-data]

### Testing Requirements

- **E2E Test Coverage**: Complete workflow from CLI command to query results [Source: docs/architecture/testing-strategy.md#e2e-scenarios]
- **Integration Tests**: Component interactions within the vault indexing engine [Source: docs/architecture/testing-strategy.md#integration-testing]
- **Unit Tests**: Individual component testing (already covered in previous stories) [Source: docs/architecture/testing-strategy.md#unit-testing]

### Technical Constraints

- **Go Version**: Must be compatible with existing Go 1.21+ codebase [Source: docs/architecture/tech-stack.md#go-version]
- **Dependencies**: Use existing libraries (cobra, viper, etc.) [Source: docs/architecture/tech-stack.md#dependencies]
- **File System**: Handle cross-platform path separators [Source: docs/architecture/tech-stack.md#platform-compatibility]

## Tasks / Subtasks

- [ ] Task 1: Register vault indexing components in DI container
  - [ ] Add cache adapters to registry
  - [ ] Register vault reader/writer adapters
  - [ ] Add frontmatter service to registry
  - [ ] Register indexer service
  - [ ] Add query service to registry
  - [ ] Include CLI index command in registry

- [ ] Task 2: Wire vault indexing dependencies in main.go
  - [ ] Import vault indexing registry functions
  - [ ] Add vault components to application container
  - [ ] Ensure proper initialization order
  - [ ] Test basic application startup with vault components

- [ ] Task 3: Create e2e test infrastructure
  - [ ] Create tests/e2e/vault_indexing_test.go
  - [ ] Set up test vault directory structure
  - [ ] Create sample markdown files with frontmatter
  - [ ] Implement test helper functions for vault setup/cleanup

- [ ] Task 4: Implement e2e test scenarios
  - [ ] Test CLI index command execution
  - [ ] Verify cache file creation and content
  - [ ] Test query functionality against indexed data
  - [ ] Validate frontmatter parsing accuracy
  - [ ] Test error handling for invalid files

- [ ] Task 5: Add comprehensive test coverage
  - [ ] Ensure 80%+ code coverage for new integration code
  - [ ] Test edge cases (empty vault, malformed frontmatter, permission issues)
  - [ ] Validate performance meets requirements
  - [ ] Run tests across different environments

- [ ] Task 6: Documentation and cleanup
  - [ ] Update any necessary documentation
  - [ ] Ensure test data is properly organized
  - [ ] Verify no breaking changes to existing functionality

## Testing

### E2E Test Scenarios

1. **Complete Vault Indexing Workflow**
   - Given: A vault directory with markdown files containing frontmatter
   - When: CLI index command is executed
   - Then: Cache files are created with correct indexed data

2. **Query Functionality**
   - Given: An indexed vault with known content
   - When: Query service is called with specific criteria
   - Then: Correct results are returned

3. **Error Handling**
   - Given: Vault with malformed files
   - When: Index command is executed
   - Then: Errors are handled gracefully without crashing

### Validation Steps

- Run full e2e test suite: `go test ./tests/e2e/...`
- Verify code coverage: `go test -cover ./internal/app/vault/...`
- Manual testing: Execute CLI commands with test vault
- Integration testing: Verify with existing CLI structure

## Dev Agent Record

### Agent Model Used

bmad-dev v1.0 - Full Stack Developer specialized in Go implementation and testing

### Dev Notes

This story requires careful integration of all vault indexing components. The DI wiring must follow the established patterns from story 1.14. E2E tests should be comprehensive but focused on the critical path.

### File List

- cmd/lithos/main.go (modified)
- internal/shared/registry/registry.go (modified)
- tests/e2e/vault_indexing_test.go (new)
- testdata/vault/ (new directory with sample files)

### Change Log

- 2025-01-12: Initial story creation following epic 3 completion pattern
