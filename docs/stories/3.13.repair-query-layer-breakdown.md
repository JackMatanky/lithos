# Story 3.13: Fix Query Layer Functionality

## Status: Draft

## Story

**As a** developer,
**I want** the query layer to work correctly with all query methods,
**so that** users can search and retrieve notes using path-based and frontmatter-based queries.

## Acceptance Criteria

1. ByPath and ByBasename query methods return correct results for all note lookups
2. Frontmatter queries handle all YAML value types (strings, numbers, booleans, arrays, maps) without panicking
3. Fresh installation works without requiring manual cache directory creation
4. Type-agnostic frontmatter lookups work correctly (int 2 matches float 2.0)
5. All query indices (byID, byPath, byBasename, byFileClass, byFrontmatter) are properly populated
6. Query service handles missing or empty cache gracefully

## Tasks / Subtasks

- [ ] Task 1: Fix index population in RefreshFromCache
  - [ ] Update QueryService.RefreshFromCache to populate all indices
  - [ ] Add path information extraction from NoteID for byPath and byBasename indices
  - [ ] Implement basename extraction logic from full NoteID paths
  - [ ] Ensure byFileClass and byFrontmatter indices are populated correctly
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 2: Add path information to Note domain model
  - [ ] Update domain.Note to include path field for query operations
  - [ ] Modify Note creation to populate path from NoteID
  - [ ] Ensure path information is preserved through cache operations
  - [ ] Update Note serialization/deserialization to handle path field
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 3: Implement comparable key normalization for frontmatter
  - [ ] Add type normalization for frontmatter query keys
  - [ ] Handle numeric type conversions (int/float compatibility)
  - [ ] Implement safe comparison for complex types (arrays, maps)
  - [ ] Add error handling for uncomparable types
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 4: Handle missing cache directory gracefully
  - [ ] Update QueryService.List to handle missing cache directory
  - [ ] Add automatic cache directory creation on first access
  - [ ] Implement proper error handling for cache access failures
  - [ ] Test fresh installation scenarios
  - [ ] Run `golangci-lint run --fix` and fix all warnings (no `nolint` allowed)

- [ ] Task 5: Quality Assurance - Pre-commit and Validation
  - [ ] Execute `pre-commit run --all-files`, stage files, and write detailed conventional commit message (no `--no-verify` flag)
  - [ ] Run bmad-qa `test-design` to validate test coverage meets requirements
  - [ ] Run bmad-po `validate-next-story` to ensure story completeness and architecture compliance

## Dev Notes

### Source Tree Information

Based on docs/architecture/source-tree.md:

**Primary Files to Modify:**
- `internal/app/query/service.go` - Contains RefreshFromCache and query methods
- `internal/domain/note.go` - Note model needs path field addition
- `internal/adapters/spi/cache/json_reader.go` - Cache reading operations

**Related Components:**
- `internal/app/vault/indexer.go` - Creates Note objects for query service
- `internal/shared/utils/` - May need path manipulation utilities

### Architecture Context from docs/architecture/data-models.md

**Note Model:**
- Currently lacks explicit path information
- NoteID serves as identifier but path data needs to be extractable
- Frontmatter queries require type-safe comparisons

**Query Indices:**
- byID: NoteID → Note (already working)
- byPath: Full path → Note (needs implementation)
- byBasename: Filename without extension → Note (needs implementation)
- byFileClass: Schema name → []Note (needs verification)
- byFrontmatter: Field value → []Note (needs type handling)

### Component Specifications from docs/architecture/components.md

**QueryService Component:**
- RefreshFromCache must populate ALL indices from cache data
- Query methods must handle various data types safely
- Should gracefully handle missing or empty cache states
- Path-based queries require path information in Note objects

**Note Domain Model:**
- Must include path information for query operations
- Path should be vault-relative for consistency
- Should support all query index requirements

### Critical Implementation Notes

**Index Population:**
- Extract path from NoteID during RefreshFromCache
- Populate byPath with full vault-relative path
- Populate byBasename by extracting filename without extension
- Ensure all indices are updated atomically

**Type-Safe Frontmatter Queries:**
- Normalize numeric types for comparison (int 2 == float 2.0)
- Handle nil/null values appropriately
- Implement safe comparison for complex types
- Add logging for type conversion issues

**Path Information:**
- NoteID contains vault-relative path (e.g., "projects/foo.md")
- Extract path for byPath index
- Extract basename for byBasename index
- Preserve path information in Note model

**Cache Directory Handling:**
- Check for cache directory existence before operations
- Create directory automatically if missing
- Handle permission errors gracefully
- Ensure operations work on fresh installations

### Testing

**Test File Locations:**
Based on docs/architecture/testing-strategy.md and source tree:
- Unit tests: `internal/app/query/service_test.go`, `internal/domain/note_test.go`
- Integration tests: `tests/integration/query_operations_test.go`
- Edge case tests: `tests/integration/query_edge_cases_test.go`

**Testing Standards:**
- Test all query methods with various data types
- Include frontmatter with arrays, maps, mixed types
- Test path-based queries with complex vault structures
- Validate fresh installation behavior
- Test type normalization for numeric comparisons

**Testing Framework:**
- Go standard testing package for unit tests
- Custom test data with complex frontmatter structures
- Integration test helpers for cache setup and teardown

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-12 | 1.0 | Initial story creation for Epic 3 critical fixes | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

[To be populated by development agent]

### Debug Log References

[To be populated by development agent]

### Completion Notes List

[To be populated by development agent]

### File List

[To be populated by development agent]

## QA Results

[To be populated by QA agent]
