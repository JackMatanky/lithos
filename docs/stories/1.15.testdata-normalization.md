# Story 1.15: Normalize Project Testdata Fixtures

## Status

Draft

## Story

**As a** product owner,
**I want** a consistent and validated `testdata/` directory layout,
**so that** developers can rely on predictable fixture locations and the new test utilities (Story 1.14) can enforce safe access rules.

### Context

- Addresses Epic 1 (Foundational CLI static template engine) quality risks caused by duplicated fixture trees (`testdata/schema` vs `testdata/schemas`) and inconsistent naming.
- Recent integration/e2e tests (Stories 1.16 and 1.14) depend on stable fixture discovery to build and validate binaries against the reference vault.

### Dependencies

- None blocking, but this story must land before Story 1.14 so the filesystem helper can rely on a canonical layout.
- Coordinate decisions on the top-level testdata directories with QA to keep gate expectations consistent.

### Assumptions

- Golden outputs either move under a canonical directory (likely `templates`) or remain only if a strong justification is recorded in this story’s Change Log.
- All fixtures should comply with snake_case once migrated; no legacy casing is permitted post-story.
- Tests consuming fixtures already use Go’s `testing` package and support table-driven validation of helper error messages.

## Acceptance Criteria

- 1.15.1: Consolidate duplicated schema directories by merging current `testdata/schema` contents into `testdata/schemas` and removing the redundant directory. Update all references in code and tests (including `tests/integration/config_loading_test.go`) to use the canonical path.

- 1.15.2: Decide final top-level fixture set (`schemas`, `templates`, `vault`, `golden` or chosen alternative). Migrate files under `testdata/golden/` into the approved directory (e.g., `templates`) or justify keeping the directory. Update any tests expecting the old location.

- 1.15.3: Enforce snake_case naming for all files and directories inside `testdata/`. Rename existing fixtures (e.g., `static-template.md` → `static_template.md`, `integration-test-template.txt` → `integration_test_template.txt`) and adjust tests accordingly. Remove `.DS_Store` and other stray files.

- 1.15.4: Add `tests/utils/testdata.go` exposing helpers to resolve fixture paths:
  - `Root(t *testing.T) string` returning the absolute path to `testdata`.
  - `Path(t *testing.T, segments ...string) string` validating the first segment against the approved top-level set and failing when nonexistent.
  - `Open(t *testing.T, segments ...string) *os.File` that wraps `os.Open` with `t.Helper()` and fails fast on errors.
  - Internal validation ensuring requested files adhere to snake_case naming, failing the test otherwise.

- 1.15.5: Integrate `testdata` helper with the filesystem utilities (Story 1.14) so `CopyFromTestdata` relies on `testdata.Path`. Update refactored tests to use these helpers instead of manual `filepath.Join` to `testdata`.

- 1.15.6: Document the canonical `testdata/` layout in `tests/README.md` (or create the doc if missing) including naming rules, allowed roots, and guidance for adding new fixtures. Mention the new helper API.

- 1.15.7: Verify all changes via `go test ./...` and `golangci-lint run ./...`, ensuring there are no remaining references to the removed paths or old names, and add targeted assertions that:
  - `testdata.Path` rejects unsupported top-level segments and names that violate snake_case.
  - Helpers surface descriptive failure messages when fixtures are missing or misnamed.

## Tasks / Subtasks

- [ ] Task 1: Merge schema directories (AC: 1.15.1)
  - [ ] Move every file from `testdata/schema` into `testdata/schemas` preserving substructure.
  - [ ] Delete the empty `testdata/schema` directory once migration is complete.

- [ ] Task 2: Update references to canonical schema path (AC: 1.15.1)
  - [ ] Search for `testdata/schema` across the repository and update each occurrence to `testdata/schemas`.
  - [ ] Verify updates in `tests/integration/config_loading_test.go` and any documentation/PRD references.

- [ ] Task 3: Decide golden fixture location (AC: 1.15.2)
  - [ ] Evaluate existing `testdata/golden` files and either move them under `testdata/templates` or document justification for keeping a dedicated directory in the Change Log.

- [ ] Task 4: Rename fixtures to snake_case (AC: 1.15.3)
  - [ ] Rename all non-snake_case fixture filenames (e.g., `static-template.md` → `static_template.md`).
  - [ ] Update all code and docs referencing renamed files to use the new names.

- [ ] Task 5: Remove stray files (AC: 1.15.3)
  - [ ] Delete `.DS_Store` and any other stray artifacts from `testdata/`.
  - [ ] Ensure `.gitignore` prevents these files from reappearing.

- [ ] Task 6: Add `tests/utils/testdata` helper (AC: 1.15.4)
  - [ ] Implement `tests/utils/testdata.go` with `Root`, `Path`, and `Open` functions that validate allowed top-level directories and snake_case filenames.

- [ ] Task 7: Unit-test `testdata` helper (AC: 1.15.4)
  - [ ] Create `tests/utils/testdata_test.go` covering valid lookups, unsupported directories, snake_case enforcement, and missing-file error messaging.

- [ ] Task 8: Integrate helper with workspace utilities (AC: 1.15.5)
  - [ ] Update `tests/utils/tempfs.go` so `CopyFromTestdata` uses the new helper for path resolution.
  - [ ] Adjust Story 1.14 refactor tasks as needed to align with the new helper.

- [ ] Task 9: Document canonical layout (AC: 1.15.6)
  - [ ] Add or update `tests/README.md` with the approved top-level directories, naming rules, and helper usage examples.
  - [ ] Update architecture/PRD references that describe fixture locations to the new canonical structure.

- [ ] Task 10: Run validations and record evidence (AC: 1.15.7)
  - [ ] Run `go test ./...` and `golangci-lint run ./...`, capturing command outputs in the Change Log.
  - [ ] Record helper test assertions demonstrating rejection of unsupported directories and snake_case violations in the Change Log.

## Dev Notes

### Source Tree Context

- Test fixtures reside under `testdata/`; this story consolidates roots (`schema` → `schemas`).
- Helper code located in `tests/utils/testdata.go` (new) and `tests/utils/tempfs.go` (Story 1.14 dependency).
- Affected test suites: `tests/e2e`, `tests/integration`, any internal package tests referencing `testdata` paths.

### Architecture References

- Testing strategy: `docs/architecture/testing-strategy.md` (fixture management, table-driven tests).
- Coding standards: `docs/architecture/coding-standards.md` (naming conventions, error handling in tests).
- Source tree overview: `docs/architecture/source-tree.md` for canonical directories.

### Assumptions & Decisions

- Golden fixtures default to `testdata/templates` unless Change Log records justification for a dedicated `golden` directory.
- All fixture names use snake_case; deviations require explicit entry in Change Log with rationale.
- Story must merge before Story 1.14 to unblock helper integration.

#### Testing

- Add unit tests for `tests/utils/testdata.go` covering:
  - Rejection of unsupported top-level directories.
  - Enforcement of snake_case naming.
  - Friendly error messages for missing fixtures.
- Run `go test ./...` after renames to ensure references updated.
- `golangci-lint run ./...` to confirm no lint violations from renames/import changes.
- QA test design reference: `docs/qa/assessments/1.15-test-design-20251030.md` for detailed scenario mapping.

## Change Log

| Date       | Version | Description                                              | Author |
|------------|---------|----------------------------------------------------------|--------|
| 2025-10-30 | 0.1     | Initial draft of Story 1.15 with template sections added | PO     |

## Dev Agent Record

### Agent Model Used

_(To be completed by development agent)_

### Debug Log References

_(To be completed by development agent)_

### Completion Notes List

_(To be completed by development agent)_

### File List

_(To be completed by development agent)_

## QA Results

### Test Design (2025-10-30)

- Test design matrix: docs/qa/assessments/1.15-test-design-20251030.md
- P0 unit coverage guards helper directory validation and snake_case enforcement.
- Manual review required for documenting `testdata/golden` decision (1.15-DOC-001).

```yaml
test_design:
  scenarios_total: 8
  by_level:
    unit: 3
    integration: 3
    e2e: 1
    manual: 1
  by_priority:
    p0: 2
    p1: 3
    p2: 3
    p3: 0
  coverage_gaps: []
```
