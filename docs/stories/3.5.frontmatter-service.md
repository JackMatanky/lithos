# Story 3.5: FrontmatterService

## Status

Draft

## Story

**As a** developer,
**I want** FrontmatterService to extract and validate frontmatter exactly as described,
**so that** the indexer produces canonical Note objects.

## Acceptance Criteria

1. `internal/app/frontmatter/service.go` implements `Extract` and `Validate` methods exactly as described in `docs/architecture/components.md#frontmatterservice`, with SchemaRegistryPort dependency for schema access during validation.

2. FrontmatterService implements Extract() method for parsing frontmatter from markdown content, following hexagonal architecture with domain service responsibilities.

3. Validation enforces FR6/FR7 requirements, including strict type checks and array vs scalar handling. FileSpec existence validation moved to QueryService (domain layer).

4. Service returns structured `FrontmatterError` instances per `error-handling-strategy.md`, preserving unknown fields as required.

5. Unit tests cover validation scenarios: missing required fields, type mismatches, FileSpec type validation, and error message content.

6. `golangci-lint run ./internal/app/frontmatter` and `go test ./internal/app/frontmatter` succeed.

## Tasks / Subtasks

- [ ] Task 1: Split VaultReaderPort into separate interfaces (AC: 1)
  - [ ] RED: Refactor existing VaultReaderPort tests in `internal/ports/spi/vault_test.go`
    - [ ] Modify existing test structure to accommodate interface separation
    - [ ] Update mock implementations to support both interfaces
    - [ ] Verify tests fail due to interface changes (methods not found)
    - [ ] Run `go test ./internal/ports/spi` and confirm failures
  - [ ] GREEN: Implement interface separation
    - [ ] Create VaultScannerPort interface in `internal/ports/spi/vault.go` with ScanAll() and ScanModified() methods
    - [ ] Modify VaultReaderPort interface to contain only Read() method for single file operations
    - [ ] Update VaultReaderAdapter in `internal/adapters/spi/vault/reader.go` to implement both VaultScannerPort and VaultReaderPort
    - [ ] Update VaultIndexerService to inject VaultScannerPort instead of VaultReaderPort
    - [ ] Ensure backward compatibility during the transition
    - [ ] Update existing tests to work with separated interfaces
    - [ ] Run `go test ./internal/ports/spi` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Add comprehensive GoDoc comments for both interfaces
    - [ ] Document interface segregation principle and responsibilities
    - [ ] Review naming: VaultScannerPort, VaultReaderPort (clear separation of concerns)
    - [ ] Run `golangci-lint run --fix internal/ports/spi`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/ports/spi` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/ports/spi`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 2: Create NoteLoaderAdapter implementing VaultReaderPort (AC: 1)
  - [ ] RED: Write failing tests for NoteLoaderAdapter
    - [ ] Write test case expecting NoteLoaderAdapter implements VaultReaderPort interface
    - [ ] Write test case expecting Read() method calls VaultReaderPort.Read()
    - [ ] Write test case expecting proper error handling for read failures
    - [ ] Write test case expecting VaultFile.Content is returned for markdown file reading
    - [ ] Verify tests fail (NoteLoaderAdapter not implemented)
    - [ ] Run `go test ./internal/adapters/api/note` and confirm failures
  - [ ] GREEN: Implement NoteLoaderAdapter
    - [ ] Create `internal/adapters/api/note/loader.go` with NoteLoaderAdapter struct
    - [ ] Implement VaultReaderPort interface methods (only Read method)
    - [ ] Add Load() method that calls VaultReaderPort.Read() and returns VaultFile.Content
    - [ ] Inject VaultReaderPort dependency in constructor
    - [ ] Add comprehensive error handling for read failures
    - [ ] Run `go test ./internal/adapters/api/note` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Add comprehensive GoDoc comments for NoteLoaderAdapter and methods
    - [ ] Document VaultReaderPort dependency and interface implementation
    - [ ] Review naming: NoteLoaderAdapter (clear adapter naming), Load/Read methods
    - [ ] Run `golangci-lint run --fix internal/adapters/api/note`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/adapters/api/note` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/adapters/api/note`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 3: Implement field validators with interface polymorphism (AC: 3)
  - [ ] RED: Write failing tests for field validators
    - [ ] Write test case expecting FieldValidator interface exists
    - [ ] Write test case expecting StringValidator implements FieldValidator
    - [ ] Write test case expecting NumberValidator implements FieldValidator
    - [ ] Write test case expecting DateValidator implements FieldValidator
    - [ ] Write test case expecting FileValidator implements FieldValidator
    - [ ] Write test case expecting BoolValidator implements FieldValidator
    - [ ] Write test case expecting Validate() delegates to appropriate validator implementations
    - [ ] Write test case expecting proper error messages for type mismatches
    - [ ] Verify tests fail (validators not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement field validators
    - [ ] Create `internal/app/frontmatter/validators.go` with FieldValidator interface
    - [ ] Implement concrete validators: StringValidator, NumberValidator, DateValidator, FileValidator, BoolValidator
    - [ ] Each validator implements Validate(fieldName string, fieldValue interface{}, prop domain.Property) error
    - [ ] FrontmatterService.Validate() orchestrates validation by delegating to appropriate validator implementations
    - [ ] Maintain clean separation between validation orchestration and specific field validation logic
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Decompose validator implementations into focused methods
    - [ ] Add comprehensive GoDoc comments for interface and implementations
    - [ ] Document validation rules for each PropertySpec type
    - [ ] Review naming: FieldValidator, StringValidator, NumberValidator, etc. (clear type-specific naming)
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 4: Implement FrontmatterService with Extract() and Validate() methods (AC: 1, 2, 3, 4)
  - [ ] RED: Write failing tests for FrontmatterService
    - [ ] Write test case expecting FrontmatterService.Extract() method exists
    - [ ] Write test case expecting Extract() calls VaultReaderPort.Read()
    - [ ] Write test case expecting Extract() parses YAML frontmatter correctly
    - [ ] Write test case expecting FrontmatterService.Validate() method exists
    - [ ] Write test case expecting Validate() accepts schema as parameter (no SchemaRegistryPort injection)
    - [ ] Write test case expecting Validate() preserves unknown fields (FR6)
    - [ ] Write test case expecting proper FrontmatterError instances on failures
    - [ ] Verify tests fail (FrontmatterService not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement FrontmatterService core methods
    - [ ] Create `internal/app/frontmatter/service.go` with FrontmatterService struct
    - [ ] Inject NoteLoaderAdapter for loading note content in Extract() method
    - [ ] Inject SchemaEngine for schema access during validation
    - [ ] Inject Logger for structured logging
    - [ ] Implement Extract() method using goldmark AST parsing to accurately identify frontmatter and goccy/go-yaml for YAML extraction
    - [ ] Implement Validate() method that uses SchemaEngine to retrieve schemas for validation (schema-driven validation using PropertySpec polymorphism)
    - [ ] Add comprehensive error handling with FrontmatterError instances
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Decompose into SRP components:
      - [ ] Extract findDelim(content []byte) (start, end int) for delimiter location
      - [ ] Extract parseYAML(yamlBytes []byte) (map[string]interface{}, error) for YAML parsing
      - [ ] Extract validateFM(fields map[string]interface{}) error for basic validation
      - [ ] Extract extractFields(fields map[string]interface{}) Frontmatter for model creation
      - [ ] Extract validateRequired(fm Frontmatter, schema Schema) error for required field checks
      - [ ] Extract validateTypes(fm Frontmatter, schema Schema) error for type validation
      - [ ] Extract formatError(field, reason string) error for error creation
      - [ ] Verify Extract() and Validate() orchestrate helpers cleanly
    - [ ] Review naming: Extract, Validate (clear method names), findDelim, parseYAML, validateFM, extractFields, validateRequired, validateTypes, formatError (helper functions)
    - [ ] Add comprehensive GoDoc comments:
      - [ ] Add package comment at top of service.go explaining FrontmatterService purpose
      - [ ] Add GoDoc for FrontmatterService struct documenting dependencies
      - [ ] Add GoDoc for Extract() explaining complete workflow
      - [ ] Add GoDoc for Validate() explaining schema parameter and validation logic
      - [ ] Document error handling strategy and FrontmatterError structure
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
    - [ ] Verify test coverage >90%
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 5: Configure FrontmatterService to use NoteLoaderAdapter and SchemaEngine (AC: 1)
  - [ ] RED: Write failing tests for NoteLoaderAdapter and SchemaEngine integration
    - [ ] Write test case expecting FrontmatterService accepts NoteLoaderAdapter injection
    - [ ] Write test case expecting FrontmatterService accepts SchemaEngine injection
    - [ ] Write test case expecting Extract() method calls NoteLoaderAdapter.Load()
    - [ ] Write test case expecting Validate() method calls SchemaEngine.Get[domain.Schema]()
    - [ ] Write test case expecting proper error handling for load and schema retrieval failures
    - [ ] Verify tests fail (integration not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement NoteLoaderAdapter and SchemaEngine integration
    - [ ] Modify FrontmatterService constructor to accept NoteLoaderAdapter and SchemaEngine
    - [ ] Update Extract() method to call noteLoader.Load(path) for markdown content
    - [ ] Update Validate() method to call schemaEngine.Get[domain.Schema](ctx, schemaName)
    - [ ] Add validation that injected dependencies implement required interfaces
    - [ ] Maintain proper error handling for load and schema retrieval failures
    - [ ] Run `go test ./internal/app/frontmatter` and verify tests pass
  - [ ] REFACTOR:
    - [ ] Update any references to use NoteLoaderAdapter and SchemaEngine
    - [ ] Add comprehensive GoDoc comments documenting dependencies
    - [ ] Document the integration with SchemaEngine for schema loading and resolution
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 6: Comprehensive testing (AC: 5)
  - [ ] RED: Write failing tests for all scenarios
    - [ ] Create FakeNoteLoaderAdapter returning predefined content for Extract() testing
    - [ ] Create FakeSchemaEngine returning predefined schemas for Validate() testing
    - [ ] Create FakeFieldValidators for validation testing
    - [ ] Write test for Extract(): valid frontmatter parsing, empty content, malformed YAML, missing delimiters
    - [ ] Write test for Validate(): required fields, type mismatches, unknown field preservation, schema validation
    - [ ] Write test for field validators: each validator type with valid/invalid inputs
    - [ ] Write test for error handling: FrontmatterError structure and messages
    - [ ] Write test for integration: Extract() + Validate() workflow
    - [ ] Verify tests fail (fakes not implemented)
    - [ ] Run `go test ./internal/app/frontmatter` and confirm failures
  - [ ] GREEN: Implement all fakes and tests
    - [ ] Implement FakeNoteLoaderAdapter with configurable content returns
    - [ ] Implement FakeSchemaEngine with configurable schema returns
    - [ ] Implement FakeFieldValidators with configurable validation behavior
    - [ ] Verify all test scenarios pass
    - [ ] Run `go test ./internal/app/frontmatter` and verify 100% pass
  - [ ] REFACTOR:
    - [ ] Review fake implementations for clarity and completeness
    - [ ] Add GoDoc comments for all fakes explaining usage
    - [ ] Verify fakes satisfy interface contracts
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL linter warnings without using nolint
    - [ ] Run `go test ./internal/app/frontmatter` to verify refactoring didn't break tests
  - [ ] Linting checkpoint:
    - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Fix ALL warnings (no nolint unless absolutely necessary)
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 7: Quality gates (AC: 6)
  - [ ] Run `go test ./internal/app/frontmatter` and verify 100% pass
  - [ ] Run `golangci-lint run internal/app/frontmatter` and fix any issues
  - [ ] Verify test coverage >90%: `go test -cover ./internal/app/frontmatter`
  - [ ] Run integration tests to verify NoteLoaderAdapter and FrontmatterService work together
  - [ ] Confirm all acceptance criteria 1-6 are met
  - [ ] Linting checkpoint:
    - [ ] Final sweep: `golangci-lint run --fix internal/app/frontmatter`
    - [ ] Verify ALL warnings resolved
    - [ ] Document any unavoidable nolint with clear justification

- [ ] Task 8: Commit changes (AC: committed)
  - [ ] Review all changes for completeness
  - [ ] Stage files:
    - [ ] `git add internal/adapters/api/note/loader.go`
    - [ ] `git add internal/adapters/api/note/loader_test.go`
    - [ ] `git add internal/app/frontmatter/validators.go`
    - [ ] `git add internal/app/frontmatter/service.go`
    - [ ] `git add internal/app/frontmatter/service_test.go`
    - [ ] `git add internal/ports/api/note.go`
    - [ ] `git add internal/ports/spi/vault.go`
    - [ ] `git add internal/adapters/spi/vault/reader.go`
  - [ ] Commit with message: `feat(frontmatter): implement FrontmatterService with Extract/Validate methods, field validators, NoteLoaderAdapter, and VaultReaderPort integration`
  - [ ] Verify commit includes all necessary files
  - [ ] Linting checkpoint:
    - [ ] Run pre-commit hooks if installed
    - [ ] Verify commit message follows conventional commits format

## Dev Notes

### FrontmatterService Implementation

From `docs/architecture/components.md#frontmatterservice` (v0.6.2):

**Purpose:** Extracts and validates frontmatter from markdown content following hexagonal architecture.

**Methods:**

- `Extract(content []byte) (Frontmatter, error)` - Parses YAML frontmatter from markdown content
- `Validate(ctx context.Context, fm Frontmatter) error` - Validates frontmatter against schema

**Dependencies:**

- VaultReaderPort - to load note content for frontmatter extraction
- Logger - structured logging

**Extract Implementation:**

```go
func (s *FrontmatterService) Extract(ctx context.Context, path string) (domain.Frontmatter, error) {
    // 1. Load note content using NoteLoaderAdapter.Load(path)
    // 2. Use returned content for parsing
    // 3. Parse markdown content to AST using goldmark (github.com/yuin/goldmark)
    // 4. Traverse AST to accurately identify frontmatter delimiters (---) using AST nodes
    // 5. Extract YAML content between delimiters using AST-based parsing
    // 6. Parse YAML using goccy/go-yaml
    // 7. Create Frontmatter model with FileClass and Fields
    // 8. Return or wrap errors as FrontmatterError
}
```

**Validate Implementation:**

```go
func (s *FrontmatterService) Validate(ctx context.Context, fm domain.Frontmatter, schemaName string) error {
    // 1. Use injected SchemaEngine to retrieve schema by name: schemaEngine.Get[domain.Schema](ctx, schemaName)
    // 2. Iterate retrieved schema Properties to validate frontmatter against schema
    // 3. Check required fields exist in frontmatter
    // 4. Delegate field validation to appropriate FieldValidator implementations
    // 5. For FileSpec, validate string/array types (existence via QueryService)
    // 6. Preserve unknown fields (FR6)
    // 7. Return structured FrontmatterError on validation failure
}
```

### Markdown Processing with Goldmark

Reference: `docs/refs/yuin-goldmark-digest`

From `docs/prd/technical-assumptions.md`:

**Library:** `github.com/yuin/goldmark` v1.7.4

- Extensible markdown parser with AST access for frontmatter extraction
- Enables future markdown features without custom development
- Actively maintained with regular updates

**Usage for Frontmatter Extraction:**

```go
import "github.com/yuin/goldmark"
import "github.com/yuin/goldmark/ast"

// Parse markdown to AST
parser := goldmark.DefaultParser()
reader := text.NewReader(content)
doc := parser.Parse(reader)

// Traverse AST to find frontmatter
ast.Walk(doc, func(n ast.Node, entering bool) (ast.WalkStatus, error) {
    if entering && n.Kind() == ast.KindFencedCodeBlock {
        // Handle code blocks containing --- markers
        return ast.WalkContinue, nil
    }
    // Find frontmatter delimiters using AST nodes
    return ast.WalkContinue, nil
})
```

### YAML Parsing

From `docs/architecture/tech-stack.md`:

**Library:** `github.com/goccy/go-yaml` v1.17.1

- 2-3x faster than go-yaml/yaml
- Critical for <300ms render performance (PRD requirement)
- Actively maintained

**Usage:**

```go
import "github.com/goccy/go-yaml"

var fields map[string]interface{}
if err := yaml.Unmarshal(yamlBytes, &fields); err != nil {
    return Frontmatter{}, NewFrontmatterError("failed to parse YAML", "", err)
}
```

### Validation Requirements

**FR6: Unknown Field Preservation**

- Frontmatter may contain fields not defined in schema
- Validation MUST NOT reject unknown fields
- Unknown fields preserved in Frontmatter.Fields map

**FR7: Schema-Driven Validation**

- Required fields MUST be present
- Field types MUST match PropertySpec
- FileSpec references MUST exist in vault (via QueryService lookup)

**Type Validation:**

- StringSpec: Check value is string
- NumberSpec: Check value is number, respect min/max/step
- DateSpec: Parse using format, check valid date
- FileSpec: Resolve via QueryService, check exists and matches constraints
- BoolSpec: Check value is boolean

**Error Handling:**
From `docs/architecture/error-handling-strategy.md`:

- Return `FrontmatterError` with field name and reason
- Wrap YAML parse errors with context
- Include schema name in error messages
- Clear remediation guidance

### File Locations

From `docs/architecture/source-tree.md`:

**Implementation:**

- `internal/app/frontmatter/service.go` - FrontmatterService implementation
- `internal/app/frontmatter/service_test.go` - Unit tests with fakes

**Dependencies:**

- `internal/domain/note.go` - Frontmatter model
- `internal/ports/spi/vault.go` - VaultReaderPort for file reading
- `internal/shared/errors/frontmatter.go` - FrontmatterError type

### Testing Standards

From `docs/architecture/testing-strategy.md`:

**Unit Tests:**

- Use fake SchemaRegistryPort implementation for testing
- Table-driven tests for validation edge cases
- Test all PropertySpec variant validations
- Test error message clarity

**Test Cases:**

- Extract: valid frontmatter, empty frontmatter, no delimiters, malformed YAML
- Validate: missing required, type mismatches, FileSpec resolution, unknown fields preserved
- Error wrapping: verify FrontmatterError structure and messages

### Refactoring Guidelines

**SRP Decomposition Examples:**

For this story (FrontmatterService), functions should be decomposed into focused helpers following SRP:

**Extract() Decomposition:**

- `findDelim(content []byte) (start, end int)` - Locate --- delimiter positions in content
- `parseYAML(yamlBytes []byte) (map[string]interface{}, error)` - Unmarshal YAML to map
- `validateFM(fields map[string]interface{}) error` - Basic sanity checks on parsed fields
- `extractFields(fields map[string]interface{}) Frontmatter` - Convert map to Frontmatter model
- Extract() orchestrates these helpers for clean separation

**Validate() Decomposition:**

- `validateRequired(fm Frontmatter, schema Schema) error` - Check all required fields present
- `validateTypes(fm Frontmatter, schema Schema) error` - Check field types match PropertySpec
- `validateFileSpec(fm Frontmatter, spec PropertySpec, queryService *QueryService) error` - Resolve file references
- `formatError(field, reason string) error` - Create structured FrontmatterError
- Validate() orchestrates these helpers for clean separation

**When to Decompose:**

- If any method exceeds 15 lines, consider extraction
- If a method has >2 concerns, extract helpers (e.g., Extract does find, parse, validate, convert → extract each)
- Extract YAML parsing for isolation and error handling
- Extract validation logic per PropertySpec type for clarity

**Naming Standards:**

- Exported types: PascalCase (FrontmatterService)
- Constructors: NewTypeName (NewFrontmatterService)
- Private helpers: camelCase (findDelim, parseYAML, validateFM, extractFields, validateRequired, validateTypes, validateFileSpec, formatError)
- Methods: PascalCase for exported (Extract, Validate), camelCase for private
- Validation helpers: validate prefix (validateRequired, validateTypes, validateFileSpec)

**Documentation Requirements:**

- Package comment at top of service.go explaining FrontmatterService purpose
- All exported types and methods have GoDoc comments
- Private helpers have GoDoc or inline comments explaining purpose
- Document delimiter format (--- at line start)
- Document YAML parsing with goccy/go-yaml rationale (2-3x faster for <300ms target)
- Document FR6 (unknown field preservation) and FR7 (schema-driven validation)
- Document FileSpec resolution via QueryService
- Document FrontmatterError structure and fields

**Error Handling Patterns:**

- Malformed YAML: Return FrontmatterError("failed to parse YAML", "", err)
- Missing required field: Return FrontmatterError with field name and "required field missing"
- Type mismatch: Return FrontmatterError with field name and "type mismatch: expected X, got Y"
- File not found: Return FrontmatterError with field name and "file not found: {path}"
- All errors include field name for context
- All errors include validation reason for troubleshooting

**Testing Decomposition:**

- Each helper function should have dedicated unit tests
- Test extraction: valid frontmatter, empty, missing delimiters, malformed YAML
- Test validation: required fields, type checks, FileSpec resolution, unknown field preservation
- Use fake SchemaRegistryPort and QueryService (no mocks for domain services)
- Verify FrontmatterError structure and messages

## Validator Design Approach

**Interface-Based Validation:**

Instead of a single FrontmatterValidator struct, implement multiple validator structs that implement a common `FieldValidator` interface:

```go
type FieldValidator interface {
    Validate(fieldName string, fieldValue interface{}, prop domain.Property) error
}

type StringValidator struct{}
type NumberValidator struct{}
type DateValidator struct{}
type FileValidator struct{}
type BoolValidator struct{}
```

**FrontmatterService Integration:**

- FrontmatterService maintains the primary `Validate()` method that orchestrates validation
- Individual field validation delegated to appropriate validator implementations
- Validators injected via interface for testability and polymorphism
- Clean separation between orchestration and specific validation logic

## Future Considerations

Based on architectural feedback, consider the following for future epics:

1. **Vault Integration Adapter**: Evaluate if a dedicated frontmatter/note adapter package is needed for vault integration, potentially in Epic 4 (Interactive Input Engine).

2. **VaultReaderPort Splitting**: If implemented, ensure all affected files in `internal/adapters/spi/vault/` are refactored accordingly to support both VaultScannerPort and VaultReaderPort interfaces.

These considerations may require additional stories in future epics to maintain clean hexagonal architecture boundaries.

## Change Log

| Date       | Version | Description                                                              | Author             |
| ---------- | ------- | ------------------------------------------------------------------------ | ------------------ |
| 2025-10-28 | 1.0     | Story created from Epic 3 requirements                                   | Bob (Scrum Master) |
| 2025-10-29 | 1.1     | Enhanced with full TDD framework, SRP decomposition, linting checkpoints | QA Specialist      |
| 2025-10-30 | 1.2     | Enhanced with goldmark integration for AST-based frontmatter extraction | Sarah (PO)         |
| 2025-10-30 | 1.3     | Story implementation completed - Extract() and Validate() fully tested   | James (Dev)        |
| 2025-10-30 | 1.4     | Architectural refactoring: Extract() moved to vault adapter, QueryService dependency removed, Validate() simplified to schema-only validation | James (Dev)        |
| 2025-10-30 | 1.5     | PO review: Updated acceptance criteria and dev notes to reflect SchemaRegistryPort dependency for validation | Sarah (PO)         |
| 2025-10-30 | 1.6     | Reset story to original requirements: restored Extract() method, clarified validation scope, removed architectural changes | Sarah (PO)         |
| 2025-10-30 | 1.7     | Completely rewrote tasks: added port splitting, NoteLoaderAdapter, field validators with polymorphism, corrected dependencies | Sarah (PO)         |
| 2025-10-30 | 1.8     | Restructured all tasks to follow explicit TDD framework (RED-GREEN-REFACTOR) with detailed test-first approach matching VaultIndexer pattern | Sarah (PO)         |
| 2025-10-30 | 1.9     | Removed SchemaRegistryPort injection and NoteLoaderPort; FrontmatterService now uses VaultReaderPort directly and Validate() accepts schema as parameter | Sarah (PO)         |
| 2025-10-30 | 1.11    | Updated NoteLoaderAdapter to only implement Read method, Extract method to use Goldmark package, and FrontmatterService to interact with SchemaEngine for schema access | Sarah (PO)         |
| 2025-10-30 | 1.10    | Added NoteLoaderAdapter implementing VaultReaderPort and reordered tasks: field validators before FrontmatterService due to dependency | Sarah (PO)         |
| 2025-10-30 | 1.8     | Story validation completed: GO assessment with 9/10 readiness score, high confidence. Status changed to In Progress for dev implementation | Sarah (PO)         |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

N/A - No blocking issues encountered

### Implementation Notes

1. **Port Splitting**: VaultReaderPort split into VaultScannerPort (for scanning) and VaultReaderPort (for single reads) for better interface segregation
2. **NoteLoaderAdapter**: Adapter implementing VaultReaderPort with only Read method to Load and Read markdown files for FrontmatterService
3. **Field Validators**: Interface polymorphism with FieldValidator implementations for each PropertySpec type (created before FrontmatterService due to dependency)
4. **SchemaEngine Integration**: FrontmatterService injects SchemaEngine to retrieve schemas by name for validation (schemas are loaded and resolved only through SchemaEngine)
5. **Goldmark Usage**: Extract() method uses goldmark package for accurate AST-based frontmatter identification
6. **FrontmatterService Integration**: Uses NoteLoaderAdapter for file loading, SchemaEngine for schema access, and field validators for validation
7. **Architecture Compliance**: Clean separation between domain services, ports, and adapters
8. **Files Status**: All implementation files deleted, ready for fresh implementation with corrected architecture

### File List

#### Files to Create

- `internal/adapters/api/note/loader.go` - NoteLoaderAdapter implementing VaultReaderPort
- `internal/adapters/api/note/loader_test.go` - Unit tests for NoteLoaderAdapter
- `internal/app/frontmatter/validators.go` - FieldValidator interface and implementations
- `internal/app/frontmatter/service.go` - FrontmatterService with Extract() and Validate() methods
- `internal/app/frontmatter/service_test.go` - Unit tests for FrontmatterService

#### Files to Modify

- `internal/ports/api/note.go` - Add NoteLoaderPort interface if needed
- `internal/ports/spi/vault.go` - Split VaultReaderPort into VaultScannerPort and VaultReaderPort
- `internal/adapters/spi/vault/reader.go` - Update to implement both interfaces

#### Dependencies

- `github.com/yuin/goldmark v1.7.4` - For AST-based markdown parsing
- `github.com/goccy/go-yaml v1.17.1` - For fast YAML parsing

#### Dependencies

- `/Users/jack/Documents/41_personal/lithos/internal/domain/note.go` (Frontmatter model)
- `/Users/jack/Documents/41_personal/lithos/internal/ports/spi/vault.go` (VaultReaderPort)
- `/Users/jack/Documents/41_personal/lithos/internal/app/schema/engine.go` (SchemaEngine for schema access)
- `/Users/jack/Documents/41_personal/lithos/internal/shared/errors/frontmatter.go` (FrontmatterError)

## QA Results

### Test Coverage Requirements

**Unit Tests - Extract():**

- Valid frontmatter parsing with YAML delimiters
- Empty frontmatter handling
- Malformed YAML error handling
- Missing delimiters handling
- Frontmatter model creation with FileClass and Fields

**Unit Tests - Validate():**

- Required field presence checked against schema
- Type validation for all PropertySpec variants (String, Number, Date, File, Bool)
- FileSpec type validation (existence via QueryService)
- Unknown fields preserved in Frontmatter.Fields (FR6)
- Array vs scalar handling per PropertySpec.array field
- Schema not found error handling
- Structured FrontmatterError with field context and validation reasons

**Quality Gates:**

- `go test ./internal/app/frontmatter` - All tests pass (>90% coverage)
- `golangci-lint run internal/app/frontmatter` - No linting issues
- Architecture v0.6.2 compliant with hexagonal pattern
- Extract() method for frontmatter parsing from markdown content

**Test Design:** `docs/qa/assessments/3.5-test-design-20251029.md`

### Key Validations

1. **YAML Parsing:** goccy/go-yaml provides fast parsing for <300ms performance target
2. **Schema Validation:** FR7 requirements enforced (required fields, type checks, FileSpec resolution)
3. **Unknown Field Preservation:** FR6 requirement satisfied - unknown fields not rejected
4. **Error Messages:** Structured FrontmatterError with field name, reason, and remediation
5. **QueryService Integration:** FileSpec validation uses QueryService for file existence checks
6. **Hexagonal Architecture:** Service depends on ports (SchemaRegistryPort, QueryService), not adapters
