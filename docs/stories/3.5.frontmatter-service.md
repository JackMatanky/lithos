# Story 3.5: FrontmatterService

## Status

Draft

## Story

**As a** developer,
**I want** FrontmatterService to extract and validate frontmatter exactly as described,
**so that** the indexer produces canonical Note objects.

## Acceptance Criteria

1. `internal/app/frontmatter/service.go` implements `Extract` and `Validate` exactly as described in `docs/architecture/components.md#frontmatterservice`, using `goccy/go-yaml` and SchemaRegistryPort/QueryService dependencies.

2. Validation enforces FR6/FR7 requirements, including strict type checks, array vs scalar handling, and FileSpec lookups via QueryService.

3. Service returns structured `FrontmatterError` instances per `error-handling-strategy.md`, preserving unknown fields as required.

4. Unit tests cover extraction edge cases, missing required fields, type mismatches, file reference resolution, and error message content.

5. `golangci-lint run ./internal/app/frontmatter` and `go test ./internal/app/frontmatter` succeed.

## Tasks / Subtasks

- [ ] Task 1: Implement Extract() method (AC: 1)
  - [ ] RED: Write failing tests for frontmatter extraction
  - [ ] RED: Test delimiter detection (---) and YAML parsing
  - [ ] RED: Test empty frontmatter and missing delimiters
  - [ ] GREEN: Implement Extract using goccy/go-yaml
  - [ ] GREEN: Handle delimiter detection and YAML unmarshaling
  - [ ] REFACTOR: Add logging and error context

- [ ] Task 2: Implement Validate() method (AC: 2, 3)
  - [ ] RED: Write failing tests for schema validation
  - [ ] RED: Test required field checks, type validation, FileSpec lookups
  - [ ] RED: Test unknown field preservation (FR6)
  - [ ] GREEN: Implement validation against schema using SchemaRegistryPort
  - [ ] GREEN: Integrate QueryService for FileSpec validation
  - [ ] GREEN: Return structured FrontmatterError instances
  - [ ] REFACTOR: Add comprehensive error messages

- [ ] Task 3: Comprehensive testing (AC: 4)
  - [ ] Create unit tests with fake SchemaRegistryPort and QueryService
  - [ ] Test extraction edge cases (malformed YAML, no delimiters)
  - [ ] Test validation scenarios (missing required, type mismatches)
  - [ ] Test FileSpec resolution via QueryService
  - [ ] Test error message clarity and structure

- [ ] Task 4: Quality gates (AC: 5)
  - [ ] Run `golangci-lint run --fix internal/app/frontmatter`
  - [ ] Run `go test ./internal/app/frontmatter` - verify 100% pass
  - [ ] Verify test coverage >90%

## Dev Notes

### FrontmatterService Implementation

From `docs/architecture/components.md#frontmatterservice` (v0.6.2):

**Purpose:** Extracts and validates frontmatter from markdown content following hexagonal architecture.

**Methods:**
- `Extract(content []byte) (Frontmatter, error)` - Parses YAML frontmatter
- `Validate(ctx context.Context, fm Frontmatter) error` - Validates against schema

**Dependencies:**
- SchemaRegistryPort - to load schemas for validation
- QueryService - to resolve FileSpec file references
- Logger - structured logging

**Extract Implementation:**
```go
func (s *FrontmatterService) Extract(content []byte) (Frontmatter, error) {
    // 1. Find frontmatter delimiters (---)
    // 2. Extract YAML between delimiters
    // 3. Parse using goccy/go-yaml
    // 4. Create Frontmatter model
    // 5. Return or wrap errors as FrontmatterError
}
```

**Validate Implementation:**
```go
func (s *FrontmatterService) Validate(ctx context.Context, fm Frontmatter) error {
    // 1. Get schema from SchemaRegistryPort using fm.FileClass
    // 2. Iterate schema Properties
    // 3. Check required fields exist
    // 4. Validate types (string, number, date, file, bool)
    // 5. For FileSpec, use QueryService to resolve references
    // 6. Preserve unknown fields (FR6)
    // 7. Return structured FrontmatterError on failure
}
```

### YAML Parsing

From `docs/architecture/tech-stack.md`:

**Library:** `github.com/goccy/go-yaml` v1.17.1
- 2-3x faster than go-yaml/yaml
- Critical for <300ms render performance (PRD requirement)
- Actively maintained

**Usage:**
```go
import "github.com/goccy/go-yaml"

var fields map[string]interface{}
if err := yaml.Unmarshal(yamlBytes, &fields); err != nil {
    return Frontmatter{}, NewFrontmatterError("failed to parse YAML", "", err)
}
```

### Validation Requirements

**FR6: Unknown Field Preservation**
- Frontmatter may contain fields not defined in schema
- Validation MUST NOT reject unknown fields
- Unknown fields preserved in Frontmatter.Fields map

**FR7: Schema-Driven Validation**
- Required fields MUST be present
- Field types MUST match PropertySpec
- FileSpec references MUST exist in vault (via QueryService lookup)

**Type Validation:**
- StringSpec: Check value is string
- NumberSpec: Check value is number, respect min/max/step
- DateSpec: Parse using format, check valid date
- FileSpec: Resolve via QueryService, check exists and matches constraints
- BoolSpec: Check value is boolean

**Error Handling:**
From `docs/architecture/error-handling-strategy.md`:
- Return `FrontmatterError` with field name and reason
- Wrap YAML parse errors with context
- Include schema name in error messages
- Clear remediation guidance

### File Locations

From `docs/architecture/source-tree.md`:

**Implementation:**
- `internal/app/frontmatter/service.go` - FrontmatterService implementation
- `internal/app/frontmatter/service_test.go` - Unit tests with fakes

**Dependencies:**
- `internal/domain/note.go` - Frontmatter model
- `internal/ports/spi/schema.go` - SchemaRegistryPort
- `internal/app/query/service.go` - QueryService for FileSpec resolution
- `internal/shared/errors/frontmatter.go` - FrontmatterError type

### Testing Standards

From `docs/architecture/testing-strategy.md`:

**Unit Tests:**
- Use fake SchemaRegistryPort (return predefined schemas)
- Use fake QueryService (return predefined notes for FileSpec validation)
- Table-driven tests for extraction edge cases
- Test all PropertySpec variant validations
- Test error message clarity

**Test Cases:**
- Extract: valid frontmatter, empty frontmatter, no delimiters, malformed YAML
- Validate: missing required, type mismatches, FileSpec resolution, unknown fields preserved
- Error wrapping: verify FrontmatterError structure and messages

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-28 | 1.0 | Story created from Epic 3 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent during implementation_

### Debug Log References

_To be completed by dev agent during implementation_

### Completion Notes List

_To be completed by dev agent during implementation_

### File List

_To be completed by dev agent during implementation_

## QA Results

_To be completed by QA agent after implementation_
