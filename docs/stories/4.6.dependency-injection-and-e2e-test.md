# Story 4.6: Dependency Injection and E2E Test for Interactive Input Engine

## Status: Draft

## Story

As a developer,
I want to implement dependency injection for the interactive input engine components and add comprehensive e2e tests,
So that the interactive input functionality is properly wired and thoroughly tested end-to-end.

## Context

This story completes the interactive input engine (Epic 4) by wiring all components through dependency injection and ensuring the entire interactive workflow works correctly through e2e testing. It follows the same pattern established in story 1.16 for the foundational CLI.

## Acceptance Criteria

### Functional Requirements

1. All interactive input components (prompt port, promptui adapter, finder port, fuzzyfind adapter, CLI find command, template engine helpers) are properly registered in the DI container
2. The main.go file includes the interactive input engine dependencies in the application wiring
3. E2E tests cover the complete interactive input workflow from CLI command execution through user prompts to template engine integration
4. The e2e tests use real terminal interactions and validate actual interactive behavior
5. Test scenarios include various user input patterns and edge cases

### Integration Requirements

6. Interactive input engine integrates seamlessly with the existing CLI command structure
7. Prompt interactions work correctly with the promptui adapter
8. Fuzzy finding operations integrate properly with the finder components
9. Template engine helpers function correctly within interactive workflows
10. No breaking changes to existing functionality

### Quality Requirements

11. All e2e tests pass consistently
12. Code coverage for interactive input components meets project standards (80%+)
13. Error handling is tested for user input validation, cancellation, and terminal issues
14. Tests run within reasonable time limits (< 30 seconds for full suite)
15. Test cleanup properly handles terminal state and mock inputs

## Dev Notes

### Previous Story Insights

From story 4.5 (CLI find command): The CLI command structure is established and ready for integration testing. The interactive components have been implemented with proper error handling.

### Data Models

- **Prompt Models**: Use existing prompt port interfaces [Source: docs/architecture/data-models.md#prompt-interfaces]
- **Finder Models**: Fuzzyfind adapter follows established finder patterns [Source: docs/architecture/data-models.md#finder-models]
- **Template Models**: Template engine helpers integrate with existing template system [Source: docs/architecture/data-models.md#template-models]

### API Specifications

- **CLI Interface**: Follows cobra CLI adapter pattern from story 1.12 [Source: docs/architecture/backend-architecture.md#cli-adapter]
- **Prompt Interface**: Implements prompt port interfaces from story 4.1 [Source: docs/architecture/backend-architecture.md#prompt-ports]
- **Finder Interface**: Uses established finder port interfaces from story 4.3 [Source: docs/architecture/backend-architecture.md#finder-ports]

### Component Specifications

- **DI Container**: Extend the existing registry from story 1.7 with interactive input components [Source: docs/architecture/backend-architecture.md#dependency-injection]
- **E2E Test Structure**: Follow the e2e testing pattern from story 1.16 [Source: docs/architecture/testing-strategy.md#e2e-testing]
- **Test Infrastructure**: Create mock terminal inputs for automated testing [Source: docs/architecture/testing-strategy.md#mock-testing]

### File Locations

- **Main Application**: Update cmd/lithos/main.go to include interactive input dependencies [Source: docs/architecture/source-tree.md#main-application]
- **DI Registry**: Extend internal/shared/registry/registry.go with interactive components [Source: docs/architecture/source-tree.md#registry-package]
- **E2E Tests**: Create tests/e2e/interactive_input_test.go [Source: docs/architecture/source-tree.md#e2e-tests]
- **Test Fixtures**: Add test fixtures for terminal interactions [Source: docs/architecture/source-tree.md#test-data]

### Testing Requirements

- **E2E Test Coverage**: Complete workflow from CLI command to interactive completion [Source: docs/architecture/testing-strategy.md#e2e-scenarios]
- **Integration Tests**: Component interactions within the interactive input engine [Source: docs/architecture/testing-strategy.md#integration-testing]
- **Mock Testing**: Terminal and user input mocking for reliable automation [Source: docs/architecture/testing-strategy.md#mock-testing]

### Technical Constraints

- **Go Version**: Must be compatible with existing Go 1.21+ codebase [Source: docs/architecture/tech-stack.md#go-version]
- **Terminal Compatibility**: Handle different terminal types and capabilities [Source: docs/architecture/tech-stack.md#platform-compatibility]
- **Dependencies**: Use existing libraries (cobra, promptui, etc.) [Source: docs/architecture/tech-stack.md#dependencies]

## Tasks / Subtasks

- [ ] Task 1: Register interactive input components in DI container
  - [ ] Add prompt adapters to registry
  - [ ] Register finder adapters
  - [ ] Add template engine helpers to registry
  - [ ] Include CLI find command in registry

- [ ] Task 2: Wire interactive input dependencies in main.go
  - [ ] Import interactive input registry functions
  - [ ] Add interactive components to application container
  - [ ] Ensure proper initialization order
  - [ ] Test basic application startup with interactive components

- [ ] Task 3: Create e2e test infrastructure
  - [ ] Create tests/e2e/interactive_input_test.go
  - [ ] Set up mock terminal input/output
  - [ ] Create test scenarios for different user interactions
  - [ ] Implement test helper functions for terminal setup/cleanup

- [ ] Task 4: Implement e2e test scenarios
  - [ ] Test CLI find command execution with user prompts
  - [ ] Verify fuzzy finding functionality with mock inputs
  - [ ] Test template engine integration in interactive flows
  - [ ] Validate error handling for invalid inputs and cancellations
  - [ ] Test edge cases (empty results, user cancellation, terminal issues)

- [ ] Task 5: Add comprehensive test coverage
  - [ ] Ensure 80%+ code coverage for new integration code
  - [ ] Test various user input patterns and validation
  - [ ] Validate performance meets requirements
  - [ ] Run tests across different terminal environments

- [ ] Task 6: Documentation and cleanup
  - [ ] Update any necessary documentation
  - [ ] Ensure test fixtures are properly organized
  - [ ] Verify no breaking changes to existing functionality

## Testing

### E2E Test Scenarios

1. **Complete Interactive Find Workflow**
   - Given: CLI find command is executed
   - When: User provides search input through prompts
   - Then: Fuzzy finding returns correct results and integrates with template engine

2. **User Input Validation**
   - Given: Interactive prompt for user input
   - When: Invalid input is provided
   - Then: Validation errors are displayed and user is prompted again

3. **Cancellation Handling**
   - Given: Interactive session in progress
   - When: User cancels operation
   - Then: Clean exit without errors and proper cleanup

### Validation Steps

- Run full e2e test suite: `go test ./tests/e2e/...`
- Verify code coverage: `go test -cover ./internal/app/interactive/...`
- Manual testing: Execute CLI commands with interactive inputs
- Integration testing: Verify with existing CLI structure

## Dev Agent Record

### Agent Model Used

bmad-dev v1.0 - Full Stack Developer specialized in Go implementation and testing

### Dev Notes

This story requires careful integration of interactive components with terminal handling. The DI wiring must follow established patterns. E2E tests need sophisticated mocking for terminal interactions.

### File List

- cmd/lithos/main.go (modified)
- internal/shared/registry/registry.go (modified)
- tests/e2e/interactive_input_test.go (new)
- testdata/interactive/ (new directory with test fixtures)

### Change Log

- 2025-01-12: Initial story creation following epic 4 completion pattern
