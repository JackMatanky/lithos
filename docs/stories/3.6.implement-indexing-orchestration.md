# Story 3.6: Implement Indexing Orchestration

## Status

Draft

## Story

As a developer, I want to implement the indexing orchestration logic, so that the rebuild method coordinates all components.

## Acceptance Criteria

- 3.6.1: Rebuild method coordinates FileSystemPort, CacheCommandPort, and SchemaValidator interactions.
- 3.6.2: Service logs indexing progress using structured logging and returns IndexStats result object.

## Tasks / Subtasks

- [ ] Task 1 (AC: 3.6.1): Implement `Rebuild` Orchestration
  - [ ] In the `VaultIndexer`'s `Rebuild` method, call the `FileSystemPort.Walk` method to get a list of markdown files.
  - [ ] For each file, read the content using `FileSystemPort.ReadFile`.
  - [ ] Extract the frontmatter using the `ExtractFrontmatter` function.
  - [ ] Validate the frontmatter using the `SchemaValidator`.
  - [ ] Create a `Note` domain model.
  - [ ] Store the note in the cache using `CacheCommandPort.Store`.
- [ ] Task 2 (AC: 3.6.2): Implement Logging and Stats
  - [ ] Add structured logging to the `Rebuild` method to log progress (e.g., files scanned, notes indexed, errors encountered).
  - [ ] Create an `IndexStats` struct to hold statistics about the indexing process (e.g., number of files scanned, number of notes indexed, duration).
  - [ ] Return the `IndexStats` object from the `Rebuild` method.
- [ ] Task 3: Add and Update Unit Tests
  - [ ] Update the unit tests for the `VaultIndexer` to reflect the new orchestration logic.
  - [ ] Mock the `FileSystemPort`, `CacheCommandPort`, and `SchemaValidator`.
  - [ ] Test that the `Rebuild` method correctly orchestrates the calls to the ports.
  - [ ] Test that the `IndexStats` are calculated correctly.
- [ ] Task 4: Full method and function decomposition into private srp function while ensuring a logical file organization.
- [ ] Task 5: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass
- [ ] Task 6: Pre-commit and commit readiness
  - [ ] Execute `pre-commit run` to confirm hooks pass
  - [ ] Stage updates and commit with a fully descriptive conventional commit message

## Dev Notes

### Data Models
- The `Note` model is the central data structure for indexed content. [Source: docs/architecture/data-models.md#note]
- `IndexStats` should be a new struct that captures the results of an indexing operation.

### Component Specifications
- The `VaultIndexer` service is responsible for orchestrating the entire indexing process. [Source: docs/architecture/components.md#vaultindexer]
- The `Rebuild` method is the entry point for a full re-index of the vault. [Source: docs/architecture/components.md#vaultindexer]

### File Locations
- The `VaultIndexer` is in `internal/app/indexing/vault_indexer.go`. [Source: docs/architecture/source-tree.md#source-tree]
- Tests are in `internal/app/indexing/vault_indexer_test.go`. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Testing Requirements
- Unit tests must use mocks for all port interactions. [Source: docs/architecture/testing-strategy.md#unit-tests]
- Tests should verify the orchestration logic and the accuracy of the returned stats. [Source: docs/architecture/testing-strategy.md#unit-tests]

### Technical Constraints
- The orchestration must be robust and handle errors from any of the ports. [Source: docs/architecture/coding-standards.md#error-handling]
- The process should be cancelable via the `context.Context`. [Source: docs/architecture/coding-standards.md#core-standards]

## Change Log

| Date       | Version | Description                                     | Author |
| ---------- | ------- | ----------------------------------------------- | ------ |
| 2025-10-22 | 1.0     | Initial story draft for indexing orchestration. | sm     |

## Dev Agent Record

### Agent Model Used

_TBD_

### Debug Log References

_TBD_

### Completion Notes List

_TBD_

### File List

_TBD_

## QA Results

_TBD_
