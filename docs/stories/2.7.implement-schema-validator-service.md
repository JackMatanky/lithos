# Story 2.7: Implement Schema Validator Service

## Status

Draft

## Story

As a developer, I want to implement the SchemaValidator as a separate domain service, so that validation logic is decoupled from schema loading.

## Acceptance Criteria

**Functional Requirements:**

2.7.1: `internal/app/schema/` contains SchemaValidator implementing validation interface.
2.7.2: Service validates Frontmatter against Schema using PropertySpec polymorphism.
2.7.3: Validation checks Required fields, Array constraints, and type-specific PropertySpec rules.
2.7.4: Returns structured ValidationError types from `internal/shared/errors/`.

**Integration Requirements:**

2.7.5: SchemaValidator follows domain service patterns with proper dependency injection.
2.7.6: Service integrates with SchemaRegistry for schema lookup.
2.7.7: Validation supports context cancellation for long-running validations.

**Quality Requirements:**

2.7.8: Unit tests cover SchemaValidator behavior with mocked dependencies.
2.7.9: Code follows project coding standards and naming conventions.
2.7.10: Comprehensive error handling with structured validation errors.

## Tasks / Subtasks

- [ ] Task 1: Define SchemaValidator interface and service (AC: 2.7.1, 2.7.5)
  - [ ] Create `internal/app/schema/validator.go` with SchemaValidator service struct
  - [ ] Define SchemaValidatorPort interface in `internal/ports/api/schema.go` for dependency injection
  - [ ] Implement constructor accepting SchemaRegistry dependency
  - [ ] Follow domain service patterns with proper encapsulation
  - [ ] Ensure service consumes resolved domain schemas from SchemaRegistry (no JSON parsing in validator)

- [ ] Task 2: Implement frontmatter validation logic (AC: 2.7.2, 2.7.3, 2.7.7)
  - [ ] Implement Validate(ctx context.Context, schemaName string, frontmatter Frontmatter) Result[ValidationResult] method
  - [ ] Look up schema from SchemaRegistry.Get(schemaName) with error handling for missing schemas
  - [ ] Validate each frontmatter field against schema ResolvedProperties (post-inheritance)
  - [ ] Use PropertySpec polymorphism for type-specific validation (StringPropertySpec, NumberPropertySpec, etc.)
  - [ ] Check Required fields constraints (field must exist in frontmatter.Fields)
  - [ ] Check Array constraints (if Array=true, value must be slice; if Array=false, value must be scalar)
  - [ ] Support context cancellation for validation process
  - [ ] Validate against schema.ResolvedProperties (not Properties) to include inheritance

- [ ] Task 3: Implement structured error handling (AC: 2.7.4, 2.7.10)
  - [ ] Create ValidationError types in `internal/shared/errors/validation.go`:
    - FieldValidationError (field name, expected type, actual value, constraint violated)
    - RequiredFieldError (missing required field name)
    - ArrayConstraintError (field name, expected array/scalar, actual type)
    - PropertySpecError (field name, PropertySpec-specific error)
  - [ ] Implement field-level error reporting with property names and values
  - [ ] Use Result[T] pattern for functional error handling across all validation methods
  - [ ] Provide clear error messages for different validation failures with remediation hints
  - [ ] Aggregate multiple field errors into single ValidationResult

- [ ] Task 4: Integrate with SchemaRegistry (AC: 2.7.6)
  - [ ] Ensure SchemaValidator uses SchemaRegistry.Get() for schema lookup
  - [ ] Handle cases where schema is not found with SchemaNotFoundError
  - [ ] Support validation against schema.ResolvedProperties (post-inheritance resolution from Story 2.6)
  - [ ] Validate frontmatter.FileClass matches schemaName parameter
  - [ ] Handle PropertyBank references that may be in ResolvedProperties

- [ ] Task 5: Add comprehensive testing (AC: 2.7.8, 2.7.9)
  - [ ] Create `internal/app/schema/validator_test.go` with unit tests
  - [ ] Add tests with mocked SchemaRegistry and various frontmatter scenarios
  - [ ] Test validation scenarios for each PropertySpec type:
    - StringPropertySpec: enum validation, pattern matching, edge cases
    - NumberPropertySpec: min/max bounds, step validation, type checking
    - DatePropertySpec: format validation with Go time layouts
    - FilePropertySpec: fileClass/directory constraints (if applicable)
    - BoolPropertySpec: type checking
  - [ ] Test Required field validation (missing fields, optional fields)
  - [ ] Test Array constraint validation (scalar vs array values)
  - [ ] Test inheritance validation using schema.ResolvedProperties
  - [ ] Test error handling: schema not found, malformed frontmatter, validation failures
  - [ ] Test Result[T] pattern and structured error reporting
  - [ ] Test context cancellation scenarios
  - [ ] Ensure test coverage meets project standards (≥85% for app layer)

- [ ] Task 6: Decompose functions for SRP compliance
  - [ ] Break larger validation routines into focused private helpers:
    - validateRequiredFields() helper
    - validateArrayConstraints() helper
    - validatePropertySpec() helper for PropertySpec polymorphism
    - aggregateValidationErrors() helper
  - [ ] Keep public APIs unchanged while improving internal structure
  - [ ] Re-run the validator test suite to verify all acceptance criteria remain satisfied

- [ ] Task 7: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass

- [ ] Task 8: Pre-commit and commit readiness
  - [ ] Execute `pre-commit` to confirm hooks pass
  - [ ] Stage updates and commit with a full conventional commit message summarizing validator changes

## Dev Notes

**Previous Story Insights:**
- Stories 2.1-2.6 will implement Config, Schema/Property models, SchemaEnginePort, SchemaRegistry, and inheritance resolution providing foundation
- This story builds on PropertySpec implementations and SchemaRegistry
- Hexagonal architecture patterns established provide guidance for domain service implementation

**Data Models:**
- Frontmatter model with Fields map and FileClass for validation input
- Schema model with ResolvedProperties for validation rules
- Property model with PropertySpec interface for polymorphic validation

**API Specifications:**
- SchemaValidator interface with Validate method
- ValidationError types for structured error reporting
- Result[T] pattern for functional error handling

**Component Specifications:**
- SchemaValidator located in `internal/app/schema/validator.go`
- Follows domain service patterns with dependency injection
- Uses PropertySpec polymorphism for extensible validation

**File Locations:**
- Service implementation: `internal/app/schema/validator.go` (create new)
- Tests: `internal/app/schema/validator_test.go` (create new)
- Error types: `internal/shared/errors/validation.go` (create new)

**Testing Requirements:**
- Unit tests for SchemaValidator with mocked SchemaRegistry
- Tests for validation of various property types and constraints
- Error handling tests for different validation failure scenarios
- Integration tests with real schemas and frontmatter

**Technical Constraints:**
- Follow domain service principles: business logic in application layer
- Use dependency injection for SchemaRegistry access
- Implement Result[T] pattern from shared errors package
- Support context cancellation for validation operations
- Leverage PropertySpec interface for polymorphic validation

**Source References:**
- [Architecture: docs/architecture/components.md#schemalidatorservice]
- [Architecture: docs/architecture/data-models.md#frontmatter]
- [Architecture: docs/architecture/coding-standards.md#error-handling]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]

### Context Source
- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: Domain service implementation for frontmatter validation
- **Integration Points**: SchemaValidator used by VaultIndexer and TemplateEngine for validation
- **Goal**: Establish core domain service for schema-based frontmatter validation

### Technical Guidance

#### Existing System Context
- **Current State**: SchemaRegistry loads schemas, Property models define validation rules
- **Technology Stack**: Go 1.23+ with domain service patterns, PropertySpec polymorphism
- **Integration Points**: SchemaValidator validates frontmatter during indexing and template generation
- **Architecture Pattern**: Domain service using Result[T] pattern for functional error handling

#### Integration Approach
- **Domain Service**: Implement as pure business logic service in application layer
- **Dependency Injection**: Accept SchemaRegistry dependency via constructor
- **Polymorphic Validation**: Use PropertySpec interface for type-specific validation
- **Structured Errors**: Return ValidationError types with field-level details

#### Technical Constraints
- **Application Layer**: SchemaValidator belongs in `internal/app/schema/` as domain service
- **Result Pattern**: Use `internal/shared/errors` Result[T] for error handling
- **Context Support**: All public methods must accept context.Context for cancellation
- **Polymorphism**: Leverage PropertySpec interface for extensible validation

#### Key Files to Modify/Create
- `internal/app/schema/validator.go` - **CREATE** - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - **CREATE** - Unit tests for SchemaValidator
- `internal/shared/errors/validation.go` - **CREATE** - ValidationError types

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data
- **Validation Tests**: Test various validation scenarios and error conditions
- **Integration Tests**: Test end-to-end validation with real schemas

### Definition of Done

- [ ] SchemaValidator service implemented in `internal/app/schema/` following domain service patterns
- [ ] SchemaValidatorPort interface defined for dependency injection
- [ ] Service validates Frontmatter against Schema.ResolvedProperties using PropertySpec polymorphism
- [ ] Validation checks Required fields, Array constraints, and type-specific PropertySpec rules
- [ ] Returns Result[ValidationResult] with structured ValidationError types for field-level details
- [ ] Integrates with SchemaRegistry for schema lookup with proper error handling
- [ ] Supports context cancellation for validation operations
- [ ] Validates against post-inheritance ResolvedProperties (includes property bank references)
- [ ] Structured error types defined: FieldValidationError, RequiredFieldError, ArrayConstraintError, PropertySpecError
- [ ] Clear error messages with remediation hints for different validation failures
- [ ] Unit tests pass with ≥85% coverage for all validation scenarios including inheritance
- [ ] Code follows project coding standards and naming conventions
- [ ] Private helper functions for validation concerns follow SRP

### Risk Assessment

#### Implementation Risks
- **Primary Risk**: Complex PropertySpec polymorphism may introduce validation bugs
- **Mitigation**: Implement incrementally with comprehensive unit tests
- **Verification**: Test validation with various property types and constraints

#### Rollback Plan
- **Git Rollback**: Revert to previous commit if validation logic fails
- **File Removal**: Delete new validator files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

### Testing

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data
- **Validation Tests**: Test various validation scenarios and error conditions
- **Integration Tests**: Test end-to-end validation with real schemas

#### Testing Standards
- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use table-driven tests for multiple validation scenarios
- Test both success and failure cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft for Schema Validator service implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- SchemaValidator service patterns from components.md
- Validation logic requirements from data-models.md
- Error handling patterns from shared errors package

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- SchemaValidator service requirements extracted from components.md
- Validation logic and error handling requirements included
- Testing strategy aligned with project standards

### File List

**Files to Create/Modify:**
- `internal/app/schema/validator.go` - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - Unit tests for SchemaValidator
- `internal/shared/errors/validation.go` - ValidationError types
- `internal/ports/api/schema.go` - SchemaValidatorPort interface (update existing)

## QA Results

### Pre-Implementation Review

**Status**: Story needs completion and dependency resolution before implementation

**Key Issues Identified:**
- Story dependencies: Requires completion of Stories 2.2, 2.3, 2.5, and 2.6
- Tasks need to be completed sequentially before story can be approved
- Validation logic needs detailed specification for PropertySpec polymorphism
- Error handling patterns need structured approach for field-level validation

**Critical Dependencies:**
- Story 2.2: Frontmatter domain model for validation input
- Story 2.3: PropertySpec interface and concrete implementations for polymorphic validation
- Story 2.5: SchemaRegistry service for schema lookup
- Story 2.6: Schema inheritance resolution for validating against ResolvedProperties

**Critical Integration Points:**
- ValidationError types must integrate with shared errors package
- PropertySpec.Validate() method polymorphism from domain layer
- SchemaRegistry.Get() integration for schema lookup
- Context cancellation support throughout validation pipeline

**Recommendations:**
- Wait for all prerequisite stories (2.2-2.6) completion before implementing
- Complete Task 1-8 sequentially with focus on PropertySpec polymorphism
- Ensure comprehensive testing of all PropertySpec types and inheritance scenarios
- Design ValidationResult aggregation to handle multiple field errors effectively
