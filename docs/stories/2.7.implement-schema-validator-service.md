# Story 2.7: Implement Schema Validator Service

## Status: Draft

## Story

As a developer, I want to implement the SchemaValidator as a separate domain service, so that validation logic is decoupled from schema loading.

## Acceptance Criteria

**Functional Requirements:**

2.7.1: `internal/app/schema/` contains SchemaValidator implementing validation interface.
2.7.2: Service validates Frontmatter against Schema using PropertySpec polymorphism.
2.7.3: Validation checks Required fields, Array constraints, and type-specific PropertySpec rules.
2.7.4: Returns structured ValidationError types from `internal/shared/errors/`.

**Integration Requirements:**

2.7.5: SchemaValidator follows domain service patterns with proper dependency injection.
2.7.6: Service integrates with SchemaRegistry for schema lookup.
2.7.7: Validation supports context cancellation for long-running validations.

**Quality Requirements:**

2.7.8: Unit tests cover SchemaValidator behavior with mocked dependencies.
2.7.9: Code follows project coding standards and naming conventions.
2.7.10: Comprehensive error handling with structured validation errors.

## Tasks / Subtasks

- [ ] Task 1: Define SchemaValidator interface and service (AC: 2.7.1, 2.7.5)
  - [ ] Create `internal/app/schema/validator.go` with SchemaValidator service struct
  - [ ] Define interface for SchemaValidator if needed for dependency injection
  - [ ] Implement constructor accepting SchemaRegistry dependency
  - [ ] Follow domain service patterns with proper encapsulation

- [ ] Task 2: Implement frontmatter validation logic (AC: 2.7.2, 2.7.3, 2.7.7)
  - [ ] Implement Validate method accepting schemaName and Frontmatter
  - [ ] Look up schema from SchemaRegistry
  - [ ] Validate each property using PropertySpec polymorphism
  - [ ] Check Required fields and Array constraints
  - [ ] Support context cancellation for validation process

- [ ] Task 3: Implement structured error handling (AC: 2.7.4, 2.7.10)
  - [ ] Create ValidationError types in `internal/shared/errors/validation.go`
  - [ ] Implement field-level error reporting with property names and values
  - [ ] Use Result[T] pattern for functional error handling
  - [ ] Provide clear error messages for different validation failures

- [ ] Task 4: Integrate with SchemaRegistry (AC: 2.7.6)
  - [ ] Ensure SchemaValidator can access resolved schemas from SchemaRegistry
  - [ ] Handle cases where schema is not found
  - [ ] Support validation against resolved properties (post-inheritance)

- [ ] Task 5: Add comprehensive testing (AC: 2.7.8, 2.7.9)
  - [ ] Create `internal/app/schema/validator_test.go` with unit tests
  - [ ] Add tests with mocked SchemaRegistry and various frontmatter scenarios
  - [ ] Test validation of required fields, array constraints, and PropertySpec rules
  - [ ] Test error handling and structured error reporting
  - [ ] Ensure test coverage meets project standards (â‰¥85% for app layer)

## Dev Notes

**Previous Story Insights:**
- Stories 2.1-2.6 will implement Config, Schema/Property models, SchemaEnginePort, SchemaRegistry, and inheritance resolution providing foundation
- This story builds on PropertySpec implementations and SchemaRegistry
- Hexagonal architecture patterns established provide guidance for domain service implementation

**Data Models:**
- Frontmatter model with Fields map and FileClass for validation input
- Schema model with ResolvedProperties for validation rules
- Property model with PropertySpec interface for polymorphic validation

**API Specifications:**
- SchemaValidator interface with Validate method
- ValidationError types for structured error reporting
- Result[T] pattern for functional error handling

**Component Specifications:**
- SchemaValidator located in `internal/app/schema/validator.go`
- Follows domain service patterns with dependency injection
- Uses PropertySpec polymorphism for extensible validation

**File Locations:**
- Service implementation: `internal/app/schema/validator.go` (create new)
- Tests: `internal/app/schema/validator_test.go` (create new)
- Error types: `internal/shared/errors/validation.go` (create new)

**Testing Requirements:**
- Unit tests for SchemaValidator with mocked SchemaRegistry
- Tests for validation of various property types and constraints
- Error handling tests for different validation failure scenarios
- Integration tests with real schemas and frontmatter

**Technical Constraints:**
- Follow domain service principles: business logic in application layer
- Use dependency injection for SchemaRegistry access
- Implement Result[T] pattern from shared errors package
- Support context cancellation for validation operations
- Leverage PropertySpec interface for polymorphic validation

**Source References:**
- [Architecture: docs/architecture/components.md#schemalidatorservice]
- [Architecture: docs/architecture/data-models.md#frontmatter]
- [Architecture: docs/architecture/coding-standards.md#error-handling]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]

### Context Source
- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: Domain service implementation for frontmatter validation
- **Integration Points**: SchemaValidator used by VaultIndexer and TemplateEngine for validation
- **Goal**: Establish core domain service for schema-based frontmatter validation

### Technical Guidance

#### Existing System Context
- **Current State**: SchemaRegistry loads schemas, Property models define validation rules
- **Technology Stack**: Go 1.23+ with domain service patterns, PropertySpec polymorphism
- **Integration Points**: SchemaValidator validates frontmatter during indexing and template generation
- **Architecture Pattern**: Domain service using Result[T] pattern for functional error handling

#### Integration Approach
- **Domain Service**: Implement as pure business logic service in application layer
- **Dependency Injection**: Accept SchemaRegistry dependency via constructor
- **Polymorphic Validation**: Use PropertySpec interface for type-specific validation
- **Structured Errors**: Return ValidationError types with field-level details

#### Technical Constraints
- **Application Layer**: SchemaValidator belongs in `internal/app/schema/` as domain service
- **Result Pattern**: Use `internal/shared/errors` Result[T] for error handling
- **Context Support**: All public methods must accept context.Context for cancellation
- **Polymorphism**: Leverage PropertySpec interface for extensible validation

#### Key Files to Modify/Create
- `internal/app/schema/validator.go` - **CREATE** - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - **CREATE** - Unit tests for SchemaValidator
- `internal/shared/errors/validation.go` - **CREATE** - ValidationError types

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data
- **Validation Tests**: Test various validation scenarios and error conditions
- **Integration Tests**: Test end-to-end validation with real schemas

### Definition of Done
- [ ] SchemaValidator service implemented in `internal/app/schema/` following domain service patterns
- [ ] Service validates Frontmatter against Schema using PropertySpec polymorphism
- [ ] Validation checks Required fields, Array constraints, and type-specific rules
- [ ] Returns structured ValidationError types with field-level details
- [ ] Integrates with SchemaRegistry for schema lookup
- [ ] Supports context cancellation for validation operations
- [ ] Unit tests pass with adequate coverage for all validation scenarios
- [ ] Code follows project coding standards and naming conventions

### Risk Assessment

#### Implementation Risks
- **Primary Risk**: Complex PropertySpec polymorphism may introduce validation bugs
- **Mitigation**: Implement incrementally with comprehensive unit tests
- **Verification**: Test validation with various property types and constraints

#### Rollback Plan
- **Git Rollback**: Revert to previous commit if validation logic fails
- **File Removal**: Delete new validator files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

### Testing

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data
- **Validation Tests**: Test various validation scenarios and error conditions
- **Integration Tests**: Test end-to-end validation with real schemas

#### Testing Standards
- Follow testing patterns from `docs/architecture/testing-strategy.md`
- Unit tests co-located with implementation files
- Use table-driven tests for multiple validation scenarios
- Test both success and failure cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story draft for Schema Validator service implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- SchemaValidator service patterns from components.md
- Validation logic requirements from data-models.md
- Error handling patterns from shared errors package

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- SchemaValidator service requirements extracted from components.md
- Validation logic and error handling requirements included
- Testing strategy aligned with project standards

### File List

**Files to Create/Modify:**
- `internal/app/schema/validator.go` - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - Unit tests for SchemaValidator
- `internal/shared/errors/validation.go` - ValidationError types
