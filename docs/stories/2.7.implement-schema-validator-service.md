# Story 2.7: Implement Schema Validator Service

## Status

Approved

## Story

As a developer, I want to implement the SchemaValidator as a separate domain service, so that validation logic is decoupled from schema loading and moved from domain models to the application layer.

## Acceptance Criteria

**Functional Requirements:**

2.7.1: `internal/app/schema/` contains SchemaValidator implementing validation interface.
2.7.2: Service validates Frontmatter against Schema using PropertySpec polymorphism.
2.7.3: Validation checks Required fields, Array constraints, and type-specific PropertySpec rules.
2.7.4: Returns structured ValidationError types from `internal/shared/errors/`.
2.7.5: **ARCHITECTURAL**: All validation methods extracted from domain models (Property.Validate(), Schema.Validate(), PropertySpec validation) and moved to SchemaValidator service.

**Integration Requirements:**

2.7.6: SchemaValidator follows domain service patterns with proper dependency injection.
2.7.7: Service integrates with SchemaRegistry for schema lookup.
2.7.8: Validation supports context cancellation for long-running validations.

**Quality Requirements:**

2.7.9: Unit tests cover SchemaValidator behavior with mocked dependencies.
2.7.10: Code follows project coding standards and naming conventions.
2.7.11: Comprehensive error handling with structured validation errors.

## Tasks / Subtasks

- [ ] Task 1: Define SchemaValidator interface and service (AC: 2.7.1, 2.7.6)
  - [ ] Create `internal/app/schema/validator.go` with SchemaValidator service struct
  - [ ] Define SchemaValidatorPort interface in `internal/ports/api/schema.go` for dependency injection
  - [ ] Implement constructor accepting SchemaRegistry dependency
  - [ ] Follow domain service patterns with proper encapsulation
  - [ ] Ensure service consumes resolved domain schemas from SchemaRegistry (no JSON parsing in validator)

- [ ] Task 2: Implement frontmatter validation logic (AC: 2.7.2, 2.7.3, 2.7.8)
  - [ ] Implement Validate(ctx context.Context, schemaName string, frontmatter Frontmatter) Result[ValidationResult] method
  - [ ] Look up schema from SchemaRegistry.Get(schemaName) with error handling for missing schemas
  - [ ] Validate each frontmatter field against schema ResolvedProperties (post-inheritance)
  - [ ] Use PropertySpec polymorphism for type-specific validation (StringPropertySpec, NumberPropertySpec, etc.)
  - [ ] Check Required fields constraints (field must exist in frontmatter.Fields)
  - [ ] Check Array constraints (if Array=true, value must be slice; if Array=false, value must be scalar)
  - [ ] Support context cancellation for validation process with periodic context.Done() checks
  - [ ] Validate against schema.ResolvedProperties (not Properties) to include inheritance
  - [ ] Add context cancellation checks in validation loops for responsiveness

- [ ] Task 3: Implement structured error handling (AC: 2.7.4, 2.7.11)
  - [ ] Create ValidationError types in `internal/shared/errors/validation.go` per Result[T] pattern:
    - FieldValidationError (field name, expected type, actual value, constraint violated)
    - RequiredFieldError (missing required field name)
    - ArrayConstraintError (field name, expected array/scalar, actual type)
    - PropertySpecError (field name, PropertySpec-specific error)
  - [ ] Implement field-level error reporting with property names and values
  - [ ] Use Result[T] pattern from `internal/shared/errors` for functional error handling across all validation methods
  - [ ] Provide clear error messages for different validation failures with remediation hints
  - [ ] Aggregate multiple field errors into single ValidationResult with detailed context

- [ ] Task 4: Integrate with SchemaRegistry (AC: 2.7.7)
  - [ ] Ensure SchemaValidator uses SchemaRegistry.Get() for schema lookup
  - [ ] Handle cases where schema is not found with SchemaNotFoundError per components.md
  - [ ] Support validation against schema.ResolvedProperties (post-inheritance resolution from Story 2.6)
  - [ ] Validate frontmatter.FileClass matches schemaName parameter
  - [ ] Handle PropertyBank references that may be in ResolvedProperties per data-models.md

- [ ] Task 5: Add comprehensive testing (AC: 2.7.9, 2.7.10)
  - [ ] Create `internal/app/schema/validator_test.go` with unit tests
  - [ ] Add tests with mocked SchemaRegistry and various frontmatter scenarios
  - [ ] Test validation scenarios for each PropertySpec type:
    - StringPropertySpec: enum validation, pattern matching, edge cases
    - NumberPropertySpec: min/max bounds, step validation, type checking
    - DatePropertySpec: format validation with Go time layouts
    - FilePropertySpec: fileClass/directory constraints (if applicable)
    - BoolPropertySpec: type checking
  - [ ] Test Required field validation (missing fields, optional fields)
  - [ ] Test Array constraint validation (scalar vs array values)
  - [ ] Test inheritance validation using schema.ResolvedProperties
  - [ ] Test error handling: schema not found, malformed frontmatter, validation failures
  - [ ] Test Result[T] pattern and structured error reporting
  - [ ] Test context cancellation scenarios with various timeout durations
  - [ ] Test PropertySpec polymorphism edge cases and error handling
  - [ ] Ensure test coverage meets project standards (â‰¥95% for internal/app per testing-strategy.md)

- [ ] Task 6: Extract validation methods from domain models (AC: 2.7.5)
  - [ ] Move `Property.Validate()` logic to `SchemaValidator.ValidateProperty()`
  - [ ] Move `Schema.Validate()` logic to `SchemaValidator.ValidateSchema()`
  - [ ] Move PropertySpec validation orchestration to SchemaValidator
  - [ ] Remove validation methods from domain models, keeping only data structures
  - [ ] Update all callers to use SchemaValidator service instead of model methods
  - [ ] Verify all existing tests pass after validation method extraction

- [ ] Task 7: Decompose functions for SRP compliance
  - [ ] Break larger validation routines into focused private helpers:
    - validateRequiredFields() helper
    - validateArrayConstraints() helper
    - validatePropertySpec() helper for PropertySpec polymorphism
    - aggregateValidationErrors() helper
  - [ ] Keep public APIs unchanged while improving internal structure
  - [ ] Re-run the validator test suite to verify all acceptance criteria remain satisfied

- [ ] Task 8: Enforce linting and formatting workflow
  - [ ] Run `golangci-lint fmt`
  - [ ] Run `golangci-lint run --fix`, rectifying warnings without `//nolint` unless unavoidable
  - [ ] After each fix, rerun `golangci-lint fmt` and execute tests to ensure they pass

- [ ] Task 9: Pre-commit and commit readiness
  - [ ] Execute `pre-commit` to confirm hooks pass
  - [ ] Stage updates and commit with a full conventional commit message summarizing validator changes

## Dev Notes

**Previous Story Insights:**
- Stories 2.1-2.6 will implement Config, Schema/Property models, SchemaLoaderPort, SchemaRegistry, and inheritance resolution providing foundation
- This story builds on PropertySpec implementations and SchemaRegistry
- Hexagonal architecture patterns established provide guidance for domain service implementation

**Data Models:**
- Frontmatter model with Fields map and FileClass for validation input [Source: docs/architecture/data-models.md#frontmatter]
- Schema model with ResolvedProperties for validation rules [Source: docs/architecture/data-models.md#schema]
- Property model with PropertySpec interface for polymorphic validation [Source: docs/architecture/data-models.md#property]

**API Specifications:**
- SchemaValidator interface with Validate method [Source: docs/architecture/components.md#schemavalidator]
- ValidationError types for structured error reporting [Source: docs/architecture/coding-standards.md#error-handling]
- Result[T] pattern for functional error handling [Source: internal/shared/errors package]

**Component Specifications:**
- SchemaValidator located in `internal/app/schema/validator.go` [Source: docs/architecture/components.md#domain-services]
- Follows domain service patterns with dependency injection [Source: docs/architecture/components.md#schemavalidator]
- Uses PropertySpec polymorphism for extensible validation [Source: docs/architecture/data-models.md#propertyspec]

**File Locations:**
- Service implementation: `internal/app/schema/validator.go` (create new)
- Tests: `internal/app/schema/validator_test.go` (create new)
- Error types: `internal/shared/errors/validation.go` (create new)

**Testing Requirements:**
- Unit tests for SchemaValidator with mocked SchemaRegistry
- Tests for validation of various property types and constraints
- Error handling tests for different validation failure scenarios
- Integration tests with real schemas and frontmatter

**Technical Constraints:**
- Follow domain service principles: business logic in application layer [Source: docs/architecture/components.md#domain-services]
- Use dependency injection for SchemaRegistry access [Source: docs/architecture/components.md#schemavalidator]
- Implement Result[T] pattern from shared errors package [Source: docs/architecture/coding-standards.md#error-handling]
- Support context cancellation for validation operations [Source: docs/architecture/coding-standards.md#core-standards]
- Leverage PropertySpec interface for polymorphic validation [Source: docs/architecture/data-models.md#propertyspec]

**PropertySpec Implementation Details:**
- StringPropertySpec: Supports enum validation, pattern matching (regex), min/max length constraints
- NumberPropertySpec: Supports min/max bounds, step validation, integer vs float type checking
- DatePropertySpec: Supports Go time layout format validation (RFC3339, custom formats)
- FilePropertySpec: Supports fileClass/directory constraints for file references
- BoolPropertySpec: Supports type checking and validation

**Result[T] Pattern Usage:**
- All validation methods return Result[ValidationResult] not (ValidationResult, error)
- Use errors.Ok[ValidationResult](result) for success cases
- Use errors.Err[ValidationResult](validationError) for failure cases
- Chain validation operations using Result[T].AndThen() methods

**ValidationError Type Structure:**
- Base ValidationError interface with Error() string and Field() string methods
- FieldValidationError: field name, expected type, actual value, constraint violated
- RequiredFieldError: missing required field name with helpful message
- ArrayConstraintError: field name, expected array/scalar, actual type received
- PropertySpecError: field name, PropertySpec-specific error with context

**Source References:**
- [Architecture: docs/architecture/components.md#schemavalidator]
- [Architecture: docs/architecture/data-models.md#frontmatter]
- [Architecture: docs/architecture/coding-standards.md#error-handling]
- [Architecture: docs/architecture/testing-strategy.md#unit-tests]

### Context Source
- **Source**: Epic 2 - Configuration & Schema Loading
- **Enhancement Type**: Domain service implementation for frontmatter validation with architectural refactoring
- **Integration Points**: SchemaValidator used by VaultIndexer and TemplateEngine for validation
- **Goal**: Establish core domain service for schema-based frontmatter validation and extract validation logic from domain models

### Architectural Refactoring
**CRITICAL**: This story will extract all validation methods currently embedded in domain models and move them to the SchemaValidator service:

- `Property.Validate()` â†’ `SchemaValidator.ValidateProperty()`
- `Schema.Validate()` â†’ `SchemaValidator.ValidateSchema()`
- PropertySpec validation methods â†’ `SchemaValidator` orchestration
- Domain models become pure data structures, validation becomes application layer business logic

This resolves the architectural inconsistency where validation methods were incorrectly placed in the domain layer instead of the application layer as defined in `docs/architecture/components.md`.

### Technical Guidance

#### Existing System Context
- **Current State**: SchemaRegistry loads schemas, Property models define validation rules
- **Technology Stack**: Go 1.23+ with domain service patterns, PropertySpec polymorphism
- **Integration Points**: SchemaValidator validates frontmatter during indexing and template generation
- **Architecture Pattern**: Domain service using Result[T] pattern for functional error handling

#### Integration Approach
- **Domain Service**: Implement as pure business logic service in application layer
- **Dependency Injection**: Accept SchemaRegistry dependency via constructor
- **Polymorphic Validation**: Use PropertySpec interface for type-specific validation
- **Structured Errors**: Return ValidationError types with field-level details

#### Technical Constraints
- **Application Layer**: SchemaValidator belongs in `internal/app/schema/` as domain service
- **Result Pattern**: Use `internal/shared/errors` Result[T] for error handling
- **Context Support**: All public methods must accept context.Context for cancellation
- **Polymorphism**: Leverage PropertySpec interface for extensible validation

#### Key Files to Modify/Create
- `internal/app/schema/validator.go` - **CREATE** - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - **CREATE** - Unit tests for SchemaValidator
- `internal/shared/errors/validation.go` - **CREATE** - ValidationError types

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data [Source: docs/architecture/testing-strategy.md#unit-tests]
- **Validation Tests**: Test various validation scenarios and error conditions including PropertySpec polymorphism edge cases
- **Integration Tests**: Test end-to-end validation with real schemas and inheritance resolution
- **Context Cancellation Tests**: Test validation behavior with various timeout scenarios (immediate cancellation, mid-validation cancellation, long-running operations)

### Definition of Done

- [ ] SchemaValidator service implemented in `internal/app/schema/` following domain service patterns
- [ ] SchemaValidatorPort interface defined for dependency injection
- [ ] Service validates Frontmatter against Schema.ResolvedProperties using PropertySpec polymorphism
- [ ] Validation checks Required fields, Array constraints, and type-specific PropertySpec rules
- [ ] Returns Result[ValidationResult] with structured ValidationError types for field-level details
- [ ] Integrates with SchemaRegistry for schema lookup with proper error handling
- [ ] Supports context cancellation for validation operations
- [ ] Validates against post-inheritance ResolvedProperties (includes property bank references)
- [ ] Structured error types defined: FieldValidationError, RequiredFieldError, ArrayConstraintError, PropertySpecError
- [ ] Clear error messages with remediation hints for different validation failures
- [ ] **ARCHITECTURAL**: All validation methods extracted from domain models and moved to SchemaValidator service
- [ ] Domain models (Property, Schema) become pure data structures without validation methods
- [ ] All callers updated to use SchemaValidator service instead of model methods
- [ ] Unit tests pass with â‰¥85% coverage for all validation scenarios including inheritance
- [ ] Code follows project coding standards and naming conventions
- [ ] Private helper functions for validation concerns follow SRP

### Risk Assessment

#### Implementation Risks
- **Primary Risk**: Complex PropertySpec polymorphism may introduce validation bugs
- **Mitigation**: Implement incrementally with comprehensive unit tests
- **Verification**: Test validation with various property types and constraints

#### Rollback Plan
- **Git Rollback**: Revert to previous commit if validation logic fails
- **File Removal**: Delete new validator files if integration issues arise
- **Testing Verification**: Run full test suite to ensure no regressions

### Testing

#### Testing Strategy
- **Unit Tests**: Test SchemaValidator with mocked SchemaRegistry and frontmatter data
- **Validation Tests**: Test various validation scenarios and error conditions
- **Integration Tests**: Test end-to-end validation with real schemas

#### Testing Standards
- Follow testing patterns from `docs/architecture/testing-strategy.md` [Source: docs/architecture/testing-strategy.md#unit-tests]
- Unit tests co-located with implementation files (â‰¥95% coverage for internal/app)
- Use table-driven tests for multiple validation scenarios and PropertySpec types
- Test both success and failure cases including edge cases and error conditions
- Mock SchemaRegistry using tests/utils/mocks.go patterns
- Test context cancellation scenarios with configurable timeouts

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.2 | Fixed validation issues: corrected AC numbering, updated source references, reordered tasks, enhanced technical details, added context cancellation testing | po |
| 2025-10-21 | 1.1 | Added explicit architectural refactoring requirements - validation methods moved from domain models to service | po |
| 2025-10-20 | 1.0 | Initial story draft for Schema Validator service implementation | sm |

## Dev Agent Record

### Agent Model Used

sm (Scrum Master)

### Debug Log References

- SchemaValidator service patterns from components.md
- Validation logic requirements from data-models.md
- Error handling patterns from shared errors package

### Completion Notes List

- Story created with comprehensive technical context from architecture documents
- SchemaValidator service requirements extracted from components.md
- Validation logic and error handling requirements included
- Testing strategy aligned with project standards
- **ARCHITECTURAL**: Added explicit requirements for extracting validation methods from domain models to resolve architectural inconsistency
- **VALIDATION FIXES**: Fixed duplicate AC numbering (2.7.5), corrected source references, reordered Task 6 after implementation tasks
- **ENHANCED TECHNICAL DETAILS**: Added PropertySpec implementation details, Result[T] pattern usage, ValidationError structure specifications
- **IMPROVED TESTING**: Enhanced context cancellation testing, clarified coverage requirements (â‰¥95% for internal/app), added edge case scenarios

### File List

**Files to Create/Modify:**
- `internal/app/schema/validator.go` - SchemaValidator service implementation
- `internal/app/schema/validator_test.go` - Unit tests for SchemaValidator
- `internal/shared/errors/validation.go` - ValidationError types
- `internal/ports/api/schema.go` - SchemaValidatorPort interface (update existing)

## QA Results

### Pre-Implementation Review

**Status**: Story ready for implementation after validation fixes applied

**Previous Issues Resolved:**
- âœ… **FIXED**: Duplicate AC numbering (2.7.5) - renumbered ACs 2.7.6-2.7.11
- âœ… **FIXED**: Invalid source references corrected to match architecture documents
- âœ… **FIXED**: Task sequence reordered - validation extraction (Task 6) moved after implementation (Tasks 2-3)
- âœ… **ENHANCED**: Technical details added for PropertySpec polymorphism, Result[T] pattern, ValidationError structures
- âœ… **ENHANCED**: Context cancellation testing scenarios detailed
- âœ… **CLARIFIED**: Test coverage requirements (â‰¥95% for internal/app per testing-strategy.md)

**Current Dependencies:**
- Story 2.2: Frontmatter domain model for validation input
- Story 2.3: PropertySpec interface and concrete implementations for polymorphic validation
- Story 2.5: SchemaRegistry service for schema lookup
- Story 2.6: Schema inheritance resolution for validating against ResolvedProperties

**Critical Integration Points:**
- ValidationError types must integrate with shared errors package [Source: docs/architecture/coding-standards.md#error-handling]
- PropertySpec polymorphism for validation [Source: docs/architecture/data-models.md#propertyspec]
- SchemaRegistry.Get() integration for schema lookup [Source: docs/architecture/components.md#schemavalidator]
- Context cancellation support throughout validation pipeline [Source: docs/architecture/coding-standards.md#core-standards]

**Implementation Guidance:**
- Complete Tasks 1-9 sequentially with focus on PropertySpec polymorphism edge cases
- Ensure comprehensive testing of all PropertySpec types and inheritance scenarios
- Design ValidationResult aggregation to handle multiple field errors effectively
- **ARCHITECTURAL**: Plan for significant refactoring - validation methods will be moved from domain models to service layer (Task 6)
- Implement validation extraction incrementally to minimize risk
- Use table-driven tests for comprehensive scenario coverage

### Validation Fixes Applied (Version 1.2)

**Critical Issues Resolved:**
- Fixed duplicate AC 2.7.5 by renumbering integration and quality requirements
- Corrected source references to match actual architecture document structure
- Reordered Task 6 (validation extraction) to execute after implementation tasks complete

**Enhanced Technical Specifications:**
- Added detailed PropertySpec implementation guidance with specific constraints
- Clarified Result[T] pattern usage with example method signatures
- Specified ValidationError type structure with field-level details
- Enhanced context cancellation testing with timeout scenarios

**Quality Improvements:**
- Clarified test coverage requirements (â‰¥95% for internal/app per testing-strategy.md)
- Added PropertySpec polymorphism edge case testing guidance
- Enhanced source citations throughout Dev Notes section
- Improved task sequencing for safer implementation approach
