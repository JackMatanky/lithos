<%*
//-------------------------------------------------------------------
// GLOBAL FOLDER PATH VARIABLES
//-------------------------------------------------------------------
const cal_day_dir = "10_calendar/11_days/";
const cal_week_dir = "10_calendar/12_weeks/";
const cal_month_dir = "10_calendar/13_months/";
const cal_quarter_dir = "10_calendar/14_quarters/";
const cal_year_dir = "10_calendar/15_years/";
const goals_dir = "30_goals/";
const value_goals_dir = "30_goals/31_value_goals/";
const outcome_goals_dir = "30_goals/31_outcome_goals/";
const personal_proj_dir = "41_personal/";
const habit_ritual_proj_dir = "45_habit_ritual/";
const education_proj_dir = "42_education/";
const professional_proj_dir = "43_professional/";
const work_proj_dir = "44_work/";
const contacts_dir = "51_contacts/";
const organizations_dir = "52_organizations/";

/* ---------------------------------------------------------- */
/*                    FORMATTING CHARACTERS                   */
/* ---------------------------------------------------------- */
//Characters
const new_line = String.fromCodePoint(0xa);
const two_new_line = new_line.repeat(2);
const space = String.fromCodePoint(0x20);
const two_space = space.repeat(2);
const hash = String.fromCodePoint(0x23);
const hyphen = String.fromCodePoint(0x2d);
const two_hyphen = hyphen.repeat(2);
const hr_line = hyphen.repeat(3);
const backtick = String.fromCodePoint(0x60);
const three_backtick = backtick.repeat(3);
const colon = String.fromCodePoint(0x3a);
const two_percent = String.fromCodePoint(0x25).repeat(2);
const less_than = String.fromCodePoint(0x3c);
const great_than = String.fromCodePoint(0x3e);
const excl = String.fromCodePoint(0x21);

//Text Formatting
const head_lvl = (int) => `${hash.repeat(int)}${space}`;
const yaml_li = (value) => `${new_line}${ul_yaml}"${value}"`;
const link_alias = (file, alias) => ["[[" + file, alias + "]]"].join("|");
const link_tbl_alias = (file, alias) => ["[[" + file, alias + "]]"].join("\\|");
const cmnt_ob_start = `${two_percent}${space}`;
const cmnt_ob_end = `${space}${two_percent}`;
const cmnt_html_start = `${less_than}${excl}${two_hyphen}${space}`;
const cmnt_html_end = `${space}${two_hyphen}${great_than}`;
const tbl_start = `${String.fromCodePoint(0x7c)}${space}`;
const tbl_pipe = `${space}${String.fromCodePoint(0x7c)}${space}`;
const tbl_end = `${space}${String.fromCodePoint(0x7c)}`;
const tbl_left = `${colon}${hyphen.repeat(8)}${space}`;
const tbl_right = `${space}${hyphen.repeat(8)}${colon}`;
const tbl_cent = `${colon}${hyphen.repeat(8)}${colon}`;
const ul = `${hyphen}${space}`;
const ul_yaml = `${space.repeat(2)}${ul}`;
const checkbox = `${ul}[${space}]${space}`;
const call_start = `${great_than}${space}`;
const call_ul = `${call_start}${ul}`;
const call_ul_indent = `${call_start}${space.repeat(4)}${ul}`;
const call_check = `${call_start}${checkbox}`;
const call_check_indent = `${call_start}${space.repeat(4)}${checkbox}`;
const call_tbl_start = `${call_start}${tbl_start}`;
const call_tbl_end = `${tbl_end}${two_space}`;
const dv_colon = `${colon.repeat(2)}${space}`;

//-------------------------------------------------------------------
// FORMATTING FUNCTIONS
//-------------------------------------------------------------------
const snake_case_fmt = (name) =>
  name.replaceAll(/(\-\s\-)|(\s)|(\-)]/g, "_").toLowerCase();

//-------------------------------------------------------------------
// SET THE FILE'S CREATION AND MODIFIED DATE
//-------------------------------------------------------------------
const date_created = moment().format("YYYY-MM-DD[T]HH:mm");
const date_modified = moment().format("YYYY-MM-DD[T]HH:mm");

//-------------------------------------------------------------------
// SET THE DATE, TYPE, AND FILE CLASS
//-------------------------------------------------------------------
const nl_date = await tp.user.nl_date(tp);
const type = "day";
const file_class = "cal_" + type;

//-------------------------------------------------------------------
// SET THE FILE'S TITLE
//-------------------------------------------------------------------
// Check if note already has title
const has_title = !tp.file.title.startsWith("Untitled");
let title;
let full_title;
let short_title;

// If note does not have title,
// prompt for title and rename file
if (!has_title) {
  title = moment(nl_date).format("YYYY-MM-DD");
  full_title = moment(nl_date).format("dddd, MMMM Do YYYY");
  short_title = moment(nl_date).format("YY-M-D");
  await tp.file.rename(title);
} else {
  title = tp.file.title;
  full_title = moment(nl_date).format("dddd, MMMM Do YYYY");
  short_title = moment(nl_date).format("YY-M-D");
}

const alias = [full_title, short_title];

//-------------------------------------------------------------------
// SET THE DATE VARIABLES
//-------------------------------------------------------------------
const date = moment(nl_date).format("YYYY-MM-DD");
const weekday = moment(nl_date).format("dddd");
const year = moment(nl_date).format("YYYY");
const quarter = moment(nl_date).format("Q");
const month_name = moment(nl_date).format("MMMM");
const month_number = moment(nl_date).format("MM");
const week_number = moment(nl_date).format("ww");
const year_day = moment(nl_date).format("DDDD");
const month_day = moment(nl_date).format("DD");
const prev_date = moment(nl_date).subtract(1, "days").format("YYYY-MM-DD");
const next_date = moment(nl_date).add(1, "days").format("YYYY-MM-DD");
const two_weeks = moment(nl_date).add(14, "days").format("YYYY-MM-DD");

//-------------------------------------------------------------------
// MOVE TO DAY CALENDAR DIRECTORY
//-------------------------------------------------------------------
const folder = tp.file.folder();

if (folder!= "31_days") {
  await tp.file.move(cal_day_dir + title);
}

//-------------------------------------------------------------------
// PAGE CONTENT
//-------------------------------------------------------------------
// Metadata
tR += "---" + "\n" +
"title: " + title + "\n" +
"aliases: " + alias + "\n" +
"date: " + date + "\n" +
"weekday: " + weekday + "\n" +
"year: " + year + "\n" +
"quarter: " + quarter + "\n" +
"month_name: " + month_name + "\n" +
"month_number: " + month_number + "\n" +
"week_number: " + week_number + "\n" +
"year_day: " + year_day + "\n" +
"month_day: " + month_day + "\n" +
"type: " + type + "\n" +
"file_class: " + file_class + "\n" +
"date_created: " + date_created + "\n" +
"date_modified: " + date_modified + "\n" +
"---" +
"\n" +
"# " + full_title + "\n" +
"\n"
%>

<< [[<%* tR += prev_date %>]] | [[<%* tR += next_date %>]] >>

---

# Journal

- [ ] Daily Reflection
	- [[80_insight/95_journals/<%* tR += date %> daily_reflection |Daily Reflection]]
- [ ] Gratitude Journal
	- [[80_insight/95_journals/<%* tR += date %> gratitude |Daily Gratitude]]

# Tasks

## Due Today

```tasks
not done
due on <%* tR += date %>
path does not include 00_system
```

## Completed Today

```dataview
TABLE WITHOUT ID
	regexreplace(regexreplace(T.text, "(#task)|\[.*$", ""), "(_action_item)|(_meeting)|(_habit)|(_morning_ritual)|(_workday_startup_ritual)|(_workday_shutdown_ritual)|(_evening_ritual)", "") AS Task,
	regexreplace(regexreplace(T.text, "(#task)|\[.*$", ""), "^[A-Za-z0-9\'\-\s]*_", "") AS Type,
	T.completion AS Completed,
	T.time_start AS Start,
	T.time_end AS End,
	T.duration_est AS Estimate,
	(date(dateformat(T.completion, "yyyy-MM-dd") + "T" + T.time_end) -
	date(dateformat(T.completion, "yyyy-MM-dd") + "T" + T.time_start)) AS Duration,
	T.section AS Link
FROM -"00_system/05_templates" AND #task
FLATTEN file.tasks AS T
WHERE any(file.tasks, (t) => t.completion = date(<%* tR += date %>))
SORT T.time_start ASC
```

## Overdue

```tasks
not done
due before <%* tR += date %>
path does not include 00_system
```

## No Due Date

```tasks
not done
no due date
path does not include 0_system
```

---

# Created Today

## Tasks and Events

```dataview
TABLE WITHOUT ID
	regexreplace(regexreplace(T.text, "(#task)|\[.*$", ""), "(_action_item)|(_meeting)|(_habit)|(_morning_ritual)|(_workday_startup_ritual)|(_workday_shutdown_ritual)|(_evening_ritual)", "") AS Task,
	regexreplace(regexreplace(T.text, "(#task)|\[.*$", ""), "^[A-Za-z0-9\'\s]*_", "") AS Type,
	T.due AS Due,
	(date(dateformat(T.completion, "yyyy-MM-dd") + "T" + T.time_end) -
	date(dateformat(T.completion, "yyyy-MM-dd") + "T" + T.time_start)) AS Duration,
	T.section AS Link
FROM -"00_system/05_templates" AND #task
FLATTEN file.tasks AS T
WHERE any(file.tasks, (t) => t.created = date(<%* tR += date %>))
SORT T.time_start ASC
```

## Journal Entries

```dataview
LIST
	rows.file.link
FROM -"00_system/05_templates"
WHERE (file.cday = date(2023-04-25))
	AND (file.frontmatter.date_created = "<%* tR += date %>")
	AND (file.frontmatter.file_class = "pdev_journal")
GROUP BY file.frontmatter.file_class
```

## Knowledge

```dataview
LIST
	rows.file.link
FROM -"00_system/05_templates"
WHERE (file.cday = date(2023-04-25))
	AND (file.frontmatter.date_created = "<%* tR += date %>")
	AND (file.frontmatter.file_class != "cal_day")
	AND (file.frontmatter.file_class != "pdev_journal")
	AND (file.frontmatter.file_class != "task_action_item")
	AND (file.frontmatter.file_class != "task_meeting")
GROUP BY file.frontmatter.file_class
```

%>
