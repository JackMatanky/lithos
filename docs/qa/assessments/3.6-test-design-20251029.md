# Test Design: Story 3.6 - VaultIndexer Service

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.6 - VaultIndexer Service
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 15
- **Unit tests:** 15 (100%)
- **Priority distribution:** P0: 11, P1: 4

**Rationale:** VaultIndexer orchestrates multiple dependencies. Tests use fakes for VaultReaderPort, FrontmatterService, CacheWriterPort, QueryService, and Logger. Coverage verifies call ordering, stats tracking, failure handling, and logging.

---

## Test Scenarios by Acceptance Criteria

### Build Workflow (AC 1)

| ID           | Level | Priority | Test Description                                                     | Justification                                 |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | --------------------------------------------- |
| 3.6-UNIT-001 | Unit  | P0       | Build invokes VaultReader.ScanAll once                               | Ensures start of pipeline                      |
| 3.6-UNIT-002 | Unit  | P0       | Build filters to `.md` files before extraction                       | Data scope control                             |
| 3.6-UNIT-003 | Unit  | P0       | Build calls FrontmatterService.Extract and Validate per file         | Core orchestration                             |
| 3.6-UNIT-004 | Unit  | P0       | Build constructs Note objects with IDs and content                   | Ensures note creation                           |
| 3.6-UNIT-005 | Unit  | P0       | Build persists notes via CacheWriterPort.Persist                     | Cache consistency                              |
| 3.6-UNIT-006 | Unit  | P0       | Build updates QueryService indices via AddNote                       | Index consistency                              |
| 3.6-UNIT-007 | Unit  | P0       | Build logs summary metrics with IndexStats                           | Observability                                  |

### Error Handling & FR9 (AC 2-3)

| ID           | Level | Priority | Test Description                                                     | Justification                                 |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | --------------------------------------------- |
| 3.6-UNIT-008 | Unit  | P0       | Validation failure increments stats and continues processing         | FR9 tolerant processing                         |
| 3.6-UNIT-009 | Unit  | P0       | Cache write failure increments stats, logs warning, continues        | Non-fatal cache errors                          |
| 3.6-UNIT-010 | Unit  | P1       | QueryService failure aborts build if architecture requires           | Clarifies fail-fast boundary                    |
| 3.6-UNIT-011 | Unit  | P1       | IndexStats captures scanned/indexed/failed counts accurately         | Stats accuracy                                  |

### Concurrency & Performance Hooks (AC 2)

| ID           | Level | Priority | Test Description                                                     | Justification                                 |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | --------------------------------------------- |
| 3.6-UNIT-012 | Unit  | P1       | Build records total duration using monotonic clock                   | NFR3 metrics                                    |

### Tooling & Fakes

| ID           | Level | Priority | Test Description                                                     | Justification                                 |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | --------------------------------------------- |
| 3.6-UNIT-013 | Unit  | P0       | Test harness provides fakes for dependencies capturing call order    | Ensures deterministic assertions                |
| 3.6-UNIT-014 | Unit  | P0       | `go test ./internal/app/vault` passes with coverage                  | Test gate                                       |
| 3.6-UNIT-015 | Unit  | P0       | `golangci-lint run ./internal/app/vault` clean                       | Lint gate                                       |

---

## Test Scenario Details

- Stage order verified via fake recording slice (ScanAll → Extract/Validate → Cache → Query).
- For validation failures, fake returns error for one file; ensure build continues and stats reflect failure.
- Cache failure scenario: Persist returns error; expect warning log and stats increment but continue indexing.
- QueryService AddNote failure should abort (confirm architecture expectation) and produce error result.
- Stats struct should match counts; tests assert fields and total duration > 0.

---

## Risk Coverage

- **RISK-INDEXER-001:** Pipeline stops on recoverable errors → Mitigated by 3.6-UNIT-008/009.
- **RISK-INDEXER-002:** Stats inaccurate → Mitigated by 3.6-UNIT-011/012.
- **RISK-INDEXER-003:** Missing dependency calls → Mitigated by 3.6-UNIT-001/002/003/005/006.
- **RISK-INDEXER-004:** Lack of observability → Mitigated by 3.6-UNIT-007/012.

---

## Test Execution Order

1. Setup fakes (013).
2. Happy path (001-007).
3. Failure scenarios (008-010).
4. Stats/duration checks (011-012).
5. Tooling commands (014-015).

---

## Quality Gates

- ✅ All 11 P0 scenarios passing.
- ✅ Lint and unit tests succeed.
- ✅ Logs confirm stage metrics.

---

## Summary

This test plan validates VaultIndexer’s orchestration, ensuring resilient indexing, accurate stats, and observability before CLI and services depend on it.
