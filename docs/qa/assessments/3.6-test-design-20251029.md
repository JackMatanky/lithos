# Test Design: Story 3.6 - QueryService

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.6 - QueryService
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 9
- **Unit tests:** 9 (100%)
- **Priority distribution:** P0: 6, P1: 3

**Rationale:** QueryService provides efficient lookups for indexed notes. Tests use fakes for CacheReaderPort and Logger. Coverage verifies index population, query methods, cache refresh, concurrent access, and error handling. ByFrontmatter testing deferred to Story 3.8.

---

## Test Scenarios by Acceptance Criteria

### Index Population & Structure (AC 1)

| ID           | Level | Priority | Test Description                                                     | Justification                                         |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ----------------------------------------------------- |
| 3.6-UNIT-001 | Unit  | P0       | QueryService struct has all required indices (byID, byPath, etc.)    | Data structure integrity                              |
| 3.6-UNIT-002 | Unit  | P0       | RefreshFromCache populates all indices from CacheReaderPort          | Index initialization                                  |
| 3.6-UNIT-003 | Unit  | P0       | Indices use sync.RWMutex for concurrent access                       | Thread safety                                         |

### Query Methods (AC 1, 2)

| ID           | Level | Priority | Test Description                                                     | Justification                                         |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ----------------------------------------------------- |
| 3.6-UNIT-004 | Unit  | P0       | ByID returns correct Note for valid ID                               | Core lookup functionality                             |
| 3.6-UNIT-005 | Unit  | P0       | ByPath returns correct Note for valid path                           | Path-based lookup                                     |
| 3.6-UNIT-006 | Unit  | P0       | ByFileClass returns slice of Notes for valid file class              | Schema-based lookup                                   |

| 3.6-UNIT-008 | Unit  | P1       | Query methods return structured errors for missing entries           | Error handling                                        |

### Instrumentation & Logging (AC 3)

| ID           | Level | Priority | Test Description                                                     | Justification                                         |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ----------------------------------------------------- |
| 3.6-UNIT-009 | Unit  | P1       | Query methods log debug information per architecture                 | Observability                                         |

### Tooling (AC 5)

- `go test ./internal/app/query` executed as part of unit suite (covered by scenarios above).
- `golangci-lint run ./internal/app/query` enforced in CI.

---

## Test Scenario Details

- Use fake CacheReaderPort for unit tests returning predetermined Note slices.
- Query methods tested with populated indices; verify correct results and error handling.
- Concurrent access tested with goroutines using RWMutex.
- Logging assertions via capturing logger to validate query operations.
- RefreshFromCache tested with fake cache data to verify index population.

---

## Risk Coverage

- **RISK-QUERY-001:** Index corruption during concurrent access → Mitigated by 3.6-UNIT-003.
- **RISK-QUERY-002:** Missing entries not handled → Mitigated by 3.6-UNIT-008.
- **RISK-QUERY-003:** Stale cache data → Mitigated by 3.6-UNIT-002.
- **RISK-CLI-004:** Documentation/help outdated → Mitigated by 3.9-E2E-012.

---

## Test Execution Order

1. Index structure and population tests (001-003).
2. Query method tests (004-008).
3. Instrumentation tests (009).
4. Run lint and go test commands for query package.

---

## Quality Gates

- ✅ All P0 unit scenarios passing.
- ✅ Concurrent access thread-safe.
- ✅ Lint and test commands succeed.

---

## Summary

The test plan validates QueryService's lookup capabilities, ensuring efficient and thread-safe access to indexed notes with proper error handling.
