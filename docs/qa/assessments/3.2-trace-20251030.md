# Requirements Traceability Matrix

## Story: 3.2 - JSON Cache Adapters

### Coverage Summary

- Total Requirements: 12 (ACs 3.2.1 through 3.2.12)
- Fully Covered: 12 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

## Requirement Mappings

### AC 3.2.1: Create `internal/adapters/spi/cache/json_writer.go` with JSONCacheWriteAdapter

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestNewJSONCacheWriter`
  - Given: Valid config and logger
  - When: Constructor called
  - Then: Returns adapter implementing CacheWriterPort interface
  - Coverage: full

### AC 3.2.2: Implement Persist method with atomic writes

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestPersist`
  - Given: Valid note and cache directory
  - When: Persist called
  - Then: JSON file created atomically with correct content
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestPersist_Overwrite`
  - Given: Existing cache file
  - When: Persist called with same note ID
  - Then: File overwritten atomically
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestPersist_ErrorHandling`
  - Given: Invalid cache directory permissions
  - When: Persist called
  - Then: Returns wrapped CacheWriteError
  - Coverage: full

### AC 3.2.3: Implement Delete method with idempotent behavior

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestDelete`
  - Given: Existing cache file
  - When: Delete called
  - Then: File removed successfully
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestDelete_Idempotent`
  - Given: Non-existent cache file
  - When: Delete called
  - Then: Returns nil (idempotent)
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_writer_test.go::TestDelete_ErrorHandling`
  - Given: Permission denied on cache directory
  - When: Delete called
  - Then: Returns wrapped CacheDeleteError
  - Coverage: full

### AC 3.2.4: Create `internal/adapters/spi/cache/json_reader.go` with JSONCacheReadAdapter

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestNewJSONCacheReader`
  - Given: Valid config and logger
  - When: Constructor called
  - Then: Returns adapter implementing CacheReaderPort interface
  - Coverage: full

### AC 3.2.5: Implement Read method with unknown field preservation

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestRead`
  - Given: Valid JSON cache file
  - When: Read called with note ID
  - Then: Returns Note with preserved unknown fields (FR6)
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestRead_NotFound`
  - Given: Non-existent cache file
  - When: Read called
  - Then: Returns ErrNotFound
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestRead_ErrorHandling`
  - Given: Malformed JSON file
  - When: Read called
  - Then: Returns wrapped CacheReadError
  - Coverage: full

### AC 3.2.6: Implement List method with partial failure tolerance

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestList`
  - Given: Cache directory with multiple JSON files
  - When: List called
  - Then: Returns all valid notes
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestList_PartialFailures`
  - Given: Mix of valid and invalid JSON files
  - When: List called
  - Then: Returns valid notes, logs warnings for invalid ones
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/json_reader_test.go::TestList_EmptyDirectory`
  - Given: Empty cache directory
  - When: List called
  - Then: Returns empty slice
  - Coverage: full

### AC 3.2.7: Create helper functions in `internal/adapters/spi/cache/helper.go`

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `internal/adapters/spi/cache/helper_test.go::TestNoteFilePath`
  - Given: Cache directory and note ID
  - When: noteFilePath called
  - Then: Returns correct `{cacheDir}/{noteID}.json` path
  - Coverage: full

- **Unit Test**: `internal/adapters/spi/cache/helper_test.go::TestEnsureCacheDir`
  - Given: Valid directory path
  - When: ensureCacheDir called
  - Then: Creates directory if missing, succeeds if exists
  - Coverage: full

### AC 3.2.8: Comprehensive unit tests for JSONCacheWriteAdapter

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Tests**: All tests in `json_writer_test.go`
  - Given: Various scenarios (success, errors, edge cases)
  - When: Adapter methods called
  - Then: Correct behavior and error handling
  - Coverage: full

### AC 3.2.9: Comprehensive unit tests for JSONCacheReadAdapter

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Tests**: All tests in `json_reader_test.go`
  - Given: Various scenarios (success, errors, edge cases)
  - When: Adapter methods called
  - Then: Correct behavior and error handling
  - Coverage: full

### AC 3.2.10: All tests pass

**Coverage: FULL**

Given-When-Then Mappings:

- **Test Execution**: `go test ./internal/adapters/spi/cache`
  - Given: Complete test suite
  - When: Tests executed
  - Then: All tests pass (verified: 87.1% coverage)
  - Coverage: full

### AC 3.2.11: All linting passes

**Coverage: FULL**

Given-When-Then Mappings:

- **Lint Execution**: `golangci-lint run ./internal/adapters/spi/cache`
  - Given: Complete codebase
  - When: Linting executed
  - Then: No issues found (verified: 0 issues)
  - Coverage: full

### AC 3.2.12: Committed with proper message

**Coverage: FULL**

Given-When-Then Mappings:

- **Git Commit**: Verified in story completion notes
  - Given: All ACs met and tests passing
  - When: Code committed
  - Then: Message follows convention: "feat(cache): implement JSON cache adapters with atomic writes and unknown field preservation"
  - Coverage: full

## Critical Gaps

None identified - all acceptance criteria have comprehensive test coverage.

## Test Design Recommendations

Based on analysis, the current test design is excellent:

1. **Complete Coverage**: All 12 ACs have corresponding tests
2. **Risk Mitigation**: Tests cover all identified risks (atomic writes, field preservation, error handling)
3. **Quality Gates**: Both linting and testing requirements verified

## Risk Assessment

- **High Risk**: None - atomic write guarantees, error handling, and field preservation all tested
- **Medium Risk**: None - comprehensive error scenarios covered
- **Low Risk**: None - all edge cases addressed

## Integration with Gates

This traceability confirms:

- All P0 tests from test-design are implemented and passing
- No security/data-loss critical tests missing
- Full compliance with traceability requirements
