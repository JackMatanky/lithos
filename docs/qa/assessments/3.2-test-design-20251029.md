# Test Design: Story 3.2 - JSON Cache Adapters

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.2 - Implement JSON Cache Adapters
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 18
- **Unit tests:** 18 (100%)
- **Integration tests:** 0
- **Priority distribution:** P0: 13, P1: 5

**Rationale:** Adapters touch filesystem, serialization, and error wrapping. Tests use temp directories and dependency fakes (atomic writer via interface) to avoid flakiness. Coverage ensures atomic writes, idempotent deletes, FR6 field preservation, list resilience, and error classifications.

---

## Test Scenarios by Acceptance Criteria

### JSONCacheWriteAdapter (AC 3.2.1-3.2.3)

| ID           | Level | Priority | Test Description                                                      | Justification                             |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | ----------------------------------------- |
| 3.2-UNIT-001 | Unit  | P0       | Persist writes JSON file and creates cache directory                  | Core success path                        |
| 3.2-UNIT-002 | Unit  | P0       | Persist overwrites existing file atomically (verify temp file usage)  | Atomic write guarantee                   |
| 3.2-UNIT-003 | Unit  | P0       | Persist returns wrapped error when cache dir creation fails           | Error propagation                        |
| 3.2-UNIT-004 | Unit  | P0       | Delete removes existing file                                          | Delete success                           |
| 3.2-UNIT-005 | Unit  | P0       | Delete non-existent file returns nil                                  | Idempotent delete                        |
| 3.2-UNIT-006 | Unit  | P0       | Delete returns wrapped error on permission failure                    | Error propagation                        |
| 3.2-UNIT-007 | Unit  | P1       | Debug logs emitted on persist/delete success                          | Observability                            |

### JSONCacheReadAdapter (AC 3.2.4-3.2.6)

| ID           | Level | Priority | Test Description                                                      | Justification                             |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | ----------------------------------------- |
| 3.2-UNIT-008 | Unit  | P0       | Read returns Note for existing JSON                                   | Core success path                        |
| 3.2-UNIT-009 | Unit  | P0       | Read returns ErrNotFound for missing file                             | Contract expectation                     |
| 3.2-UNIT-010 | Unit  | P0       | Read wraps errors for malformed JSON                                  | Error propagation                        |
| 3.2-UNIT-011 | Unit  | P0       | Read preserves unknown fields in Frontmatter                          | FR6 compliance                           |
| 3.2-UNIT-012 | Unit  | P0       | List returns all notes in directory                                   | Core success path                        |
| 3.2-UNIT-013 | Unit  | P0       | List skips non-JSON files and continues on unreadable files           | Resilience                               |
| 3.2-UNIT-014 | Unit  | P0       | List aggregates partial results and warnings                          | Requirement for partial success          |
| 3.2-UNIT-015 | Unit  | P1       | List empty directory returns empty slice                              | Edge case                                |

### Shared Helpers & Error Types (AC 3.2.7-3.2.9)

| ID           | Level | Priority | Test Description                                                      | Justification                             |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | ----------------------------------------- |
| 3.2-UNIT-016 | Unit  | P1       | noteFilePath constructs `{cacheDir}/{NoteID}.json`                    | Ensures helper used consistently          |
| 3.2-UNIT-017 | Unit  | P1       | ensureCacheDir handles existing directory idempotently                | Helper behavior                           |
| 3.2-UNIT-018 | Unit  | P0       | Errors include note ID and path metadata                              | Error strategy compliance                 |

---

## Test Scenario Details

- Use `t.TempDir()` for isolated filesystem state.
- Inject stub `atomicwriter` via functional option or interface to assert atomic rename usage.
- For FR6 verification, write JSON with extra fields and assert `Note.Frontmatter.Fields` retains them.
- For partial list tests, create one valid note, one malformed JSON (expect warning log), ensure valid note still returned.
- Logging assertions can use capturing logger from prior stories.

---

## Risk Coverage

- **RISK-CACHE-001:** Atomic write guarantees broken → Mitigated by 3.2-UNIT-002.
- **RISK-CACHE-002:** Unknown fields lost → Mitigated by 3.2-UNIT-011.
- **RISK-CACHE-003:** Deletes non-idempotent → Mitigated by 3.2-UNIT-005.
- **RISK-CACHE-004:** Directory traversal/incorrect paths → Mitigated by 3.2-UNIT-016.
- **RISK-CACHE-005:** Errors lack context → Mitigated by 3.2-UNIT-018.

---

## Test Execution Order

1. Helper tests (16-17) to stabilize utilities.
2. Writer tests (1-7).
3. Reader tests (8-15).
4. Run `golangci-lint run ./internal/adapters/spi/cache` and `go test ./internal/adapters/spi/cache`.

---

## Quality Gates

- ✅ All 13 P0 scenarios implemented and passing.
- ✅ Logging assertions confirmed where required.
- ✅ Lint and unit tests succeed.

---

## Summary

This plan confirms the JSON cache adapters fulfill atomic write, idempotent delete, FR6 preservation, resilient listing, and error-reporting requirements before the indexing pipeline depends on them.
