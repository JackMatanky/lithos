# Test Design: Story 3.3 - VaultReaderPort & Adapter

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.3 - VaultReaderPort and VaultReaderAdapter
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 17
- **Unit tests:** 17 (100%)
- **Priority distribution:** P0: 12, P1: 5

**Rationale:** Vault reader hits the filesystem and must handle large vaults reliably. Tests rely on temp directory fixtures, simulating mixed file types, permissions, incremental scans, and path validation. DTO creation is verified for metadata accuracy.

---

## Test Scenarios by Acceptance Criteria

### Port & DTO Definitions (AC 3.3.1-3.3.2)

| ID           | Level | Priority | Test Description                                                      | Justification                                      |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | -------------------------------------------------- |
| 3.3-UNIT-001 | Unit  | P0       | Compile-time assertion for VaultReaderPort interface signatures       | Guards contract stability                          |
| 3.3-UNIT-002 | Unit  | P0       | VaultFile constructor populates metadata and content accurately       | DTO correctness                                    |
| 3.3-UNIT-003 | Unit  | P1       | GoDoc comment contains business semantics and FR references           | Documentation requirement                          |

### ScanAll / ScanModified (AC 3.3.3-3.3.5)

| ID           | Level | Priority | Test Description                                                      | Justification                                      |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | -------------------------------------------------- |
| 3.3-UNIT-004 | Unit  | P0       | ScanAll on empty vault returns empty slice                            | Edge case                                           |
| 3.3-UNIT-005 | Unit  | P0       | ScanAll reads mixed file types and includes all                       | Core behavior                                       |
| 3.3-UNIT-006 | Unit  | P0       | ScanAll skips `.lithos/` directories                                  | Requirement                                         |
| 3.3-UNIT-007 | Unit  | P0       | ScanAll handles permission errors by logging warning and continuing   | Resilience                                          |
| 3.3-UNIT-008 | Unit  | P0       | ScanModified returns files newer than `since`                         | Incremental scan                                    |
| 3.3-UNIT-009 | Unit  | P1       | ScanModified excludes older files even if they exist                  | Edge case                                           |

### Read Method (AC 3.3.6)

| ID           | Level | Priority | Test Description                                                      | Justification                                      |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | -------------------------------------------------- |
| 3.3-UNIT-010 | Unit  | P0       | Read returns VaultFile with metadata and content                      | Core behavior                                       |
| 3.3-UNIT-011 | Unit  | P0       | Read rejects paths outside vault ("../" traversal)                   | Security requirement                                |
| 3.3-UNIT-012 | Unit  | P0       | Read returns wrapped error for missing file                           | Error propagation                                   |
| 3.3-UNIT-013 | Unit  | P0       | Read returns wrapped error for permission denied                      | Error propagation                                   |

### Logging & Metadata (General)

| ID           | Level | Priority | Test Description                                                      | Justification                                      |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | -------------------------------------------------- |
| 3.3-UNIT-014 | Unit  | P1       | ScanAll logs number of files scanned and duration                     | Observability                                       |
| 3.3-UNIT-015 | Unit  | P1       | Metadata fields (ModTime, Size, MimeType) match actual file stats     | DTO accuracy                                        |

### Tooling (AC 3.3.8-3.3.9)

| ID           | Level | Priority | Test Description                                                      | Justification                                      |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | -------------------------------------------------- |
| 3.3-UNIT-016 | Unit  | P0       | `go test ./internal/adapters/spi/vault` executes with temp fixtures   | Test gate                                           |
| 3.3-UNIT-017 | Unit  | P0       | `golangci-lint run ./internal/adapters/spi/vault` clean               | Lint gate                                           |

---

## Test Scenario Details

- Use `t.TempDir()` to construct vault structure with subdirectories, `.lithos/` folder, and varied file types.
- For ScanModified, manipulate file ModTime using `os.Chtimes`.
- To simulate permission errors, chmod a file to `000` on Unix (skip on Windows with build tags).
- Path traversal check constructs path like `../outside.md` and ensures adapter rejects it.
- Metadata tests compare VaultFile fields to `os.Stat` results.

---

## Risk Coverage

- **RISK-VAULTREAD-001:** Unexpected files included/excluded → Mitigated by 3.3-UNIT-005/006/008.
- **RISK-VAULTREAD-002:** Security exposure via path traversal → Mitigated by 3.3-UNIT-011.
- **RISK-VAULTREAD-003:** Permission errors crash scan → Mitigated by 3.3-UNIT-007.
- **RISK-VAULTREAD-004:** Incorrect metadata used downstream → Mitigated by 3.3-UNIT-015.

---

## Test Execution Order

1. DTO/interface tests (001-003).
2. ScanAll/ScanModified tests (004-009).
3. Read tests (010-013).
4. Logging/metadata checks (014-015).
5. Tooling commands (016-017).

---

## Quality Gates

- ✅ All 12 P0 scenarios passing.
- ✅ Lint/test commands succeed.
- ✅ Logs captured with stage durations.

---

## Summary

The tests confirm VaultReaderAdapter safely scans the vault, respects incremental updates, returns rich metadata, rejects traversal, and handles filesystem anomalies before feeding the indexer.
