# Test Design: Story 3.11

Date: 2025-01-12
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 8 (44%)
- Integration tests: 6 (33%)
- E2E tests: 2 (11%)
- Performance tests: 2 (11%)
- Priority distribution: P0: 12, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Only markdown files have content loaded during vault scanning

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.11-UNIT-001 | Unit        | P0       | File extension filtering  | Pure logic validation    |
| 3.11-UNIT-002 | Unit        | P0       | Content loading bypass    | Algorithm correctness    |
| 3.11-INT-001  | Integration | P0       | Mixed file vault scanning | Component interaction    |
| 3.11-PERF-001 | Performance | P0       | Memory usage with binaries| Memory leak prevention   |

### AC2: Cache directory exclusion works correctly without false positives

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.11-UNIT-003 | Unit        | P0       | Cache directory detection | Path manipulation logic  |
| 3.11-UNIT-004 | Unit        | P0       | Exclusion logic validation| Algorithm correctness    |
| 3.11-INT-002  | Integration | P0       | Nested cache exclusion    | Filesystem interaction   |
| 3.11-E2E-001  | E2E         | P0       | Vault indexing exclusion  | Critical user workflow   |

### AC3: Large vaults with PDFs, images, and other binary files scan efficiently

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.11-INT-003  | Integration | P0       | Large vault scanning      | Performance validation   |
| 3.11-PERF-002 | Performance | P0       | Scanning time benchmarks  | Efficiency measurement   |

### AC4: Memory usage remains predictable and bounded regardless of vault size

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.11-UNIT-005 | Unit        | P0       | Memory bounds checking    | Algorithm validation     |
| 3.11-INT-004  | Integration | P0       | Memory monitoring         | Resource usage tracking  |

### AC5: File filtering happens before content loading to prevent unnecessary memory allocation

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.11-UNIT-006 | Unit        | P0       | Filter order validation   | Sequence correctness     |
| 3.11-UNIT-007 | Unit        | P0       | Memory allocation tracking| Resource optimization    |
| 3.11-INT-005  | Integration | P0       | Filtered content loading  | Process optimization     |

### AC6: Proper mime-type detection is used for accurate file classification

#### Scenarios

| ID           | Level       | Priority | Test                      | Justification            |
| ------------ | ----------- | -------- | ------------------------- | ------------------------ |
| 3.11-UNIT-008 | Unit        | P1       | Mime-type detection       | Classification accuracy  |
| 3.11-INT-006  | Integration | P1       | Fallback logic testing    | Edge case handling       |
| 3.11-E2E-002  | E2E         | P1       | File type classification  | End-to-end validation    |

## Risk Coverage

### Critical Risks Addressed

- **Memory Leak (P0)**: Comprehensive memory usage testing with bounds checking
- **Performance Degradation (P0)**: Benchmarking and efficiency validation
- **Incorrect Filtering (P0)**: Multiple levels of filtering logic validation
- **Cache Contamination (P0)**: Exclusion logic testing across scenarios

### Test Coverage Gaps

- No P2/P3 tests identified - all functionality is critical for memory management
- No manual testing scenarios - all validation can be automated

## Recommended Execution Order

1. P0 Unit tests (8 tests) - Validate core algorithms
2. P0 Integration tests (5 tests) - Validate component interactions
3. P0 E2E tests (2 tests) - Validate complete workflows
4. P1 tests (4 tests) - Validate enhanced features
5. Performance tests (2 tests) - Validate efficiency metrics

## Test Implementation Notes

### Unit Test Locations
- `internal/adapters/spi/vault/reader_test.go` - File filtering and scanning logic
- `internal/shared/utils/file_test.go` - File type detection utilities
- `internal/domain/vault_test.go` - FileMetadata and exclusion logic

### Integration Test Locations
- `tests/integration/vault_scanning_test.go` - Scanning process with real filesystem
- `tests/integration/memory_monitoring_test.go` - Memory usage validation

### E2E Test Locations
- `tests/e2e/vault_indexing_test.go` - Complete indexing workflow

### Performance Test Locations
- `tests/performance/vault_scanning_bench_test.go` - Benchmarking and memory profiling

### Test Data Requirements
- Mixed file vaults: 1000+ files including markdown, PDFs, images, binaries
- Nested directory structures with cache directories
- Files without extensions for mime-type fallback testing
- Large binary files (100MB+) for memory testing

### Mock Requirements
- File system operations for unit tests
- Memory monitoring interfaces
- Mime-type detection services

## Quality Checklist

- [x] Every AC has at least one test scenario
- [x] Test levels appropriate for risk and complexity
- [x] No duplicate coverage across levels
- [x] Critical paths have multiple test levels
- [x] Priorities align with business impact (memory leak prevention)
- [x] Test IDs follow naming convention
- [x] Implementation locations specified
- [x] Test data requirements documented
