# Test Design: Story 3.1 - Cache Port Interfaces

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.1 - Define Cache Port Interfaces
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 8
- **Unit tests:** 8 (100%)
- **Integration tests:** 0 (0%)
- **E2E tests:** 0 (0%)
- **Priority distribution:** P0: 6, P1: 2

**Rationale:** The cache ports are architectural contracts with no runtime logic. Tests focus on compile-time interface satisfaction, context propagation, and documenting concurrency/FS requirements. Lightweight fake implementations ensure signatures stay stable and context cancellation is respected.

---

## Test Scenarios by Acceptance Criteria

### AC 3.1.1-3.1.2: Interface Signatures & Context Semantics

| ID           | Level | Priority | Test Description                                                   | Justification                                           |
| ------------ | ----- | -------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| 3.1-UNIT-001 | Unit  | P0       | Compile-time assertion that CacheWriterPort requires Persist/Delete with context | Guards method signatures and context usage |
| 3.1-UNIT-002 | Unit  | P0       | Compile-time assertion that CacheReaderPort requires Read/List with context       | Guards method signatures and context usage |
| 3.1-UNIT-003 | Unit  | P0       | FakeWriter implementing interface returns context cancellation error untouched   | Ensures context propagation expectations    |
| 3.1-UNIT-004 | Unit  | P0       | FakeReader implementing interface returns context cancellation error untouched   | Ensures context propagation expectations    |

### AC 3.1.3: Documentation Requirements

| ID           | Level | Priority | Test Description                                                   | Justification                                           |
| ------------ | ----- | -------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| 3.1-UNIT-005 | Unit  | P1       | Doc comment lint test verifying concurrency + cache dir guidance present | Keeps architectural documentation intact |

### AC 3.1.4: Interface Tests

| ID           | Level | Priority | Test Description                                                   | Justification                                           |
| ------------ | ----- | -------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| 3.1-UNIT-006 | Unit  | P0       | Mock/fake structs satisfy interfaces via `var _ CacheWriterPort = (*fakeWriter)(nil)` | Protects contract for implementers      |
| 3.1-UNIT-007 | Unit  | P0       | Interface tests ensure signatures support error wrapping (errors.Is/As)            | Aligns with error-handling strategy      |

### Tooling & Lint (AC 3.1.5)

| ID           | Level | Priority | Test Description                                                   | Justification                                           |
| ------------ | ----- | -------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| 3.1-UNIT-008 | Unit  | P0       | `golangci-lint run ./internal/ports/spi` enforced in CI/test script | Ensures lint gate captured in checklist  |

---

## Test Scenario Details

### Compile-Time Interface Assertions (3.1-UNIT-001, 3.1-UNIT-002, 3.1-UNIT-006)
```go
var (
    _ CacheWriterPort = (*fakeWriter)(nil)
    _ CacheReaderPort = (*fakeReader)(nil)
)
```
These assertions ensure any future signature change breaks tests immediately.

### Context Propagation (3.1-UNIT-003, 3.1-UNIT-004)
```go
func (f *fakeWriter) Persist(ctx context.Context, note Note) error {
    if err := ctx.Err(); err != nil {
        return err
    }
    f.persistCalled = true
    return nil
}
```
Tests should cancel the context before calling Persist/Delete and assert the returned error equals `context.Canceled` without wrapping.

### Error Interface Expectations (3.1-UNIT-007)
Ensure fake implementations wrap errors using `CacheWriteError`/`CacheReadError` scaffolding so downstream adapters know what to return.

### Documentation Guard (3.1-UNIT-005)
Use go/doc analysis or simple string contains tests to assert comment blocks mention concurrency safety and cache directory expectations.

### Tooling Check (3.1-UNIT-008)
Record lint command execution in test checklist (could be a build tag + helper test verifying `golangci-lint` run as part of CI).

---

## Risk Coverage

- **RISK-CACHEPORT-001:** Interface signature drift unnoticed → Mitigated by 3.1-UNIT-001/002/006.
- **RISK-CACHEPORT-002:** Implementations mishandle context cancellation → Mitigated by 3.1-UNIT-003/004.
- **RISK-CACHEPORT-003:** Documentation omits threading/cache-dir guidance → Mitigated by 3.1-UNIT-005.
- **RISK-CACHEPORT-004:** Error contract unclear → Mitigated by 3.1-UNIT-007.

---

## Test Execution Order

1. Compile-time assertions (fast fail on signature issues).
2. Context propagation tests with fake implementations.
3. Documentation comment checks.
4. Lint command execution.

---

## Quality Gates

- ✅ All 6 P0 tests (compile-time + context + error + lint) pass.
- ✅ Doc lint ensures concurrency/cache guidance present.
- ✅ `golangci-lint run ./internal/ports/spi` reports zero issues.

---

## Summary

This test plan ensures the cache port interfaces remain stable contracts with clear context expectations, documentation, and lint compliance before adapters are implemented.
