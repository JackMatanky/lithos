# Requirements Traceability Matrix

## Story: 3.5 - VaultIndexer Service

### Coverage Summary

- Total Requirements: 8
- Fully Covered: 8
- Partially Covered: 0
- Not Covered: 0
- Test Design Reference: docs/qa/assessments/3.5-vault-indexer-service-test-design-20251031.md

### Requirement Mappings

#### AC1: Build() workflow (vault scan → note creation → cache persist)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `TestVaultIndexer_Build_CallsVaultScannerScanAll`
  - Given: VaultIndexer with FakeVaultScannerPort
  - When: Build() method called
  - Then: ScanAll() called on vault scanner

- **Unit Test**: `TestVaultIndexer_Build_CallsCacheWriterPersist`
  - Given: VaultIndexer with FakeCacheWriterPort
  - When: Build() method called with .md file
  - Then: Persist() called on cache writer with created Note

#### AC2: IndexStats records counts and duration

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `TestVaultIndexer_Build_HandlesCacheWriteFailures`
  - Given: Cache write failure scenario
  - When: Build() completes
  - Then: IndexStats shows correct ScannedCount, IndexedCount=0, CacheFailures=1, Duration>0

- **Unit Test**: `TestVaultIndexer_Build_CallsVaultScannerScanAll`
  - Given: Multiple files in vault
  - When: Build() processes files
  - Then: ScannedCount matches file count

#### AC3: Cache write failures logged as warnings, processing continues

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `TestVaultIndexer_Build_HandlesCacheWriteFailures`
  - Given: CacheWriterPort returns error on Persist()
  - When: Build() processes file
  - Then: Warning logged, CacheFailures incremented, processing continues for other files

#### AC4: Basic file scanning creates Note objects with metadata

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `TestVaultIndexer_Build_CallsCacheWriterPersist`
  - Given: .md file with metadata (path, size, modtime)
  - When: processFile() called
  - Then: Note created with derived NoteID from path

#### AC5: Focused service - orchestrates only, delegates scanning/caching

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: All Build tests
  - Given: VaultIndexer with injected dependencies
  - When: Build() orchestrates workflow
  - Then: Only calls injected ports, no direct implementation

#### AC6: IndexStats tracks scanning metrics

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `TestVaultIndexer_Build_HandlesCacheWriteFailures`
  - Given: Files processed with mixed success/failure
  - When: Build() completes
  - Then: Stats accurately reflect scanned, indexed, failures

#### AC7: Unit tests with fakes verify call order, error handling, stats

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `TestVaultIndexer_Build_CallsVaultScannerScanAll`
  - Given: FakeVaultScannerPort
  - When: Build() called
  - Then: Correct call order verified

- **Unit Test**: `TestVaultIndexer_Build_HandlesVaultScanFailure`
  - Given: ScanAll returns error
  - When: Build() called
  - Then: Error returned immediately, no persistence attempted

- **Unit Test**: `TestVaultIndexer_Build_HandlesCacheWriteFailures`
  - Given: Persist returns error
  - When: Build() called
  - Then: Warning logged, stats updated, processing continues

#### AC8: golangci-lint and go test succeed

**Coverage: FULL**

Given-When-Then Mappings:

- **Verification**: Manual execution
  - Given: Codebase
  - When: `golangci-lint run ./internal/app/vault` executed
  - Then: 0 issues reported

- **Verification**: Manual execution
  - Given: Test suite
  - When: `go test ./internal/app/vault` executed
  - Then: All tests pass

### Critical Gaps

None identified - all acceptance criteria fully covered by unit tests.

### Test Design Recommendations

- Current test coverage at 97.4% exceeds requirements
- All P0 test scenarios implemented
- Fakes provide excellent testability
- No additional test types needed for this unit-level service
