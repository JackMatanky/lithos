# Test Design: Story 2.1 - Config and Schema Domain Models

**Date:** 2025-10-29 (Updated)
**Designer:** Quinn (Test Architect)
**Story:** 2.1 Config and Schema Domain Models
**Epic:** 2 - Configuration & Schema Loading
**Status:** Config Complete, Schema Pending

---

## Test Strategy Overview

### Overall Metrics

- **Total test scenarios:** 28
- **Unit tests:** 28 (100%)
- **Integration tests:** 0 (0%)
- **E2E tests:** 0 (0%)
- **Priority distribution:** P0: 26, P1: 2

### By Model

**Config Model (✅ Complete):**
- Test scenarios: 12
- All unit tests (pure domain model)
- Priority: 10 P0, 2 P1
- Status: Implemented and passing

**Schema Model (🚧 Pending):**
- Test scenarios: 16
- All unit tests (pure domain model with validation)
- Priority: 15 P0, 1 P1
- Status: Pending implementation (Tasks 5-9)

### Test Level Justification

**Why Unit Tests Only:**
- Both Config and Schema are **pure domain models** with zero external dependencies
- No database, filesystem, or service interactions at this layer
- Business logic and validation are self-contained
- **Fast feedback loop** essential for domain model development (< 50ms total)
- Integration testing appropriately deferred to Stories 2.4+ (SchemaPort, SchemaValidator, SchemaResolver)

**Why No Integration Tests:**
- Config has no component interactions at domain layer
- Schema validation delegates to Property (tested at unit level)
- Cross-schema validation tested in Story 2.6 (SchemaValidator)
- Schema inheritance resolution tested in Story 2.7 (SchemaResolver)
- Schema loading from filesystem tested in Story 2.4 (SchemaPort)

**Why No E2E Tests:**
- Not user-facing functionality (domain models consumed by application services)
- E2E coverage provided in Story 2.9 (complete schema system integration)

---

## Config Model Test Scenarios (AC 2.1.1-2.1.11)

### AC 2.1.1-2.1.4: Config Model Structure

**Requirement:** Create Config struct with 6 fields, JSON tags, NewConfig() constructor with defaults, and PropertyBankPath() helper.

#### Scenarios

| ID           | Level | Priority | Test Description                                      | Justification                                    |
| ------------ | ----- | -------- | ----------------------------------------------------- | ------------------------------------------------ |
| 2.1-UNIT-001 | Unit  | P0       | NewConfig with all defaults creates valid Config      | Core constructor behavior, foundational logic    |
| 2.1-UNIT-002 | Unit  | P0       | NewConfig applies VaultPath default to CWD            | Critical default path resolution                 |
| 2.1-UNIT-003 | Unit  | P0       | NewConfig applies TemplatesDir default correctly      | Path construction depends on VaultPath default   |
| 2.1-UNIT-004 | Unit  | P0       | NewConfig applies SchemasDir default correctly        | Path construction depends on VaultPath default   |
| 2.1-UNIT-005 | Unit  | P0       | NewConfig applies PropertyBankFile default            | Default filename must match architecture spec    |
| 2.1-UNIT-006 | Unit  | P0       | NewConfig applies CacheDir default correctly          | Hidden directory path construction               |
| 2.1-UNIT-007 | Unit  | P0       | NewConfig applies LogLevel default to "info"          | Default logging verbosity                        |
| 2.1-UNIT-008 | Unit  | P0       | NewConfig with partial config (mix of values/defaults) | Real-world scenario: some config, some defaults |
| 2.1-UNIT-009 | Unit  | P1       | NewConfig with full config uses provided values       | Verify no defaults override explicit values      |
| 2.1-UNIT-010 | Unit  | P0       | PropertyBankPath() returns correct joined path        | Critical helper method for schema loading        |

### AC 2.1.5-2.1.6: Value Object Semantics

| ID           | Level | Priority | Test Description                              | Justification                             |
| ------------ | ----- | -------- | --------------------------------------------- | ----------------------------------------- |
| 2.1-UNIT-011 | Unit  | P1       | Config has no setter methods (immutability)   | Enforce value object pattern at test time |

### AC 2.1.7-2.1.9: Unit Tests & Quality Gates

| ID           | Level | Priority | Test Description                        | Justification                                  |
| ------------ | ----- | -------- | --------------------------------------- | ---------------------------------------------- |
| 2.1-UNIT-012 | Unit  | P0       | JSON marshal/unmarshal round-trip       | Serialization integrity for config persistence |

---

## Schema Model Test Scenarios (AC 2.1.12-2.1.22)

### AC 2.1.12-2.1.15: Schema Struct and Constructor

**Requirement:** Create Schema struct with Name, Extends, Excludes, Properties; JSON/YAML tags; NewSchema() constructor with defensive copies.

#### Scenarios

| ID           | Level | Priority | Test Description                                     | Justification                          |
| ------------ | ----- | -------- | ---------------------------------------------------- | -------------------------------------- |
| 2.1-UNIT-013 | Unit  | P0       | NewSchema creates valid schema with all fields       | Core constructor behavior              |
| 2.1-UNIT-014 | Unit  | P0       | NewSchema defensive copy of excludes slice           | Validates immutability (excludes)      |
| 2.1-UNIT-015 | Unit  | P0       | NewSchema defensive copy of properties slice         | Validates immutability (properties)    |
| 2.1-UNIT-016 | Unit  | P0       | Modifying constructor args doesn't affect Schema     | Validates complete immutability        |

**Details:**

- **2.1-UNIT-013:** Given name="contact", extends="base", excludes=["tags"], properties=[prop1], when NewSchema called, then Schema created with all fields correct
- **2.1-UNIT-014:** Given excludes=["tag1", "tag2"], when NewSchema called and original slice modified, then Schema.Excludes unchanged
- **2.1-UNIT-015:** Given properties=[prop1, prop2], when NewSchema called and original slice modified, then Schema.Properties unchanged
- **2.1-UNIT-016:** Given all constructor arguments as mutable slices, when NewSchema called and all args modified, then Schema internal state completely unchanged

### AC 2.1.14: Schema Validation

**Requirement:** Implement Validate() method with name validation, excludes/extends constraint, property delegation, SchemaError returns.

#### Scenarios

| ID           | Level | Priority | Test Description                                     | Justification                          |
| ------------ | ----- | -------- | ---------------------------------------------------- | -------------------------------------- |
| 2.1-UNIT-017 | Unit  | P0       | Validate() succeeds with valid schema                | Success path validation                |
| 2.1-UNIT-018 | Unit  | P0       | Validate() fails when Name is empty                  | Critical: name is required identifier  |
| 2.1-UNIT-019 | Unit  | P0       | Validate() fails when Excludes without Extends       | Validates excludes/extends constraint  |
| 2.1-UNIT-020 | Unit  | P0       | Validate() delegates to Property.Validate()          | Validates property validation delegation |
| 2.1-UNIT-021 | Unit  | P0       | Validate() aggregates multiple property errors       | Validates error aggregation (errors.Join) |
| 2.1-UNIT-022 | Unit  | P0       | Validation errors include schema name (FR5)          | Validates FR5 traceability requirement |

**Details:**

- **2.1-UNIT-017:** Given Schema with Name="contact", valid Properties, when Validate() called, then returns nil error
- **2.1-UNIT-018:** Given Schema with Name="", when Validate() called, then returns SchemaError with message "schema name cannot be empty"
- **2.1-UNIT-019:** Given Schema with Extends="" and Excludes=["tags"], when Validate() called, then returns SchemaError "excludes can only be used with extends"
- **2.1-UNIT-020:** Given Schema with invalid Property (missing ID), when Validate() called, then Property.Validate() invoked and error returned
- **2.1-UNIT-021:** Given Schema with 3 invalid Properties, when Validate() called, then all 3 errors aggregated using errors.Join
- **2.1-UNIT-022:** Given Schema Name="contact" that fails validation, when error returned, then error message includes "contact" for FR5 traceability

### AC 2.1.16-2.1.17: Schema Value Object Semantics

**Requirement:** Schema is immutable with comprehensive GoDoc.

#### Scenarios

| ID           | Level | Priority | Test Description                              | Justification                             |
| ------------ | ----- | -------- | --------------------------------------------- | ----------------------------------------- |
| 2.1-UNIT-023 | Unit  | P0       | Schema has no setter methods (immutability)   | Enforce value object pattern at test time |

**Details:**

- **2.1-UNIT-023:** Given Schema type, when reflection checks for setter methods, then zero setter methods found

### AC 2.1.18-2.1.20: Serialization and Quality

**Requirement:** JSON/YAML marshaling tests, linting passes, all tests pass.

#### Scenarios

| ID           | Level | Priority | Test Description                                     | Justification                          |
| ------------ | ----- | -------- | ---------------------------------------------------- | -------------------------------------- |
| 2.1-UNIT-024 | Unit  | P0       | JSON round-trip preserves all fields                 | Validates JSON serialization           |
| 2.1-UNIT-025 | Unit  | P0       | YAML round-trip preserves all fields                 | Validates YAML serialization           |
| 2.1-UNIT-026 | Unit  | P0       | Schema with Extends and Excludes marshals correctly  | Validates optional fields handling     |
| 2.1-UNIT-027 | Unit  | P0       | Schema with multiple Properties marshals correctly   | Validates slice serialization          |
| 2.1-UNIT-028 | Unit  | P1       | Schema with empty Extends omits field in JSON        | Edge case: omitempty behavior          |

**Details:**

- **2.1-UNIT-024:** Given Schema with all fields, when marshaled to JSON and back, then resulting Schema matches original exactly
- **2.1-UNIT-025:** Given Schema with all fields, when marshaled to YAML and back, then resulting Schema matches original exactly
- **2.1-UNIT-026:** Given Schema with Extends="base", Excludes=["tags"], when marshaled/unmarshaled, then all inheritance fields preserved
- **2.1-UNIT-027:** Given Schema with Properties=[prop1, prop2, prop3], when marshaled/unmarshaled, then all properties preserved in order
- **2.1-UNIT-028:** Given Schema with Extends="", when marshaled to JSON, then "extends" field not present (validates omitempty tag)

---

## Risk Coverage Analysis

### Config Model Risks

| Risk ID    | Risk Description                            | Mitigating Tests            |
| ---------- | ------------------------------------------- | --------------------------- |
| CONFIG-001 | Default paths incorrectly constructed       | 2.1-UNIT-001 through 2.1-UNIT-007 |
| CONFIG-002 | Explicit config values overridden by defaults | 2.1-UNIT-008, 2.1-UNIT-009 |
| CONFIG-003 | Config mutation causes inconsistent state   | 2.1-UNIT-011                |
| CONFIG-004 | JSON serialization loses data               | 2.1-UNIT-012                |
| CONFIG-005 | PropertyBankPath returns incorrect path     | 2.1-UNIT-010                |

### Schema Model Risks

| Risk ID    | Risk Description                            | Mitigating Tests            |
| ---------- | ------------------------------------------- | --------------------------- |
| SCHEMA-001 | Empty Name accepted (critical validation)   | 2.1-UNIT-018                |
| SCHEMA-002 | Excludes allowed without Extends            | 2.1-UNIT-019                |
| SCHEMA-003 | Property validation not delegated           | 2.1-UNIT-020                |
| SCHEMA-004 | Defensive copies not made (mutability)      | 2.1-UNIT-014, 2.1-UNIT-015, 2.1-UNIT-016 |
| SCHEMA-005 | JSON/YAML serialization loses fields        | 2.1-UNIT-024, 2.1-UNIT-025  |
| SCHEMA-006 | Error messages lack schema context (FR5)    | 2.1-UNIT-022                |
| SCHEMA-007 | Multiple property errors not aggregated     | 2.1-UNIT-021                |

---

## Coverage Gaps and Deferred Testing

### Explicitly Deferred to Later Stories

1. **Cross-schema validation** (Story 2.6 - SchemaValidator):
   - Extends references non-existent parent schema
   - Duplicate schema names across files
   - $ref references non-existent properties

2. **Inheritance resolution** (Story 2.7 - SchemaResolver):
   - Multi-level inheritance chains (A → B → C)
   - Circular inheritance detection
   - Excludes references validation (property exists in parent)
   - Property merge semantics

3. **Schema loading** (Story 2.4 - SchemaPort):
   - File I/O operations
   - JSON/YAML parsing errors from disk
   - Missing schema files

4. **Integration with Property model** (Story 2.2):
   - Schema with complex PropertySpec variants
   - Property validation error propagation
   - Property constraint enforcement

### No Coverage Gaps in This Story

✅ All acceptance criteria for Config (2.1.1-2.1.11) have corresponding tests
✅ All acceptance criteria for Schema (2.1.12-2.1.22) have corresponding tests
✅ All identified risks have mitigating tests

---

## Test Execution Order

### Phase 1: Config Model (P0 - Critical Foundation)
1. **2.1-UNIT-001** - All defaults (fail fast on constructor issues)
2. **2.1-UNIT-002 through 2.1-UNIT-007** - Individual default validation
3. **2.1-UNIT-008** - Partial config (most common scenario)
4. **2.1-UNIT-010** - PropertyBankPath helper
5. **2.1-UNIT-012** - JSON round-trip
6. **2.1-UNIT-009, 2.1-UNIT-011** - P1 tests

### Phase 2: Schema Model (P0 - Core Domain Entity)
1. **2.1-UNIT-013** - NewSchema constructor (fail fast on schema creation)
2. **2.1-UNIT-017** - Validate() success path
3. **2.1-UNIT-018** - Empty name validation (critical requirement)
4. **2.1-UNIT-019** - Excludes/Extends constraint
5. **2.1-UNIT-020** - Property validation delegation
6. **2.1-UNIT-014 through 2.1-UNIT-016** - Immutability (defensive copies)
7. **2.1-UNIT-021, 2.1-UNIT-022** - Error handling and FR5 traceability
8. **2.1-UNIT-023** - Immutability enforcement
9. **2.1-UNIT-024 through 2.1-UNIT-027** - Serialization
10. **2.1-UNIT-028** - P1 edge case

---

## Test Implementation Status

### Config Model (✅ Complete)

**File:** `internal/domain/config_test.go`

**Status:** All 12 test scenarios implemented and passing

**Coverage:** >90% for Config model

**Quality Gates Met:**
- ✅ All 10 P0 unit tests pass
- ✅ All 2 P1 unit tests pass
- ✅ `golangci-lint run ./internal/domain` produces zero critical warnings
- ✅ Test coverage ≥ 90%
- ✅ Execution time < 50ms

### Schema Model (🚧 Pending)

**Target File:** `internal/domain/schema_test.go`

**Status:** Awaiting implementation (Tasks 5-9)

**Coverage Target:** >90% for Schema model

**Prerequisites:**
- Property model available (Story 2.2) for Property.Validate() delegation
- SchemaError type defined for error validation
- Test fixtures for JSON/YAML marshaling

**Test Utilities Needed:**
- Helper: `createValidTestProperty()` - returns valid Property for testing
- Helper: `createInvalidTestProperty()` - returns invalid Property for delegation testing
- Fixture: Sample JSON schema for marshaling tests
- Fixture: Sample YAML schema for marshaling tests

---

## Quality Gates

### Config Model Quality Gates (✅ Met)

- ✅ All 10 P0 unit tests pass
- ✅ All 2 P1 unit tests pass
- ✅ `golangci-lint run ./internal/domain` zero critical warnings
- ✅ Test coverage ≥ 90%
- ✅ Test execution < 50ms
- ✅ No race conditions (`go test -race`)

### Schema Model Quality Gates (⏳ Pending)

Required for story completion:
- ⏳ All 15 P0 unit tests pass
- ⏳ All 1 P1 unit test passes
- ⏳ `golangci-lint run ./internal/domain` zero critical warnings
- ⏳ Test coverage ≥ 90%
- ⏳ Test execution < 50ms (total for all domain tests)
- ⏳ No race conditions (`go test -race`)

---

## Dependencies & Downstream Impact

### Prerequisites

**Config Model:**
- Go stdlib: `path/filepath`, `encoding/json`, `reflect`, `strings`
- No external dependencies

**Schema Model:**
- Go stdlib: `context`, `encoding/json`, `errors`, `reflect`
- YAML library: `gopkg.in/yaml.v3`
- Property model (Story 2.2) for validation delegation

### Downstream Consumers

**Config Model:**
- Story 2.4: SchemaPort uses Config.SchemasDir and Config.PropertyBankPath()
- Story 3.X: CacheAdapters use Config.CacheDir
- Epic 1.X: TemplateLoaderAdapter uses Config.TemplatesDir

**Schema Model:**
- Story 2.2: Property model required for delegation
- Story 2.4: SchemaPort loads and returns Schema instances
- Story 2.6: SchemaValidator validates Schema instances
- Story 2.7: SchemaResolver processes Schema inheritance
- Story 2.8: SchemaEngine orchestrates Schema pipeline

---

## Test Maintenance Considerations

### Low Maintenance Risk

**Config Model:**
- Pure unit tests with zero external dependencies
- Stable domain model (value objects rarely change)
- No brittle test data or fixtures
- Deterministic behavior

**Schema Model:**
- Pure unit tests with minimal dependencies (Property model only)
- Stable validation rules (FR5 requirements unlikely to change)
- Immutability pattern prevents state-related bugs
- Clear error semantics

### Potential Future Changes

**Config Model:**
- Adding new config fields → Add corresponding default tests
- Changing default values → Update test expectations
- Adding validation → May require new test scenarios

**Schema Model:**
- Adding new validation rules → Add corresponding test scenarios
- Changing error messages → Update error assertion tests
- Adding new inheritance features → Defer to SchemaResolver tests (Story 2.7)

---

## Test Design Principles Applied

### Shift Left ✅
- **All unit tests:** Domain logic tested at lowest level
- **Fast feedback:** No external dependencies, < 50ms total execution
- **Early validation:** Fail fast on constructor and validation issues

### Risk-Based ✅
- **P0 priority:** All foundational domain models (26/28 tests)
- **Critical validation:** Name required, excludes/extends constraint, immutability
- **FR5 compliance:** Error messages include schema names for traceability

### Efficient Coverage ✅
- **Test once at right level:** Pure domain logic → unit tests only
- **No redundancy:** Integration testing appropriately deferred
- **Clear boundaries:** Domain models isolated, integration tested in later stories

### Maintainability ✅
- **Pure functions:** Zero/minimal external dependencies
- **No/minimal mocks:** No infrastructure to mock
- **Stable tests:** Domain logic rarely changes
- **Fast execution:** Entire suite runs in milliseconds

---

## Summary

**Config Model (✅ Complete):**
- 12 comprehensive unit tests covering all acceptance criteria
- All P0 priority except 2 P1 edge cases
- >90% code coverage achieved
- Zero external dependencies - pure domain model
- All quality gates met

**Schema Model (🚧 Pending Implementation):**
- 16 comprehensive unit tests designed for all acceptance criteria
- 15 P0, 1 P1 priority (core domain entity)
- Target >90% code coverage
- Minimal dependencies (Property model from Story 2.2)
- Integration testing appropriately deferred to Stories 2.4-2.8

**Overall Test Strategy:**
- **28 total scenarios:** All unit tests (appropriate for pure domain models)
- **Efficient:** Testing at the right level (no over-testing with integration/e2e)
- **Comprehensive:** All validation rules, immutability, serialization covered
- **Risk-focused:** P0 priority for critical functionality (26/28 tests)
- **Maintainable:** Fast, stable, deterministic tests
- **Traceable:** FR5 compliance with error identifiers

**Deferred Appropriately:**
- Cross-schema validation → Story 2.6 (SchemaValidator)
- Inheritance resolution → Story 2.7 (SchemaResolver)
- Schema file loading → Story 2.4 (SchemaPort)
- Full system integration → Story 2.9 (E2E tests)

**Next Steps:**
1. Implement Schema model (Tasks 5-9 in Story 2.1)
2. Write Schema unit tests following this test design
3. Verify >90% coverage for Schema
4. Update quality gate status when Schema complete
