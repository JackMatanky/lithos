# Test Design: Story 2.10 Schema System Performance Optimizations

Date: 2025-11-01
Designer: Quinn (Test Architect)

## Test Strategy Overview

**Story Focus:** Performance optimizations to eliminate redundant property validations, improve startup time, and reduce CPU overhead in schema system.

**Test Approach:** Heavy emphasis on unit tests for caching/validation logic, integration tests for context propagation, and benchmarks for performance validation. Given the performance nature, benchmarks are P0 priority.

**Risk Assessment:** High risk of performance regressions or incorrect caching behavior. Critical to maintain validation correctness while improving performance.

**Test Levels Distribution:**
- Unit: 60% (caching, validation logic, parameter cleanup)
- Integration: 30% (context propagation, component interaction)
- E2E: 5% (full schema loading workflow)
- Benchmarks: 5% (performance measurement)

## Test Scenarios by Acceptance Criteria

### AC1: Property Validation De-duplication

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-UNIT-001 | Unit | P0 | Property validation caching prevents redundant validation calls | Pure logic - validation state tracking |
| 2.10-UNIT-002 | Unit | P0 | Validation state correctly tracked across multiple validation attempts | State management correctness |
| 2.10-UNIT-003 | Unit | P1 | Cached validation results match fresh validation results | Correctness preservation |
| 2.10-INT-001 | Integration | P0 | Schema.Validate skips already validated properties | Component interaction |
| 2.10-INT-002 | Integration | P0 | SchemaValidator skips already validated properties during walks | Multi-component validation |

**Given-When-Then Mappings:**

- **Unit Test**: `internal/domain/property_spec_test.go::TestValidationCaching`
  - Given: PropertySpec with validation state uninitialized
  - When: Validate called multiple times
  - Then: Validation logic executes only once, subsequent calls return cached result

- **Integration Test**: `internal/domain/schema_test.go::TestSchemaValidateCaching`
  - Given: Schema with pre-validated properties
  - When: Schema.Validate called
  - Then: Property validation skipped, only schema-level checks performed

### AC2: Regex Compilation Caching

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-UNIT-004 | Unit | P0 | Regex patterns precompiled once and cached | Pure logic - compilation caching |
| 2.10-UNIT-005 | Unit | P0 | Cached regex used for subsequent validations | Cache utilization |
| 2.10-UNIT-006 | Unit | P1 | Invalid regex patterns still fail compilation | Error handling preservation |
| 2.10-UNIT-007 | Unit | P1 | Thread-safe access to compiled regex cache | Concurrency safety |

**Given-When-Then Mappings:**

- **Unit Test**: `internal/domain/property_spec_test.go::TestRegexCompilationCaching`
  - Given: PropertySpec with regex pattern
  - When: Validation called multiple times
  - Then: Regex compiled once, cached instance reused

### AC3: Unused Parameter Cleanup

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-UNIT-008 | Unit | P0 | ValidateAll signature updated to remove unused PropertyBank parameter | API contract change |
| 2.10-UNIT-009 | Unit | P0 | All ValidateAll callers updated to remove unused argument | Breaking change compatibility |
| 2.10-INT-003 | Integration | P1 | Schema validation workflow functions without PropertyBank parameter | End-to-end validation flow |

**Given-When-Then Mappings:**

- **Unit Test**: `internal/adapters/spi/schema/validator_test.go::TestValidateAllSignature`
  - Given: ValidateAll method with updated signature
  - When: Called without PropertyBank parameter
  - Then: Validation completes successfully using internal state

### AC4: Extender Ordering Simplification

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-UNIT-010 | Unit | P0 | Inheritance merge logic simplified without orderIndex map | Logic simplification |
| 2.10-UNIT-011 | Unit | P0 | Merge order preserved using resolved lookup | Correctness preservation |
| 2.10-UNIT-012 | Unit | P1 | Complex inheritance chains maintain correct precedence | Edge case handling |

**Given-When-Then Mappings:**

- **Unit Test**: `internal/adapters/spi/schema/extender_test.go::TestInheritanceMergeSimplified`
  - Given: Schema inheritance chain without orderIndex bookkeeping
  - When: Extender resolves inheritance
  - Then: Properties merged in correct precedence order

### AC5: Context Propagation

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-UNIT-013 | Unit | P0 | loadPropertyBank accepts and uses provided context | Context threading |
| 2.10-INT-004 | Integration | P0 | Context cancellation interrupts large property bank loading | Cancellation behavior |
| 2.10-INT-005 | Integration | P1 | Context timeout prevents hanging on slow property bank loads | Timeout handling |

**Given-When-Then Mappings:**

- **Integration Test**: `internal/adapters/spi/schema/loader_test.go::TestLoadPropertyBankCancellation`
  - Given: Large property bank and cancellable context
  - When: Context cancelled during loading
  - Then: Loading operation terminates gracefully

### AC6: Performance Benchmarking

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-BENCH-001 | Benchmark | P0 | Property validation benchmark shows performance improvement | Performance measurement |
| 2.10-BENCH-002 | Benchmark | P0 | Schema loading benchmark with large catalogs | Startup time optimization |
| 2.10-BENCH-003 | Benchmark | P1 | Regex compilation benchmark shows caching benefits | CPU usage reduction |

**Given-When-Then Mappings:**

- **Benchmark Test**: `internal/domain/property_spec_bench_test.go::BenchmarkPropertyValidation`
  - Given: Large set of properties requiring validation
  - When: Validation performed with and without caching
  - Then: Cached version shows measurable performance improvement

### AC7: Memory Efficiency

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-UNIT-014 | Unit | P1 | Memory allocations reduced from removed unused parameters | Memory optimization |
| 2.10-UNIT-015 | Unit | P1 | Unnecessary data structures eliminated | Allocation reduction |
| 2.10-BENCH-004 | Benchmark | P1 | Memory benchmark shows allocation improvements | Memory profiling |

**Given-When-Then Mappings:**

- **Unit Test**: `internal/adapters/spi/schema/validator_test.go::TestValidateAllMemoryEfficiency`
  - Given: ValidateAll called with various schema sizes
  - When: Memory profiling enabled
  - Then: Allocations from unused parameters eliminated

### AC8: Startup Time Optimization

**Test Scenarios:**

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.10-E2E-001 | E2E | P0 | Full application startup with large schema catalog | End-to-end performance |
| 2.10-INT-006 | Integration | P0 | SchemaEngine.Load performance with optimizations | Critical path timing |
| 2.10-BENCH-005 | Benchmark | P0 | Startup time benchmark shows measurable improvement | Overall system performance |

**Given-When-Then Mappings:**

- **E2E Test**: `tests/e2e/schema_startup_test.go::TestLargeCatalogStartup`
  - Given: Application with large schema catalog
  - When: Full startup sequence executed
  - Then: Startup time within acceptable bounds with improvements

## Risk-Based Testing Strategy

### Priority 1 (P0): Critical Performance Paths
- All validation caching and de-duplication logic
- Context propagation and cancellation
- Performance benchmarks and measurements
- Startup time critical path

### Priority 2 (P1): Correctness and Edge Cases
- Parameter cleanup and API changes
- Extender logic simplification
- Memory efficiency improvements
- Thread-safety and concurrency

### Test Data Requirements

- **Small Schema Set:** 5-10 schemas for unit testing
- **Large Schema Catalog:** 100+ schemas for performance testing
- **Complex Inheritance:** Multi-level inheritance chains
- **Invalid Data:** Malformed schemas for error handling
- **Concurrent Load:** Multiple goroutines for thread-safety testing

## Recommended Execution Order

1. **P0 Unit Tests** (validation caching, regex compilation, parameter cleanup)
2. **P0 Integration Tests** (context propagation, component interaction)
3. **P0 Benchmarks** (performance baselines before optimization)
4. **P0 E2E Tests** (startup time validation)
5. **P1 Tests** (edge cases, memory efficiency)

## Quality Indicators

**Pass Criteria:**
- All P0 tests pass with >95% coverage
- Performance benchmarks show measurable improvements
- Memory allocations reduced by >20%
- Startup time improved by >30% for large catalogs
- No correctness regressions in validation behavior

**Risk Indicators:**
- Validation caching bypasses or incorrect results
- Context cancellation not working
- Performance regressions
- Memory leaks from new caching structures</content>
</xai:function_call: write>
<xai:function_call name="write">
<parameter name="filePath">docs/qa/gates/2.10-schema-performance-optimizations.yml
