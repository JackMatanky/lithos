# Test Design: Story 3.4 - VaultWriterPort & Adapter

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.4 - VaultWriterPort and VaultWriterAdapter
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 14
- **Unit tests:** 14 (100%)
- **Priority distribution:** P0: 10, P1: 4

**Rationale:** Writer adapter must guarantee atomic writes, idempotent deletes, and preservation of YAML frontmatter. Tests use temp directories, capture logs, and simulate permission failures. Interface assertions keep port contract stable.

---

## Test Scenarios by Acceptance Criteria

### Port Definition (AC 3.4.1)

| ID           | Level | Priority | Test Description                                             | Justification                           |
| ------------ | ----- | -------- | ------------------------------------------------------------ | --------------------------------------- |
| 3.4-UNIT-001 | Unit  | P0       | Compile-time assertion for VaultWriterPort interface         | Guards signature stability              |
| 3.4-UNIT-002 | Unit  | P1       | GoDoc contains idempotency/atomic write guidance             | Documentation requirement               |

### Persist Implementation (AC 3.4.2-3.4.3)

| ID           | Level | Priority | Test Description                                             | Justification                           |
| ------------ | ----- | -------- | ------------------------------------------------------------ | --------------------------------------- |
| 3.4-UNIT-003 | Unit  | P0       | Persist creates new file with serialized markdown            | Core success path                       |
| 3.4-UNIT-004 | Unit  | P0       | Persist overwrites existing file atomically                  | Atomic guarantee                        |
| 3.4-UNIT-005 | Unit  | P0       | Persist creates parent directories when missing              | Directory handling                      |
| 3.4-UNIT-006 | Unit  | P0       | Persist returns wrapped error on permission denied           | Error propagation                       |
| 3.4-UNIT-007 | Unit  | P0       | Persist preserves frontmatter fields exactly (FR6)           | Data integrity                          |
| 3.4-UNIT-008 | Unit  | P1       | Debug log emitted on successful persist                      | Observability                           |

### Delete Implementation (AC 3.4.4)

| ID           | Level | Priority | Test Description                                             | Justification                           |
| ------------ | ----- | -------- | ------------------------------------------------------------ | --------------------------------------- |
| 3.4-UNIT-009 | Unit  | P0       | Delete removes existing file                                 | Core success path                       |
| 3.4-UNIT-010 | Unit  | P0       | Delete non-existent file returns nil                         | Idempotent delete                       |
| 3.4-UNIT-011 | Unit  | P0       | Delete returns wrapped error on permission denied            | Error propagation                       |
| 3.4-UNIT-012 | Unit  | P1       | Delete emits debug log on success                            | Observability                           |

### Tooling & Atomic Writer Dependency (AC 3.4.5-3.4.7)

| ID           | Level | Priority | Test Description                                             | Justification                           |
| ------------ | ----- | -------- | ------------------------------------------------------------ | --------------------------------------- |
| 3.4-UNIT-013 | Unit  | P0       | Test verifies atomic writer temp/rename sequence used        | Ensures `atomicwriter` integration      |
| 3.4-UNIT-014 | Unit  | P0       | `go test ./internal/adapters/spi/vault` & lint succeed       | Tooling gate                            |

---

## Test Scenario Details

- Use helper to serialize Note to markdown (frontmatter YAML + body) and validate round-trip.
- Atomic check: stub atomic writer capturing temp path usage or inspect remaining temp files.
- Permission denied simulated via chmod 0444 and attempt to overwrite (skip on Windows).
- Logging assertions via capturing logger from previous stories.

---

## Risk Coverage

- **RISK-VAULTWRITE-001:** Atomic guarantees broken → Mitigated by 3.4-UNIT-004 & 3.4-UNIT-013.
- **RISK-VAULTWRITE-002:** Frontmatter mutated → Mitigated by 3.4-UNIT-007.
- **RISK-VAULTWRITE-003:** Delete not idempotent → Mitigated by 3.4-UNIT-010.
- **RISK-VAULTWRITE-004:** Error messages lack context → Mitigated by 3.4-UNIT-006/011.

---

## Test Execution Order

1. Interface/doc checks (001-002).
2. Persist suite (003-008, 013).
3. Delete suite (009-012).
4. Lint/test command (014).

---

## Quality Gates

- ✅ All 10 P0 scenarios passing.
- ✅ Lint and unit tests clean.
- ✅ Logs captured for success paths.

---

## Summary

Tests ensure the vault writer persists/overwrites atomically, preserves frontmatter, deletes idempotently, and logs appropriately before CommandOrchestrator depends on it.
