# Test Design: Story 3.7 - QueryService

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.7 - QueryService
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 18
- **Unit tests:** 18 (100%)
- **Priority distribution:** P0: 13, P1: 5

**Rationale:** QueryService manages in-memory indices with concurrency requirements. Tests cover index population, individual query methods, cache refresh, concurrent access, and error types using fake cache reader and sample notes.

---

## Test Scenarios by Acceptance Criteria

### Index Construction & Refresh (AC 1, 4)

| ID           | Level | Priority | Test Description                                                      | Justification                                 |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | --------------------------------------------- |
| 3.7-UNIT-001 | Unit  | P0       | New QueryService initializes maps and RWMutex                         | Struct correctness                             |
| 3.7-UNIT-002 | Unit  | P0       | RefreshFromCache loads notes from CacheReader and populates indices   | Core behavior                                  |
| 3.7-UNIT-003 | Unit  | P0       | Refresh clears old entries before reloading                           | Prevent stale data                             |
| 3.7-UNIT-004 | Unit  | P1       | Refresh handles cache reader error and returns wrapped error          | Error propagation                              |

### Lookup Methods (AC 1-2)

| ID           | Level | Priority | Test Description                                                      | Justification                                 |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | --------------------------------------------- |
| 3.7-UNIT-005 | Unit  | P0       | ByID returns note when present                                        | Core lookup                                    |
| 3.7-UNIT-006 | Unit  | P0       | ByID returns ErrNotFound when absent                                  | Error behavior                                 |
| 3.7-UNIT-007 | Unit  | P0       | ByPath returns note by exact path                                     | FR9 requirement                                |
| 3.7-UNIT-008 | Unit  | P0       | ByFileClass returns notes matching schema                             | FR9 requirement                                |
| 3.7-UNIT-009 | Unit  | P0       | ByFrontmatter filters by key/value pairs                              | Flexible query                                 |
| 3.7-UNIT-010 | Unit  | P0       | ByBasename (via FR9) returns list of notes with same basename         | FR9 requirement                                |
| 3.7-UNIT-011 | Unit  | P1       | Query methods respect case sensitivity per design                     | Edge case                                      |

### Concurrency & Observability (AC 1,3,4)

| ID           | Level | Priority | Test Description                                                      | Justification                                 |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | --------------------------------------------- |
| 3.7-UNIT-012 | Unit  | P0       | Concurrent read access via goroutines has no race (with `-race`)      | Thread safety                                  |
| 3.7-UNIT-013 | Unit  | P0       | Logging/instrumentation hook invoked during queries                   | Observability                                  |
| 3.7-UNIT-014 | Unit  | P1       | Metrics counters (if provided) increment appropriately                | Instrumentation                                |

### Helper Utilities

| ID           | Level | Priority | Test Description                                                      | Justification                                 |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | --------------------------------------------- |
| 3.7-UNIT-015 | Unit  | P0       | CacheReader fake returns deterministic set for tests                  | Test harness                                   |
| 3.7-UNIT-016 | Unit  | P0       | Error wrapping includes query name/context                            | Error strategy                                 |
| 3.7-UNIT-017 | Unit  | P1       | Index removal on refresh handles deleted notes                        | Edge case                                      |

### Tooling (AC 4-5)

| ID           | Level | Priority | Test Description                                                      | Justification                                 |
| ------------ | ----- | -------- | --------------------------------------------------------------------- | --------------------------------------------- |
| 3.7-UNIT-018 | Unit  | P0       | `go test ./internal/app/query` & lint succeed                         | Tooling gate                                   |

---

## Test Scenario Details

- Build fixtures with multiple notes covering different file classes, basenames, and frontmatter fields.
- Use cache reader fake returning slice and track calls to ensure refresh hits reader once.
- For concurrency test, spawn 100 goroutines performing different queries under read lock, run with `-race`.
- Logging/instrumentation check: capture logs or counter increments during queries.
- Ensure QueryService returns copies to prevent mutation (optional check).

---

## Risk Coverage

- **RISK-QUERY-001:** Indices not synchronized → Mitigated by 3.7-UNIT-001/003.
- **RISK-QUERY-002:** Lookups fail to support FR9 keys → Mitigated by 3.7-UNIT-007/008/009/010.
- **RISK-QUERY-003:** Concurrent reads cause races → Mitigated by 3.7-UNIT-012.
- **RISK-QUERY-004:** Errors uninformative → Mitigated by 3.7-UNIT-006/016.

---

## Test Execution Order

1. Struct initialization tests (001).
2. Refresh and helper fakes (002-004, 015).
3. Lookup suite (005-011, 016-017).
4. Concurrency & instrumentation (012-014).
5. Tooling (018).

---

## Quality Gates

- ✅ All 13 P0 scenarios passing.
- ✅ Concurrency tested with `-race`.
- ✅ Lint/test commands succeed.

---

## Summary

The QueryService tests guarantee accurate, concurrent-safe lookups across all required keys, proper error reporting, and observability prior to template and validator integration.
