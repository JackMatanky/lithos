# Test Design: Story 3.8 - CLI Index Command

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.8 - CLI Index Command
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 12
- **Unit tests:** 8
- **Integration/E2E tests:** 4 (CLI invocation with fixtures)
- **Priority distribution:** P0: 9, P1: 3

**Rationale:** This story spans application and CLI layers. Unit tests verify CommandOrchestrator delegation, logging, and error handling. Integration tests run the actual CLI against temp fixtures to confirm cache generation, output, and exit codes.

---

## Test Scenarios by Acceptance Criteria

### CommandOrchestrator.IndexVault (AC 1)

| ID           | Level | Priority | Test Description                                                     | Justification                                         |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ----------------------------------------------------- |
| 3.8-UNIT-001 | Unit  | P0       | IndexVault calls VaultIndexer.Build and returns stats                | Core delegation                                      |
| 3.8-UNIT-002 | Unit  | P0       | IndexVault logs start and completion summary                         | Observability requirement                            |
| 3.8-UNIT-003 | Unit  | P0       | IndexVault wraps errors with context                                 | Error strategy                                       |
| 3.8-UNIT-004 | Unit  | P1       | IndexVault propagates metrics (scanned/indexed/failures)             | Data integrity                                       |

### CLI Adapter (AC 2)

| ID           | Level | Priority | Test Description                                                     | Justification                                         |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ----------------------------------------------------- |
| 3.8-UNIT-005 | Unit  | P0       | CLI registers `index` command with flags per architecture            | Interface contract                                   |
| 3.8-UNIT-006 | Unit  | P0       | CLI command invokes CommandPort.IndexVault                           | Delegation                                           |
| 3.8-UNIT-007 | Unit  | P0       | CLI prints stats to stdout on success                                | User feedback                                        |
| 3.8-UNIT-008 | Unit  | P0       | CLI exits with non-zero status on failure                            | Error path                                           |

### Integration/E2E (AC 2-3)

| ID           | Level | Priority | Test Description                                                     | Justification                                         |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ----------------------------------------------------- |
| 3.8-E2E-009  | E2E   | P0       | `lithos index` against fixture vault creates cache JSON files        | Ensures end-to-end pipeline                          |
| 3.8-E2E-010  | E2E   | P0       | CLI output includes stats and success message                        | User experience                                      |
| 3.8-E2E-011  | E2E   | P1       | Failure scenario: inject VaultIndexer error → command prints error & exits 1 | Error observability                           |
| 3.8-E2E-012  | E2E   | P1       | Help/usage text references command per PRD                           | Documentation alignment                              |

### Tooling (AC 5)

- `go test ./internal/app/command ./internal/adapters/api/cli` executed as part of unit suite (covered by scenarios above).
- `golangci-lint run ./internal/app/command ./internal/adapters/api/cli` enforced in CI.

---

## Test Scenario Details

- Use fake VaultIndexer for unit tests capturing Build calls and returning predetermined IndexStats.
- Logging assertions via capturing logger to validate start/end messages.
- E2E tests run CLI by executing `lithos index --cache-dir <temp> --vault <fixtures>` within temp workspace; verify generated files and parse stats printed.
- Failure scenario can use stub CommandPort returning error; assert exit code and stderr message.
- Help text check ensures `lithos --help` lists `index` command with PRD wording.

---

## Risk Coverage

- **RISK-CLI-001:** CLI fails to trigger indexer → Mitigated by 3.8-UNIT-005/006 and E2E tests.
- **RISK-CLI-002:** Stats misreported → Mitigated by 3.8-UNIT-002/004 and E2E-010.
- **RISK-CLI-003:** Errors hidden → Mitigated by 3.8-UNIT-003/008 and E2E-011.
- **RISK-CLI-004:** Documentation/help outdated → Mitigated by 3.8-E2E-012.

---

## Test Execution Order

1. Unit tests for command orchestrator (001-004).
2. Unit tests for CLI adapter (005-008).
3. Integration/E2E tests (009-012) using fixtures.
4. Run lint and go test commands across command + CLI packages.

---

## Quality Gates

- ✅ All P0 unit and E2E scenarios passing.
- ✅ CLI exit codes validated for success/failure paths.
- ✅ Lint and test commands succeed.

---

## Summary

The test plan confirms the `index` command drives VaultIndexer, reports stats, handles failures, and updates CLI help before release.
