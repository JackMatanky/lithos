# Test Design: Story 3.5 - FrontmatterService

**Date:** 2025-10-29
**Designer:** Quinn (Test Architect)
**Story:** 3.5 - FrontmatterService
**Epic:** 3 - Vault Caching & Indexing

---

## Test Strategy Overview

- **Total test scenarios:** 16
- **Unit tests:** 16 (100%)
- **Priority distribution:** P0: 12, P1: 4

**Rationale:** FrontmatterService is pure logic with parsing and validation dependencies (SchemaRegistryPort, QueryService). Tests use in-memory YAML samples and fake dependencies to cover extraction, validation, FR6/FR7 rules, and error shaping.

---

## Test Scenarios by Acceptance Criteria

### Extraction (AC 1)

| ID           | Level | Priority | Test Description                                                     | Justification                               |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ------------------------------------------- |
| 3.5-UNIT-001 | Unit  | P0       | Extract parses YAML between `---` delimiters                         | Core behavior                               |
| 3.5-UNIT-002 | Unit  | P0       | Extract handles missing closing delimiter (returns empty frontmatter)| Edge case                                    |
| 3.5-UNIT-003 | Unit  | P0       | Extract returns body content unchanged                               | Ensures content separation                   |
| 3.5-UNIT-004 | Unit  | P1       | Extract tolerates BOM/leading whitespace                             | Robustness                                   |

### Validation (AC 2)

| ID           | Level | Priority | Test Description                                                     | Justification                               |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ------------------------------------------- |
| 3.5-UNIT-005 | Unit  | P0       | Validate detects missing required field                              | FR7 compliance                               |
| 3.5-UNIT-006 | Unit  | P0       | Validate enforces type mismatch (string vs array)                    | Type safety                                  |
| 3.5-UNIT-007 | Unit  | P0       | Validate handles FileSpec references via QueryService fake           | FR6 file lookup                              |
| 3.5-UNIT-008 | Unit  | P0       | Validate returns success when fields match schema                    | Happy path                                   |
| 3.5-UNIT-009 | Unit  | P0       | Validation preserves unknown fields in returned structure            | FR6 requirement                              |
| 3.5-UNIT-010 | Unit  | P1       | Validate supports array vs scalar differentiation                    | Additional FR7 scenario                      |

### Error Handling (AC 3)

| ID           | Level | Priority | Test Description                                                     | Justification                               |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ------------------------------------------- |
| 3.5-UNIT-011 | Unit  | P0       | FrontmatterError includes field name and schema reference            | Error clarity                               |
| 3.5-UNIT-012 | Unit  | P0       | Multiple validation issues aggregate into composite error            | Error richness                              |

### Dependency Fakes & Instrumentation (AC 1-3,5)

| ID           | Level | Priority | Test Description                                                     | Justification                               |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ------------------------------------------- |
| 3.5-UNIT-013 | Unit  | P1       | Fake SchemaRegistryPort provides schema lookups used by validator    | Ensures isolation                           |
| 3.5-UNIT-014 | Unit  | P1       | Fake QueryService handles FileSpec lookups (existing/missing files)  | Ensures file resolution logic               |

### Tooling (AC 4-5)

| ID           | Level | Priority | Test Description                                                     | Justification                               |
| ------------ | ----- | -------- | -------------------------------------------------------------------- | ------------------------------------------- |
| 3.5-UNIT-015 | Unit  | P0       | Unit test verifying validation logging/instrumentation hooks execute | Observability                               |
| 3.5-UNIT-016 | Unit  | P0       | `go test ./internal/app/frontmatter` & `golangci-lint` succeed       | Tooling gate                                |

---

## Test Scenario Details

- Use YAML snippets with nested structures to exercise type handling.
- Fakes for SchemaRegistryPort provide schema definitions (required/optional fields, array specs, FileSpec details).
- QueryService fake tracks calls for file references and can simulate missing entries.
- FrontmatterError assertions should check message content and underlying causes.

---

## Risk Coverage

- **RISK-FRONT-001:** Incorrect extraction leads to malformed notes → Mitigated by 3.5-UNIT-001/002/003.
- **RISK-FRONT-002:** Schema violations slip through → Mitigated by 3.5-UNIT-005/006/007/010.
- **RISK-FRONT-003:** Unknown fields dropped → Mitigated by 3.5-UNIT-009.
- **RISK-FRONT-004:** Errors lack actionable detail → Mitigated by 3.5-UNIT-011/012.

---

## Test Execution Order

1. Extraction tests (001-004).
2. Validation happy path and failures (005-010).
3. Error shaping (011-012).
4. Dependency fakes instrumentation (013-014).
5. Logging/tooling checks (015-016).

---

## Quality Gates

- ✅ All 12 P0 scenarios passing.
- ✅ Fakes cover schema/file lookups.
- ✅ Lint and unit tests succeed.

---

## Summary

This plan proves FrontmatterService extracts YAML accurately, enforces schema rules, preserves unknown fields, and surfaces meaningful errors prior to indexer integration.
